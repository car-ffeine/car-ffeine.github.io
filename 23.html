<!doctype html>
<html lang="ko" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Deadlock trouble shooting | CAR-FFEINE</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://car-ffeine.github.io/23"><meta data-rh="true" name="docusaurus_locale" content="ko"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="ko"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Deadlock trouble shooting | CAR-FFEINE"><meta data-rh="true" name="description" content="이 글을 쓰는 이유"><meta data-rh="true" property="og:description" content="이 글을 쓰는 이유"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-07-31T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/drunkenhw"><meta data-rh="true" property="article:tag" content="deadlock,trouble-shooting"><link data-rh="true" rel="canonical" href="https://car-ffeine.github.io/23"><link data-rh="true" rel="alternate" href="https://car-ffeine.github.io/23" hreflang="ko"><link data-rh="true" rel="alternate" href="https://car-ffeine.github.io/23" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="CAR-FFEINE RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="CAR-FFEINE Atom Feed"><link rel="stylesheet" href="/assets/css/styles.3f0749fa.css">
<link rel="preload" href="/assets/js/runtime~main.7add4df6.js" as="script">
<link rel="preload" href="/assets/js/main.69b720bd.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="본문으로 건너뛰기"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">본문으로 건너뛰기</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">CAR-FFEINE</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/woowacourse-teams/2023-car-ffeine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="어두운 모드와 밝은 모드 전환하기 (현재 밝은 모드)" aria-label="어두운 모드와 밝은 모드 전환하기 (현재 밝은 모드)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="최근 블로그 문서 둘러보기"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/30">카페인 팀의 협업 일화</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/29">useSyncExternalStore로 만들어보는 전역상태관리 도구</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/28">카페인 팀에서 사용한 지도 시스템에 관하여</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/27">EC2 서버 추가와 동시에 Dev, Prod 환경 분리하기</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/26">카페인 팀 클라이언트의 테스트 자동화</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Deadlock trouble shooting</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-07-31T00:00:00.000Z" itemprop="datePublished">2023년 7월 31일</time> · <!-- -->약 13분</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/drunkenhw" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/drunkenhw.png" alt="박스터"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/drunkenhw" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">박스터</span></a></div><small class="avatar__subtitle" itemprop="description">Backend</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="이-글을-쓰는-이유">이 글을 쓰는 이유<a href="#이-글을-쓰는-이유" class="hash-link" aria-label="이 글을 쓰는 이유에 대한 직접 링크" title="이 글을 쓰는 이유에 대한 직접 링크">​</a></h2><p>먼저 이 글을 쓰는 이유는 저희 카페인 팀의 혼잡도 저장 및 충전기의 상태를 업데이트하는 로직에서 dead Lock이 발생하여 mysql과 connection을 잃는 에러가 발생했기 때문입니다.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LATEST DETECTED DEADLock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-07-21 01:49:54 </span><span class="token number" style="color:#36acaa">281472560787424</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TRANSACTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRANSACTION </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain">, ACTIVE </span><span class="token number" style="color:#36acaa">373</span><span class="token plain"> sec inserting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql tables </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> use </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, Locked </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock WAIT </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> Lock struct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, heap size </span><span class="token number" style="color:#36acaa">1128</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> row Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, undo log entries </span><span class="token number" style="color:#36acaa">328</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL thread </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">860</span><span class="token plain">, OS thread handle </span><span class="token number" style="color:#36acaa">281472107409376</span><span class="token plain">, query </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2958720</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO charger_status </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station_id, charger_id, latest_update_time, charger_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> VALUES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;ST414511&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;01&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;2023-07-21 08:27:43&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;CHARGING_IN_PROGRESS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ON DUPLICATE KEY UPDATE latest_update_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2023-07-21 08:27:43&#x27;</span><span class="token plain">, charger_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;CHARGING_IN_PROGRESS&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> HOLDS THE Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">742</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">424</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain"> Lock_mode X Locks rec but not gap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> WAITING FOR THIS Lock TO BE GRANTED:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">718</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">280</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain"> Lock_mode X Locks rec but not gap waiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TRANSACTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRANSACTION </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain">, ACTIVE </span><span class="token number" style="color:#36acaa">507</span><span class="token plain"> sec inserting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql tables </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> use </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, Locked </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock WAIT </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> Lock struct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, heap size </span><span class="token number" style="color:#36acaa">1323</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> row Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, undo log entries </span><span class="token number" style="color:#36acaa">432</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL thread </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">859</span><span class="token plain">, OS thread handle </span><span class="token number" style="color:#36acaa">281472629186528</span><span class="token plain">, query </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3017483</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO charger_status </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station_id, charger_id, latest_update_time, charger_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> VALUES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;ST412801&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;11&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;2023-07-21 10:48:20&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;CHARGING_IN_PROGRESS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ON DUPLICATE KEY UPDATE latest_update_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2023-07-21 10:48:20&#x27;</span><span class="token plain">, charger_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;CHARGING_IN_PROGRESS&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> HOLDS THE Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">718</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">208</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain"> Lock_mode X Locks rec but not gap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> WAITING FOR THIS Lock TO BE GRANTED:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">742</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">424</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain"> Lock_mode X Locks rec but not gap waiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>실제 <strong>개발 서버</strong>에서 발생한 데드락의 로그입니다. 해당 로그는 charger_status에 저장 시 서로 XLock을 획득하지 못하여 생기는 에러입니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mysql-dead-lock이란">Mysql Dead Lock이란<a href="#mysql-dead-lock이란" class="hash-link" aria-label="Mysql Dead Lock이란에 대한 직접 링크" title="Mysql Dead Lock이란에 대한 직접 링크">​</a></h2><p>그럼 Dead Lock은 왜 생기고 언제 생길까요?
저는 이 Log를 직접 마주하기 전까지는 Dead Lock이 그냥 Lock의 시간이 오래 걸릴 때 생기는 줄 알았습니다. 하지만 그렇게 간단하게 발생하는 것은 아니였습니다.</p><ol><li><p>상호 배제(Mutual Exclusion): MySQL은 기본적으로 트랜잭션 내에서 잠금(Lock)을 사용하여 데이터의 상호 배제를 제어합니다. 따라서 두 개 이상의 트랜잭션이 같은 데이터를 동시에 변경하려고 할 때, 해당 데이터에 대한 잠금이 설정되어 상호 배제 조건이 만족됩니다.</p></li><li><p>점유와 대기(Hold and Wait): 트랜잭션이 이미 하나 이상의 데이터를 잠근 상태에서 다른 데이터의 잠금을 얻기 위해 대기하고 있는 경우 점유와 대기 조건이 만족됩니다. 즉, 트랜잭션이 자신이 점유한 데이터를 유지한 상태에서 다른 데이터에 대한 잠금을 기다리고 있어야 합니다.</p></li><li><p>비선점(Non-Preemption): MySQL에서는 기본적으로 트랜잭션이 다른 트랜잭션이 점유한 데이터의 잠금을 강제로 해제할 수 없습니다. 따라서 비선점 조건이 만족됩니다.</p></li><li><p>순환 대기(Circular Wait): 두 개 이상의 트랜잭션이 각각 서로가 기다리는 데이터의 잠금을 보유해야 순환 대기 조건이 만족됩니다. 예를 들면, 트랜잭션 A가 데이터 X의 잠금을 기다리고, 트랜잭션 B는 데이터 Y의 잠금을 기다리며, 트랜잭션 C는 데이터 Z의 잠금을 기다리는 상태가 발생한다면 순환 대기 조건이 성립합니다.</p></li></ol><p>사실 기본 컴퓨터 시스템의 dead Lock과 유사한 조건입니다. 이 부분을 모두 만족해야 데드락이 발생합니다.
하나씩 알아보겠습니다. 먼저 개발 서버에서 발생한 데드락으로 살펴보겠습니다.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TRANSACTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRANSACTION </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain">, ACTIVE </span><span class="token number" style="color:#36acaa">373</span><span class="token plain"> sec inserting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql tables </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> use </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, Locked </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock WAIT </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> Lock struct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, heap size </span><span class="token number" style="color:#36acaa">1128</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> row Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, undo log entries </span><span class="token number" style="color:#36acaa">328</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL thread </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">860</span><span class="token plain">, OS thread handle </span><span class="token number" style="color:#36acaa">281472107409376</span><span class="token plain">, query </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2958720</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO charger_status </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station_id, charger_id, latest_update_time, charger_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> VALUES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;ST414511&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;01&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;2023-07-21 08:27:43&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;CHARGING_IN_PROGRESS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ON DUPLICATE KEY UPDATE latest_update_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2023-07-21 08:27:43&#x27;</span><span class="token plain">, charger_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;CHARGING_IN_PROGRESS&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> HOLDS THE Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">742</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">424</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain"> Lock_mode X Locks rec but not gap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TRANSACTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRANSACTION </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain">, ACTIVE </span><span class="token number" style="color:#36acaa">507</span><span class="token plain"> sec inserting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql tables </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> use </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, Locked </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock WAIT </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> Lock struct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, heap size </span><span class="token number" style="color:#36acaa">1323</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> row Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, undo log entries </span><span class="token number" style="color:#36acaa">432</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL thread </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">859</span><span class="token plain">, OS thread handle </span><span class="token number" style="color:#36acaa">281472629186528</span><span class="token plain">, query </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3017483</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO charger_status </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station_id, charger_id, latest_update_time, charger_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> VALUES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;ST412801&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;11&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;2023-07-21 10:48:20&#x27;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&#x27;CHARGING_IN_PROGRESS&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ON DUPLICATE KEY UPDATE latest_update_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2023-07-21 10:48:20&#x27;</span><span class="token plain">, charger_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;CHARGING_IN_PROGRESS&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> HOLDS THE Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">718</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">208</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain"> Lock_mode X Locks rec but not gap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>1번 트랜잭션 1000560이 charge_status 테이블에 insert <del>~ on duplicate key update ~</del> 쿼리를 발생시키기 위해 <code>space id 64 page no 742 n bits 424 index PRIMARY of table</code>  에 X Lock을 가지고 있습니다
그리고 2번 트랜잭션 946331 도 똑같은 테이블에 비슷한 쿼리를 발생시키려고 합니다. 그리고 해당 트랜잭션도 X Lock을 가지고 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="저희-팀에-데드락이-발생한-이유">저희 팀에 데드락이 발생한 이유<a href="#저희-팀에-데드락이-발생한-이유" class="hash-link" aria-label="저희 팀에 데드락이 발생한 이유에 대한 직접 링크" title="저희 팀에 데드락이 발생한 이유에 대한 직접 링크">​</a></h3><p>먼저 저희 팀은 공공 API를 통해 전기차 충전소 정보를 cron으로 업데이트 해주고 있습니다.
그리고 충전기의 상태도 주기적으로 업데이트 해주고 있습니다.
충전소 정보를 갱신할 경우 새로 생긴 충전소가 있다면 추가해줘야하고, 새로 생긴 충전소가 있다면 새로운 충전기가 있을테고, 그에따른 충전기 상태도 추가해줘야합니다.
그리고 원래 있던 충전소의 정보가 바뀌는 것에 대해서도 업데이트 해줘야합니다. 이렇게 된다면 여러번의 분기 처리로 application 레벨에서 해결하는 것이 나을지 혹은 mysql의 문법 중 <code>INSERT ~~ ON DUPLICATE KEY UPDATE ~~</code>을 이용할까 고민을 했었는데요.</p><p>그 중 후자를 택한 이유를 말씀드리겠습니다. 충전기의 정보는 하루에 공공 API를 요청할 수 있는 key 제한이 있고 지도 기반으로 검색할 수 있는 조건이 없기 때문에 실시간으로 요청할 수 없는 구조입니다.
그래서 요청 key 제한을 넘지 않는 선에서 자주 요청을 해야합니다. 그렇게해야 사용자에게 정보에 대한 신뢰를 줄 수 있습니다. 따라서 자주 요청되는 작업에 Application 레벨에서 구현한다면, findAll() 메서드를 통해 23만건의 충전기 상태 정보를 메모리에 로딩합니다. 그리고 api의 요청을 통해 얻은 23만+n건의 충전기 상태 정보를 메모리에 올립니다.</p><p>그리고 해당 정보가 있는지 비교합니다. 해당 정보가 findAll()로 찾아온 list에 없으면 Insert, 해당 정보가 있다면 update를 통해 갱신합니다.</p><p>이렇게 한다면 총 batch Insert, Update를 통해 2번의 쿼리 + 46만 n건의 충전기 정보를 메모리에 올려 비교하는 연산이 생길 것 입니다.
하지만  <code>INSERT ~~ ON DUPLICATE KEY UPDATE ~~</code> 를 사용한다면 batch insert를 통해 1번의 쿼리로 해결 할 수 있습니다. 메모리에 데이터도 적재하지 않고 말이죠.</p><p>하지만 보셨던 것과 같이 데드락이 발생했습니다.  이유는 <code>INSERT ~~ ON DUPLICATE KEY UPDATE ~~</code> 의 특수한 Lock mechanism 때문입니다. 해당 쿼리는</p><ol><li>먼저 삽입하려는 행이 테이블에 존재하는지 확인합니다.</li><li>그리고 읽은 record에 대해 S Lock을 설정합니다.</li><li>그리고 해당 record가 duplicate key라는 조건이라면 X Lock을 설정합니다.</li></ol><p>이런 방식으로 작동하기 때문입니다.
이런 방식이 왜 문제가 될 수 있는지 알아보겠습니다.
먼저 자신이 읽은 record에 S Lock을 각각의 트랜잭션이 설정합니다.
그리고 업데이트를 하기위해 record에 X Lock을 설정하려고 합니다. 하지만 각각의 트랜잭션이 서로 S Lock을 설정했기 때문에 S Lock을 반납하고 X Lock을 설정하려고 해도 두 트랜잭션 모두 기다리는 데드락 상황이 발생하기 때문입니다. 이런 상황이 되면 아까 위에서 말씀드렸던 데드락의 조건 4가지가 다 만족하고 데드락이 발생합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="해결-방안">해결 방안<a href="#해결-방안" class="hash-link" aria-label="해결 방안에 대한 직접 링크" title="해결 방안에 대한 직접 링크">​</a></h3><p>해결 방안은 여러가지가 있을 수 있습니다.
그 중 제 수준에서 생각할 수 있는 방법은 2가지가 있습니다.</p><ol><li>트랜잭션을 작게 분리
트랜잭션을 오래 가지고 있으면 Lock을 가지고 있는 시간이 오래걸립니다.
그래서 트랜잭션을 작게 분리할 수 있습니다.  페이징을 통해 트랜잭션을 작게 분리하다보면 쿼리가 여러번 나가 성능상 문제가 생길 수 있을 것 같습니다.</li><li><code>INSERT ~~ ON DUPLICATE KEY UPDATE ~~</code> 사용하지 않기
해당 sql이 아닌 <code>INSERT IGNORE</code>을 사용하여 추가된 정보만 넣고, update는 다른 작업으로 분리하기</li></ol><p>이런 방법들을 사용하면 될 것 같았습니다. 그 중 저는 현재는 간단하게 2번째 방법이 제일 나을 것 같다는 생각에 쿼리를 수정했습니다.</p><p>그리고 문제를 해결했습니다. 해당 문제가 발생하게 되어 좀 더 재밌는 것들을 고민하고 공부할 수 있는 저희 팀에게 감사하고 모르는 키워드를 많이 알려준 누누에게 감사합니다.</p><p>아직 배우는 단계라 정확한 정보가 아닐 수 있습니다. 부족한 부분에 대해 많은 지적 부탁드립니다.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>태그:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/deadlock">deadlock</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/trouble-shooting">trouble-shooting</a></li></ul></div></footer></article><div></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="블로그 게시물 탐색"><a class="pagination-nav__link pagination-nav__link--prev" href="/24"><div class="pagination-nav__sublabel">이전 게시물</div><div class="pagination-nav__label">Out of memory trouble shooting</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/22"><div class="pagination-nav__sublabel">다음 게시물</div><div class="pagination-nav__label">필터링 기능 구현과 인덱스 이용한 조회 속도 개선하기</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#이-글을-쓰는-이유" class="table-of-contents__link toc-highlight">이 글을 쓰는 이유</a></li><li><a href="#mysql-dead-lock이란" class="table-of-contents__link toc-highlight">Mysql Dead Lock이란</a><ul><li><a href="#저희-팀에-데드락이-발생한-이유" class="table-of-contents__link toc-highlight">저희 팀에 데드락이 발생한 이유</a></li><li><a href="#해결-방안" class="table-of-contents__link toc-highlight">해결 방안</a></li></ul></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 CAR-FFEINE, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7add4df6.js"></script>
<script src="/assets/js/main.69b720bd.js"></script>
</body>
</html>