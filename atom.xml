<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://car-ffeine.github.io/</id>
    <title>CAR-FFEINE Blog</title>
    <updated>2023-10-18T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://car-ffeine.github.io/"/>
    <subtitle>CAR-FFEINE Blog</subtitle>
    <entry>
        <title type="html"><![CDATA[카페인 팀의 무중단 배포]]></title>
        <id>https://car-ffeine.github.io/41</id>
        <link href="https://car-ffeine.github.io/41"/>
        <updated>2023-10-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요! 카페인팀의 제이입니다.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요! 카페인팀의 제이입니다.</p><p>저희 카페인 팀에서 무중단 배포를 진행했습니다.
어떤 과정으로 진행을 했는지 작성해보도록 하겠습니다!</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="기존-배포-방식과-문제점">기존 배포 방식과 문제점<a href="#기존-배포-방식과-문제점" class="hash-link" aria-label="기존 배포 방식과 문제점에 대한 직접 링크" title="기존 배포 방식과 문제점에 대한 직접 링크">​</a></h2><b>먼저 카페인 팀의 기존 배포 방식은 다음과 같습니다.</b><br><br><ol><li><b>Target branch에 push</b>가 되면 <b>Github Actions</b>가 작동합니다.</li><li>Target branch의 <b>소스 코드가 빌드되어서 Docker Hub</b>에 올라가게 됩니다.</li><li><b>Github Actions의 self-hosted runner</b>를 통해 <b>infra 서버에서 prod 서버로 접근</b>하여서 <b>기존에 띄워진 서버를 다운</b> 시킵니다.</li><li>Docker Hub에 업로드한 <b>Docker image를 pull해서 서버를 가동</b>시킵니다.</li></ol><br>이런 과정으로 배포 스크립트가 작성되어 있습니다. 하지만 이 방법은 <b>기존 서버를 다운 시키고 새로운 서버를 띄울 때 다운 타임이 존재한다는 문제점</b>이 있습니다.<br><br>사용자 입장에서는 잘 사용하고 있는데 갑자기 서비스가 작동되지 않는다면 서비스에 대한 신뢰성이 낮아질 수도 있고 이런 이유로 이탈할 수도 있습니다.<hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="기존-문제를-해결하기">기존 문제를 해결하기<a href="#기존-문제를-해결하기" class="hash-link" aria-label="기존 문제를 해결하기에 대한 직접 링크" title="기존 문제를 해결하기에 대한 직접 링크">​</a></h2><p>저희는 먼저 제한된 EC2 인스턴스로 인해 롤링 배포의 장점을 가져갈 수 없었고, 카나리 방식 또한 저희 서비스에서 필요로한 전략이 아니기 때문에 비교적 롤백도 빠른 <b>Blue/Green</b> 전략을 선택하였습니다.</p><p>저희의 Blue/Green 무중단 배포 시나리오는 다음과 같습니다.
편의를 위해서 <b>[기존 서버(기존 포트) / 새로운 서버(새로운 포트)]</b> 라는 명칭을 사용하겠습니다.</p><br><ol><li><b>Target branch에 push</b>가 되면 <b>Github Actions가 작동</b>합니다.</li><li>Target branch의 <b>소스 코드가 빌드되어서 Docker Hub</b> 에 올라가게 됩니다.</li><li><b>Github Actions의 self-hosted runner</b>를 통해 <b>infra 서버에서 prod 서버로 접근</b>해서 Docker Hub에 업로드한 <b>새로운 버전의 Image를 pull</b> 해옵니다.</li><li>만약 <b>8080 포트에 기존 서버가 띄워져 있으면 8081 포트를 새로운 서버가 띄워질 포트로 지정</b>해주고, 반대로 <b>8081 포트에 기존 서버가 띄워져 있으면 8080 포트에 새로운 서버가 띄워질 포트로 지정</b>해줍니다.</li><li>미리 Docker Hub에 업로드한 <b>Docker image를 <!-- -->[image+port]<!-- -->라는 네이밍으로 pull을 한 후 새로운 포트로 서버를 가동</b>시킵니다.</li><li>새로운 서버가 제대로 가동 됐는지 확인하기 위해서 <b>헬스 체크</b>를 진행합니다. 20번 동안 서버가 정상 동작하는지 Spring Actuactor를 통해서 확인을 합니다.</li><li><b>정상 작동이 됐음을 확인하면 현재 인스턴스에는 2대의 서버</b>가 띄워져있고 <b>요청은 여전히 기존 서버</b>로 들어가게 됩니다. 따라서 <b>Nginx를 통해 포트포워딩을 새로운 서버의 포트로 지정</b>해주고 <b>기존 서버는 내려</b>줍니다.</li></ol><br>여기까지가 카페인 팀의 시나리오입니다. 그렇다면 하나씩 스크립트를 확인해보겠습니다. 설명은 주석으로 달아두겠습니다 :)<br><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backend-deployyml">backend-deploy.yml<a href="#backend-deployyml" class="hash-link" aria-label="backend-deploy.yml에 대한 직접 링크" title="backend-deploy.yml에 대한 직접 링크">​</a></h3><p>(Github Actions에서 사용)</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 1. prod/backend branch에 push 작업이 일어나면 해당 작업을 수행한다</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> prod/backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">docker-build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaults</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 2. 도커 허브에 로그인</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Log in to Docker Hub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker/login</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">action@f4ef78c080cd8ba55a85445d5b36e214a81df20a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.DOCKERHUB_USERNAME </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.DOCKERHUB_PASSWORD </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 3. JDK 17 설치 및 빌드 (프로젝트 Java version)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set up JDK 17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">java@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">java-version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'17'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">distribution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'adopt'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Gradle Caching</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/cache@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            ~/.gradle/caches</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            ~/.gradle/wrapper</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> runner.os </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gradle</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> hashFiles('</span><span class="token important">**/*.gradle*'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> '</span><span class="token important">**/gradle-wrapper.properties')</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">restore-keys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            ${{ runner.os }}-gradle-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Grant execute permission for gradlew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> chmod +x gradlew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build for asciiDoc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./gradlew bootjar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build with Gradle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./gradlew bootjar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 4. 산출물을 Image로 빌드 후 Docker Hub에 Image Push하기</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Extract metadata (tags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> labels) for Docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> meta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker/metadata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">action@9ec57ed1fcdbf14dcef7dfbe97b2010124a938b7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">images</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> woowacarffeine/backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build and push Docker image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker/build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">action@3b5e8027fcad23fda98b2e3ac259d8d67585f671</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">context</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./backend/Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">platforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> linux/arm64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">tags</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> woowacarffeine/backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> steps.meta.outputs.labels </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 5. Self-hosted 작동 -&gt; infra 인스턴스에서 작동됨</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hosted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> needs.docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">build.result == 'success' </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">needs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">build </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 6. infra 인스턴스에서 prod 인스턴스로 접근 (아래부터는 prod 서버 내에서 작업)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Join EC2 prod server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> appleboy/ssh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">action@master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">JASYPT_KEY</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.JASYPT_KEY </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">DATABASE_USERNAME</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.DATABASE_USERNAME </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">DATABASE_PASSWORD</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.DATABASE_PASSWORD </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SERVER_HOST </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SERVER_USERNAME </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SERVER_KEY </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SERVER_PORT </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">envs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> JASYPT_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DATABASE_USERNAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DATABASE_PASSWORD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">script</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 7. Docker Hub에서 Image를 pull해온다</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sudo docker pull woowacarffeine/backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 8. 만약 8080 포트가 켜져 있으면 새로운 서버의 포트는 8081로 설정</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if sudo docker ps </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> grep "</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">8080"; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              export BEFORE_PORT=8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              export NEW_PORT=8081</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              export NEW_ACTUATOR_PORT=8089</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 9. 만약 8081 포트가 켜져 있으면 새로운 서버의 포트는 8080로 설정</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              export BEFORE_PORT=8081</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              export NEW_PORT=8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              export NEW_ACTUATOR_PORT=8088</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 10. Docker로 새로운 서버를 띄운다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sudo docker run </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">d </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">p $NEW_PORT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">8080 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">p $NEW_ACTUATOR_PORT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">8088 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e "SPRING_PROFILE=prod" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e "ENCRYPT_KEY=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">secrets.JASYPT_KEY</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e "DATABASE_USERNAME=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">secrets.DATABASE_USERNAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e "DATABASE_PASSWORD=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">secrets.DATABASE_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e "REPLICA_DATABASE_USERNAME=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">secrets.REPLICA_DB_USER_NAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e "REPLICA_DATABASE_PASSWORD=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">secrets.REPLICA_DB_USER_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e "SLACK_WEBHOOK_URL=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">secrets.SLACK_WEBHOOK_URL</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name backend$NEW_PORT \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            woowacarffeine/backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 11. prod 인스턴스에 있는 bluegreen.sh 를 작동한다. (이 때 port 값을 같이 넣어준다.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sudo sh /home/ubuntu/bluegreen.sh $BEFORE_PORT $NEW_PORT $NEW_ACTUATOR_PORT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><br><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bluegreensh">bluegreen.sh<a href="#bluegreensh" class="hash-link" aria-label="bluegreen.sh에 대한 직접 링크" title="bluegreen.sh에 대한 직접 링크">​</a></h3><p>(prod 인스턴스 내부에 존재)</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 1. Github Actions를 통해 넘겨 받은 환경변수 값</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">BEFORE_PORT</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">NEW_PORT</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">NEW_ACTUATOR_PORT</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"기존 포트 : </span><span class="token string variable" style="color:#36acaa">$BEFORE_PORT</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"새로운 포트: </span><span class="token string variable" style="color:#36acaa">$NEW_PORT</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"새로운 ACTUATOR_PORT: </span><span class="token string variable" style="color:#36acaa">$NEW_ACTUATOR_PORT</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2. 20번 동안 헬스 체크를 진행</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">count</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"서버 상태 확인(</span><span class="token string variable" style="color:#36acaa">${count}</span><span class="token string" style="color:#e3116c">/20)"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 3. 새로운 서버가 작동되는지 Actuator를 통해 값을 받아옴</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">STATUS</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">curl</span><span class="token variable" style="color:#36acaa"> -s http://127.0.0.1:$</span><span class="token variable punctuation" style="color:#393A34">{</span><span class="token variable" style="color:#36acaa">NEW_ACTUATOR_PORT</span><span class="token variable punctuation" style="color:#393A34">}</span><span class="token variable" style="color:#36acaa">/actuator/health-check</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 4. Actuator를 통해 성공적으로 서버가 띄워지지 않은 경우</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${STATUS}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'{"status":"up"}'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 5. 10초를 기다린 후 다시 헬스 체크를 진행한다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 6. 헬스 체크를 통해 새로운 서버가 성공적으로 작동된다면 멈춘다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 7. 20번의 헬스 체크를 하는 동안 새로운 서버가 제대로 작동되지 않은 경우 종료</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$count</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">20</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"새로운 서버 배포를 실패했습니다."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 8. 새로운 서버가 성공적으로 작동한 경우</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Nginx를 통해 포트포워딩을 기존 포트에서 새로운 포트로 변경해준다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 이 부분은 .inc 파일을 통해 Nginx에서 주입 받아서 포트만 변경해도 됩니다!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">BACKEND_PORT</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$NEW_PORT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">envsubst </span><span class="token string" style="color:#e3116c">'${BACKEND_PORT}'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> backend.template </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> backend.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> backend.conf /etc/nginx/conf.d/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> nginx -s reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 9. 기존 서버를 내려주고, 도커 리소스를 정리해준다</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> stop backend</span><span class="token variable" style="color:#36acaa">$BEFORE_PORT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> container prune -f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 카페인 팀에서는 무중단 배포를 도입할 수 있었습니다.</p><p>긴 글 읽어주셔서 감사합니다 :)</p>]]></content>
        <author>
            <name>제이</name>
            <uri>https://github.com/sosow0212</uri>
        </author>
        <category label="infra" term="infra"/>
        <category label="ec2" term="ec2"/>
        <category label="cd" term="cd"/>
        <category label="aws" term="aws"/>
        <category label="zero-time" term="zero-time"/>
        <category label="blue-green" term="blue-green"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 서비스와 함께하는 전기차 여행 2]]></title>
        <id>https://car-ffeine.github.io/40</id>
        <link href="https://car-ffeine.github.io/40"/>
        <updated>2023-10-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요? 센트와 가브리엘 입니다.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요? 센트와 가브리엘 입니다.</p><p>저희 카페인 팀에서는 지난번 <a href="https://car-ffeine.github.io/39" target="_blank" rel="noopener noreferrer">카페인 서비스 1차 체험</a> 진행 이후 일부 기능 개선이 있었습니다. 기능 개선의 유용성을 판별하고자 카페인 서비스 2차 체험을 다녀왔습니다.</p><p>저희 팀에서 1차 체험 이후 개선한 사항은 다음과 같습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-지역검색">1. 지역검색<a href="#1-지역검색" class="hash-link" aria-label="1. 지역검색에 대한 직접 링크" title="1. 지역검색에 대한 직접 링크">​</a></h3><p><img loading="lazy" alt="no offset" src="/assets/images/city-search-2c43a5fed62ee0aa8a90519d91092b83.png" width="551" height="396" class="img_ev3q"></p><ul><li>이제는 검색어를 입력하는 경우, 전국 도시의 주소가 같이 제공됩니다.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-충전소-마커를-확인할-수-있는-지도-영역-확장">2. 충전소 마커를 확인할 수 있는 지도 영역 확장<a href="#2-충전소-마커를-확인할-수-있는-지도-영역-확장" class="hash-link" aria-label="2. 충전소 마커를 확인할 수 있는 지도 영역 확장에 대한 직접 링크" title="2. 충전소 마커를 확인할 수 있는 지도 영역 확장에 대한 직접 링크">​</a></h3><p><img loading="lazy" alt="no offset" src="/assets/images/mobile-markers-2cd607c6d10d89914731914ded7c421b.png" width="341" height="907" class="img_ev3q"></p><p>(기존에는 위 사진보다 좁은 영역만을 호출하는 것이 허용되었다.)</p><ul><li>모바일에서 좀 더 넓은 영역을 호출하는 것을 허용했습니다. 원래는 디바이스 너비를 고려하지 않고 줌 레벨 기준으로 요청을 제한했으나, 이제는 사용자 디바이스에 보이는 지도의 영역 크기를 기반으로 요청을 제한하는 방식을 도입했습니다.</li><li>기존에 사용하던 마커의 단점은, 그 크기가 너무 크다는 것이었습니다. 이로인해 더 넓은 영역을 보여주는 경우에 마커들이 겹치는 현상이 있었는데요, 이를 수정하기 위해 특정 영역 크기 이상에서는 마커를 좀 더 간소화 된 디자인으로 보이도록 개선하였습니다.</li><li>마커 사이즈가 작아지면서 사용 가능한 충전기 개수가 더이상 들어갈 공간이 없어졌습니다. 따라서 마커 색상은 그대로 유지를 하되, 인포 윈도우에 현재 사용 가능한 충전기 개수를 보여주는 방식으로 디자인을 개선하였습니다.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="체험-규칙-설정">체험 규칙 설정<a href="#체험-규칙-설정" class="hash-link" aria-label="체험 규칙 설정에 대한 직접 링크" title="체험 규칙 설정에 대한 직접 링크">​</a></h2><p>개선한 기능이 실제로 유용한지 확인해보기 위해 저희는 카페인 서비스 2차 체험의 규칙을 다음과 같이 설정했습니다.</p><p>저희는 좀 더 의미있는 경험을 하기위해 1차 체험 때 정했던 규칙에 더해서 다음과 같은 추가 규칙을 설정하였습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="중간에-목표-지점이-많이-변경된다">중간에 목표 지점이 많이 변경된다<a href="#중간에-목표-지점이-많이-변경된다" class="hash-link" aria-label="중간에 목표 지점이 많이 변경된다에 대한 직접 링크" title="중간에 목표 지점이 많이 변경된다에 대한 직접 링크">​</a></h3><p>지난 카페인 서비스 1차 체험에서는 지역 검색이 없어 목표 지점을 찾는 것이 불편했습니다. 1차 체험 이후 지역 검색이 추가 되었으므로 이 기능이 얼마나 유용한지 경험해보고자 이 규칙을 설정했습니다.</p><p>추가로 목표 지점 주변의 충전소를 확인할 때 새로 추가된 지도 영역 확장이 얼마나 유용한지도 경험해보고자 했습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="체험-개요">체험 개요<a href="#체험-개요" class="hash-link" aria-label="체험 개요에 대한 직접 링크" title="체험 개요에 대한 직접 링크">​</a></h2><p><img loading="lazy" alt="no offset" src="/assets/images/routes-f67d5286798a1ebb66fc487e25eb788c.png" width="494" height="720" class="img_ev3q"></p><ol><li>잠실역 출발</li><li>하남 만두집</li><li>다음 목적지 설정</li><li>판교</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="체험-후기">체험 후기<a href="#체험-후기" class="hash-link" aria-label="체험 후기에 대한 직접 링크" title="체험 후기에 대한 직접 링크">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="잠실역-출발">잠실역 출발<a href="#잠실역-출발" class="hash-link" aria-label="잠실역 출발에 대한 직접 링크" title="잠실역 출발에 대한 직접 링크">​</a></h3><p><img loading="lazy" alt="no offset" src="/assets/images/from-jamsil-6642367d758b59285f047247604f3b73.png" width="400" height="400" class="img_ev3q"></p><p>쏘카에서 EV6를 대여해서 <code>가브리엘</code>, <code>센트</code>, <code>키아라</code>가 잠실역에서 출발하였습니다. 저녁 퇴근 이후에 남이섬을 가려고 목적지를 설정하였으나 배가 너무 고파서 가는 길에 식사를 하자고 얘기가 나왔습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="하남-만두집">하남 만두집<a href="#하남-만두집" class="hash-link" aria-label="하남 만두집에 대한 직접 링크" title="하남 만두집에 대한 직접 링크">​</a></h3><p>따라서 진정한 처음 목적지는 스타필드였으나, 가브리엘은 동네 주민이라 스타필드를 너무 잘 알고 있었습니다. 따라서 스타필드에 전기차 충전소가 어디에 있는지도 알고있으므로 목적지를 급하게 변경하기로 했습니다. 이 때 목적지 변경을 위해 주변 식당을 둘러보던 중에 괜찮은 식당을 발견해서 해당 식당을 기준으로 주변 충전소를 확인해보기로 했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/go-to-starfield-cafc0eef5101f3d1f0b81bf033fd2d99.png" width="500" height="667" class="img_ev3q"></p><p>식당 주변을 가기 위해 지역 검색을 처음으로 사용하여 식당과 가까운 지역을 탐색할 수 있었습니다.</p><p>이 과정에서 식당에는 충전소가 없다는 사실을 알게되어, 근처 충전소를 찾아보기 위해서 지도를 축소했더니 1차 체험때와는 달리 더 넓은 영역을 보여줬습니다. 이전에는 마커 자체가 보이지 않아 답답하였으나, 이제는 더 넓은 영역을 조회할 수 있게 되어 편리했습니다.</p><p>지난 체험 이후로 피드백을 자체 수집하여 개발한 기능들이 편하다는 것을 식당에 가는 길에 느낄 수 있었습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="다음-목적지-설정">다음 목적지 설정<a href="#다음-목적지-설정" class="hash-link" aria-label="다음 목적지 설정에 대한 직접 링크" title="다음 목적지 설정에 대한 직접 링크">​</a></h3><p><img loading="lazy" alt="no offset" src="/assets/images/mandu-mandu-10754738289399ba0e8782a13a873c34.png" width="500" height="500" class="img_ev3q"></p><p>하남 만두집에서 식사를 하다가 알게된 사실은, 남이섬은 생각보다 너무 멀다는 것이었습니다. 식사를 마치고 남이섬에 가면, 충전도 제대로 못하고 돌아올 판이었습니다.</p><p>식사를 하면서 다른 목적지를 알아봤는데, 가브리엘이 예전에 가봤던 곳 중에서 남양주의 물의 정원이 시간을 떼우기 좋다는 소리를 하였습니다. 따라서 물의 정원을 검색해보았습니다.</p><p>놀랍게도 물의정원은 검색결과에 없었습니다!</p><p>어쩔 수 없이 카카오 지도로 물의 정원 위치를 확인하여 주소를 알아내었고, 이 주소를 카페인 검색창에 넣었습니다. 저희는 이 과정에서 카페인 서비스는 업체명 조회가 안된다는 것이 치명적인 단점이라고 생각했습니다. 다만, 이 기능은 검색 할 때마다 많은 비용이 청구되어 현실적으로 지금 당장 기능을 넣는 것은 어렵다고 판단했습니다.</p><p>결국 주소 검색을 통해 물의 정원과 가장 가까운 충전소를 알아내었습니다.</p><p>그런데! 지도를 축소해서 확인해 보니 해당 충전소는 물의 정원과 생각보다 멀었습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/near-water-cebfb5c4cd07a3c477e3106a1c7ccb7e.png" width="500" height="1082" class="img_ev3q"></p><p><img loading="lazy" alt="no offset" src="/assets/images/30-minutes-c85532af9807b46a836114f47d9370a8.png" width="500" height="1082" class="img_ev3q"></p><p>무려 걸어서 30분이나 걸리는 충전소였습니다!</p><p>전기차 충전을 위해 왕복 1시간이나 걸리는 거리를 걸을 수 없다고 생각하였습니다.</p><p>물론 지난 체험에서 전기차가 생각보다 배터리가 오래간다는 사실을 알고 있었지만, 만약 저희처럼 충전이 급한 사용자라면 목적지를 포기할 수 밖에 없겠구나 라는 생각이 들었습니다.</p><p>마지막으로 정한 목적지는, 의외의 결정이었습니다.</p><p>굉장히 발전된 첨단 도시로 알려진 판교였습니다!</p><p>사실은 앞으로 갈지도 모르는 판교를 미리 구경이나 해보자는게 이유였지만 비밀입니다(?)</p><p>일단 판교역은 IT서비스 회사들이 많이 몰려있는 곳이었습니다.</p><p>따라서 저희는 판교역을 카페인 검색창에 검색했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/pangyo-26dd2c251b15ce4e6c7830e01f2e80a5.png" width="370" height="630" class="img_ev3q"></p><p>지도를 판교역으로 이동하여 외부인 개방인 충전소를 찾았는데, 판교공영주차장이 보여서 해당 충전소를 목적지로 잡고 출발했습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="판교">판교<a href="#판교" class="hash-link" aria-label="판교에 대한 직접 링크" title="판교에 대한 직접 링크">​</a></h3><p>하남에서 판교를 가기 위해서는 서하남IC를 지나야했습니다.</p><p>가는 길에 우리 서비스에 나오는 정보와 실제 정보가 일치하는지 점검차 서하남 간이 휴게소를 들려봤습니다.</p><p>이 휴게소에도 충전소가 있다고 검색이 되었기 때문입니다!</p><p><img loading="lazy" alt="no offset" src="/assets/images/hanam_station-f703f3a6946ea1106e2a022e886577a9.png" width="500" height="667" class="img_ev3q"></p><p>검색 당시에는 2대의 충전기가 있다고 나왔고, 둘다 사용이 가능하다고 되어있었는데 실제로 확인해보니 일치하는 것을 확인했습니다.</p><p>먼 길을 달려 판교에 도착하였습니다.</p><p>주차장에 들어오기 전, 카페인 서비스를 확인해보니 판교공영주차장의 충전기 총 12기 중 10기가 사용가능한 상태였습니다.</p><p>정작 들어와서 보니 입구부터 너무 많은 전기차들이 충전기를 사용중이었습니다.</p><p>뭔가 이상하다 싶었지만, 아직 서버에 반영이 안된건가? 하면서 비어있는 충전기를 찾았습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/empty_station-051c14502d2c5ad67f2353c987e78397.png" width="500" height="667" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/charging-ffe0ad234bee030a3c530c6535014a1c.png" width="500" height="500" class="img_ev3q"></p><p>충전기를 꽂고 나서 알게된 것은 카페인 서비스에 나온 충전소 회사명과 방금 꽂은 충전기 회사명이 다르다는 것이었습니다.</p><p>알고보니 음성 인식으로 네비에 검색한 충전소는 판교공영주차장이 아닌 판교역 환승 주차장이라 엉뚱한 곳으로 온 것이었습니다!!!</p><p>다행인 점은 우리 서비스에서 제공하는 충전기 사용 여부 정보가 잘못된 것이 아니었다는 것이었습니다.</p><p>그래서 애초에 가고자 했던 판교공영주자창에 대한 카페인 서비스의 정보가 실제와 동일한지 확인해보러 걸어서 이동했습니다. (바로 앞에 있었기 때문입니다.)</p><p><img loading="lazy" alt="no offset" src="/assets/images/no-chargers-342cb105d18982d69b1571832f59cb3c.png" width="500" height="375" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/real-pangyo-fb5b6d1a87ed372fd36e6e0e352168ca.png" width="418" height="228" class="img_ev3q"></p><p>도착해보니 1층의 충전기들이 모두 공사중이었고, 서비스의 정보가 실제로도 불일치 하는 줄 알았습니다. 다시 상세 정보를 보니 3~6층에 충전기들에 대한 정보라는 것이 명시되어 있었고, 실제로도 이와 동일한 것을 확인했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/full-charged-5c139dee4a42c83edfb5a71b71220cda.png" width="500" height="375" class="img_ev3q"></p><p>저희는 시간이 너무 흘러 다시 잠실로 돌아와 차를 반납하고 체험을 마무리 했습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론">결론<a href="#결론" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="불편했던-점">불편했던 점<a href="#불편했던-점" class="hash-link" aria-label="불편했던 점에 대한 직접 링크" title="불편했던 점에 대한 직접 링크">​</a></h3><ul><li>디바이스에 보여지는 지도 영역 확장시에 원하는 정보를 볼 수 없는 것이 불편했다.<ul><li>지도를 확대해주세요 모달이 뜨고, 원래 있던 충전소 마커가 전부 사라진다.</li></ul></li><li>현재 나의 위치를 알아볼 수 있는 수단이 없어 불편했다.<ul><li>현위치를 나타내는 핀 (1차 체험기에서도 언급했던 부분)</li><li>내 위치를 상대적으로 알 수 있는 랜드마크의 부족</li></ul></li><li>특정 장소(매장명) 검색이 안돼서 카페인 서비스만으로 목적지를 찾아가기 불편했다.<ul><li>카카오맵 등을 활용해 특정 장소 검색을 진행해야 했다.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="다음-목표">다음 목표<a href="#다음-목표" class="hash-link" aria-label="다음 목표에 대한 직접 링크" title="다음 목표에 대한 직접 링크">​</a></h3><p>앞선 불편했던점을 개선하기 위해 다음과 같은 기능 개선을 추가로 진행할 예정입니다.</p><ul><li>디바이스에 보여지는 지도 영역 확장에 제한이 생기지 않게 충전소 마커 클러스터링을 우선적으로 도입한다.</li><li>현재 나의 위치를 알아볼 수 있도록 지하철 역과 같은 랜드마커를 지웠던 것을 롤백한다.</li></ul><p>카페인 서비스만으로 목적지를 찾아갈 수 있도록 하기 위해서 특정 장소 검색을 추가하고 싶지만, 해당 기능을 구현하기 위해선 검색당 비용이 많이 청구되는 장소 검색 API를 추가해야 했기에 현실적으로 지금 당장 구현하기 어렵다고 판단했습니다.</p><p>이상 카페인 사용기였습니다.</p>]]></content>
        <author>
            <name>가브리엘</name>
            <uri>https://github.com/gabrielyoon7</uri>
        </author>
        <author>
            <name>센트</name>
            <uri>https://github.com/kyw0716</uri>
        </author>
        <category label="카페인" term="카페인"/>
        <category label="서비스 경험" term="서비스 경험"/>
        <category label="피드백" term="피드백"/>
        <category label="전기차 사용기" term="전기차 사용기"/>
        <category label="전기차 충전소 앱" term="전기차 충전소 앱"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 서비스와 함께하는 전기차 여행 1]]></title>
        <id>https://car-ffeine.github.io/39</id>
        <link href="https://car-ffeine.github.io/39"/>
        <updated>2023-10-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[카페인 서비스를 개발하면서 가장 많이 받은 피드백 중 하나는 사용자 경험이 반드시 필요하다는 것이었습니다.]]></summary>
        <content type="html"><![CDATA[<p>카페인 서비스를 개발하면서 가장 많이 받은 피드백 중 하나는 <code>사용자 경험</code>이 반드시 필요하다는 것이었습니다.</p><p>아무래도 전기자동차를 보유한 팀원들이 아무도 없다보니 실제 사용자들이 겪는 어려움을 예상할 수 밖에 없었습니다.</p><p>따라서 전기 자동차 운전자들을 찾아내어 수차례 인터뷰를 진행하였는데 실제 차주들이 원하는 기능이 무엇인지, 어떤 어려움을 겪는지를 확인하여 이를 바탕으로 서비스를 개발하였습니다.</p><p>서비스를 처음 개발하였을 때 가장 많이 받았던 피드백은 앱 로드 속도가 너무 느리다는 것이었습니다.</p><p>서비스 초기에는 로딩 속도가 너무 느려서 사용자들에게 서비스 사용을 권장하기 미안한 상태였습니다.</p><p>따라서 실사용자를 모집하는 것 보다 <code>서비스 안정화에 집중하는 것</code>이 최우선이라는 목표 아래에 서비스를 개선하는 시간을 가졌고, 지금은 로딩 속도가 빠르다는 피드백을 받고 있습니다.</p><p>지난 한 달간 서비스 안정화에 집중을 했다면, 이제는 사용자 경험을 개선하는데 집중을 해야할 때가 왔습니다.</p><p>따라서 사용자 유치를 위해 전기차 동호회 카페, 카카오톡 오픈채팅, 자동차 커뮤니티 등을 돌면서 홍보를 진행하였습니다.</p><p>다행히도 불특정 다수의 익명 사용자들을 손쉽게 구할 수 있었습니다.</p><p>사용자들로부터 많은 피드백을 받았고, 해당 피드백을 저희 서비스에 최대한 반영하고자 노력했습니다.</p><p>하지만, 대부분의 사용자들이 저희 서비스에 단순히 방문하여 피드백을 준 것일 뿐 <code>실제로 사용하면서 피드백을 준 것 같지는 않다는 느낌</code>을 받았습니다.</p><p>사용자들이 앱에 머무른 시간을 GA4를 통해 확인 하였을 때 평균 3분 이상이라는 긴 시간을 머물러서 앱을 꼼꼼하게 사용했을 것이라고 기대는 하였으나, 사용 중에 피드백을 준다거나 사용 후에 피드백을 준 것이 맞는지 확신하기 어려웠습니다.</p><p>그렇다고 주변에서 전기차주들을 찾자니 문제가 발생하였습니다. 일단 전기자동차 보급률이 굉장히 낮았으며, 40~50대에 편중되어 있어 저희에게 협조해 줄 차주분들을 주변에서 찾기 어려웠습니다. (대부분 생업으로 인해 바쁘십니다 ㅠㅠ)</p><p>따라서 저희는 그냥 직접 서비스를 사용하면서 사용자 경험을 하기로 하였습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="카페인-서비스에서는요">카페인 서비스에서는요<a href="#카페인-서비스에서는요" class="hash-link" aria-label="카페인 서비스에서는요에 대한 직접 링크" title="카페인 서비스에서는요에 대한 직접 링크">​</a></h2><p>저희 서비스에서 지원하는 핵심 기능은 다음과 같았습니다.</p><ul><li>전국 충전소 조회<ul><li>지도 탐색을 통한 검색</li><li>검색창을 통한 검색</li></ul></li><li>충전소의 운영 정보 확인</li><li>충전소 별 충전기 상태 조회 (실시간)</li><li>충전소 및 충전기 고장 신고</li><li>충전소 별 충전기 사용량 통계 조회</li><li>충전소 별 리뷰 조회</li></ul><p>이외에도 많은 기능들이 있었지만, 위의 기능들이 사용자들이 가장 주력으로 사용할 것 같은 기능들이었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="계획을-세워보자">계획을 세워보자<a href="#계획을-세워보자" class="hash-link" aria-label="계획을 세워보자에 대한 직접 링크" title="계획을 세워보자에 대한 직접 링크">​</a></h2><p>전기자동차 렌트에 앞서 어디에 방문할 지 부터 정해야 했습니다.
저희는 몇 가지 원칙을 가지고 방문지를 정하기로 했습니다.</p><ol><li>잘 모르는 지역일 것</li><li>도착지에 충전소가 반드시 있을 것</li><li>타사 앱을 전혀 사용하지 말 것</li></ol><p>일단, 제가 처음 정했던 목표는 경상남도 진주시였습니다.
진주시에서 복귀해야하는 팀원이 있던 점, 방문해 본 적이 없는 도시인 점, 장거리라서 충전기 사용이 필연적인 점 등 여러 가지 이유로 진주시를 방문하기로 결정했습니다.</p><p>카페인 서비스를 킨 순간 눈앞이 캄캄해졌습니다.</p><p>"진주시가 어디에 있지?"</p><p><img loading="lazy" alt="no offset" src="/assets/images/search-jinju-30418d91d2c934c034a8dfad5c1491a4.png" width="392" height="225" class="img_ev3q"></p><p>다행히 진주시를 검색하니 주소 기반으로 검색이 되었습니다!
진주시를 검색한 것은 아니지만 간접적이라도 검색이 되는 것을 보고 안심했습니다.
아무 충전소를 눌러서 진주시로 이동하는 것은 가능했습니다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">여기에서 저는 이 과정에서 도시나 지역 검색 기능이 반드시 필요하다고 생각했습니다.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>하지만 너무 멀었습니다.
왕복 700km를 생각해야하여 1박 2일이 필수였고, 팀원들 간에 일정을 조정하기가 너무 어려웠습니다.
따라서 다른 도시를 찾아보기로 했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/gangnam-to-majang-road-9055db79283cf64185e1bb666184c5a8.png" width="341" height="569" class="img_ev3q"></p><p>그러던 중, 제가 전에 방문했던 파주시의 <code>마장호수</code>가 생각났습니다.
서울에서 꽤나 먼 거리(약 50km)에 있었고, 적당히 시간을 보낼만한 장소였습니다.
다행히도 충전소의 이름이 <code>마장호수관리사무소</code>여서 카페인 서비스를 통해 바로 찾을 수 있었습니다.
심지어 마장호수 주변에는 충전소가 많지 않은 편이었고, 초급속 충전기가 있어 저희 앱을 실험하기에 딱 좋았습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="마장호수로-출발">마장호수로 출발<a href="#마장호수로-출발" class="hash-link" aria-label="마장호수로 출발에 대한 직접 링크" title="마장호수로 출발에 대한 직접 링크">​</a></h2><p>저 <code>가브리엘</code>과 <code>제이</code>, <code>박스터</code>는 서울 선정릉역에서 아이오닉5를 렌트하고 마장호수로 출발했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/go-to-majang-1-d01eda49c17c24d9a4108abd1b9ca392.png" width="800" height="1067" class="img_ev3q"></p><p>처음 계획했던 것 처럼 타사의 앱을 사용하지 않고 마장호수를 검색하여 이동했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/go-to-majang-2-d26dcd9609e6c5d7650cecacec8cb707.png" width="800" height="1067" class="img_ev3q"></p><p>전날 이미 검색을 했지만, 혹시 사용 중일수도 있기에 한번 더 검색해봤으며 해당 시간대에 충전소가 평소에 덜 붐빌 것이라는 통계 자료를 확인했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/go-to-majang-3-5f31a82af43e3759bee8b42264621f06.png" width="800" height="1067" class="img_ev3q"></p><p><img loading="lazy" alt="no offset" src="/assets/images/go-to-majang-4-0d49e7bf47c388bf28c49e20466d8e84.png" width="396" height="602" class="img_ev3q"></p><p><img loading="lazy" alt="no offset" src="/assets/images/go-to-majang-5-755f10355fba4cc47e5e03111b288f9a.png" width="800" height="1067" class="img_ev3q"></p><p>마장 호수까지 20분 거리를 남기고, 갑자기 배가 고파진 저희는 목적지를 틀어 <code>파주닭국수 본점</code>을 가기로 했습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="파주닭국수가-어디에-있지">파주닭국수가 어디에 있지?<a href="#파주닭국수가-어디에-있지" class="hash-link" aria-label="파주닭국수가 어디에 있지?에 대한 직접 링크" title="파주닭국수가 어디에 있지?에 대한 직접 링크">​</a></h2><p>카페인 서비스를 활용하여 파주닭국수 본점 근처의 충전소를 검색해보기로 했습니다.
자동차 내비게이션에는 파주닭국수가 어디인지 나와있지만, 저희 서비스에는 식당 정보는 존재하지 않았습니다.
해당 식당이 도대체 어디에 있는지 확인할 수 없었습니다. (파주닭국수에서는 전기차 충전소가 없었기 떄문입니다.)</p><p><img loading="lazy" alt="no offset" src="/assets/images/songchoo-to-noodle-1-89b97c2f9b2cf318352dd5278d187af7.png" width="1170" height="2532" class="img_ev3q"></p><p>따라서 저희는 자동차 내비게이션에 있는 도로명 주소를 검색하여 위치를 파악하려고 하였고, 다소 부정확 하지만 동네에 있는 인근 충전소를 찾을 수 있었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="휴게소에-들리다">휴게소에 들리다<a href="#휴게소에-들리다" class="hash-link" aria-label="휴게소에 들리다에 대한 직접 링크" title="휴게소에 들리다에 대한 직접 링크">​</a></h2><p>카페인 서비스로 검색해보니 식당으로 가는 길 휴게소에도 충전소가 있다고 합니다.
휴게소 이름을 입력하니 바로 나왔습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/yangju-station-3-39fe8f49c8e070e331af945bdfcd1ea4.png" width="424" height="342" class="img_ev3q"></p><p>심지어 지금 사용중이라고 합니다! 따라서 저희는 확인해보기 위해 휴게소에 들리기로 했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/yangju-station-1-fd7b0cbd8d8cc09963819dccffa041e1.png" width="589" height="541" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/yangju-station-2-150186569bc1aadb7fef52a92eb08990.png" width="800" height="1067" class="img_ev3q"></p><p>실제로 사용 중임을 확인했습니다. 저희 서비스에서 사용중이라고 나왔는데 실제로 사용중인 것을 보니 공공 api가 나름 실시간으로 데이터를 잘 보내주고 있다고 생각하게 되었고, 저희 팀 서버에서도 이를 제대로 수집하고 있다고 생각하였습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/yangju-station-5-9fa68b52371626e811855721537b3903.png" width="800" height="1067" class="img_ev3q"></p><p>말로만 듣던 고속도로 휴게소의 전기차 충전소 대기줄을 직접 확인할 수 있었습니다.
차주 분과 인터뷰 하고 싶었지만, 차 내부에서 너무 바빠보이셔서 그럴 수 없었습니다.</p><p>전기차 충전을 기다리면서 무엇을 할 수 있을까요?
이 분은 다행히도 업무를 보고 계셨지만, 다른 차주들은 무엇을 하고 보낼지 궁금해졌습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/yangju-station-4-4a9c407456f17146e4a73982588534fe.png" width="391" height="330" class="img_ev3q"></p><p>휴게소에는 충전소가 하나 더 있었습니다.</p><p>한 곳은 사용중이지만, 다른 한 곳은 사용할 수 있었습니다.</p><p>저희는 이 충전소를 사용해보기로 했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/yangju-station-6-eedf609663774abec3b7d49bcfb08433.png" width="488" height="453" class="img_ev3q"></p><p>사용할 수 있으니깐 들어가봐야지! 하고 도착한 순간 아차 싶었습니다.</p><p>"아, 충전소가 외부인 사용 금지일 수 있었지?"</p><p>저희는 분명히 서비스를 직접 개발했으니깐 다 알고 있던 사항이었지만, 전혀 생각치 못했습니다.</p><p>서비스를 개발하는 내내 외부인 개방 충전소에 대한 중요성을 간파하였고, 이 기능을 넣었으면서도 사용하지 않고 충전소를 방문한 것이었습니다.</p><p>바로 앞에 있어서 다행이었지만, 어찌됐든 이 충전소를 사용할 수 없었습니다.</p><p>따라서 저희는 휴게소를 떠나는 내내 이 문제에 대해서 토론을 할 수 밖에 없었습니다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">분명 우리가 만든 서비스인데 왜 놓쳤을까?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="맛있는-점심">맛있는 점심<a href="#맛있는-점심" class="hash-link" aria-label="맛있는 점심에 대한 직접 링크" title="맛있는 점심에 대한 직접 링크">​</a></h2><p><img loading="lazy" alt="no offset" src="/assets/images/noodle-1-7d8319e2dfdd497702beee7434ff11df.png" width="800" height="1067" class="img_ev3q"></p><p>파주닭국수 본점에서 맛있는 식사를 했습니다.</p><p>비록 식당에는 전기차 충전소가 없었지만, 인근에 충전소가 있어 실험을 하나 해볼 수 있었습니다.</p><p>인근 충전소와 식당의 거리가 가까워 보이는데, 과연 걸어갈 수 있을까?</p><p>실제로 걷지는 않았습니다만 차 타면서 지나가면서 확인해본 결과 직접 걸을 수 없는 거리였습니다. (굉장히 걷기 싫은 수준의 먼 거리였습니다.)</p><p>집에 있는 PHEV를 탈 기회가 많아 전기차 충전소를 자주 방문했던 저는 이런 점을 잘 알고 있었습니다.</p><p>다행히 이 부분을 잘 알고 있었기에 저희는 이 부분을 서비스에 반영하였고, 모든 데이터를 포기하지 않았던 것이 옳은 선택이었다는 것을 확인하게 되었습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/noodle-2-aeba7c70a95630c849043966a129c484.png" width="800" height="1067" class="img_ev3q"></p><p>식사가 끝나고 드디어 마장호수로 출발하게 되었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="마장호수-도착">마장호수 도착<a href="#마장호수-도착" class="hash-link" aria-label="마장호수 도착에 대한 직접 링크" title="마장호수 도착에 대한 직접 링크">​</a></h2><p>마장호수에 도착하자마자 충전소에 방문했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/majang-1-f0c17e4a4eebf85e398e564dc9133da4.png" width="800" height="1067" class="img_ev3q"></p><p>통계에서는 사용률이 적을 것이라고 하였는데 저희만 있었습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/majang-2-21741606310bd7fbcca71b0742ff9f7b.png" width="800" height="1067" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/majang-4-716cd1f6863af654877496c90e3ddcce.png" width="800" height="1067" class="img_ev3q"></p><p>2기 중 1곳을 저희가 사용하였고, 마장호수를 돌았습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/majang-3-2c0739d4032a7969c0e817140d145d17.png" width="800" height="800" class="img_ev3q"></p><p>약 50분 간 산책을 하고, 돌아와보니 충전기 다 되어있었습니다.</p><p>사실 마장호수 까지 오는 내내 든 생각이었지만, 전기차의 배터리가 생각보다 오래 간다는 생각이 들었습니다.</p><p>일부러 회생제동 기능도 끄고, 에어컨을 강하게 틀어서 배터리를 소진하려고 하였으나, 85km를 주행하는 동안 겨우 20%를 소모하였습니다.</p><p>충전기를 꽂을 때 50%였으나, 호수를 한바퀴 돌고 오니 이미 100%가 되어있었습니다.</p><p>여담이지만, 저희가 돌아왔을 때 옆 자리에는 전기 화물차가 있어 충전소가 가득 찼습니다.</p><p>또, 앱에서도 충전기 사용 여부가 업데이트 되는 것을 확인했습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/majang-5-3dcf405d7cfb3117c26578730869a61f.png" width="800" height="1067" class="img_ev3q"></p><p>배터리 성능에는 좋지 않고 가격도 비싸서 이를 자주 사용하는 것은 좋지 않겠지만, 급한 사람들은 급속 충전기를 사용하면 되겠구나 싶었습니다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">따라서 급속과 완속은 더더욱 다른 개념으로 봐야겠다는 생각이 들었습니다.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>제가 그동안 경험했던 전기차 충전소는 완속 기준이었기에 신선한 경험이었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="선릉으로-돌아오다">선릉으로 돌아오다<a href="#선릉으로-돌아오다" class="hash-link" aria-label="선릉으로 돌아오다에 대한 직접 링크" title="선릉으로 돌아오다에 대한 직접 링크">​</a></h2><p><img loading="lazy" alt="no offset" src="/assets/images/end-3f2a026de77a0a0b117023d6fb3d3f66.png" width="800" height="524" class="img_ev3q"></p><p>선릉으로 돌아와서 차량을 반납하였습니다.</p><p>저희는 이번 여정을 통해 카페인 서비스에서 어떤 점을 개선해야할지 좀 더 명확하게 알게되었습니다.</p><ol><li>현재 서비스에서 제공하는 기능들로 충전소를 검색하는 것은 가능하며, 충전소의 위치를 정확하게 파악하는 것도 가능하다.</li><li>하지만 충전소가 없는 목적지는 검색할 수 없고, 현 위치가 어디인지 가늠하기가 어려워진다.</li><li>충전소를 사용할 수 있다고 표기되어 있더라도 외부인 개방이 아닐 수 있다. 정보가 정확히 제공됨에도 불구하고 이를 단번에 눈치채기 어렵다.</li><li>이러한 문제를 예상하여 <code>외부인 개방 여부</code>를 필터링 할 수 있는 기능을 제공하고 있음에도 불구하고 사용하지 않았다.</li><li>충전소의 통계 자료의 적중률은 높았으나, 좀 더 많은 충전소를 들려 확인해봐야 할 것 같았다.</li><li>전기자동차는 생각보다 오래가고 상품성이 있었다. 주행 능력도 충분하고, 인프라가 잘 되어있다. 이걸 왜 욕하지? 라는 생각이 들었다.</li><li>지도 확대 허용 범위가 너무 좁아서 사용하는데 불편한건 실제 상황에서 더 불편했다.</li></ol><p>이상 카페인 사용기였습니다.</p>]]></content>
        <author>
            <name>가브리엘</name>
            <uri>https://github.com/gabrielyoon7</uri>
        </author>
        <category label="카페인" term="카페인"/>
        <category label="서비스 경험" term="서비스 경험"/>
        <category label="피드백" term="피드백"/>
        <category label="전기차 사용기" term="전기차 사용기"/>
        <category label="전기차 충전소 앱" term="전기차 충전소 앱"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[충전소 조회 api 분리]]></title>
        <id>https://car-ffeine.github.io/37</id>
        <link href="https://car-ffeine.github.io/37"/>
        <updated>2023-09-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[성능 개선을 위해 충전소 조회 API의 설계를 변경하였습니다.]]></summary>
        <content type="html"><![CDATA[<p>성능 개선을 위해 충전소 조회 API의 설계를 변경하였습니다.
기존에는 충전소 간단 정보와 마커 정보를 한 번에 받아오도록 설계되어 있었지만,
백엔드와 프론트엔드가 협업하여 간단 정보와 마커 정보를 각각 필요한 만큼만 조회하도록 명세를 수정하였습니다.</p><p>이 과정에서 먼저, 백엔드와 프론트엔드는 함께 모여 기능 요구사항과 성능 개선 목표를 논의하였습니다.
그리고 충전소 간단 정보와 마커 정보를 각각 조회하는 API 엔드포인트를 새로 설계하였습니다.</p><p>다음으로, 백엔드에서 간단 정보 조회를 위한 API를 구현하였습니다.
필요한 필드만을 조회하여 데이터베이스의 부하를 줄이고 응답 시간을 개선하였습니다.
이후에는 프론트엔드에서 해당 API를 호출하여 필요한 정보를 받아오도록 수정하였습니다.</p><p>마지막으로, 마커 정보 조회를 위한 API를 구현하였습니다.
마커 정보는 지도에 표시되는 정보로서, 요청한 영역 외부로 지도가 이동할 경우 호출되도록 설계되었습니다.
기존에는 간단 정보 리스트를 보여주기 위해 조회하던 정보들이 다수 포함되어 있었지만,
이 정보를 제외하고 마커를 띄우기 위해 필요한 최소한의 정보를 조회하도록 수정해 서버의 부하를 낮췄습니다.</p><p>이러한 변경으로 인해 충전소 조회 API의 성능이 개선되었습니다.
필요한 정보만을 조회하므로써 데이터베이스의 부하를 줄이고 응답 시간을 단축할 수 있게 되었습니다.
또한, 프론트엔드에서는 필요한 정보만을 호출하여 불필요한 데이터를 받아오지 않아도 되므로 클라이언트 측의 성능도 향상되었습니다.</p>]]></content>
        <author>
            <name>센트</name>
            <uri>https://github.com/kyw0716</uri>
        </author>
        <category label="협업" term="협업"/>
        <category label="서버 부하 줄이기" term="서버 부하 줄이기"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 서비스 방문자 분석]]></title>
        <id>https://car-ffeine.github.io/38</id>
        <link href="https://car-ffeine.github.io/38"/>
        <updated>2023-09-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[저희 팀은 단순 방문자 100명을 모아야하는 미션을 받았습니다.]]></summary>
        <content type="html"><![CDATA[<p>저희 팀은 단순 방문자 100명을 모아야하는 미션을 받았습니다.</p><p>목표 달성을 위해 약 2주 전에 실행 계획을 제출해야 했는데요</p><p>100명을 모집하기 위해 다음과 같은 계획을 세웠습니다.</p><hr><p><img loading="lazy" alt="no offset" src="/assets/images/plan-3fc93ba26b35c030eb65ab12693c3e9d.png" width="547" height="588" class="img_ev3q"></p><hr><p>이 당시 저희 팀의 가장 큰 고민은, 전기차가 여전히 소수의 운전자에게만 보급되었다는 점이었습니다.</p><p>특히, 전기차 보급 관련 통계 자료를 찾아보면 대부분의 차주들은 40~60대에 압도적으로 몰려있어 젊은 연령 층에서는 거의 구매를 하지 않고 있다는 사실을 알 수 있습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/statistics-21b36978d73755cecb3467f4e1073606.png" width="550" height="560" class="img_ev3q"></p><p>위 자료는 2021년 7월 기준이지만, 최신 자료에서도 마찬가지로 젊은 연령층에서는 전기차를 보유한 사람을 찾기 어렵다고 나옵니다. 실제로 주변 또래의 운전자를 찾아보면 대부분 가솔린 모델을 타고 다니고 있습니다.</p><p>따라서 저희는 홍보 대상을 주변에서 찾지 않고 불특정 다수의 사람들을 모집하기 위해 다음과 같은 방법을 사용하기로 했습니다.</p><h1>홍보 방법</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="카페">카페<a href="#카페" class="hash-link" aria-label="카페에 대한 직접 링크" title="카페에 대한 직접 링크">​</a></h2><p><img loading="lazy" alt="no offset" src="/assets/images/insta1-8dda3e9901b103049de37f31b92bcef9.png" width="405" height="720" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/naver1-74e1ea2ae9d209519a6e0e4bbfbfd118.png" width="341" height="720" class="img_ev3q"></p><p>네이버에 있는 전기자동차 동호회 카페 중 가장 큰 곳에 글을 올려 방문자를 모집하기로 했습니다.</p><p>카페에 글을 올리는 것은 무료이며, 카페에 가입한 사람들은 전기차에 관심이 있는 사람들이기 때문에 저희가 원하는 방문자를 모집하기에 적합하다고 생각했습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="카카오톡-오픈채팅">카카오톡 오픈채팅<a href="#카카오톡-오픈채팅" class="hash-link" aria-label="카카오톡 오픈채팅에 대한 직접 링크" title="카카오톡 오픈채팅에 대한 직접 링크">​</a></h2><p><img loading="lazy" alt="no offset" src="/assets/images/kakao1-db8e1f74b21fb57c445953a725655757.png" width="318" height="720" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/kakao2-64098d5aea7cc23291aa52968c7615ac.png" width="492" height="1022" class="img_ev3q"></p><p>카카오톡 오픈채팅에는 수많은 대화방이 존재합니다.</p><p>특정 주제로 만들어진 대화방이 대부분이기에 전기차를 주제로 한 오픈채팅 대화방을 찾는 것은 전혀 어렵지 않았습니다.</p><p>안타깝게도 일부 단톡방에서 강퇴를 당했지만, 차주들과 채팅하면서 피드백을 받아볼 수 있었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="기타-홍보-수단">기타 홍보 수단<a href="#기타-홍보-수단" class="hash-link" aria-label="기타 홍보 수단에 대한 직접 링크" title="기타 홍보 수단에 대한 직접 링크">​</a></h2><p>기타 홍보 수단은 아직 사용하지 않았습니다.</p><p>네이버 밴드, 보배드림은 사용하는 크루가 없어서 홍보를 하기 어려웠고, 구글 애드센스와 같은 도구는 비용이 발생하기에 아직은 이르다고 판단했습니다.</p><h1>Google Analytics 4 통계 집계 결과</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="단순-방문자">단순 방문자<a href="#단순-방문자" class="hash-link" aria-label="단순 방문자에 대한 직접 링크" title="단순 방문자에 대한 직접 링크">​</a></h2><p><img loading="lazy" alt="no offset" src="/assets/images/ga1-ded341d6d5a299c796b47c59a877face.png" width="643" height="417" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/ga2-6bd5526f4979c6e138f62655ec40bc35.png" width="1303" height="657" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/ga3-8b208e34fa7b0373c66ae2bfd3846d1d.png" width="504" height="249" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/ga4-f86fa316bd8bf5445f9c975c5f45bc3e.png" width="1241" height="515" class="img_ev3q">
이처럼 외부 지역에서도 많이 접속해주신 것을 확인할 수 있습니다.
<img loading="lazy" alt="no offset" src="/assets/images/ga5-5df11e590562d95b0fa649bd3387368c.png" width="988" height="411" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/ga6-561fc65ecd81a5b722e153f8d88fb28a.png" width="1286" height="870" class="img_ev3q">
<img loading="lazy" alt="no offset" src="/assets/images/ga7-95e3adb914559e5d38a6f85cb912af33.png" width="1263" height="891" class="img_ev3q"></p><p>집계 된 자료처럼 방문자들이 단순 방문만 한 것이 아니라, 수 많은 이벤트를 발생시키고 평균 참여 시간도 상당 부분 확보했음을 확인할 수 있습니다.</p>]]></content>
        <author>
            <name>가브리엘</name>
            <uri>https://github.com/gabrielyoon7</uri>
        </author>
        <category label="ga4" term="ga4"/>
        <category label="google analytics 4" term="google analytics 4"/>
        <category label="카페인" term="카페인"/>
        <category label="방문자 분석" term="방문자 분석"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[마커 렌더링 최적화]]></title>
        <id>https://car-ffeine.github.io/36</id>
        <link href="https://car-ffeine.github.io/36"/>
        <updated>2023-09-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[1. 개요]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-개요">1. 개요<a href="#1-개요" class="hash-link" aria-label="1. 개요에 대한 직접 링크" title="1. 개요에 대한 직접 링크">​</a></h3><p>기존의 구조에서는 마커 하나를 렌더링하기 위해 다음과 같은 과정을 거쳤다.</p><ol><li>StationMarkersContainer 컴포넌트에서 충전소 정보 요청</li><li>충전소 정보를 props로 넘겨 Marker 컴포넌트 호출</li><li>지도에 부착될 DOM요소 생성</li><li>createRoot를 통해 리액트 root 생성</li><li>2번에서 생성한 DOM 요소를 전달해 구글 지도 api의 Marker 생성자 함수 호출</li><li>3번에서 생성했던 root의 render 메서드 호출</li><li>마커 인스턴스 전역 상태에 새로 생성한 마커 추가</li></ol><p>위 과정을 거쳤을 때의 마커 렌더링 모습을 보면 다음과 같다.</p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/28520ee3-2fa6-4110-b4e4-8a0bb706324e" alt="before" class="img_ev3q"></p><p>마커들이 한번에 렌더링 되는 것이 아니라 산발적으로 렌더링 되는 모습을 확인할 수 있다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-문제-원인-분석">2. 문제 원인 분석<a href="#2-문제-원인-분석" class="hash-link" aria-label="2. 문제 원인 분석에 대한 직접 링크" title="2. 문제 원인 분석에 대한 직접 링크">​</a></h3><p>마커를 렌더링 하기 위해 거치는 과정을 분석해 보았다.</p><p>1 ~ 3 과정에서는 성능에 크게 영향을 끼칠 요소가 없지만 4번 과정은 일반적인 리액트 프로젝트를 개발할 때 겪는 과정이 아니다. 따라서 createRoot를 통해 많은 개수의 루트를 생성했을 때의 영향에 대해 알아보았다.</p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/494a5bc5-be5d-4a58-b5b2-77ce7d3e5de7" alt="image" class="img_ev3q"></p><p>리액트 공식 문서를 보니 페이지의 일부에 리액트를 뿌려서 사용하는 경우에는 루트를 필요한 만큼 생성해도 된다는 이야기가 포함되어 있었다. 따라서 4번 과정 또한 문제의 원인이라고 볼 수 없었다.</p><p>5번 과정은 구글 지도에 마커를 특정 위도 경도에 위치시키기 위해서 어쩔 수 없이 거쳐야 하는 과정이므로 이 과정은 문제가 있더라도 개선이 불가능해 일단 고려하지 않았다.</p><p>6번 과정은 4번 과정에서 생성했던 리액트 루트의 render 메서드를 호출해 실제로 화면에 리액트 컴포넌트를 그리도록 하는 과정이다. 이 과정 또한 리액트 컴포넌트를 화면에 렌더링하기 위해선 어쩔 수 없이 거쳐야 하는 과정이므로 고려하지 않았다.</p><blockquote><p>하지만 6번 과정에서 리액트 컴포넌트를 직접 그리는 것이 아니라 구글 지도 api의 기본 마커를 사용하면 성능을 향상시킬 수 있지 않냐고 반문할 수도 있을 것이다. 이전에는 이러한 방식을 사용해 마커를 렌더링 했었다. 우리의 서비스는 현재 사용 가능한 충전소 개수를 마커를 통해서도 전달하기 때문에 이를 고려해 기본 마커를 사용할 때 다음의 두 가지 문제가 생긴다.</p><ol><li>사용 가능한 충전소 개수를 기본 마커에 렌더링 할 때 성능이 매우 좋지 않다.</li><li>마커의 디자인을 바꾸고자 할 때 변경에 대응하기 어렵다.</li></ol><p>따라서 마커는 리액트 루트의 render 메서드를 호출해 리액트 컴포넌트를 렌더링하는 것으로 결정했다.</p></blockquote><p>마지막으로 남은 7번 과정에서는 useSyncExternalState 훅을 사용해 전역적으로 관리하고 있던 상태에 수정을 가하는 연산을 수행한다. 이 과정은 이전에도 성능 저하를 유발할 것으로 예상되던 부분이었다. (하단 링크 참고)</p><p><a href="https://www.notion.so/useSyncExternalStore-state-67e686eead8b4750b3015a1f75ea3e76?pvs=21" target="_blank" rel="noopener noreferrer">useSyncExternalStore 훅을 통해 구독한 state가 한번에 업데이트 되는 이유</a></p><p>요청의 결과로 받아온 마커 정보의 개수가 100개라고 가정해보자. 우리는 이제 마커를 렌더링 할 것이다. 첫 번째 마커의 렌더링을 위해 1번 ~ 6번의 과정을 거친 후 7번 과정을 수행한다. 그러면 리액트 입장에서는 리액트 루트의 render 메서드 호출에 대한 동작을 수행해야 하고, 새로운 마커 인스턴스에 대한 전역 상태를 변경시키는 동작을 수행해야 한다. 리액트가 이 과정을 100번 반복하고 나면 우리는 비로소 모든 마커가 화면에 렌더링 된 모습을 볼 수 있을 것이다.</p><p>나는 이 부분에서 성능 저하의 요소가 있다고 생각했다. 리액트에서의 상태 변화는 곧 리액트 내부의 렌더링을 위한 로직이 수행되게 함을 의미하고, 이 과정을 개선 이전에는 마커의 개수만큼 반복하고 있었던 것이다. 여기까지 생각해보니 전역 상태 변화에 대해 리액트가 렌더링을 위한 연산을 진행할 동안에는 마커의 렌더링(render 메서드 호출)이 멈추는 것이 아닐까 하는 생각이 들었다.</p><p>그래서 크롬 개발자 도구의 퍼포먼스 탭을 들어가 보니 산발적으로 발생하던 마커 렌더링의 문제 원인이 짐작했던 그 원인임을 확인할 수 있었다.</p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/20926d19-79a5-4d49-b733-de1c2b87059c" alt="image" class="img_ev3q"></p><p>프레임 이미지 하단을 보면 산발적인 마커 렌더링이 수행될 때마다 수반되는 어떤 함수 호출이 있음을 확인할 수 있다.</p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/20b8f1e4-eceb-4e18-82f0-8ef6cc5ee8a1" alt="image" class="img_ev3q"></p><p>이 부분이 문제의 함수 호출 부분이다. 자세히 살펴보면 상단에 <code>performWorkUntilDeadline</code>이란 함수가 호출됨을 볼 수 있다.</p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/d7a91ce6-4907-4c79-948b-d80a205a0697" alt="image" class="img_ev3q"></p><p>이 <code>performWorkUntilDeadline</code> 라는 함수를 조금 알아보니 해당 함수는 간단히 말해 리액트에서 state의 변경이 한번에 많이 발생할 때 5ms의 데드라인 시간을 줄 때 사용하는 함수라는 것을 알게 되었다. 문제의 원인이라고 생각했던 마커 개수 만큼의 전역 상태 변화가 실제로 마커 렌더링을 잠시 중단하게 만들고 있음을 알게 되었다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-문제-해결">3. 문제 해결<a href="#3-문제-해결" class="hash-link" aria-label="3. 문제 해결에 대한 직접 링크" title="3. 문제 해결에 대한 직접 링크">​</a></h3><p>앞서 분석한 문제를 개선해보고자 마커 렌더링에 필요한 충전소 정보 배열을 부모 컴포넌트에서 받아와 각 충전소 정보를 자식 컴포넌트에 넘겨주고, 자식 컴포넌트에서 마커 생성과 렌더링 로직을 수행하던 기존의 방식을 부수고 부모 컴포넌트에서 모든 것을 일괄 처리하는 방식으로 고쳐보았다.</p><p>고치는 과정에서 기존 방식에서는 리액트 생명 주기에 의존하여 화면에 보여지지 않는 마커를 지워주던 로직을 이제는 모두 직접 구현해야 했다.</p><p>이전의 영역과 겹치는 부분에 있는 충전소는 다시 그리지 않고, 영역 밖의 충전소를 나타내는 마커는 지워주고, 이전의 영역과 겹치지 않는 새로 받아온 충전소는 그리도록 다음과 같이 메서드를 분리해보았다.</p><ul><li>기존과 겹치지 않는 새로운 영역에 대한 마커를 생성하는 메서드</li><li>기존과 겹쳐지는 영역에 대한 마커들을 반환하는 메서드</li><li>새로운 영역 밖에 있는 마커들을 지워주는 메서드</li><li>새롭게 생성된 마커를 화면에 렌더링하는 메서드</li></ul><p>이 메서드들을 커스텀 훅으로 분리해 부모 컴포넌트에서 이를 활용하도록 하여 다소 복잡할 수 있는 마커 렌더링 로직을 선언적으로 구현할 수 있도록 했다.</p><p>결과적으로 기존에 사용되던 기능들을 그대로 사용할 수 있으면서 화면에 마커가 산발적으로 렌더링 되던 문제가 해결 되었고, 부가적인 효과로 전체 마커의 렌더링 시점도 앞당길 수 있게 되었다. + 기존에는 구조적인 문제로 연산량이 너무 많아 클러스터링이 늦어져 이를 도입할 수 없었던 문제를 구조 수정으로 인해 적용할 수 있게 되었다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="작업한-pr">작업한 PR<a href="#작업한-pr" class="hash-link" aria-label="작업한 PR에 대한 직접 링크" title="작업한 PR에 대한 직접 링크">​</a></h3><p><a href="https://github.com/woowacourse-teams/2023-car-ffeine/pull/737" target="_blank" rel="noopener noreferrer">https://github.com/woowacourse-teams/2023-car-ffeine/pull/737</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결과-분석-performance-탭-활용">결과 분석 (performance 탭 활용)<a href="#결과-분석-performance-탭-활용" class="hash-link" aria-label="결과 분석 (performance 탭 활용)에 대한 직접 링크" title="결과 분석 (performance 탭 활용)에 대한 직접 링크">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="before">before<a href="#before" class="hash-link" aria-label="before에 대한 직접 링크" title="before에 대한 직접 링크">​</a></h3><p>마커 조회 요청이 종료된 시점: 약 <code>2499ms</code></p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/033e8519-a1aa-43a4-959d-afeba93c1917" alt="image" class="img_ev3q"></p><p>첫 마커 렌더링 시점: <code>3093ms</code></p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/b4fc47ca-4ef3-43f4-a9a5-7117edabc225" alt="image" class="img_ev3q"></p><p>모든 마커 렌더링 종료 시점: 약 <code>3611ms</code></p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/2b8a4c4c-218b-419a-8a47-e3b768d35bc2" alt="image" class="img_ev3q"></p><p>처음으로 마커가 렌더링 될 때까지 소요된 시간: <code>594ms</code></p><p>모든 마커 렌더링에 소요된 시간: <code>1112ms</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="after">after<a href="#after" class="hash-link" aria-label="after에 대한 직접 링크" title="after에 대한 직접 링크">​</a></h3><p>마커 조회 요청의 시작점: 약 <code>1875ms</code></p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/b7b8ff0c-2314-4e3f-a9f4-72c445636283" alt="image" class="img_ev3q"></p><p>모든 마커 렌더링 종료 시점: <code>2395ms</code></p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/d75c323e-5c04-42a2-ad3e-1d13ea52216e" alt="image" class="img_ev3q"></p><p>처음으로 마커가 렌더링 될 때까지 소요된 시간: <code>519ms</code></p><p>모든 마커 렌더링에 소요된 시간: <code>519ms</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="개선-결과">개선 결과<a href="#개선-결과" class="hash-link" aria-label="개선 결과에 대한 직접 링크" title="개선 결과에 대한 직접 링크">​</a></h3><p>처음으로 마커가 렌더링 되는 시점은 두 방식 모두 비슷한 결과를 보인다. 하지만 개선 후 방식은 한번에 모든 마커가 렌더링 되는 방식이고, 개선 이전의 방식은 산발적으로 마커가 렌더링 되는 방식이므로 개선 후의 방식에서 전체 마커를 렌더링 하는 시점이 훨씬 빨라지게 되었다.</p><p>결과적으로 전체 마커가 렌더링 되는 속도 약 <code>55.6%</code> 단축하게 되었다. 이 결과는 마커가 늘어날 수록 더욱 차이가 극적으로 벌어질 것으로 예상된다.</p><p>before</p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/28520ee3-2fa6-4110-b4e4-8a0bb706324e" alt="before" class="img_ev3q"></p><p>after</p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/77326660/1b1521c6-d220-4140-bbe9-fff40051c6a2" alt="after" class="img_ev3q"></p>]]></content>
        <author>
            <name>센트</name>
            <uri>https://github.com/kyw0716</uri>
        </author>
        <category label="react" term="react"/>
        <category label="useSyncExternalState" term="useSyncExternalState"/>
        <category label="googleMap" term="googleMap"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Scale-out 시 Scheduling 중복 실행 막기]]></title>
        <id>https://car-ffeine.github.io/35</id>
        <link href="https://car-ffeine.github.io/35"/>
        <updated>2023-09-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 박스터입니다]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 박스터입니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="이-글을-쓰는-이유">이 글을 쓰는 이유<a href="#이-글을-쓰는-이유" class="hash-link" aria-label="이 글을 쓰는 이유에 대한 직접 링크" title="이 글을 쓰는 이유에 대한 직접 링크">​</a></h2><p>저희 서비스에서는 주기적으로 충전기의 상태와 정보를 업데이트하거나, 통계를 저장하는 스케줄링 작업이 있습니다.
지금의 저희 서버는 단일 서버로 구성되어있어 문제가 없지만, 만약 <strong>서버를 scale-out</strong> 하게 된다면 어떻게 될까요?</p><p><strong>똑같은 schedule이 중복</strong>되어 실행될 것입니다. 그렇다고 어떤 서버는 schedule을 동작하지 않도록 하고, 어떤 서버는 schedule을 동작하도록 한다면 스케줄이 동작하는 서버가 다운된다면 동작하는
서버의 다운타임만큼 저희 서버의 데이터를 최신화할 수 없고, 최신화가 중요한 저희 서비스에서는 사용자의 불만을 초래할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="구현해보기">구현해보기<a href="#구현해보기" class="hash-link" aria-label="구현해보기에 대한 직접 링크" title="구현해보기에 대한 직접 링크">​</a></h2><p>Schedule 정보를 어떻게 다른 환경에서 같이 공유하여 관리할 수 있을까요?
간단히 생각하면 Local 환경이 아닌, Global 환경에서 정보를 관리하면 될 것 같습니다.</p><p>따라서 Schedule의 정보를 저장할 수 있는 테이블을 아래의 Entity 의 필드와 같이 생성해보겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Entity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ScheduleTask</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">BaseEntity</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation punctuation" style="color:#393A34">@Id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> jobName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation punctuation" style="color:#393A34">@Enumerated</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">EnumType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STRING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">JobStatus</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>먼저 id는 해당 스케줄을 구분할 수 있는 id여야 할 것입니다. 가장 쉽게 정할 수 있는 id는 스케줄의 <strong>job 이름</strong>과,
Schedule으로 등록한 <strong>시간</strong>을 조합하여 생성한다면 unique하고 분산 환경에서도 쉽게 구분할 수 있는 id가 될 것 입니다.</p><p>그리고 아래와 같은 Business Logic 있다고 가정하겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">BusinessLogic</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ApplicationEventPublisher</span><span class="token plain"> applicationEventPublisher</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation punctuation" style="color:#393A34">@Scheduled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cron </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0/2 * * * * *"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">complexJob</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"복잡한 Job 시작"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation punctuation" style="color:#393A34">@Scheduled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cron </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0/4 * * * * *"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">moreComplexJob</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"좀 더 복잡한 Job 시작"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RuntimeException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>하나는 매 2초마다 실행 후 바로 종료되고, 하나는 매 4초마다 실행 후 3초의 대기와 종료되는 메서드입니다.
이런 스케줄은 어떻게 동작할까요? 저는 당연히 2초와 4초마다 해당 메서드가 실행될 줄 알았습니다.</p><p>로그를 살펴보면 아래와 같은 결과가 발생했습니다.
<img loading="lazy" src="https://github.com/drunkenhw/comments/assets/106640954/5e275085-fce6-43ae-88ca-d3f9c484b6f3" alt="log" class="img_ev3q">
복잡한 job이 2번 실행될 때, 좀 더 복잡한 job이 1번 실행되는 걸 볼 수 있습니다. 예상했던 결과입니다.</p><p>하지만 실행된 시간을 살펴보겠습니다.
<img loading="lazy" src="https://github.com/drunkenhw/comments/assets/106640954/abbe2c65-c26b-46ba-a4e3-fc0f4e5a6612" alt="log-with-time" class="img_ev3q"></p><p>분명 매 2초와 4초마다 실행하기 때문에 작업 시간이 2의 배수가 되어야할텐데</p><p>34, 36, 36, <strong>39</strong>, 40, 40, <strong>43</strong>, 44, 44, <strong>47</strong>초 로 점점 작업이 밀리는 것을 확인할 수 있습니다.</p><p>왜 그럴까요? 스프링 공식 문서에서는 아래와 같이 설명하고 있습니다.</p><blockquote><p>A ThreadPoolTaskScheduler can also be auto-configured if need to be associated to scheduled task execution (using @EnableScheduling for instance). The thread pool uses one thread by default and its settings can be fine-tuned using the spring.task.scheduling namespace, as shown in the following example:</p></blockquote><p><a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#features.task-execution-and-scheduling" target="_blank" rel="noopener noreferrer">참고 - 스프링 공식 문서</a></p><p>스프링의 Schedule은 Default로 하나의 싱글 스레드에서 동작하기 때문입니다.
그렇기 때문에 매번 작업이 밀려 원하는 시간에 동작하지 않는 현상이 발생할 수 있습니다.</p><p>하지만 Schedule을 분산 환경에서 구분하기 위해서는 job이 실행된 시간이 중요하기 때문에 이렇게 작업이 밀려버린다면 구분을 할 수 없게 됩니다.
따라서 Schedule Thread Pool Size를 늘리도록 하겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ScheduleConfig</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">SchedulingConfigurer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">configureTasks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ScheduledTaskRegistrar</span><span class="token plain"> taskRegistrar</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ThreadPoolTaskScheduler</span><span class="token plain"> taskScheduler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadPoolTaskScheduler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        taskScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setPoolSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        taskScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setThreadNamePrefix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"schedule-task-"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        taskScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        taskRegistrar</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setTaskScheduler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskScheduler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>SchedulingConfigurer 를 구현하여 Thread Pool size를 일단 10개로 정의했습니다.</p><p><img loading="lazy" src="https://github.com/drunkenhw/comments/assets/106640954/14b225bc-297e-4e7d-b196-23d779f635c0" alt="success" class="img_ev3q">
스레드 풀을 늘렸더니 위와 같이 2의 배수의 시간에 정확히 작동이 되는 것을 확인할 수 있습니다.</p><p>하지만 이렇게 여러 작업을 동시에 실행된다면 데이터베이스에 병목현상이 발생되어 오히려 작업이 더 느리게 끝날 수도 있다고 생각했습니다.</p><p>그래서 해당 부분의 실행을 관리하는 클래스를 생성하여 해당 클래스에서 Schedule의 작업을 관리하도록 구현했습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">BusinessLogic</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ApplicationEventPublisher</span><span class="token plain"> applicationEventPublisher</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Scheduled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cron </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0/2 * * * * *"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">complexJobSchedule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        applicationEventPublisher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">publishEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SchedulingEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">complexJob</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"complexJob"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">LocalDateTime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Scheduled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cron </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0/4 * * * * *"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">moreComplexJobSchedule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        applicationEventPublisher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">publishEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SchedulingEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">moreComplexJob</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"moreComplexJob"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">LocalDateTime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>로직이 있는 BusinessLogic 서비스에서 스케줄의 시간마다 실행해야할 메서드를 Event로 발행합니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ScheduleService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ExecutorService</span><span class="token plain"> executorService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Executors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newFixedThreadPool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Queue</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">SchedulingEvent</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> scheduleTasks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">AtomicBoolean</span><span class="token plain"> isRunning </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicBoolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation punctuation" style="color:#393A34">@EventListener</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SchedulingEvent</span><span class="token plain"> schedulingEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduleTasks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">schedulingEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation punctuation" style="color:#393A34">@Scheduled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cron </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0/1 * * * * *"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">polling</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">scheduleTasks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> isRunning</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareAndSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">SchedulingEvent</span><span class="token plain"> schedulingEvent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scheduleTasks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">poll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      executorService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">schedulingEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>그리고 위와 같은 스케줄을 관리하는 서비스에서는 Schedule Event를 받아 실행하도록 만들었습니다. 해당 클래스에서는 ThreadPool을 새로 생성하여, schedule의 스레드에 영향을 받지 않도록 구현했습니다.</p><p>그리고 1초마다 실행되는 스케줄을 만들어 queue에 작업이 있는지, 현재 작업 중인지 확인하여 그렇지 않다면 queue에서 작업을 꺼내 실행하도록 만들었습니다.</p><p>거의 구현이 끝나갑니다. 이제는 해당 Schedule의 데이터를 저장하고, 작업이 실패했을 시에 다시 작업을 하기 위한 기능만 구현하면 될 것 같습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ScheduleService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SchedulingEvent</span><span class="token plain"> schedulingEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> jobId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> schedulingEvent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">jobId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">LocalDateTime</span><span class="token plain"> executionTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> schedulingEvent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executionTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isJobInProgressOrDone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jobId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"작업이 실행중입니다. {} {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> executionTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> jobId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ScheduleTask</span><span class="token plain"> entity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ScheduleTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jobId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> executionTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">JobStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">RUNNING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduleTaskJdbcRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            schedulingEvent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">runnable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scheduleTaskJdbcRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">JobStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">DONE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"{} 작업 실행 중 에러가 발생했습니다."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> jobId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scheduleTaskJdbcRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">JobStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ERROR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tasks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">schedulingEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isJobInProgressOrDone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> jobId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Optional</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">ScheduleTask</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> taskOptional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scheduleTaskRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jobId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskOptional</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isPresent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ScheduleTask</span><span class="token plain"> scheduleTask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> taskOptional</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> scheduleTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">JobStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">RUNNING</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> scheduleTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">JobStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">DONE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이 부분은 간단하게 구현할 수 있습니다. 위와 같이 작업의 실행 시간과, job의 이름으로 데이터베이스에서 조회하고, 없다면 작업을 실행하고
있다면 작업이 ERROR 인지 확인하여 작업을 실행해주면 될 것 같습니다.</p><p><img loading="lazy" src="https://github.com/drunkenhw/comments/assets/106640954/3ff855db-ff8e-4aa4-8b47-ed5b2ff6dd64" alt="complete" class="img_ev3q"></p><p>위와 같이 두 개의 서버를 동시에 띄웠을 때에도 스케줄이 잘 작동하는 것을 확인할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론">결론<a href="#결론" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><p>스케줄을 이렇게 구현할 수도 있지만 환경이 된다면 Message Queue를 사용하는 것이 어떨까요?</p><p>혹시 틀린 부분이 있다면 지적 부탁드립니다.</p>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="java" term="java"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[캐시와 이분 탐색으로 조회 성능 개선하기]]></title>
        <id>https://car-ffeine.github.io/34</id>
        <link href="https://car-ffeine.github.io/34"/>
        <updated>2023-09-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 박스터입니다]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 박스터입니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="이-글을-쓰는-이유">이 글을 쓰는 이유<a href="#이-글을-쓰는-이유" class="hash-link" aria-label="이 글을 쓰는 이유에 대한 직접 링크" title="이 글을 쓰는 이유에 대한 직접 링크">​</a></h2><p>이전 글에서도 계속 설명했듯이 조회 성능을 최대한 빠르게 하는 것이 저희 서비스에서 핵심이라고 생각하기 때문에 지금도 예전에 비해 빨라졌지만 다른 개선점이 보여 개선을 하고자합니다.</p><p><a href="https://car-ffeine.github.io/31" target="_blank" rel="noopener noreferrer">조회 성능 개선하기 1 (인덱스)</a></p><p><a href="https://car-ffeine.github.io/32" target="_blank" rel="noopener noreferrer">조회 성능 개선하기 2 (데이터베이스 복제)</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론">결론<a href="#결론" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><p>결론부터 말씀드리면 로컬에서 캐싱을 적용한 후 100명의 사용자가 지도의 데이터를 조회할 때를 기준으로</p><p><strong>TPS</strong> 78 -&gt; 128</p><p><strong>Response Time</strong> 1236 ms -&gt; 751 ms</p><p>약 <strong>64%</strong> 성능이 개선 되었습니다.</p><p><em>(저번 성능 테스트의 결과가 다른 이유는 비즈니스 로직이 변경되어 조회 방식이 바뀌었기 때문입니다. 그래서 캐싱을 적용하기전, 한 후 를 비교했습니다.)</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="caching">Caching<a href="#caching" class="hash-link" aria-label="Caching에 대한 직접 링크" title="Caching에 대한 직접 링크">​</a></h2><blockquote><p>In computing, a cache is a hardware or software component that stores data so that future requests for that data can be served faster; the data stored in a cache might be the result of an earlier computation or a copy of data stored elsewhere.</p></blockquote><p>캐싱은 위키 백과에서 위와 같이 설명하고 있습니다. 즉 메모리에 데이터를 복사본을 올려 좀 더 빠르게 데이터에 접근하는 방식입니다.</p><p>캐싱의 단점은 수정, 삽입, 삭제가 되었을 때, 관리 포인트가 두 군데가 된다는 점입니다. 만약 데이터베이스에만 새로운 정보를 저장하고, 캐시에는 저장해주지 않는다면 사용자는 그 정보를 볼 수 없습니다.</p><p>하지만 저희 서비스에서 적용한 이유는 충전기의 충전 상태 (충전 중, 대기중, 고장)에 대한 정보는 최신화가 되어야하지만, 충전소의 이름이라던지, 위치, 다른 정보들은 쉽게 변하지 않기 때문에 해당 정보를 캐싱한다면 좋을 것 같았습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="캐싱-적용하기">캐싱 적용하기<a href="#캐싱-적용하기" class="hash-link" aria-label="캐싱 적용하기에 대한 직접 링크" title="캐싱 적용하기에 대한 직접 링크">​</a></h2><p>먼저 캐싱을 어디에서 하는지도 중요합니다. 크게 <strong>로컬 캐시</strong>와 <strong>글로벌 캐시</strong>로 나눌 수 있을 것 같습니다.
글로벌 캐시의 장점은 스케일 아웃을 했을 때, 모든 서버가 다 같은 데이터를 바라보기 때문에 데이터 정합성이 좋아집니다. 하지만 저희 서비스는 단일 서버로 구성되어 있기 때문에, 로컬 캐시를 해도 문제가 없습니다. 그리고 글로벌 캐시를 적용하기 위해서는 Redis나 Memcached 같은 도구를 모든 팀원이 알아야하지만 로컬 캐시는 그렇게 하지 않더라도 편하게 적용할 수 있다는 점에서 로컬에 캐싱하는 방법을 적용해보겠습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="캐싱할-정보-가져오기">캐싱할 정보 가져오기<a href="#캐싱할-정보-가져오기" class="hash-link" aria-label="캐싱할 정보 가져오기에 대한 직접 링크" title="캐싱할 정보 가져오기에 대한 직접 링크">​</a></h3><p>캐싱을 하기 위해서는 먼저 캐싱할 데이터를 가져와야합니다. 저희 서비스는 출장 혹은 여행을 가는 전기차 오너가 핵심 페르소나이기 때문에 사용자들이 찾는 정보의 위치는 불특정합니다. 서울에서 다른 지방으로 출장을 가는 경우도 있을 것이고, 지방에서 서울에 가는 경우도 있기 때문에, 모든 데이터를 캐싱해야할 것이라 판단했습니다.</p><p>그래서 어플리케이션 실행 시에 모든 충전소를 캐싱하기로 선택했습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">InitialStationCache</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">ApplicationRunner</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">StationCacheRepository</span><span class="token plain"> stationCacheRepository</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">StationQueryRepository</span><span class="token plain"> stationQueryRepository</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ApplicationArguments</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Initialize station cache"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">StationInfo</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> stations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stationQueryRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stationCacheRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Station cache initialized"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Station cache size: {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>위와 같이 ApplicationRunner를 구현하여 어플리케이션 실행 시 모든 충전소의 정보를 가져오도록 만들었습니다.
여기서 Entity인 Station을 가져오지 않은 이유는 크게 두가지가 있습니다.</p><ol><li>지도로 조회하는 부분의 성능을 개선하고자 했지만, Entity에는 지도를 조회할 때 불필요한 정보도 있기 때문에 메모리상의 낭비가 생길 수 있습니다.</li><li>Entity를 캐싱하게 된다면 hibernate 1차 캐시에도 적재되고, 힙 메모리에도 적재되는 일이 발생하여 메모리상 낭비라고 생각했습니다.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="범위-검색하기">범위 검색하기<a href="#범위-검색하기" class="hash-link" aria-label="범위 검색하기에 대한 직접 링크" title="범위 검색하기에 대한 직접 링크">​</a></h3><p>충전소의 데이터를 조회하는 조건은 위도, 경도의 최소, 최대값을 기준으로 만족하는 데이터를 보여줍니다.
아래와 같이 간단히 조건을 stream()의 filter()를 사용해서 구현했습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">StationCacheRepository</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">StationInfo</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> cachedStations</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">StationInfo</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findByCoordinate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token class-name">BigDecimal</span><span class="token plain"> minLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token class-name">BigDecimal</span><span class="token plain"> minLongitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLongitude</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cachedStations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">latitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">minLatitude</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">latitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxLatitude</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">longitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">minLongitude</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">longitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxLongitude</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>하지만 해당 방법으로 로컬에서 조회를 테스트 했을 때 캐시를 적용한 것보다 더 느려진 결과가 나왔습니다.
캐싱을 해서 데이터베이스까지 요청을 보내지 않는데 왜 더 느려진 것일까요?</p><p>답은 <strong>인덱스</strong> 였습니다. Mysql 에서 인덱스는 B Tree로 구성되어 있습니다. 데이터베이스에서는 위도, 경도로 복합 인덱스가 설정되어 있었지만, 현재 어플리케이션 로직에는 해당 부분이 없습니다.</p><p>그래서 filter로 순회하는 시간복잡도가 O(n)이고, 데이터베이스에서는 O(log n)이기 때문에 더 느려진 것입니다. 그렇다고 제가 직접 B tree 자료구조를 직접 구현해야할까요?</p><p>현재 해당 조회 API는 위도 경도로 범위 탐색을 하고 있습니다. 결국엔 station의 정보들이 위도, 경도로 정렬만 되어 있다면 B tree를 직접 구현하지 않더라도 같은 시간복잡도 O(log n)으로 탐색할 수 있습니다.
물론 B tree와 다른 부분은 해당 충전소의 정확한 위도, 경도로 단일 칼럼을 조회할 때는 O(n)이기 때문에 이런 방법이 문제가 될 수 있지만, 해당 캐시 데이터로는 무조건 범위 탐색을 하기 때문에, B tree를 구현하지 않고 이분 탐색으로 조회하는 방식으로 변경해보겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">StationInfo</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> stations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachedStations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachedStations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">o1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> o2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> latitudeCompare </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> o1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">latitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">o2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">latitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">latitudeCompare </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> o1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">longitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">o2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">longitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> latitudeCompare</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">StationInfo</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BigDecimal</span><span class="token plain"> minLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> minLongitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLongitude</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> lowerBound </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">binarySearch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">minLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">START_INDEX</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> upperBound </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">binarySearch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lowerBound</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lowerBound </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> upperBound </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emptyList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cachedStations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">skip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lowerBound</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">upperBound </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> lowerBound</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">longitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">minLongitude</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">longitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxLongitude</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">binarySearch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BigDecimal</span><span class="token plain"> latitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> startIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> left </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> startIndex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> right </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cachedStations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">left </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> right</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> middle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> left </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">right </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> left</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">StationInfo</span><span class="token plain"> middleStation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cachedStations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">middle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">middleStation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">latitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">latitude</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> middle</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                right </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> middle </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                left </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> middle </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>먼저 어플리케이션이 실행될 때 cache 데이터를 찾아 저장하는 것 뿐만 아니라, 위도(Latitude)를 기준으로 정렬하도록 만들었습니다. 그리고 위도의 최소, 최대값의 인덱스를 가장 효율적으로 찾아올 수 있도록 binary search를 하는 메서드를 만들었습니다. 이렇게 한다면 O(log n) 으로 위도의 최대 최소 조건에 포함되는 모든 station의 값을 조회할 수 있습니다. 그리고 조회한 데이터들의 개수만큼 filter를 통해 경도(longitude) 가 포함되는지 확인합니다. 해당 방식의 구현은 B tree가 작동하는 방식과 유사할 것입니다.</p><p>이분 탐색을 적용한 결과 로컬에서 응답 속도가 120 ms -&gt; 50 ~ 70 ms로 약 2배 빨라진 것을 확인할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="실시간이-중요한-데이터는">실시간이 중요한 데이터는?<a href="#실시간이-중요한-데이터는" class="hash-link" aria-label="실시간이 중요한 데이터는?에 대한 직접 링크" title="실시간이 중요한 데이터는?에 대한 직접 링크">​</a></h2><p>앞서 말씀드렸다시피 지도로 충전소를 조회할 때, 충전소의 정보들에는 바뀌지 않는 정보뿐만 아니라, 최신화해야하는 충전기의 현재 상태 정보가 있습니다. 이러한 정보들은 캐싱해둘 수 없습니다. 하더라도, 관리 포인트가 늘어나기 때문에 데이터베이스에서 캐싱해둔 충전기 id로 충전기의 상태를 찾아와서 정보를 합쳐 반환하는 식으로 만들 수 있습니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token keyword" style="color:#00009f">when</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'STANDBY'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> charger_status cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">group</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>위와 같은 쿼리로 해당 충전소의 최신화된 충전기 상태를 가져올 수 있습니다.</p><p>캐싱을 하기전에 데이터베이스를 이용해 데이터를 가져올 때의 쿼리는 아래와 같습니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">distinct</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        charge_station s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        charger c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latitude</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain">?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latitude</span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain">?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">longitude</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain">?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">longitude</span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain">?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">longitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_parking_free</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_private</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">when</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_condition</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'STANDBY'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">when</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capacity</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">50</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        charge_station s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        charger c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        charger_status cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">group</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>원래는 위와 같이 여러번의 Join을 하고, 2번의 쿼리가 나갔던 반면 지금은 join을 하지않는 한번의 깔끔한 쿼리로 개선되었습니다.</p><p>그리고 <strong>station 테이블의 위도, 경도로 범위 탐색을 위해 생성했던 index도 제거</strong>할 수 있게 되었습니다!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론-1">결론<a href="#결론-1" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><ol><li>캐싱할 수 있는 부분은 하는 것도 좋을 것 같습니다</li><li>시간 복잡도를 계산해봅시다.</li><li>성능 개선 재밌습니다.</li></ol>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="java" term="java"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[혼잡도 조회 속도를 파티셔닝과 인덱스로 개선해보기]]></title>
        <id>https://car-ffeine.github.io/33</id>
        <link href="https://car-ffeine.github.io/33"/>
        <updated>2023-09-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요.
카페인 팀의 제이입니다.</p><p>저희 서비스에서는 충전소의 요일과 시간대 별로 충전소 혼잡도 정보를 제공을 차별적인 기능으로 제공하고 있습니다.</p><p>이를 구현하기 위해서 공공 데이터에서 정보를 수집하고있습니다.
혼잡도를 조회하기 위해서는 약 23만 건의 충전소 <em> 7일 </em> 24시간 = 약 4000만 건의 데이터 중에서 조회를 하는 형식으로 되어있습니다.</p><p>너무 많은 데이터가 있다보니 조회 속도가 많이 느린데요.
오늘은 이를 어떻게 개선했는지 작성해보도록 하겠습니다.</p><p>참고로 해당 글의 성능 측정에 이용한 데이터의 수는 약 20만 건입니다.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="문제-확인">문제 확인<a href="#문제-확인" class="hash-link" aria-label="문제 확인에 대한 직접 링크" title="문제 확인에 대한 직접 링크">​</a></h2><p>기존의 저희는 많은 양의 데이터를 감당하기 힘들어서 <!-- -->[오전, 오후]<!-- --> 이렇게 두 부분으로 나눠서 혼잡도를 조회했습니다.</p><p>하지만 실제 배포를 하기 위해서 더이상은 오전 오후로 나눌 수가 없었는데요.</p><p>정상적인 데이터를 제공하기 위해서 먼저 24시간 기준으로 혼잡도를 갱신하도록 로직부터 바꾸었습니다.</p><p>위와 같이 코드를 바꾸니 바로 성능에 문제가 생겼습니다.
<img loading="lazy" src="https://postfiles.pstatic.net/MjAyMzA5MTFfMTA4/MDAxNjk0NDIwNjEzOTU3.Q1_sK5nRvBVbJ9w4bdYkofc0zX00TQmJUQPIqRQiofwg.FRujZOroDjWC4znh0pueWi84EAh9-LVKk17z2ojLi1Ig.PNG.sosow0212/image.png?type=w773" alt="img" class="img_ev3q"></p><p>위의 사진과 같이 slow-query를 분석해보았습니다.
혼잡도 업데이트에도 시간이 걸리는 것을 확인할 수 있지만, 조회 시간은 최악의 경우 약 12분 정도로 사용자들이 볼 수도 없었습니다.</p><p>이런 문제가 발생한 이유는 다음과 같습니다.
먼저 가장 큰 문제는 데이터가 많기 때문이고, 두 번째로는 비효율적인 API로 인한 문제입니다.</p><p>현재 혼잡도 조회시 0~23시까지 모든 요일의 급속과 완속 충전기에 대한 혼잡도를 가져옵니다.
굳이 이럴 필요 없이 선택한 요일에만 혼잡도를 가져온다면 불필요한 조회는 없을 거라고 생각해서 일부분 리팩토링을 하기로 했습니다.</p><p>추가적으로 박스터가 DB Replication을 적용해서, Update로 인한 속도 저하 현상도 많이 줄어들 것을 기대할 수 있었습니다.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="문제-해결-과정">문제 해결 과정<a href="#문제-해결-과정" class="hash-link" aria-label="문제 해결 과정에 대한 직접 링크" title="문제 해결 과정에 대한 직접 링크">​</a></h2><ul><li>먼저 기존 코드로 조회시에 속도가 얼마나 나오는지 확인을 해보겠습니다.
<img loading="lazy" src="https://blogfiles.pstatic.net/MjAyMzA5MTFfMTgz/MDAxNjk0NDIwODU1MDg0.d2ig3CCgdHDwkz_7d4qyhVKM0PQ4MV8BcUwm9LjqAcAg.LdVGDSqRuArzM32ZD1tHbxsD2xG5pt8xrOrDwhR25wcg.PNG.sosow0212/image.png" alt="img" class="img_ev3q">
기존의 모든 혼잡도를 들고오는 경우 위와 같이 536ms의 시간이 소모되는 것을 확인할 수 있습니다.</li></ul><p><img loading="lazy" src="https://blogfiles.pstatic.net/MjAyMzA5MTFfMjA5/MDAxNjk0NDIwODk3NDE4.N3tGXL52LYr5Koc1Lwk0Tfhe3Apkao9BEI8waHIkwNgg.AUEcIoBUg8AtXMiZCc2P13Vb_DCeWnsoXH2-6acaClIg.PNG.sosow0212/image.png" alt="img" class="img_ev3q">
위에 사진과 같이 <code>day_of_week</code> 즉 혼잡도를 확인하고 싶은 요일을 추가적으로 조건에 명시해주니
148ms로 줄은 것을 확인할 수 있습니다.</p><p>148ms는 아직 한참 느립니다.</p><p>먼저 문제를 해결하기 위해서 <code>DB Partitioning</code>을 적용했습니다.</p><p>DB Partitioning에 대해 간단하게 설명하자면 큰 테이블을 작은 단위로 관리하는 기법입니다.
하나의 테이블로 보이지만 이를 적용하면 실제로 여러 개의 테이블로 분리해서 관리하는 기법이고, 이를 통해서 조회 및 업데이트 쿼리 성능이 개선될 수 있습니다.</p><p>저희 팀은 List partitioning을 적용해서 <code>day_of_week(요일)</code>을 기준으로 파티셔닝을 했습니다.
<img loading="lazy" src="https://blogfiles.pstatic.net/MjAyMzA5MTFfMTE0/MDAxNjk0NDIxMzg1NTMx.Q4VBItbFdityCKdRFYqpC1qVtoi81RRqcmysYMh-9xog.d8MIYW-tatGXoaxCJ-o6vS5wydEk1yQVQTtmmZvooFIg.PNG.sosow0212/image.png" alt="img" class="img_ev3q">
위에 사진과 같이 day_of_week를 기준으로 파티셔닝을 했습니다.</p><p><img loading="lazy" src="https://blogfiles.pstatic.net/MjAyMzA5MTFfMjA5/MDAxNjk0NDIxNDM3MTI2.QXclZKmnwVTcYrkR95yPJV3vxCCzcaisaWj29WGxFucg.CO0SafuQLRmWPzAs9-9ForUnT1fjcqxXBRmX1UmB-b8g.PNG.sosow0212/image.png" alt="img" class="img_ev3q">
List Partitioning을 적용하고 위에 사진과 같이 조회 쿼리를 다시 날려보면, <code>partitions = p_friday</code> 로 잘 나뉘어진 것을 확인할 수 있습니다.</p><p>파티셔닝 작업이 잘 되었으니 이제 API에서 요일 별 혼잡도 조회로 바꿔보겠습니다.
먼저 쿼리를 변경하고 쿼리를 확인해보니 다음과 같이 나왔습니다.</p><p><img loading="lazy" src="https://postfiles.pstatic.net/MjAyMzA5MTFfMjQ5/MDAxNjk0NDIxNTcwOTg3.mgx-mdBa6J6k8erhiksOOkzrMzOMmCLX7iuRPZf7RNEg.ALwxez4qUVHB1wlIr9zsZovCBlxoIsmgCa4wNv-7t_4g.PNG.sosow0212/image.png?type=w773" alt="img" class="img_ev3q">
위와 같은 조회 쿼리가 나왔으므로 인덱스를 아래와 같이 <code>station_id, day_of_week</code>에 걸어주었습니다.</p><p><img loading="lazy" src="https://postfiles.pstatic.net/MjAyMzA5MTFfMjgy/MDAxNjk0NDIxNjI2NDAz.XqGsab-JR_fQaIZhCYMiKy5r3cn85wFLwUNlmCo1Gqwg.a26_N5lnwzXX6z0JRqn35u8pGcj1TAa2nDamgRyOYjUg.PNG.sosow0212/image.png?type=w773" alt="img" class="img_ev3q">
위 실행 속도에서 execution time을 확인해보면 인덱스를 걸고 <code>134ms -&gt; 5ms</code>로 성능이 많이 개선 되었음을 확인할 수 있습니다.</p><p><img loading="lazy" src="https://postfiles.pstatic.net/MjAyMzA5MTFfMjI3/MDAxNjk0NDIxNjc5NDIw.kbfBLWKeY70QFeByKN5xVX1WhFSpFZbJnFkx9l0zyrQg.Wv0QU9W6Fqjfr8eyyLT2MyttjDKzN2cdrItGH7CDLPYg.PNG.sosow0212/image.png?type=w773" alt="img" class="img_ev3q">
실행 계획도 의도한대로 잘 나오는 것을 보실 수 있습니다.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="정리">정리<a href="#정리" class="hash-link" aria-label="정리에 대한 직접 링크" title="정리에 대한 직접 링크">​</a></h2><ol><li>DB Partitioning - (day_of_week : 요일)을 기준으로 파티셔닝</li><li>조회 쿼리에 맞게 인덱스 설정</li><li>API 수정 (모든 요일의 혼잡도 조회 -&gt; 해당 요일의 혼잡도 조회)</li></ol><p>결과적으로 기존 혼잡도 조회시 511ms가 나왔으나, 요일 별 조회 및 파티셔닝 &amp; 인덱스를 적용하고 execution time = 5ms로 개선</p>]]></content>
        <author>
            <name>제이</name>
            <uri>https://github.com/sosow0212</uri>
        </author>
        <category label="mysql" term="mysql"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[데이터베이스 레플리케이션으로 조회 성능 개선하기]]></title>
        <id>https://car-ffeine.github.io/32</id>
        <link href="https://car-ffeine.github.io/32"/>
        <updated>2023-09-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[이 글을 쓰는 이유]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="이-글을-쓰는-이유">이 글을 쓰는 이유<a href="#이-글을-쓰는-이유" class="hash-link" aria-label="이 글을 쓰는 이유에 대한 직접 링크" title="이 글을 쓰는 이유에 대한 직접 링크">​</a></h2><p>먼저 이 글을 쓰게 된 계기를 말씀드리겠습니다. 지난 글에서 설명했듯이 저희 프로젝트에서는 데이터베이스가 실행되고 있는 서버의 cpu 사용률이 100%가 되는 문제가 있었습니다.
이 부분에 대해서는 조회 성능을 높혀 어느정도 해결하고자 했습니다. 하지만 조회가 아닌 많은 데이터를 일정한 주기로 업데이트 해줘야하는 로직도 포함되어 있기 때문에 업데이트를 할 때 조회를 하게 된다면 cpu 사용률은 비슷할 것입니다. 이 부분을 해결하고자 데이터베이스 레플리케이션을 알아보겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론">결론<a href="#결론" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><p>결론부터 말씀드리면 데이터베이스 레플리케이션을 적용한 후 성능이 눈에 띄게 좋아졌습니다. 해당 부분은 다음 포스팅에 작성하겠습니다
100명의 사용자가 지도의 데이터를 조회할 때를 기준으로</p><p><strong>TPS</strong> 179 -&gt; 366</p><p><strong>Response</strong> Time 550 ms -&gt; 271 ms</p><p>약 2배 가량 성능이 향상된 것을 볼 수 있습니다.</p><h1>데이터베이스 레플리케이션이란?</h1><p>데이터베이스 레플리케이션이란 하나의 데이터베이스에서 다른 하나 이상의 데이터베이스로 데이터의 복제 또는 복사를 수행하는 프로세스 또는 기술입니다. 데이터베이스 레플리케이션은 주로 다음과 같은 목적으로 사용됩니다</p><ol><li><p><strong>고가용성</strong>:
데이터베이스 서버의 장애가 발생했을 때, 레플리카 데이터베이스를 사용하여 시스템을 계속 운영할 수 있습니다. 이렇게 하면 서비스 중단 시간을 최소화하고 비즈니스 연속성을 유지할 수 있습니다.</p></li><li><p><strong>성능 향상</strong> :
레플리케이션을 사용하면 읽기 작업을 분산시킬 수 있으므로 데이터베이스 서버의 읽기 부하를 줄일 수 있습니다. 이를 통해 데이터베이스 성능을 향상시킬 수 있습니다.</p></li><li><p><strong>지역적 분산</strong> :
데이터베이스 레플리케이션을 통해 데이터를 지리적으로 분산시킬 수 있습니다. 이렇게 하면 지역적인 사용자 또는 응용 프로그램에 빠르게 데이터를 제공할 수 있으며, 지역적인 규정 준수 요구사항을 충족시킬 수 있습니다.</p></li><li><p><strong>백업과 복구</strong> :
레플리케이션을 사용하여 주 데이터베이스의 백업을 생성하고, 이를 사용하여 장애 복구를 수행할 수 있습니다. 주 데이터베이스가 손상되었을 때 백업 데이터베이스를 사용하여 시스템을 빠르게 복원할 수 있습니다.</p></li><li><p><strong>데이터 분석 및 보고</strong> :
레플리케이션을 사용하여 데이터를 다른 분석 또는 보고 도구로 복사하여 데이터 웨어하우스 또는 분석 시스템에서 사용할 수 있습니다.</p></li></ol><p>저희 팀에서 레플리케이션을 적용한 가장 큰 이유는 성능 향상입니다. 아무래도 저희 서비스에서는 읽기 작업과 쓰기 작업이 둘 다 빈번하게 일어나고, 특히 쓰기 작업에 많은 연산이 필요합니다. 사용자에게 최신의 데이터를 제공하고자 쓰기 작업을 자주하여 데이터를 최신화하더라도, 읽기 작업이 느려지면 아무도 사용하지 않을 것입니다. 하지만 이렇게 서버를 여러 대 두어 하나의 데이터베이스 서버가 받는 부하를 분산시킨다면 성능이 향상 될 것입니다.</p><p>그리고 두번째로는 고가용성입니다. 현재 저희의 데이터베이스는 하나의 서버로 SPOF 문제가 있습니다. 하지만 레플리케이션을 적용하여 데이터베이스를 분산한다면 하나의 데이터베이스가 장애가 생겨 중지가 되더라도, 다른 서버의 데이터베이스로 서비스를 이어나갈 수 있습니다.</p><h1>데이터베이스 복제 방식</h1><p>데이터베이스 복제 방식은 크게 두가지가 있습니다. <strong>Binary Log로 복제하는 방식</strong>과 <strong>GTID(Global Transaction Id)를 통해 복제를 하는 방식</strong>이 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="binary-log-복제-방식">Binary log 복제 방식<a href="#binary-log-복제-방식" class="hash-link" aria-label="Binary log 복제 방식에 대한 직접 링크" title="Binary log 복제 방식에 대한 직접 링크">​</a></h2><p>먼저 Binary Log 는 데이터베이스에서 수행한 쿼리 (사용자 추가, 인덱스 추가, Update, Insert, Delete 등 ) 모든 정보를 Binary Log에 기록합니다. 그리고 해당 바이너리 로그에는 이벤트마다 Mysql 서버의 고유한 Server id를 가지고 있는데, 해당 Id가 같은 서버에서는 해당 이벤트를 자신이 발생시킨 이벤트로 간주하고 적용하지 않습니다. 그러므로 각각의 고유한 server id를 설정해줘야 합니다.
이 <strong>바이너리 로그 파일의 위치와 바이너리 로그 파일명</strong>을 통해 Replica 서버는 Source 서버의 이벤트를 적용합니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gtid-복제-방식">GTID 복제 방식<a href="#gtid-복제-방식" class="hash-link" aria-label="GTID 복제 방식에 대한 직접 링크" title="GTID 복제 방식에 대한 직접 링크">​</a></h2><p>Mysql 5.5 버전 이상부터는 GTID 기반 복제도 가능하게 추가되었습니다 GTID는 source id와 transaction id가 조합된 방식으로 생성됩니다. source id는 트랜잭션이 발생한 소스 서버를 식별하기 위한 값으로 server의 uuid 입니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">+</span><span class="token comment" style="color:#999988;font-style:italic">--------------------------------------+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> source_uuid                          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token comment" style="color:#999988;font-style:italic">--------------------------------------+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> c3a2296b</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">31</span><span class="token plain">a2</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain">ee</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">b887</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">02</span><span class="token plain">a8cf0173ac </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token comment" style="color:#999988;font-style:italic">--------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이러한 GTID를 기반으로 Source 서버를 구분하고 Binary Log 파일에 기록된 GTID를 확인하여 마지막에 적용한 이벤트를 확인하고, 적용하지 않은 이벤트를 순차대로 실행시켜 복제할 수 있습니다.</p><p>이 두가지 방법 중 저희는 GTID 방식의 복제를 선택했습니다. 이유는 간단합니다.</p><p>이런 방식으로 토폴로지를 구성했다고 가정해보겠습니다. Source 서버에서는 Binary Log 10번 파일까지 이벤트가 발생했습니다. 그리고 Replica1 에서는 Source 서버의 이벤트가 최신화 되어 있지만, Replica2  서버는 아직 최신화가 되지 않은 상황입니다. 이 상황에서 Source Server에 장애가 발생하여 서버가 중단 되었습니다.</p><p>그러면 Replica1 서버를 Source 서버로 승격합니다. 이렇게 된다면 Replica1 서버에서 모든 쿼리의 요청이 들어오게 됩니다. BinaryLog10이라는 파일의 위치와 파일을 찾을 방법이 없기 때문에 Source서버가 복구되지 않는 이상 혹은 Replica 1 서버의 Relay Log가 남아있지 않는 이상 Replica2 서버는 절대 최신화될 수 없습니다. 이런 식의 방식이라면 Source 서버가 중단되었을 때 다른 서버가 동작하기 때문에 고가용성 문제는 해결된 것 같지만, Replica2 서버는 아무 일도 하지않고 남아있는 서버, 즉 Source 서버 하나가 중단되었으나 <strong>2대의 서버가 중단된 것</strong>과 마찬가지입니다.</p><p>이러한 문제를 해결하기 위해 GTID가 등장했습니다. GTID 방식은 Binary Log의 위치와 파일명이 필요한 것이 아닌 다음 이벤트의 GTID만 있다면 해당 이벤트를 바로 적용할 수 있다는 점입니다. Source 서버로 승격된 Replica1 서버에서 <strong>GTID를 받아 적용하여 최신화</strong>할 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="저희-팀의-복제-방식">저희 팀의 복제 방식<a href="#저희-팀의-복제-방식" class="hash-link" aria-label="저희 팀의 복제 방식에 대한 직접 링크" title="저희 팀의 복제 방식에 대한 직접 링크">​</a></h3><p>이러한 장점으로 GTID기반 복제 방식을 사용하였습니다.</p><h1>복제 동기화 방식</h1><p>복제 방식에는 크게 두가지가 있습니다. <strong>비동기 복제</strong>와 <strong>반동기 복제</strong>입니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="비동기-복제">비동기 복제<a href="#비동기-복제" class="hash-link" aria-label="비동기 복제에 대한 직접 링크" title="비동기 복제에 대한 직접 링크">​</a></h2><p>비동기 복제는 말그대로 비동기로 복제하는 것입니다. 아주 간단합니다. Source 서버에서 어떠한 이벤트가 발생할 때 Replica 서버의 반영과 상관없이 동작하는 것입니다.
소스 서버에서 커밋된 트랜잭션은 바이너리 로그에 기록되고, 레플리카 서버에서는 주기적으로 새로운 트랜잭션에 대한 바이너리 로그를 요청합니다. 이러한 방식은 소스 서버는 레플리카 서버가 제대로 변경 되었는지 알 수 없습니다. 즉 데이터 정합성에 문제가 생긴다는 단점이 있습니다. 하지만 이러한 방식은 소스 서버가 각 트랜잭션에 대해 레플리카 서버로 전송되는 부분을 고려하지 않는다는 점이 속도 측면에서 빠르고, 또 여러 대의 레플리카 서버를 구성하더라도 큰 성능 저하가 없다는 점이서 장점이 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="반동기-복제">반동기 복제<a href="#반동기-복제" class="hash-link" aria-label="반동기 복제에 대한 직접 링크" title="반동기 복제에 대한 직접 링크">​</a></h2><p>반동기 복제는 비동기 복제보다 좀 더 데이터 정합성이 올라갑니다. 소스 서버는 변경된 트랜잭션이 있을 때 레플리카 서버가 다 전송이 되었다는 ACK 신호를 받기 때문에 확실히 알 수 있습니다. 하지만 전송여부만 확인하기 때문에 트랜잭션이 반영이 되었다는 보장은 없습니다. 반동기 복제 방식은 2가지가 있습니다.</p><ol><li><strong>After sync</strong>: After Sync 방식은 소스 서버에서 트랜잭션을 바이너리 로그에 기록 후 Storage Engine에 바로 커밋하지 않습니다. 먼저 바이너리 로그에 기록 후 레플리카 서버의 ACK 응답을 기다립니다. 그리고 ACK 응답이 도착하면 그제서야 스토리지 엔진을 커밋하여 트랜잭션을 처리하고 결과를 반환합니다.</li><li><strong>After commit</strong>: After commit은 이름 그대로 커밋을 먼저 하는 것입니다. 트랜잭션이 생기면 먼저 바이너리 로그에 기록 후 소스 서버 스토리지 엔진에 커밋합니다. 그리고 레플리카 서버의 ACK 응답이 내려오면 클라이언트는 처리 결과를 얻고 다음 쿼리를 수행할 수 있습니다.</li></ol><p>먼저 after commit 방식은 소스 서버에 장애가 발생했을 때 팬텀 리드가 발생하게 됩니다. 트랜잭션이 스토리지 엔진 커밋까지된 후 레플리카 서버의 응답을 기다립니다. 이처럼 스토리지 엔진 커밋까지 완료된 데이터는 다른 세션에서도 조회가 가능합니다. 트랜잭션이 커밋되었고, 레플리카 서버로 아직 응답을 기다릴 때, 소스 서버에 장애가 발생한다면 새로운 소스 서버로 승격된 레플리카 서버에서 데이터를 조회할 때 자신이 이전 소스 서버에서 조회했던 데이터를 보지 못할 수도 있습니다.</p><p>그리고 이처럼 레플리카 서버가 승격된 상황에 소스 서버의 장애가 복구되어 재사용할 경우 이미 커밋된 그 트랜잭션을 수동으로 롤백 시켜야만 데이터가 맞는 상황이 생깁니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="저희-팀의-복제-동기화-방식">저희 팀의 복제 동기화 방식<a href="#저희-팀의-복제-동기화-방식" class="hash-link" aria-label="저희 팀의 복제 동기화 방식에 대한 직접 링크" title="저희 팀의 복제 동기화 방식에 대한 직접 링크">​</a></h3><p>이러한 장단점으로 저희 팀은 데이터 무결성이 중요하다 판단되어 반동기 복제 방식을 사용하고, After Sync 방식을 적용하였습니다.</p><h1>복제 토폴리지</h1><p>복제 토폴리지는 여러가지 방식 중 자신의 상황과 가장 맞는 방식을 사용하면 될 것 같습니다. 저희 팀이 고려해야할 문제는 먼저 성능을 올려야 했고, 단일 장애포인트를 개선해야했습니다. 하지만 사용할 수 있는 서버는 2대 뿐이였습니다. 이러한 상황에서 어떤 방식을 택할 수 있을까요?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="싱글-레플리카">싱글 레플리카<a href="#싱글-레플리카" class="hash-link" aria-label="싱글 레플리카에 대한 직접 링크" title="싱글 레플리카에 대한 직접 링크">​</a></h2><p>가장 기본적이며 가장 많이 쓰이는 형태입니다. 어플리케이션에서 레플리카 서버에 읽기 요청을 전달하면, 레플리카 서버에 문제가 생겼을 때, 서비스 장애 상황이 발생할 수 있습니다. 그러므로 소스 서버에서 Read, Write를 둘 다 하고, 레플리카 서버는 failover를 위해 대기하는 예비용 서버로 구성합니다.
소스 서버에 장애가 발생했을 때 소스 서버를 대체하거나 데이터를 백업하는 용도로 사용합니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="멀티-레플리카">멀티 레플리카<a href="#멀티-레플리카" class="hash-link" aria-label="멀티 레플리카에 대한 직접 링크" title="멀티 레플리카에 대한 직접 링크">​</a></h2><p>싱글 레플리카와 비슷한 구성이지만 레플리카 서버가 한 대 더 추가된 구성입니다. 해당 방식은 SPOF 문제가 없기 때문에 레플리카 서버 하나를 읽기 전용 서버로 둘 수 있습니다. 읽기 작업을 분산함으로 어플리케이션의 성능을 향상 시킬 수 있습니다. 아까 말했던 장애 상황이 발생하면 예비용 서버인 Replica2 서버를 Source 서버 혹은 Replica1(읽기 전용) 서버로 대체할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="체인-복제">체인 복제<a href="#체인-복제" class="hash-link" aria-label="체인 복제에 대한 직접 링크" title="체인 복제에 대한 직접 링크">​</a></h2><p>레플리카 서버가 많아져 소스 서버의 바이너리 로그를 읽는 부하가 많아질 때 할 수 있는 구성입니다. 좀 전에 설명드렸던 멀티 레플리카 방식에서 똑같은 구성을 추가한 방식으로 볼 수 있습니다. Source 1 의 정보를 복제한 Replica 1-1, 1-2 서버는 빠르게 데이터가 반영되지만, Source1의 이벤트를 복제한 Source2를 복제한 Replica 2-1, 2-2 서버는 당연히 늦게 반영되기 때문에 해당 그룹은 예비용으로 사용합니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="듀얼-소스-복제">듀얼 소스 복제<a href="#듀얼-소스-복제" class="hash-link" aria-label="듀얼 소스 복제에 대한 직접 링크" title="듀얼 소스 복제에 대한 직접 링크">​</a></h2><p>데이터베이스 둘 다 소스 서버이면서 레플리카 서버인 경우입니다. 이 경우는 <strong>Active-Active</strong>구성과 <strong>Active-Passive</strong> 구성으로 나뉩니다</p><p>Active-Active는 서버 둘 다 읽기와 쓰기가 가능한 형태입니다. 즉 부하를 분산시키기 위해 서버 모두 읽고 쓰는 작업을 하는 것입니다. 하지만 이러한 방식은 뻔한 단점이 있습니다. 서로의 이벤트가 동기화 되기 전에는 정합성이 깨질 수 있습니다. 또 동시에 같은 데이터에 대해 쓰기 작업을 수행할 때, 하나의 서버에서 쓰기가 완료되었더라도, 다른 하나의 서버에 늦게 끝난 쓰기가 있다면 마지막 트랜잭션인 늦게 끝난 쓰기 작업이 반영되어 예상하지 못한 결과가 나올 수 있습니다.</p><p>또 다른 문제로는 Auto Increment를 사용할 때입니다. 새로운 데이터가 동시에 생성될 때 Auto Increment가 중복되는 에러가 발생할 수 있기 때문에 해당 토폴로지에서는 ID를 DB에 의존하지 않는 것이 좋습니다.</p><p>Active-Passive 방식은 하나의 서버만 읽기와 쓰기 요청이 되지만, 나머지 서버는 대기하고 있습니다. 두 서버 모두 언제나 쓰기 작업이 가능한 형태이기 때문에 장애 발생 시 빠르게 Faliover할 수 있다는 점이 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="멀티-소스-복제">멀티 소스 복제<a href="#멀티-소스-복제" class="hash-link" aria-label="멀티 소스 복제에 대한 직접 링크" title="멀티 소스 복제에 대한 직접 링크">​</a></h2><p>하나의 레플리카 서버가 다수의 소스 서버를 갖는 구성입니다. 데이터베이스 샤딩을 해뒀는데, 다시 하나의 서버로 통합하고 싶을 때 사용할 수 있습니다. 혹은 서로 다른 데이터를 한 곳에 백업을 할 때도 사용할 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="저희-팀의-토폴로지-방식">저희 팀의 토폴로지 방식<a href="#저희-팀의-토폴로지-방식" class="hash-link" aria-label="저희 팀의 토폴로지 방식에 대한 직접 링크" title="저희 팀의 토폴로지 방식에 대한 직접 링크">​</a></h3><p>그럼 이렇게나 많은 구성 중에 저희 팀에서 택할 수 있는 토폴로지 방식은 싱글 레플리카 방식과 듀얼 소스 복제 방식 밖에 없습니다. 왜냐하면 주어진 서버가 2대뿐이기 때문입니다.
하지만 듀얼 소스 방식은 적용하는데 무리가 있는 부분이 있습니다. 일단 저희가 레플리케이션을 적용하려는 가장 큰 이유는 <strong>성능</strong> 이기 때문에 성능이 변하지 않는 듀얼 소스의 Active-Passive 방식은 제외하겠습니다. 그리고 Active-Active 방식은 부하를 분산시킬 수 있다는 장점이 있지만, 단점으로는 Auto Increment를 사용하는데에 위험이 있다는 점과, 데이터의 정합성 문제가 생길 수 있다는 점에서 듀얼 소스 방식은 제외하도록 했습니다.</p><p>그럼 싱글 레플리카 방식을 적용할 수 밖에 없는데요. 싱글 레플리카의 방식은 가용성 문제를 해결하기 위해 만들어진 방식입니다. 하지만 저희 서비스는 현재 가용성보다 성능을 더 신경써야하는 상황이기때문에 싱글 레플리카 토폴로지를 구성하지만 레플리카 서버를 예비용이 아닌 읽기 전용 방식으로 사용하도록 하고, 가용성 부분을 포기하기로 정했습니다.</p><h1>코드에 적용하기</h1><p><a href="https://github.com/kwon37xi/replication-datasource" target="_blank" rel="noopener noreferrer">replication-datasource</a> Github 소스 코드를 참고하시거나, <a href="https://greeng00se.github.io/db-replication" target="_blank" rel="noopener noreferrer">DB 복제, @Transactional에 따라 요청 분리해보기</a> 글을 참고하여 따라하면 금방하실 수 있습니다!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론-1">결론<a href="#결론-1" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><p>데이터베이스 레플리케이션 생각보다 어렵지 않습니다.</p><p>데이터베이스 재밌습니다. 인프라도 재밌습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="참고">참고<a href="#참고" class="hash-link" aria-label="참고에 대한 직접 링크" title="참고에 대한 직접 링크">​</a></h2><p>Real Mysql 8.0</p>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="mysql" term="mysql"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[조회 성능 개선하기]]></title>
        <id>https://car-ffeine.github.io/31</id>
        <link href="https://car-ffeine.github.io/31"/>
        <updated>2023-09-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 박스터입니다]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 박스터입니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="이-글을-쓰는-이유">이 글을 쓰는 이유<a href="#이-글을-쓰는-이유" class="hash-link" aria-label="이 글을 쓰는 이유에 대한 직접 링크" title="이 글을 쓰는 이유에 대한 직접 링크">​</a></h2><p>먼저 이 글을 쓰게 된 계기를 말씀드리겠습니다. 카페인 팀 프로젝트에는 사용자가 보고있는 지도에 충전소를 보여주는 조회 기능이 가장 중요하고, 제일 요청이 많이 들어옵니다.</p><p>하지만 조회 성능이 좋지 않은 까닭인지 여러 사용자가 접속하면 아래와 같이 데이터베이스가 실행되고 있는 서버의 cpu 사용률이 100%가 되는 문제가 있었습니다.
<img loading="lazy" src="https://github.com/drunkenhw/drunkenhw.github.io/assets/106640954/2330435f-17b4-4d38-b16b-c72fd7017969" alt="cpu" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="조회-성능-개선하기">조회 성능 개선하기<a href="#조회-성능-개선하기" class="hash-link" aria-label="조회 성능 개선하기에 대한 직접 링크" title="조회 성능 개선하기에 대한 직접 링크">​</a></h2><p>먼저 제가 개선하기 위해 사용했던 방법들에 대해 적어보겠습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dto-이용하기">DTO 이용하기<a href="#dto-이용하기" class="hash-link" aria-label="DTO 이용하기에 대한 직접 링크" title="DTO 이용하기에 대한 직접 링크">​</a></h3><p>현재 구조는 아래의 JPA를 이용해 아래와 같은 쿼리로 entity로 데이터를 조회합니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">distinct</span><span class="token plain"> station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 chargerStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 chargerStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">company_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contact</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">detail_location</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_parking_free</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_private</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">longitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operating_time</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">private_reason</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capacity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 chargerStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 chargerStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 chargerStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_condition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 chargerStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latest_update_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> charge_station station</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      charger charger </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      charger_status chargerStatus </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chargerStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> charger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chargerStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latitude </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">37.5019194727953082567</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latitude </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">37.5092305272047217433</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">longitude </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.044542269049714936</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">longitude </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.058071330950285064</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>JPA를 통해 이러한 방식으로 조회한다면 아주 편하게 값을 가져오고, fetch join을 통해 하위의 entity들의 정보도 깔끔하게 가져옵니다.</p><p>가져온 값으로 필요한 정보들을 매핑하고 가공하여 응답을 내려줬습니다.</p><p>하지만 조회만을 위해 JPA의 entity를 조회한다는 것은 여러 단점이 존재합니다.</p><p>제일 먼저 응답을 내려줄 때 불필요한 데이터까지 모두 조회를 한다는 부분입니다.
이렇게 많은 필드들이 있습니다. 하지만 응답에서는 대부분의 경우 모든 정보가 필요하지 않습니다. 그리고 모든 정보를 다 보내주는 것도 좋지 않습니다. 대량의 데이터를 조회할 때의 성능이 아주 나빠집니다.</p><p>그래서 필요한 칼럼만 조회하는 것이 좋습니다.</p><p>그리고 또 다른 단점으로는 JPA로 entity를 조회할 때 Hibernate 캐시에 저장한다던가, One To One 에서 N+1 쿼리가 발생하기 때문에 성능적인 이슈가 여러가지 있습니다.</p><p>그래서 조회만 하는 api라면 DTO Projection으로 하는 것이 좋을 것 같습니다.
그리고 아래와 같이 변경하였습니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">longitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_parking_free</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_private</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">when</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'STANDBY'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">when</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capacity </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> charge_station s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> charger c </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> charger_status cs </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">group</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 필요한 칼럼만 조회하는 방식으로 변경하여, 선릉역 근처를 조회하는 기준으로 약 450ms -&gt; 350ms로 개선되었습니다.</p><p>하지만 아직도 너무 느린 것을 확인할 수 있습니다. 그래서 실행 계획을 확인했습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="실행-계획-확인하기">실행 계획 확인하기<a href="#실행-계획-확인하기" class="hash-link" aria-label="실행 계획 확인하기에 대한 직접 링크" title="실행 계획 확인하기에 대한 직접 링크">​</a></h3><p>sql의 실행 계획은 아주 중요하고 성능을 개선할 때 아주 유용합니다.</p><p>실행 계획에는 여러가지 정보들이 있습니다.</p><ol><li><p><strong>ID</strong>: 실행 계획 내에서 각 작업 또는 단계를 식별하는 일련번호입니다. 실행 계획은 여러 단계로 나뉘며, ID를 통해 이러한 단계를 식별할 수 있습니다.</p></li><li><p><strong>Select Type</strong>: 쿼리의 각 단계(예: SIMPLE, PRIMARY, SUBQUERY)에 대한 실행 유형을 나타냅니다. 이는 MySQL이 데이터를 선택하고 처리하는 방식을 나타냅니다.</p></li><li><p><strong>Table</strong>: 실행 계획에 포함된 테이블의 이름 또는 별칭입니다. 어떤 테이블이 사용되는지를 확인할 수 있습니다.</p></li><li><p><strong>Type</strong>: 테이블 접근 방식을 나타냅니다. 이 값은 인덱스 스캔, 풀 테이블 스캔 등과 같은 값일 수 있으며, 성능에 큰 영향을 미칩니다.</p></li><li><p><strong>Possible Keys</strong>: 사용 가능한 인덱스를 나타냅니다. MySQL이 어떤 인덱스를 사용할 수 있는지 알려줍니다.</p></li><li><p><strong>Key</strong>: 실제로 선택된 인덱스입니다. 이 값은 가능한 인덱스 중에서 실제로 사용되는 인덱스를 나타냅니다.</p></li><li><p><strong>Key Len</strong>: 사용된 인덱스의 길이를 나타냅니다.</p></li><li><p><strong>Ref</strong>: 인덱스를 사용하여 테이블 간의 연결을 나타내는 열입니다.</p></li><li><p><strong>Rows</strong>: 각 단계에서 예상되는 행의 수입니다. 이 값은 성능 평가에 중요한 역할을 합니다.</p></li><li><p><strong>Extra</strong>: 기타 정보를 제공합니다. 이 칼럼에는 추가 정보 및 힌트가 포함될 수 있습니다.</p></li></ol><p>이렇게 여러 칼럼이 있습니다. 그 중 성능에 큰 영향을 미치는 칼럼 두 가지만 자세히 알아보겠습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="type">Type<a href="#type" class="hash-link" aria-label="Type에 대한 직접 링크" title="Type에 대한 직접 링크">​</a></h3><ol><li><strong>const</strong> : 쿼리에 Primary key 혹은 unique key 칼럼을 이용하는 where 조건절을 가지고 있고, 반드시 하나의 데이터를 반환하는 방식이다. (옵티마이저가 해당 부분은 상수로 처리하기 때문에 const라고 한다.)</li><li><strong>eq_ref</strong> : 조인에서 Primary key 혹은 unique key 칼럼을 이용하는 where 조건절을 가지고 있고, 반드시 하나의 데이터를 반환하는 방식이다. (const와 다른 점은 eq_ref는 조인에서 사용된다는 점이다.)</li><li><strong>ref</strong> : eq_ref와 다르게 join의 순서와 관계없이 사용된다. 그리고 primary key, unique key도 관계없다. 그냥 인덱스의 종류와 관계없이 <code>=</code> 조건으로 검색할 때 사용된다</li><li><strong>fulltext</strong>:  mysql 전문 검색 인덱스를 사용해서 레코드에 접근하는 방법, 전문 검색할 컬럼에 인덱스가 있어야 한다. "MATCH ... AGAINST ..." 구문을 사용해서 실행된다</li><li><strong>range</strong>: 인덱스를 이용해서 검색하는데, 검색 조건이 <code>&gt;, &gt;=, &lt;, &lt;=, BETWEEN, IN()</code> 등의 연산자를 사용하는 경우이다. 보통의 인덱스 스캔이라고 하면 range, const, ref를 칭한다</li><li><strong>index</strong>: 인덱스 풀 스캔이다. 인덱스를 이용해서 테이블의 모든 레코드를 읽는다. 인덱스를 이용해서 테이블을 읽는 것이기 때문에 all보다는 빠르다.</li><li><strong>all</strong>: 테이블 풀 스캔이다. 테이블의 모든 레코드를 읽는다. 가장 느린 방법이다.</li></ol><p>실행 계획에서 자주 보이는 type들만 <strong>성능이 좋은 순</strong>으로 정리해봤습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="extra">Extra<a href="#extra" class="hash-link" aria-label="Extra에 대한 직접 링크" title="Extra에 대한 직접 링크">​</a></h3><ol><li><strong>using filesort</strong>: 정렬을 위해 별도의 파일 정렬을 수행한다. 이는 인덱스를 사용하지 않고 정렬을 수행한다는 의미이다. 이는 성능에 좋지 않다.</li><li><strong>using index</strong>: 인덱스만으로 쿼리를 처리한다. 이는 인덱스만으로 쿼리를 처리하기 때문에 성능이 좋다.</li><li><strong>using join</strong> buffer: join이 되는 칼럼은 인덱스를 생성한다. 하지만 driven table에 적절한 인덱스가 없다면 driving table에 있는 모든 레코드를 읽어서 join을 수행한다. 그래서 이걸 보완하기 위해 driving table에 읽은 레코드를 임시 공간에 저장하는데 그 곳이 join buffer이다.</li><li><strong>using temporary</strong>: 쿼리를 처리하기 위해 임시 테이블을 생성한다. 인덱스를 사용하지 못하는 group by 쿼리가 대표적인 예이다.</li><li><strong>using where</strong>:  mysql 엔진이 별도의 가공, 필터링 작업을 처리한 경우일 때만 나타난다. 범위 조건은 스토리지 엔진에서 처리되어 레코드를 리턴해주지만, 체크 조건은 mysql 엔진에서 처리된다.</li></ol><p>type뿐만 아니라 extra도 쿼리의 문제를 파악하는데 아주 큰 도움을 줍니다. 그 중 자주 보이는 것들에 대해서만 정리해봤습니다.</p><p>그럼 아까 생성한 쿼리의 실행 계획을 확인해봅시다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+--------------+------------+--------+----------------------------------+---------+---------+---------------------------------------------------------+--------+----------+--------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | select_type | table        | partitions | type   | possible_keys                    | key     | key_len | ref                                                     | rows   | filtered | Extra                                      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+--------------+------------+--------+----------------------------------+---------+---------+---------------------------------------------------------+--------+----------+--------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | SIMPLE      | station      | NULL       | range  | PRIMARY,idx_station_coordination | PRIMARY | 1022    | NULL                                                    |      2 |   100.00 | Using where; Using temporary               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | SIMPLE      | charger      | NULL       | ALL    | PRIMARY                          | NULL    | NULL    | NULL                                                    | 240340 |    10.00 | Using where; Using join buffer (hash join) |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | SIMPLE      | chargersta   | NULL       | eq_ref | PRIMARY                          | PRIMARY | 2044    | charge.charger1_.charger_id,charge.station0_.station_id |      1 |   100.00 | NULL                                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+--------------+------------+--------+----------------------------------+---------+---------+---------------------------------------------------------+--------+----------+--------------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>station 테이블에 대해서는 range 스캔, 임시 테이블을 생성하고 있습니다, 그리고 charger에서는 테이블 풀 스캔, join buffer까지 생성하고 있습니다. 다행히도 chargersta 테이블에서는 적당한 조건을 생성한 것 같습니다.</p><p>다시 한번 쿼리를 보고 실행 계획이 이렇게 나온 이유를 알아보겠습니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> charge_station s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> charger c </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> charger_status cs </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">group</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>아까 얘기했던, using temporary와 using join buffer가 발생하는 이유의 공통점을 찾아보면, 인덱스가 문제인 것을 유추할 수 있습니다.</p><p>station과 charger를 join할 때, driven table 즉, charger 테이블에 적절한 인덱스가 없어 성능이 나빠진 것이라 의심하여, 인덱스를 생성하고 다시 한번 실행 계획을 확인했습니다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+--------------+------------+--------+----------------------------------+-------------------+---------+---------------------------------------------------------+--------+----------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | select_type | table        | partitions | type   | possible_keys                    | key               | key_len | ref                                                     | rows   | filtered | Extra         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+--------------+------------+--------+----------------------------------+-------------------+---------+---------------------------------------------------------+--------+----------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | SIMPLE      | station      | NULL       | range  | PRIMARY,idx_station_coordination | PRIMARY           | 1022    | NULL                                                    |      2 |   100.00 | Using where   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | SIMPLE      | charger      | NULL       | ref    | PRIMARY,idx_station_id           | idx_station_id    | 1022    | charge.s.station_id                                     |      3 |   100.00 | NULL          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | SIMPLE      | chargersta   | NULL       | eq_ref | PRIMARY                          | PRIMARY           | 2044    | charge.charger1_.charger_id,charge.station0_.station_id |      1 |   100.00 | NULL          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+--------------+------------+--------+----------------------------------+-------------------+---------+---------------------------------------------------------+--------+----------+---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 charger 테이블에 인덱스를 생성한 것만으로도 실행 계획을 깔끔하게 개선했습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="결과">결과<a href="#결과" class="hash-link" aria-label="결과에 대한 직접 링크" title="결과에 대한 직접 링크">​</a></h3><p>아래는 인덱스를 생성하기 전 실행 속도입니다.</p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/106640954/1130eee6-c2b9-4846-b294-73de78b0f070" alt="개선_전" class="img_ev3q"></p><p>아래는 인덱스를 생성한 후 실행 속도입니다.</p><p><img loading="lazy" src="https://github.com/woowacourse-teams/2023-car-ffeine/assets/106640954/d024330a-c233-4e75-a28b-1b01b6ae3245" alt="개선_후" class="img_ev3q"></p><p>315ms -&gt; 24ms 로 약 13배 빨라진 것을 확인할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론">결론<a href="#결론" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><p><strong>실행 계획 확인은 필수입니다!</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="참고">참고<a href="#참고" class="hash-link" aria-label="참고에 대한 직접 링크" title="참고에 대한 직접 링크">​</a></h3><p>real mysql 책</p>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="mysql" term="mysql"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 팀의 협업 일화]]></title>
        <id>https://car-ffeine.github.io/30</id>
        <link href="https://car-ffeine.github.io/30"/>
        <updated>2023-08-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[레벨3 때 프로젝트를 진행하면서, 저희 팀은 많은 협업을 진행했습니다.]]></summary>
        <content type="html"><![CDATA[<p>레벨3 때 프로젝트를 진행하면서, 저희 팀은 많은 협업을 진행했습니다.</p><p>처음에는 프론트엔드, 백엔드 서로 각각의 분야만 개발을 해왔고 협업이 익숙하지 않아서 많은 부분에서 문제가 발생하곤 했습니다.</p><p>이런 과정에서 저희 팀은 어떻게 대처를 했을까요?</p><p>한 가지 일화로 저희 팀의 제이와 센트의 필터 적용 부분을 설명 드리겠습니다.</p><p>조회 시에 필터 적용 부분을 만들 때 기존에 작성해둔 API 명세대로 서로 작업을 진행하고, 중간에 생각하지 못한 부분에 대해서는 서로 대화를 많이 했습니다.
대화를 하면서 진행을 했지만 발견하지 못한 문제점이 있었습니다.</p><p>바로 충전소 회사 명에서 key 값을 어떻게 하냐에 문제였습니다.
예를 들면 충전소 회사 명에서 <code>광주시</code>라는 이름이 있었는데, 이 필터는 실제로 두 가지가 존재했습니다.</p><p>하나는 경기도 광주, 하나는 전라도 광주였습니다.</p><p>이런 부분에서 불필요한 지역의 필터까지 걸리게 되는 문제가 있었습니다.
협업하는 과정에서 이를 발견했고, 즉각 조치를 취했습니다.</p><p>조치를 취할 때 서로에게 각자 편한 방법이 있었지만,
단순히 서로에게 편한 작업을 하지 않았고, 팀원과 상의하면서 추후 진행에 문제 없는 방향을 찾고 진행할 수 있었습니다.</p><p>지금 생각해보면 만약 각자에게 편한 방식으로 문제를 수정했다면, 다른 팀원이 다른 작업을 할 때 지장이 갔을 수도 있고 불필요한 작업을 했을 수도 있었을 것 같습니다.</p><p>이 시점을 계기로 저희 팀끼리 예상하지 못한 문제를 작업 중에 발견하더라도 다른 팀원에게 공유하고 서로 짧은 회의를 통해 문제 해결 방안을 같이 찾는 것이 자연스럽게 팀문화로 자리 잡게 되었습니다.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[useSyncExternalStore로 만들어보는 전역상태관리 도구]]></title>
        <id>https://car-ffeine.github.io/29</id>
        <link href="https://car-ffeine.github.io/29"/>
        <updated>2023-08-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[저희 카페인 팀에서는 지도와 React를 결합을 해야했습니다.]]></summary>
        <content type="html"><![CDATA[<p>저희 카페인 팀에서는 지도와 React를 결합을 해야했습니다.</p><p>프로젝트 초기에는 Google Maps API를 React DOM이 아닌, 바닐라 JS의 영역에서 다루기를 희망하였고, 여러 테스트 결과 두 영역을 분리하는 것은 성공적이었습니다.</p><p>React는 그저 부착 당할 DOM을 외부(Google Maps API)로 내어주는 기능에 불과하였고, 지도와 React가 서로 협력 해야할 때만 연락을 하는 구조를 취하고자 했습니다.</p><p>예를 들면, React UI는 UI대로 동작하고, 지도는 지도 대로 동작하다가 어느 순간에만 서로가 서로를 조작할 수 있으면 됐습니다.</p><p>이를 가능하게 하는 기술로 useSyncExternalStore를 선정하게 됐습니다. 이 훅에 대한 자세한 내용은 <a href="https://leirbag.tistory.com/144" target="_blank" rel="noopener noreferrer">제 블로그</a>나 <a href="https://react.dev/reference/react/useSyncExternalStore" target="_blank" rel="noopener noreferrer">공식문서</a>에 나와있으므로 설명을 간략히 하자면 useSyncExternalStore는 React DOM 내부가 아닌 외부 저장소(JS)에서 React DOM을 조작할 수 있도록 하는 커스텀 훅입니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/0-1-2c53bc0990b8cf91a1893fcfa24a884d.png" width="1278" height="682" class="img_ev3q"></p><p>이 훅은 React 18에 출시되었으며, 외부 저장소와 React의 소통을 원활하게 돕습니다. 따라서 저희 서비스에서 활용하기 적절하다고 판단했습니다. 이 기능을 어떻게 하면 더 효율적인 방법으로 재사용할 수 있을지 고민하였고, 여러 추상화 단계를 거쳐 라이브러리 수준으로 제작할 수 있게 되었습니다.</p><p>하지만 이후에 TanStack Query를 도입하는 과정에서 각종 기능이 React Component 내에서만 사용이 가능하도록 강제되었고, 따라서 더이상 지도 API를 바닐라JS 영역에서 다룰 수 없어 React DOM으로 이식 하게 됐습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/0-2-2f8127b08e601f58c527a10322b31e6f.png" width="1033" height="682" class="img_ev3q"></p><p>이미 만들어 둔 기능이 붕 떠버린 상황이었지만 어찌 됐든 클라이언트 상태에 지도 인스턴스를 넣어야 하는 상황이라 useSyncExternalStore를 프로젝트 끝까지 클라이언트 상태 관리 도구로써 사용하게 됐습니다.</p><p>저희 팀에서 사용한 상태 관리 훅의 추상화 과정은 다음과 같습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="use-external-state-구성-및-동작-원리"><strong>use-external-state 구성 및 동작 원리</strong><a href="#use-external-state-구성-및-동작-원리" class="hash-link" aria-label="use-external-state-구성-및-동작-원리에 대한 직접 링크" title="use-external-state-구성-및-동작-원리에 대한 직접 링크">​</a></h2><p><strong>Store는 상태 관리 인스턴스를 생성한다</strong></p><p>바깥에서 주어진 초기 상태 값은 StateManager라는 클래스에 전달됩니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/1-cacfe7a641d0016ddbf2969aea2d8f42.png" width="1101" height="291" class="img_ev3q"></p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> store </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initialState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> stateManager </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">StateManager</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name constant" style="color:#36acaa">T</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initialState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> stateManager</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>초기 상태 값을 전달받은 store 함수는 StateManager라는 어떤 상태 관리 인스턴스를 생성합니다.
생성된 StateManager 인스턴스가 반환되어 store가 곧 초기 값을 가지는 StateManager가 됩니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/2-599e3eff09dd4829f3f6d2e7a4a3ea91.png" width="1280" height="280" class="img_ev3q"></p><p>예를 들어, 다음과 같은 코드가 있다고 할 때</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> countStore </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">store</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name builtin">number</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>countStore는 곧 0을 초기값으로 가지는 StateManager 인스턴스이기도 하게 됩니다.</p><p>그러면 StateManager에 대해서 알아보겠습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="statemanager는-react-바깥에-있는-어떤-저장소이다">StateManager는 react 바깥에 있는 어떤 저장소이다.<a href="#statemanager는-react-바깥에-있는-어떤-저장소이다" class="hash-link" aria-label="StateManager는 react 바깥에 있는 어떤 저장소이다.에 대한 직접 링크" title="StateManager는 react 바깥에 있는 어떤 저장소이다.에 대한 직접 링크">​</a></h3><p>(근데 이게 그냥 저장소는 아니고 좀 특별한 저장소다.)</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">SetStateCallbackType</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name constant" style="color:#36acaa">T</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prevState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">DataObserver</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name constant" style="color:#36acaa">T</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">setState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">param</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SetStateCallbackType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">getState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">subscribe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function-variable function" style="color:#d73a49">listener</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">emitChange</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">StateManager</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name constant" style="color:#36acaa">T</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">DataObserver</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name constant" style="color:#36acaa">T</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> listeners</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Array</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initialState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> initialState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">setState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">param</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SetStateCallbackType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">param </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name builtin">Function</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> param</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emitChange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">getState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">subscribe</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function-variable function" style="color:#d73a49">listener</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">listeners </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">...</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">listeners</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> listener</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">listeners </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">listeners</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> l </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> listener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">emitChange</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> listener </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">listeners</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">listener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> StateManager</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>StateManager 클래스는 외부에서 받아온 초기값을 상태로 가집니다.
setState, getState, subscribe, emitChange를 메서드로 가집니다.
여기서 작성된 코드들은 react에서 외부 저장소와 소통하기 위한 <a href="https://react.dev/reference/react/useSyncExternalStore#subscribing-to-an-external-store" target="_blank" rel="noopener noreferrer">최소한의 규격</a>입니다.</p><ul><li><p>subscribe: 단일 콜백 인수를 사용하여 스토어에 구독하는 함수입니다. 스토어가 변경되면 제공된 콜백을 호출해야 합니다. 그러면 구성 요소가 다시 렌더링 됩니다. 구독 기능은 구독을 정리하는 기능을 반환해야 합니다. (구독에 관련된 데이터는 리스너 배열 필드에 넣어서 관리합니다.)</p></li><li><p>emitChange: 리스너 배열 필드에 담겨있는 모든 리스너를 실행합니다. 즉, 구독된 어떤 것을 순차적으로 실행하게 합니다. 이는 리액트 DOM을 강제로 일깨워주는 옵저버 패턴의 역할을 하게 됩니다. 이 과정 때문에 react DOM이 정확한 재 렌더링 지점을 파악할 수 있게됩니다. (최적화 문제에서 자유로워짐)</p></li><li><p>setState: 상태를 업데이트합니다. 다만 상태가 업데이트 됐음을 알려야 하므로 emitChange를 실행시켜 react DOM을 강제로 동기화시킵니다.</p></li><li><p>getState: 호출되는 순간 현재 상태 값을 읽습니다.</p></li></ul><p>좀 어렵지만 리액트에서 이런 규격을 가져야 useSyncExternalStore훅을 쓸 수 있게 해 줍니다.
기존 예제에서는 단순한 자바스크립트 객체로 짜여있었지만 인스턴스를 자유롭게 찍어낼 수 있는 class 구조로 개선하고 추상화하였습니다.</p><p>사실 여기까지만 구현해도 useSyncExternalStore를 사용하는데 지장이 없습니다.
앞서 선언한 store객체에서 subscribe와 getState를 꺼내서 직접 전달해 주면 그만이기 때문이죠.</p><p>하지만 결국 이 과정 자체가 반복된 작업을 요구하게 됩니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="리액트-컴포넌트에서-쉽게-접근하도록-출구를-열어주자">리액트 컴포넌트에서 쉽게 접근하도록 출구를 열어주자!<a href="#리액트-컴포넌트에서-쉽게-접근하도록-출구를-열어주자" class="hash-link" aria-label="리액트 컴포넌트에서 쉽게 접근하도록 출구를 열어주자!에 대한 직접 링크" title="리액트 컴포넌트에서 쉽게 접근하도록 출구를 열어주자!에 대한 직접 링크">​</a></h3><p>리액트 컴포넌트에서는 바닐라 JS로 상태를 업데이트하는 것보다는 useState와 비슷한 형태로 훅을 사용하는 것이 훨씬 보기 깔끔할 것입니다.
매번 스토어에서 무언가를 직접 꺼내지 않도록 하는 중간 커스텀 훅이 필요합니다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> useExternalState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  store</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DataObserver</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">param</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SetStateCallbackType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> subscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> getState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setState </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useSyncExternalStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">subscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> getState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setState</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이 훅은, 바깥에서 받아온 store를 활용하여 구독/업데이트 기능을 배열로 반환합니다.
모식도를 그려보면 다음과 같습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/3-5cac69669952e5ff6f5cbae0f5fc94bf.png" width="1280" height="728" class="img_ev3q"></p><p>React 컴포넌트는 어디선가 생성된 store() 객체를 useExternalStore에 넘겨주고, <!-- -->[<!-- -->상태, 상태업데이트함수<!-- -->]<!-- -->를 받게 됩니다.
마치 기존의 useState나 useRecoilState처럼 말이죠.</p><p>정리하면 다음과 같습니다.
푸른 영역은 React DOM
녹색 영역은 직접 호출해야 하는 라이브러리의 영역 (하지만 최대한 단순한 형태로 구성해서 개발자의 부담을 덜어주는 형태)
빨간색은 개발자가 직접 건들지 못하지만 간접적으로 사용할 수 있는 영역
노란색은 React 18 엔진의 영역입니다.</p><p>이외에 제공되는 다른 커스텀 훅들도 거의 비슷한 구조를 띄고 있습니다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 추가로 구현할 수 있는 함수들</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> useSetExternalState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">store</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DataObserver</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> setState </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> setState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> useExternalValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">store</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DataObserver</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> subscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> getState </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useSyncExternalStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">subscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> getState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 바닐라JS 영역에서 자연스러운 읽기를 지원하는 함수</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getStoreSnapshot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">store</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DataObserver</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>더 다양한 예제는 <a href="https://github.com/gabrielyoon7/external-state/tree/main/src/examples" target="_blank" rel="noopener noreferrer">여기에서 확인</a>할 수 있고
작성한 라이브러리 코드 전문은 <a href="https://github.com/gabrielyoon7/external-state/tree/main/src/lib/external-state" target="_blank" rel="noopener noreferrer">여기에서 확인</a>할 수 있습니다.</p><p>겨우 파일 수십 줄로 만든 초경량 상태관리 라이브러리였습니다</p>]]></content>
        <author>
            <name>가브리엘</name>
            <uri>https://github.com/gabrielyoon7</uri>
        </author>
        <category label="useSyncExternalStore" term="useSyncExternalStore"/>
        <category label="전역 상태 관리" term="전역 상태 관리"/>
        <category label="전역상태" term="전역상태"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 팀에서 사용한 지도 시스템에 관하여]]></title>
        <id>https://car-ffeine.github.io/28</id>
        <link href="https://car-ffeine.github.io/28"/>
        <updated>2023-08-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요? 카페인 팀에서 사용한 지도 시스템에 대해서 소개하려고 합니다.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요? 카페인 팀에서 사용한 지도 시스템에 대해서 소개하려고 합니다.</p><p>지도 기능에서 가장 핵심인 기능 두 가지를 뽑자면, 지도 그 자체와 지도 위에 그려지는 마커를 뽑을 수 있을 것입니다. 지도 위에 마커를 그리는 일은 그다지 어렵지 않고, documents 에 있는 예제들을 잘 따라하면 누구나 충분히 구현할 수 있을 것입니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/markers-on-map-f97990b9b929327cd5e6990126ea5efe.png" width="518" height="432" class="img_ev3q"></p><p>하지만 마커의 갯수가 과도하게 많다면 어떤 전략을 세울 수 있을까요?</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="카페인-팀에서는요-">카페인 팀에서는요 ...<a href="#카페인-팀에서는요-" class="hash-link" aria-label="카페인 팀에서는요 ...에 대한 직접 링크" title="카페인 팀에서는요 ...에 대한 직접 링크">​</a></h3><p>카페인 서비스에서 지도는 굉장히 중요한 요소 중 하나였습니다. 사용자들이 궁금한 장소의 주변에 있는 충전소를 시각적으로 제공해주기 위해서는 지도를 잘 제어할 수 있어야 했습니다. 특히 전국에 이미 <code>수만 대의 충전소</code>가 보급이 된 상황에서 충전소 마커를 모두 그려주기 위해서는 많은 제약이 있었고, 마커를 적당한 수준으로 렌더링 하려면 클라이언트와 서버 간에 특별한 작업이 필요했습니다.</p><p>어떤 전략을 펼쳤는지 소개하기에 앞서 미리 말씀드리지만, 저희 팀에서 취한 지도 관리 전략은 모든 프로젝트에 유효하지 않을 것입니다. 지도 위에 한번에 표현할 마커의 갯수가 수백 개 이하라면, 서버에 데이터가 과도하게 많은 것이 아니라면 오히려 이러한 전략이 사용자 경험을 해칠 수 있을 것입니다. (환경이 원활하다면 데이터를 가능한 많이 보여주는 것이 좋을테니깐요.)</p><p>또, 이 글에서는 Google Maps API를 기준으로 설명하고 있지만, 지원하는 기능이 일부 다르더라도 대부분의 지도 API에서 사용이 가능한 전략일 것입니다. 참고로 개인적으로 사용 해본 여러 벤더 사의 지도 API들은 모두 이와 유사한 기능을 제공했습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="좌표란-무엇일까">좌표란 무엇일까?<a href="#좌표란-무엇일까" class="hash-link" aria-label="좌표란 무엇일까?에 대한 직접 링크" title="좌표란 무엇일까?에 대한 직접 링크">​</a></h3><p>아마 어린 시절부터 우리나라에는 특별히 38선이라는 것이 존재한다는 사실을 교육받기에 <code>좌표계라는 것이 있다는 사실</code>은 누구나 알 것입니다. 하지만 당장 위도와 경도를 구분지으라고 하면 어떤 선이 위선이고 경선인지 헷갈리기에 찍어야 할 것입니다. 따라서 이 선이 어떤 선인지, 어떤 값을 얘기하려는 것인지 사진과 함께 간단히 설명하겠습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/latlng-ea37cb4d56d09c34d2a8323c14bd2731.jpeg" width="259" height="194" class="img_ev3q"></p><p>사진을 보시면 아시겠지만 위도란, 남북의 위치를 나타내는 데 사용됩니다. 경도는 동서의 위치를 나타내는 데 사용됩니다. 대부분의 공식 문서가 영어로 작성되어있고, 코드에서도 이를 나타내는 것이 중요하기에 영문 표기법까지 소개를 하자면 위도는 Latitude, 경도는 Longitude로 표기합니다. 이유는 모르겠지만 제공되는 변수나 메서드 명으로 lat, lng라고 줄여서 표기하기도 합니다.</p><p><img loading="lazy" alt="no offset" src="data:image/gif;base64,R0lGODlhswFUAfcAAAAAAISEhP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAAAAAAALAAAAACzAVQBAAj+AAUIHEiwoMGDCBMqXMiwocOHECNKnEixosWLGDNq3MixowAAIEOKHEmypMmTKFOqXMmypcuXMGPKnEmzps2bOHPqxDkQgMefQIMKHUq0qNGjSJMS9CmQqdKnUKNKnUq1qlWHTp1e3cq1q9evYKtmDUu2rNmzaNP2XKu2rdu3cONiHCu3rt27eNPSzbsVJN+/fP2i3RtYq0TBFhEDXrxQMUfHhw2TJZwXskLFmCUztMy4c0/NGRFzvgz6K2W8ow+mTo2QtWfArkOXThj76um7tZvOzv35te+lszfy1q2X7V/OIz8mV65bJHPin503D/4bLnLRPkMCz6xcOvbo2sH+mzZeWHVyktDRf58eHn318gaXl2SfNbv8+vTrS+d62y7k9vj1JuBzz4XHHIDvwQdcbwgiCB2BBPploGAO8kdeZZKtByF3D1KolYRMDZdgWf/h952GGkZo34IFUgdVf3WVOCCHHQbIHYgjKjjjisShGGCNG4bIo1cwyiUjkAOqKOCE9hWZo14ZmihlczuyeOB6ExJ5IWrquReklfPl191+T8YV5n0Mepnime6FaWFTi7GJ45dJejkmdiKWSaSaPlLZ53ZMkklmX1vqaeihT+WJWqGINuooUIouCuejlFYq26AjOmnpppzGh2mmjHYq6qiUakrqqai+Z6pUkT7Uakf+lr2aKoTHuSjUqi/OWZCtjbno2KcUxSrrqdr9+iGvrgq53EUGJhqqWEKaN1GKtB0LbEPUJjlrRB5uZyVEo3m4LLfHsvrsVHh6Ou2PpEUnm7bfbosVu83mGW60cxk2bLDnsqqfvshW2Wu8FWULr7wDP/jRwgdvBprBke0a8GP95rogjfU2eeeKzX5rZ3cCdwmyxAjPS/KVNZaobMdKtiaouBm/WHGi5ba8bLFN4jyuwvSBh2+LzrnJc8kunzwnzHgiDTCggQLodMzOTtoVxmku+XO6tGbt7Yn06sfzvpsa22O0DrKsdWb3kS2sulEzPHXNLdqs2Z8NXzylwnQPTTT+21WjHDd7J8e79tgdH6kUrknRiDKWc/8otuBD6ooxu1rvTTCPRw8JOLyPB4705RNrhDhSio8pt7RIDo22kms6vrTl1Xp6d5aB02o4mK+rHnpoMx8Ot7t3Hpy3sDd7Z2felcOeddM+Kw257MafN+7tpPfuu/BeYy9w8phm/PL2yStv++qAlu/xw8XjOGjnh1uf+O6Pwf8T2JzSn+z7UY2Ov6P21y//Wf0Dl/uuh6gA+q8zBnTVAMXHwAZWT2oOjKAEzQXBCVrwgkTRHwY3yEFsLbCDIAyhcf73lvU9TDUiTOGtPmimpbDFRhlSoQw9okEjudBtCwtRDnc1wx6KjoX+1rnhhxiWHRwa0YdI5BYQSyhEIeoQhyRMogxr2MIX3vCKVJRiD7NoHdpVEIpf1KIYW7NEG0Iwhi6M4hhByMUu8vCIR0zgGiPYxrZch4zxmaMe8xjGPfpxW3X8oyCfFMhBGrI6hTykIhFYxkU6kjGJfKQk/dPISVoyRpW8pCbdEkncbPKPnaTkJ/cYSkyOUo+lNOMp15jKKq5yjK00y0teGZUA2PKWuMylLSGZSVl+jFFCo+VGdEnMYhrTk33EUG54dS1hNsSY0IxmMV2pxrfZa11yHKQ0t8nNXHKyl9D6nzizucZuTtOc0CxOMtVitmmJjpw+RKcuBRCAgdRTntP+JBE4aQYrWFVTi/icJz3tKZCA5nM865xMAP8JvEsa1JsFJWhBHyrQqe2zKCIyJwC4GSyGhvChE91lREdKz1uGFKRvgiMKe/bGljKrNBTF5UZjmrBDorOkJsVpPSU6UHvm1JsBJVRCO4S6//DOpzEt5kyTCtErCvKmTc0pT3eKVKTuMqhW0VQRv6jDrS4RJEzd5lLDSky9ifGmOqUqLgki0pKyVaoQxSq6zvXEHFIITl4dKkKYehiIMNWjyotmWtUqVZwWpK1tDelbEQvUbc51nXsRTXrOGBG0UmyY5jzrMQdrVaoa9q0+PWxioxpXaVJQpWCkbEtX5dgMDqW1MxT+LGdP6tm1gnaioh2tbWfL0baVJphcbeJC0pk4pBA3hcetqE5zaxDGNjexy+0sYWVbXL2qFI1rmc1B25aU7XIwuU2NrlWfG9rcela8sx1sWauL2tUWKkoJUW7+piJfC1I3rYuF7m7L61bzmre2+53neo2yKmvh0aX5Pe9ppRLeCd63wftVLHlx+1wFRzi8Aq5vUGKJ4AhTBbAU8XADj0tb/5pYtPzNb4XPC2Hbanh+F73MeFNaFREHdrOdXbGOJ9zfE884wf+lrYJhbN3L2njBVDny3kiMXx9X9SDOhTJ0T7piFru4wURu74bRm9WtKLlkTG6yiiu8V8KWecgexnL+ab88lxhvhs3tu4pMR4zjHDuZylJO8ZjvrOYrw7lgbn7znwlsFYiCOEdhxjKX8cxcCd950WK284uPquUtj3XKMqNveA/9njBD2saFXeyTySxlTIt4zaEWTqBl/BHvxvkp3uX0b+5b4h2T+tapdvSj++znXLe5yJeFk6dda9w6O3VbtI70jx/92WYz+9Rp3u2kAQ3sH74RtkORtXqnXelNJRvS4AY1Y4ccbl9DG66KTsyq+cjubRvb2pjtpgJn9e10i5vczfa1s/cc5CpLN9jaPjaC3W1ZAfo1qe5M1bDvjW99o7vhmGb0s6U9aA9WW92NIetDL63x3lqcVI3Ntb3+ze3wcceX5BFXNIYr3ph1F0qXHO+4WGVOUdqcKuQpL3nOI55vnjP85DvXrb6VeHF+STeXMee5kDfOV4UYtN3eXuvIUQ5xn5v8zFUn99SFrvR5d7vNGvUIOpM+YI5ktuidlvrPsQ70qo/a1nCfeGHTTfSvW8S0K820nAUb8LfgXOtHDrzSH+50qxs+6AAeOlYC/e4Dv9orjUcUqttOeaAXfrqXv3zWK29natu9stx2/APLUvZG9XrzbE/9md8ed34zW9ksZzdg6b74x5uF9iOavOpLjfrV67r1ywa+xJVdd4/GXvQYdcvxAYPq3gt/+I3e9+vBTf0WK57Vn3/m9Q3+fpS+i337r/l7253//J7jm/rVF/zcl+82hrIf+StUPvg7o/vdl1/xhM8853mv+X73Fe37B2/E1hbvdxcUN3hDp2T4d3WWF4DTF21dZ3MAaH8CGH8EOH+LUX/854Cuh2tdp4AJGIL6dXydhHsJl20XeEve9xUHeH4giIAfyIAU2IE0GHzoJ4HZhy2lxywDSHoCtYJc0Xz9x4E2GH0LCIMuKIIjiIFS41FMEXl1BylkUWdA6GUPl4QxiIRDiH4veH5cmGqxF0mGgXcnmGV752lVWGOnt4UbSISM1oXDpYSaZ2VMKIZYR4absWUMJm84mHbj5oVwyIa2FohueIMQ6IX+stdPcYhPeaeIRPF0H1cdpKWFgnh/V1iJ0/eFU2aCWBRsDpFUMfdrIUZzZegbLYiFgHiEizhdqdiKrjiH5ZeIqgZ6FEV2BmWLNIeH3Ddrl4iJNQh9J/ZlhDiDHVhxheQiNIeL8qSMuciHkegZk/iKhWiIvTiNw9iGnZeHEzhwS1dwR8eM3QSOcpVgjNiH0FiNxFiEv/iGRyiN1giG83eM5Phtpch05fh9zuhyhYaO2NiPsdiCqxiQvmiDgxZIT6iLjsiDYYFtaagUAdaOAvmOfxiR6QiMNPhnBgmFUiiKZ7FZDdldV+iOFUmNEzmQFqmO2XiS7nURtnRpSFaKaUH+TB9ZbCU5jSTpjsIIkRTpjxi5RC3JhHroeXCBdOfIdTvpj5kIkCZ5gzeJlLI4igEwk/DndXXxk/S3flkokiOplDaZk1nplCs5EXNmUUZngDPFGFwpkYjolax4lP94fYf4cfAzlmT5f2YZgX6XllsJlzrZlG65jtBnglSkgmEROlLZEVbJfFjpiloJluz4lX+ZksDHZoPZkpNhl3aRmH/xkJC5lNI3iHy5lqHZmEyZRT+Jl3pXe3JBlBm4mJGJkir5mKLZmWrpmE3IkhynJVSZgqypmDXZlX3JeWzGlgwxnPAYgVx0kDv4kuZ4e9t1mD/BmbM5na8pm8UZnCP5aYr+l5zzGHoo+IyQh5DQiY+JR53VaZy/uZcRiJ5otp1fxXvYlnzaeIYeB3UG6JrnOZrXmZ626ZeY+GXcOYf36IlTKRQ0NZ95IZ37SZqZKF7suaDVqZ1dF6Cf2IyISFcZYaEXyo1ViZ/jF6EPGptMyZakCaDvWREaCk22KI4pCpT2mZkemp0huoUzCpy0CZvtp5AP0aLcRHYsyqOc+KKrqZf9WaOqZ6RFqp/+l3fyg4w1d3S1qFQp2p1nB57N05ExKqNKSqNbaqPmOX1ZBFNVGm8zB3MoZXZj2ogcKpRBoaAUGRMNSqTAB6cjKnJDF6ZV5mofJqT0GXm/lZBtmqVtODH+Y7ilSJqDPnGoSoanULqhj6WPZIplf+oydWVg6ZNd8uOmW4gZAmdEM3qo6CModWpqd0pXf6qnlwmp5Llbv3UzkxJZtzlCPXJ3grpjeTVEUPepXQpMl6GopQpZTZgV3gkWHPaIhtacOZqssCqrRESrRhmQdZWsuWqou9pHwbFUEFp+MDJET4StojSeGWpSk7qSdLGssRpFmtp2uLpVJwSYDlqt1yVo2QqmocKtwnaWiwKu4WqZ8FeuVhSr57qv5bmg69qsaqqr65lroWo2+Pqfv4pa6/qEDYsb+ooRdPmi/vqqzBqwFluruaUvzTquIiqnj9auGTev67itAheVO9H+si77sjA7ElFJGswzHe4SrSOTg9honDHUVeaIsF/aqV9HHed2fiq7JVGJmoNRsSxJmGVphc96eSDrs6IHtCjLq292tSp5tGHkkpjEtGLpTfADtul6ZtjVXoWasPw5pwW6FEELm0WCsz2BqiQitzG5XmMbnlGrri61G3HKj0jZqgyrtu2pdE4SLo06GEK7kLHGpvu4t2y3O2n7paAaLPC6qEA0uRqJZGD7X3rauSjqsWNmmH+7tiU7Lb5quJl7hwhpezproGm6pnkJuRtIuu5KsjRomKlrtKu7iuO4kbILFAeKoDBKu7ZGqKXblm6JvLuLfeJ0cM2ImYsLvbkovcX+O7BvChPJi6OQRqfNi4PPG7pAinTG9KMtypH3CbixOKqUC6/be5S0R6EVOr4yuaL0K08web2Aeajvy75a+5akOqEnKqD426hjJ03mO6DD23KbKbq15qXzyr/7S5yxKL9USrfiK5Nl+rsCG5/BO7vYu5QS/GMjHJvfC7462o1BCrwMDBYe/LpT6MAm7L57VsL+yYEmuo1OsbmjR7w+WHqg66whDMGeibs4asNF28IkFIo05sNoMU1BLMS3S8Mjq75JScXAmMMwXFBjhVC7KX8XyxdGXMU32oYljMTHiYimmbTEirzpG8VSfMRYbLX5SbhuSZks5LS6ab1xoZliLMP+aNy+avu/VxzAapzHeixU+TuUE5uggEzBImzF3Euid3x9lcmvirzIftfIeBGNhDzJfQnJtQm/eAyAYbynGHeXjsqboFzGAKy8RBzL3CutYZu0q2yBjgvGbIyWj+zKhQzLWurLRQhnXKSCBZjCufzE5FuUQ5ykwmydkWzHDouXGbmcG6ZGcJyn4mqKkkzGDErC2Lm+oiyiAMuDL1yByKy3x5XNHfuH3zzDnTnOr+y761vOOuqNT0tpj1ufW3y3xjvBz/yuAS3PuwZ+8qjN+Kym+mwUC/zBndzNN2ybY0zQAG1h8ZhJRNtxXYzOtVy9VtqapivHAw3RFC3SFq20iRT+MDGVwBt8vzys0FdJ0nIYzcAs0TPtgCuc0hJhjzLH0tGrySBd0/M8yhH9y6SstLS80Ky7jD7d0i49bDDNzJJZ0YsYkV5Zx6h40qtsh0u9uRnN0wMKleesqvss1FRtkkZc0ip5iFsNTpLRutiHy2o4bOyMmDJNiYWY1uF81u4alrPobslMQ4wLxE8ihHm91+CM1xXZhXSI1EnNO9a8i9/5w6xaJnr9zIR4jUaN00AZShuNvpONpdts2Wt42Ipdaqxniae9pMQ3n8bHyYHNwsqMyYXdzZoN0Kn9gDfNky4aSYmcGFVY16K1UYaigaqNilX9e8eN1qG2wp2IprSdz93+t8mO7ZtmDZsvmNyfKWqmjdwNemDu99t8TGjKB9sJYty6DYParYrdLYjO/dxkCsMzKdxuW93WfU/qd3jMjXntfYcfOtWqaXzirZqpiaXmnXulDZa3PWq7/Xz53di3DN/QbcuSzV0xfJqPgt7YrXNYmNsoueBc9t5+bde27J6o7MJmaikJ7uAcrn/bfZL5/d+z7LyvZYsEU+BzXb5R91MtvtjqrdzcnY4xDmSpHHDK6K2PChVnR98gaVJbR35BjtpA7uHpR3XlGeFPOdkaDNeyHahhzeQOqXZU54bqR+VD7pQr56JZHtoT1dQYTOA7TYpRTSniB59CrnNm3uP+Zuf+AF58091uT22mgY6aYA5rYh50RFjmU15u+s3nD6yjKwiyBNyibs7BH73jV1W0gIfovvfia7fnSyriKDx62hXolQ6JcA5ykffpt+aBbkeMDMeKWD7qpMMZY43QPWrpXS2Y8lJvrB7lRmh4sK7p//bXwa0ZUB2URQHVhZ7jy/nr6ph/wgftYjasXgeE0frmbH4UrtbsZV1fKjfmUr7d1M5r7jzrNC6XO8M0AGvtch3mEebt327uhbvpnY5yM0jvO+Xu144tt8GpLSfqXW7oUiXvfRruhtzpwW7vSEns6eWI1OFVaGS3qqHmyq5pu2TwULuDCF/v426nCQ/qkibwcsn+wGPRHhp7nfAUhUnGsg6UaHE57WbW8Gms1ftO8iVP65IVJO10ykmeZAdONDCfxuOOYhTW6gTJ1kI22SJLGL7Cf/oa9RYvKkxm7kV/Wz0WfcV4YaeH7v1OqZ/y9LZqG7ZxzJxS9TF/kTPPZzXfb/xelrZisnENZONZ92bfKQ/G9Ztop3oWmM0tnZmO89wX9xt7bKUuU4eZ+J9tXyRmfSedZ0cP7CEO+Pgt+INP4O0UPL4b3a7L7SVu32BWZ2m+hBbd93rPdVeu7RD/7Ujew8suU3dPbzimXKfPY3tP+uRowFMP9xvPsm8v3auqgq0vQrJF+39f+pH/e5SvwpZ/gmT+a8z0mM5Ni8CgH0HEVVGjb/RZj17RKFK3zvSMC1aoXuGbz9TllE7Yz5nav4REzln8zF7sLP4peuqOtfKh74zqj/Xsn9gJDf/qRHAAEUDgQIIFDRIEcFDhwoUCHDoE8FDiRIoVLV7EmFHjRo4dPX68yPCggIIPCUoUaDIAyoEqW4psCFKmxogQZ97ECbEmRZg9Byb0KRIjgJ05jR5FmlTpxKApSzpsidIk05RQTzY9ufTmzqJaver8iBVoT5lEv55Fm9Yr1qdZoU51uZIkW4NqP3K1+5VoV6R8j+7NG1jw4Ix0X0YlCXeuU8NuCQ996PcxTrNKJW+9PFnzZq2N3cr+TWzVs2POFPGW/lvZaGaPgFG/hq109FvaoxHHnngaN2XVM1nT7L1b+HCPs0UbJy5Rd/Kyru82D85c+nSethtTVx4ZO+boF39Hdr5d/HjrQcdrt3ne997w2Suyb69e/vbydeenF/D9fkb4/fvvBzBAugI0DT0C+zowQQUXbM1ABn17MEIJGVxuwo70szBDDXercEPIPAQxROE6FDG3Ek9EcTISU8QwRRdfhBA/GPObsUYbc1rxRh135NE9GnsEMsgdcxSySCM3JPJIJZdUMEkmn4RSPSejpLLK5Ka0MkstS8MyQfZyYw2+LcecrksCizqNKzTJZJM6MwNc80ebaqL+s007mXsTwDjXrFPOO/+MLc/99nSvNzEBRVQzQe8j1EHvEoV0sEUZdS5O/iLF1K5J9XTwuxYzBfU5GZHsqk8TfQw11aQ2lVKy7nSKT1VZt3J0VlsRZfVWXY3MdVdfe+z1V2FtDHZYY10s9lhlRUx2WWc1bPZZaSOMdlprvaz1Wm2RzXZbb5nt9ltxoQ13XHOpLfdcdbEdFccYQfp0Nd7i3ehVXi17Ny96V01XVJoevRC7fevFz94h9WqQ3HYp4+iyFgcmDOIP51yYR4kBbhjJfhM2zaxDaTx0uS/BA5Mv3VyLyFCSlYsu5PzUxMtjjEGu+OCOYy6Vz5FFDi+4+E7+rixlS3022N2ay3qv4FP9PNlAU011Oj06Uy5UaT9RlVnOqV++ulOwjjQZvaDFjrpsrcmWusC0f8x67TTPSjZsq80+m+m5M6O6bqjzrnvmPt9m2yJLl5Q78LX7HlrGp8vNG3A+6Ub4aHjV7ntuvasmWnDDN89OaDD9XvrvigdXsvDFEff68MAzT/p0v6hmPfKuGQ7dUZHRltrh1q1+nWvNk7YdbaixhtJ03s1O3G7fgTfR9dZ1l/1iVO+uvexGu3bV+t3bzT54t2sevnTKnV/+dtVPnx75hfkuXKu4R3658erBU+3jnu1FU+be42cZeu7rV13HqGQ/ABaMfbarFPz+7uc//vGtUIYqmtFmty5ISU9jkqPgnSyosAlm8E8b5CAIPQikWJFwYyNEoZtOmEIWEqdaSxGhdOD3NWGVkDcUWqH7QMcZiD3MR0+L4ZOCyLkI5lBSRsTX7zColh5yjIicS1UQG6WfIf4FidyJH9FQtryVvcdkY1OcxxQIQC1CcH/ng2KmXFY/MjqQeGmEVRarSLsOwtByS/Pd9aomPO0pTmxuHFWH9Lg1W+Vvc1tr2xu5uMc68vCKk7ujIps2P8AdMnWGO2MkB/mrKfJxdqRj3gutuER5RfKSOHveD49nuUoyz5QKTN+sSOe49cWSki58pL9ylLxFsmx8q6xcKyn+Z0q6zVGI06PlJ22pSlI+RpTM7CAvBam+y7ESd66snC8ZuatZerJ7noJcoHJ5l6wxkGeuKiP9YAbFSk2Mfl4UnDGLl752wpGGwJHfcJ6JyxYqa5/67Kc/xykfeQY0Sv8ckUGNhVCFNpSOBXVoRCHZyIkuk2B29KINLyo7LWmUo3gcpTo/p6mBChCk/yrpMMcJyo0OE6IXpGhgwtSawVWyiEhrZsZK5a+Y8jSnrqSXObf0Up+qFKV+tFv4QipCN+YPlWvE29jSedJ3Kg2qQxFje6460nulsotd9BzqmIbKkplRicp7XE91iVFpgoVno8sd9W5WQEuGEa7ZxNrefor+IocdEK1f82tdCZlJvF4Nln+MHkbFislThhKYFCVfMLM1SaBSU0hT22Jdq7k6mgWwsDutZepYqlimMlKYylPm4fR6qc2aL7WFRerZbgojue1UZXStE+yu+cr5KfKJaWmWbfsoScduFrLAdO0ZdwnN2c4ItIb9YvV0e1oSPTeTmwRuSuk5yfZVF3er9V5rG/tL8DFXuxmq6S1Vi9jv8haavj2tV4ILVLqO92ad1doMYaXF/iU3nvmsbBiJCiet3rd/lh0abrHJPwPvl6vZ3atEJQy3807Ywu8a8IU1TMwNd1i+FfZwiIsrYhKT9kYZHtZ/VORSi4ozwhNCcQ3pWEr7+BZVXyCG04abiCA85inGDH3NDHumzTi2sK/rlON/55Sz7uT2fwf+mExxfKX2rlKpGVQxY1GrtsGGk7OG/d6LaRzjFa/XzGQGlXJDS95W9s7JzGyfYICMGpuSDYIBVfM9J1jnLWvnzX425JQ3iuaIVZlt3WNhni8p3Wu6mWJE7q2cBQ1QM2tWzNNSdGwZjcYAvxe2TJz0iBb4QzYSOlIEhJ3PvKM/p+l30VVl8KUfCtMSnzrUHKq1Gm+NG1PnGkRz5pKvbS1rYdca2MXGszr9s2xmN9vZz4Z2tKU9bWpX29rXxna2tb1tbnfb298Gd7SRPW5yl9vc535NQAAAOw==" width="435" height="340" class="img_ev3q"></p><p>위도와 경도만 알면, 지구 위의 어떤 위치를 나타낼 수 있습니다.</p><p>따라서, 어떤 마커를 어떤 위치에 찍을 것인지는 위도와 경도 값으로 결정할 수 있게 되겠죠?</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="사용자가-어딜-보고-있을까">사용자가 어딜 보고 있을까?<a href="#사용자가-어딜-보고-있을까" class="hash-link" aria-label="사용자가 어딜 보고 있을까?에 대한 직접 링크" title="사용자가 어딜 보고 있을까?에 대한 직접 링크">​</a></h3><p>지도 api에서 제공해주는 메서드를 활용하면 사용자의 디바이스가 어느 위치를 보고 있는지 알 수 있습니다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* 어디선가 생성된 구글 맵 객체 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> center </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCenter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">center</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lng</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 디바이스 중심의 longitude</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">center</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 디바이스 중심의 latitude</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>지도 객체로 부터 중심점을 알게되면 해당 디바이스의 중심의 좌표를 알아낼 수 있게 됩니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/get-center-85e738798dd1128d0ffcb260fc2b5f87.png" width="1627" height="1015" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="사용자의-디바이스는-얼마나-넓게-보고-있을까">사용자의 디바이스는 얼마나 넓게 보고 있을까?<a href="#사용자의-디바이스는-얼마나-넓게-보고-있을까" class="hash-link" aria-label="사용자의 디바이스는 얼마나 넓게 보고 있을까?에 대한 직접 링크" title="사용자의 디바이스는 얼마나 넓게 보고 있을까?에 대한 직접 링크">​</a></h3><p>지도 api에서 제공해주는 메서드를 활용하면 사용자의 디바이스가 어떤 영역을 보고 있는지도 알게 됩니다. 지도 api 마다 제공하는 스펙이 다르지만, 대부분은 어떤 식으로든 알려줍니다.</p><p>google maps API에서는 디스플레이의 북동쪽 끝 점의 좌표와, 남서쪽 끝 점의 좌표를 제공해줍니다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* 어디선가 생성된 구글 맵 객체 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBounds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bounds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNorthEast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lng</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bounds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNorthEast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 디바이스 1사분면 끝 점의 longitude와 latitude</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bounds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSouthWest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lng</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bounds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSouthWest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 디바이스 3사분면 끝 점의 longitude와 latitude</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="no offset" src="/assets/images/get-bounds-1b64b1a6c11afbaf50eb6247283a54c3.png" width="2162" height="1177" class="img_ev3q"></p><p>편의상 좌표를 다음과 같이 정의해보겠습니다.</p><ul><li>중심 점 p0: (x0, y0)</li><li>디바이스의 제 1사분면 끝점 p2: (x2, y2)</li><li>디바이스의 제 3사분면 끝점 p1: (x1, y1)</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">위 정의는 아래에서도 계속 설명 될 점과 좌표 입니다.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 알아낸 값으로 사용자 디바이스의 영역을 알게 됐습니다.</p><p>저희 카페인 팀에서는 이 값을 좀 더 효율적으로 다루기 위해 delta 개념을 도입했습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="화면에서-보고-있는-영역을-확대축소-하면-어떤-특징을-보일까">화면에서 보고 있는 영역을 확대/축소 하면 어떤 특징을 보일까?<a href="#화면에서-보고-있는-영역을-확대축소-하면-어떤-특징을-보일까" class="hash-link" aria-label="화면에서 보고 있는 영역을 확대/축소 하면 어떤 특징을 보일까?에 대한 직접 링크" title="화면에서 보고 있는 영역을 확대/축소 하면 어떤 특징을 보일까?에 대한 직접 링크">​</a></h3><p>delta 설명을 앞서, 사용자의 디바이스 영역과 확대 수준에 따른 실제 좌표에 대해 알아보려고 합니다.</p><p>사용자가 화면을 얼마나 넓게 보고 있는지를 쉽게 알기 위해서는 끝점들의 수치를 계산해줄 필요가 있었습니다.</p><p>사진은 사용자가 디바이스를 통해 바라 보고 있는 중심 좌표와 그 끝 점을 의미합니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/map-with-different-size-8e6b7583f89aba2fb3d68e6a5701bccf.png" width="2685" height="1648" class="img_ev3q"></p><p>예를 들어 사용자가 지도를 많이 축소한 경우에는 중심 점 p0은 그대로지만 양 끝점 p1, p2의 위치가 점점 중심 점 p0으로 부터 멀어질 것입니다.</p><p>반면에 사용자가 지도를 많이 확대한 경우에는 중심 점 p0은 그대로지만 양 끝점 p1, p2의 위치가 점점 중심점과 가까워질 것입니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/map-with-different-zoom-42d4bbf495ec0d271416c38f945afdf9.png" width="2694" height="2028" class="img_ev3q"></p><p>양 사진 모두 중심 점 p0는 그대로지만, 디바이스의 확대 수준으로 인해 양 끝점인 p1과 p2가 달라진 모습을 보인 것입니다.</p><p>즉, 이런 결론을 내릴 수 있습니다.</p><ol><li>양 끝점 p1, p2가 중심 점 p0으로 부터 멀어질 수록 지도를 축소한 것이다.</li><li>양 끝점 p1, p2가 중심 점 p0으로 부터 가까워 수록 지도를 확대한 것이다.</li></ol><p>이 때 디바이스의 디스플레이가 위도 경도 상으로 얼마나 멀어져있는지를 수치화하면 편하게 다룰 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="확대-수준을-수치화-할-수-없을까">확대 수준을 수치화 할 수 없을까?<a href="#확대-수준을-수치화-할-수-없을까" class="hash-link" aria-label="확대 수준을 수치화 할 수 없을까?에 대한 직접 링크" title="확대 수준을 수치화 할 수 없을까?에 대한 직접 링크">​</a></h3><p>사용자의 디스플레이의 중심 점 p0을 기준으로 하여 양 끝점 p1, p2이 얼마나 멀어져있는지에 따라 지도의 영역 뿐만 아니라 얼마나 많이 확대 되었는지 여부를 알게 됐습니다.</p><p>그렇다면 이를 좀 더 효율적인 방법으로 나타내려면 어떤 전략을 취할 수 있을까요?</p><p>사용자 디스플레이를 조금 더 자세히 살펴보겠습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/map-points-a315fed74acbd89996512c4f2b643bd0.png" width="2162" height="1494" class="img_ev3q"></p><p>중학교 시절 배웠던 좌표 평면계를 떠올려보면 화면에서 얻을 수 있는 좌표들은 위와 같습니다. 여기에서 각 점의 수직/수평의 변화량인 delta를 알아보면 어떨까요?</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="경도-델타-longitudedelta">경도 델타 (longitudeDelta)<a href="#경도-델타-longitudedelta" class="hash-link" aria-label="경도 델타 (longitudeDelta)에 대한 직접 링크" title="경도 델타 (longitudeDelta)에 대한 직접 링크">​</a></h4><p>p2와 p0의 경도 거리, 그리고 p1과 p0의 경도 거리는 같습니다.</p><p>즉, <code>x2 - x0 === x0 - x1</code> 이라는 결론을 얻을 수 있습니다.</p><p>이를 longitudeDelta로 정의하겠습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="위도-델타-latitudedelta">위도 델타 (latitudeDelta)<a href="#위도-델타-latitudedelta" class="hash-link" aria-label="위도 델타 (latitudeDelta)에 대한 직접 링크" title="위도 델타 (latitudeDelta)에 대한 직접 링크">​</a></h4><p>p2와 p0의 위도 거리, 그리고 p1과 p0의 위도 거리는 같습니다.</p><p>즉, <code>y2 - y0 === y0 - y1</code> 이라는 결론을 얻을 수 있습니다.</p><p>이를 latitudeDelta로 정의하겠습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/delta-57c8134a62b7c304f7958e6c3947ae7f.png" width="2294" height="1580" class="img_ev3q"></p><p>코드로 알아보면 다음과 같습니다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* 어디선가 생성된 구글 맵 객체 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBounds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> longitudeDelta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bounds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNorthEast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lng</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> bounds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSouthWest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lng</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 경도 변화량</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> latitudeDelta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bounds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNorthEast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> bounds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSouthWest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 위도 변화량</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>드디어 클라이언트에서 델타 값을 생성할 수 있게 되었습니다.</p><p>그렇다면 왜 이렇게 굳이 델타 값을 생성한 것일까요?</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="delta의-유용한-점-1-원래-의도한-값을-복원하기-쉽다">delta의 유용한 점 1: 원래 의도한 값을 복원하기 쉽다.<a href="#delta의-유용한-점-1-원래-의도한-값을-복원하기-쉽다" class="hash-link" aria-label="delta의 유용한 점 1: 원래 의도한 값을 복원하기 쉽다.에 대한 직접 링크" title="delta의 유용한 점 1: 원래 의도한 값을 복원하기 쉽다.에 대한 직접 링크">​</a></h3><p>서버의 입장에서는 중심 좌표와 델타 값만 알면 정확한 영역만큼 데이터를 호출할 수 있게 됩니다.</p><p>예를 들어 클라이언트에서 서버로 다음과 같은 파라미터를 넘겨줬다고 가정해보겠습니다.</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"longitude"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"latitude"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">37</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"longitudeDelta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"longitudeDelta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>그렇다면 서버에서는 다음과 같이 해석할 수 있게 됩니다.</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> maxLongitude </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> longitude </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> longitudeDelta</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> minLongitude </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> longitude </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> longitudeDelta</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> maxLatitude </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> latitude </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> latitudeDelta</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> minLatitude </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> latitude </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> latitudeDelta</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(javascript 기준으로 작성했습니다.)</p><p>이렇게 알아낸 경계 값을 가지고 다음과 같은 sql문을 작성할 수 있게 될 것입니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> stations </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> latitude </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> :minLatitude </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> latitude </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> :maxLatitude </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> longitude </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> :minLongitude </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> longitude </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> :maxLongitude</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="no offset" src="/assets/images/find-within-range-ca31a1685060c3a2f745d121d6bb40f1.png" width="3068" height="1866" class="img_ev3q"></p><p>즉, 위 그림처럼, 원하는 영역만큼만 정확하게 데이터를 호출할 수 있게 됩니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="delta의-유용한-점-2-델타가-무분별하게-커지는-것을-막기-쉽다">delta의 유용한 점 2: 델타가 무분별하게 커지는 것을 막기 쉽다.<a href="#delta의-유용한-점-2-델타가-무분별하게-커지는-것을-막기-쉽다" class="hash-link" aria-label="delta의 유용한 점 2: 델타가 무분별하게 커지는 것을 막기 쉽다.에 대한 직접 링크" title="delta의 유용한 점 2: 델타가 무분별하게 커지는 것을 막기 쉽다.에 대한 직접 링크">​</a></h3><p>예를 들어 사용자가 지도를 축소하여 한반도를 디스플레이에 가득 채운다면 서버가 어떻게 될까요?</p><p>이러한 행위를 막는 가장 쉬운 방법은 지도 api에서 지원하는 줌 레벨을 제한 하는 것입니다. 후술하겠지만 <em>줌 레벨은 디스플레이의 해상도를 고려하지 못합니다.</em></p><p>따라서 근본적으로 델타가 일정 값 이상 요청되지 못하도록, 혹은 연산되지 못하도록 막게 할 수 있습니다.</p><p>물론 델타가 없더라도 델타 값을 추정하여 연산할 수 있겠지만, 이를 <em>수치화 해서 관리한다면 클라이언트와 서버 모두 지도를 손쉽게 통제하는 것이 가능</em>하게 됩니다.</p><p>예를 들어 다음과 같이 델타 값을 고정하여 요청 영역을 제한할(요청을 보내지 않거나 고정된 사이즈로만 요청을 보낼) 수 있습니다.</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    longitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    latitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    longitudeDelta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> longitudeDelta &lt; </span><span class="token number" style="color:#36acaa">0.008</span><span class="token plain"> ? longitudeDelta </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.008</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    latitudeDelta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> latitudeDelta &lt; </span><span class="token number" style="color:#36acaa">0.004</span><span class="token plain"> ? latitudeDelta </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.004</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>특정 수치를 넘기지 못하게 처리할 때 눈에 보이는 변수로 취급하기 쉽습니다. (즉, 매번 계산하지 않아도 됩니다.)</p><p>디바이스 크기 관련 문제도 있습니다.</p><p>분명히 같은 줌 레벨이지만, 디바이스의 크기나 해상도에 따라 지도가 보여지는 정도가 다릅니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/different-device-size-23597d2286310ad12d59152c36bf8dff.png" width="1710" height="787" class="img_ev3q"></p><p>위 사진은 구글에서 제공하는 zoom 레벨을 동일하게 맞춘 후, 여러 디바이스에서 호출한 것입니다.</p><p>줌 레벨을 통해서 요청을 제한하다보면 여러 해상도를 제어하기 어렵습니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/too-big-screen-90eaa40397332f74af8b8d3f8bbfeced.png" width="1432" height="882" class="img_ev3q"></p><p>실제로 카페인 팀에서는 고해상도 모니터를 대응하기 위해 델타 값이 너무 크게 되면 요청의 제한을 하고 있습니다. 사진에서 보시다시피 고해상도 모니터의 경우, 너무 넓은 범위를 요청한다 싶으면 중심점으로 부터 일정 거리만 보여주도록 하고 있습니다.</p><p>(참고로 줌 레벨에 따른 요청도 덤으로 제한하고 있어서 멀리서 호출하는 행위도 금지하고 있습니다.)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="delta의-유용한-점-3-적당한-범위를-정해주기-편하다">delta의 유용한 점 3: 적당한 범위를 정해주기 편하다<a href="#delta의-유용한-점-3-적당한-범위를-정해주기-편하다" class="hash-link" aria-label="delta의 유용한 점 3: 적당한 범위를 정해주기 편하다에 대한 직접 링크" title="delta의 유용한 점 3: 적당한 범위를 정해주기 편하다에 대한 직접 링크">​</a></h3><p>위 예제에서는 정확한 범위만큼 요청하는 것을 예제로 하지만, 프로젝트에 따라서 조금 더 넓은 영역을 호출하고 싶을 때가 있을 것입니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/bigger-than-delta-9492ce7244a2b950185aecb46662c0da.png" width="1246" height="1344" class="img_ev3q"></p><p>예를 들어 현재 사용자의 디바이스 크기보다 살짝 큰 범위의 데이터를 미리 로드해 놓으면 사용자가 좁은 움직임을 보일 때 불필요한 재 렌더링을 줄여서 더 빠른 렌더링이 가능하게 됩니다.</p><p>사실 이 기법은 프로젝트마다 다르겠지만, 카페인 팀에서는 한번 불러온 마커를 매번 해제 하지 않고 <strong>이전 요청 데이터와 다음 요청 데이터를 비교하여 달라진 마커만을 정확하게 탈부착하는 작업을 진행</strong>하고 있습니다.</p><p>이런 기법을 활용하면 사용자가 좁은 범위에서 움직임을 보였을 때, 기존에 불러온 마커를 메모리에서 탈락시키지 않으므로 사용자 경험을 개선할 수도 있을 것입니다.</p><p>마커를 상태에 연동하여 정확하게 메모리에서 탈부착 시키는 전략에 대한 글은 이후에 작성할 예정입니다.</p><p>긴 글 읽어주셔서 감사합니다.</p>]]></content>
        <author>
            <name>가브리엘</name>
            <uri>https://github.com/gabrielyoon7</uri>
        </author>
        <category label="google maps api" term="google maps api"/>
        <category label="구글 지도" term="구글 지도"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[EC2 서버 추가와 동시에 Dev, Prod 환경 분리하기]]></title>
        <id>https://car-ffeine.github.io/27</id>
        <link href="https://car-ffeine.github.io/27"/>
        <updated>2023-08-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요.
카페인 팀의 제이입니다.</p><p>오늘은 저희가 EC2 인스턴스를 받으면서, 어떻게 dev, prod 배포 환경을 분리했는지 적어보려고 합니다.
기존 카페인 팀의 EC2 구조는 <a href="https://blog.naver.com/sosow0212/223163203356" target="_blank" rel="noopener noreferrer">여기서</a> 보실 수 있습니다.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="기존-상황과-문제점">기존 상황과 문제점<a href="#기존-상황과-문제점" class="hash-link" aria-label="기존 상황과 문제점에 대한 직접 링크" title="기존 상황과 문제점에 대한 직접 링크">​</a></h2><p>카페인 팀에서는 기존에 3대의 EC2 인스턴스가 있었습니다.
각각 <code>infra, dev, db</code> 역할을 하는 인스턴스로 존재하고 있었습니다.</p><p>저희는 release 브랜치를 통해 dev서버에 배포를 한 후 검증이 된다면, 실제 사용자들이 사용하는 prod 서버에 배포하고 있습니다.</p><p>문제는 기존의 3대의 인스턴스 중에서 dev 서버에 있었습니다.
기존 dev 서버는 총 4개의 서버를 배포하고 있었고 배포하는 서버는 다음과 같습니다. <code>prod-BE, prod-FE, dev-BE, dev-FE</code></p><p>그리고, 기존 dev 서버에서는 환경을 분리해주기 위해서 Nginx를 통해서 포트 포워딩은 다음과 같이 해주었습니다.</p><ul><li>prod-BE = 8080</li><li>prod-FE = 3031</li><li>dev-BE = 8081</li><li>dev-FE = 3031</li></ul><p>카페인 팀에서는 dev, prod 환경이 분리되지 않아서 인스턴스의 사용량이 높았고, 이에 따라 추가적인 EC2 인스턴스가 필요했습니다.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="문제-해결">문제 해결<a href="#문제-해결" class="hash-link" aria-label="문제 해결에 대한 직접 링크" title="문제 해결에 대한 직접 링크">​</a></h2><p>다행히도 카페인 팀에서 추가적인 EC2 인스턴스를 받았고, 저희는 배포 환경을 분리할 수 있었습니다.</p><p><img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/assets/63213487/52942893-3d8c-4c72-9972-278afa810d1d" alt="dev-prod-server" class="img_ev3q"></p><p>이와 같이 기존 dev 서버 한 개가 infra 서버와 연결되어 있었는데, 두 갈래로 나뉜 것을 확인하실 수 있습니다.</p><p>먼저 배포는 다음과 같이 진행됩니다.</p><p><code>release branch</code>에 push가 일어나면 <code>dev서버에 배포 작업</code>이 이뤄집니다.
<code>prod branch</code>에 push가 일어나면 <code>prod서버에 배포 작업</code>이 이뤄집니다.</p><p>또한 기존 dev 서버에서 4개의 포트포워딩 또한 굳이 그럴 필요가 없어졌습니다.
새로운 서버가 추가됨에 따라 dev, prod 서버 각각 Nginx에서 포트포워딩을 동일하게 <code>FE:3000, BE:8080</code> 으로 변경하였습니다.</p><p>이렇게 카페인 팀에서는 dev, prod 환경을 분리했습니다.</p><p>감사합니다!</p>]]></content>
        <author>
            <name>제이</name>
            <uri>https://github.com/sosow0212</uri>
        </author>
        <category label="ec2" term="ec2"/>
        <category label="prod" term="prod"/>
        <category label="dev" term="dev"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 팀 클라이언트의 테스트 자동화]]></title>
        <id>https://car-ffeine.github.io/26</id>
        <link href="https://car-ffeine.github.io/26"/>
        <updated>2023-08-16T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요, 카페인 팀에서는 테스트를 어떻게 하고 있을까요?]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요, 카페인 팀에서는 테스트를 어떻게 하고 있을까요?</p><p>일반적으로 소프트웨어 테스트란 백엔드에서 그 중요성이 강조되곤 하지만, 프론트엔드에서도 그에 못지 않게 중요한 부분을 차지하고 있습니다.</p><p>수많은 툴 중에서 어떤 테스트 라이브러리를 사용하는지 소개하겠습니다.</p><p>카페인 팀에서는 다음과 같은 프론트엔드 테스트 라이브러리를 사용하고 있을 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jest">Jest<a href="#jest" class="hash-link" aria-label="Jest에 대한 직접 링크" title="Jest에 대한 직접 링크">​</a></h3><p>Jest는 JavaScript의 테스트를 위한 대표적인 라이브러리입니다.
기본 설정이 간편하고, 빠르게 테스트를 실행할 때 굉장히 유용합니다.
함수를 mocking하여 의존성이 강한 함수를 제거하여 원하는 테스트를 쉽게 구성할 수 있다는 특징이 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="react-testing-library">React Testing Library<a href="#react-testing-library" class="hash-link" aria-label="React Testing Library에 대한 직접 링크" title="React Testing Library에 대한 직접 링크">​</a></h3><p>React Testing Library는 리액트 애플리케이션의 UI를 테스트하기 위한 라이브러리입니다.
React 컴포넌트를 호출하여, 사용자의 의도대로 조작할 수 있는 행위를 정의할 수 있습니다.
사용자 입장에서 상호작용 할 수 있는 부분을 스크립트로 작성하여 컴포넌트가 어떻게 변화하는지를 테스트 할 수 있게 됩니다.
가령, 어떤 사용자가 어떤 폼에 어떤 값을 입력했을 때의 예상되는 결과를 작성해두면 이후에 코드 작업 중 버그가 발생한다면 해당 위치에서 테스트가 실패할 것입니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storybook">Storybook<a href="#storybook" class="hash-link" aria-label="Storybook에 대한 직접 링크" title="Storybook에 대한 직접 링크">​</a></h3><p>Storybook은 UI를 컴포넌트 단위로 개발하고 그 즉시 시각화 할 수 있도록 돕는 테스팅 라이브러리입니다.
컴포넌트를 눈 앞에 바로 보여주고 실제 리액트에서 동작하는 것 처럼 컴포넌트 단위로 개발을 할 수 있습니다. CDD를 지향한다면 굉장히 유용한 기능이며, 개발자가 아닌 협업자에게도 원활한 커뮤니케이션을 도와줍니다.
컴포넌트 단위로 개발하기 때문에 개별 컴포넌트가 어떻게 동작하는지 확인할 수 있다는 것 자체가 굉장한 이점으로 작용합니다.
예를 들어 어떤 컴포넌트가 특정 메뉴 안에 존재해야 한다면, 이것을 확인하기 위해 해당 메뉴까지 접근해야 할 것입니다.
하지만 Storybook을 이용하면 특정 컴포넌트를 Storybook 위에 올려놓고 테스트를 할 수 있어 빠르게 작업이 가능합니다.
인터렉션이나 웹접근성을 확인해주는 플러그인도 존재하여 프론트엔드 개발에서 굉장히 중요한 역할로 부상했습니다.</p><p>저희 팀은 이외에 Cypress를 사용하는 것도 고려하였으나, 지도와 결합된 애플리케이션을 테스트하기에 다소 어려움이 있어 위 라이브러리들을 개발에 활용했습니다.</p><p>저희는 위 테스팅 라이브러리들을 원활히 활용하기 위해 테스트 자동화를 구축했습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="jest와-react-testing-library-테스트-자동화">Jest와 React Testing Library 테스트 자동화<a href="#jest와-react-testing-library-테스트-자동화" class="hash-link" aria-label="Jest와 React Testing Library 테스트 자동화에 대한 직접 링크" title="Jest와 React Testing Library 테스트 자동화에 대한 직접 링크">​</a></h2><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> frontend</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> frontend/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> .github/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">permissions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">contents</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">when</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pull</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaults</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Checkout PR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install dependencies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> npm install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> npm run test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="이벤트-트리거-설정">이벤트 트리거 설정<a href="#이벤트-트리거-설정" class="hash-link" aria-label="이벤트 트리거 설정에 대한 직접 링크" title="이벤트 트리거 설정에 대한 직접 링크">​</a></h4><p>pull_request 이벤트가 발생하였을 때, 해당 이벤트가 main 브랜치와 develop 브랜치에서만 동작합니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="변경-사항-경로-제한">변경 사항 경로 제한<a href="#변경-사항-경로-제한" class="hash-link" aria-label="변경 사항 경로 제한에 대한 직접 링크" title="변경 사항 경로 제한에 대한 직접 링크">​</a></h4><p>테스트를 실행할 때는 frontend 디렉토리와 .github 디렉토리 내의 파일들을 고려하도록 했습니다. 백엔드와의 환경 분리를 위해 이러한 접근 제한을 했습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="권한-설정">권한 설정<a href="#권한-설정" class="hash-link" aria-label="권한 설정에 대한 직접 링크" title="권한 설정에 대한 직접 링크">​</a></h4><p>permissions은 읽기 권한만 설정되어 있어 코드나 파일을 변경을 방지합니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="작업job-설정">작업(Job) 설정<a href="#작업job-설정" class="hash-link" aria-label="작업(Job) 설정에 대한 직접 링크" title="작업(Job) 설정에 대한 직접 링크">​</a></h4><p>test라는 이름의 작업을 정의하였고, 이 작업에서는 Ubuntu 환경에서 테스트를 실행합니다. test라는 이름의 환경 변수를 사용합니다. 테스트는 (카페인 팀 레포지토리의) frontend 디렉토리에서 작업하도록 하였습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="스텝step-설정">스텝(Step) 설정<a href="#스텝step-설정" class="hash-link" aria-label="스텝(Step) 설정에 대한 직접 링크" title="스텝(Step) 설정에 대한 직접 링크">​</a></h4><p>코드를 체크아웃하고, 의존성을 설치하며, 테스트를 실행하는 세 가지 단계로 구성되어 있습니다.</p><p>이러한 설정을 통해 PR에 코드가 올라올 때 자동으로 프론트엔드 테스트가 실행됩니다.</p><p>이러한 테스트 자동화 전략은 프론트엔드 애플리케이션을 안정적이게 개발하고 유지할 수 있도록 도와줍니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="storybook의-빌드-자동화">Storybook의 빌드 자동화<a href="#storybook의-빌드-자동화" class="hash-link" aria-label="Storybook의 빌드 자동화에 대한 직접 링크" title="Storybook의 빌드 자동화에 대한 직접 링크">​</a></h2><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> storybook</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> frontend/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> .github/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">22.04</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaults</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Setup Repository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set up Node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">node-version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 18.16.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install dependencies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> npm install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cache node_modules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/cache@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'**/node_modules'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> runner.os </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> hashFiles('</span><span class="token important">**/package-lock.json')</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">restore-keys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            ${{ runner.os }}-node-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> storybook build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> npm run build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">storybook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Upload storybook build files to temp artifact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/upload</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">artifact@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Storybook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> frontend/storybook</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">needs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hosted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Remove previous version app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rm </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rf dist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Download the built file to AWS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/download</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">artifact@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Storybook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> frontend/dev/dist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Move folder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> frontend/dev/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          rm -rf /home/ubuntu/dist/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          cp -r ./dist /home/ubuntu</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> comment PR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> thollander/actions</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">comment</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pull</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">request@v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">GITHUB_TOKEN</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'🚀storybook: https://storybook.carffe.in/'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>비슷한 코드이지만, 매번 PR이 열릴 때 마다 스토리북이 자동으로 빌드 및 배포됩니다.
배포가 완료되면 배포된 URL을 알려 코드 리뷰할 때 참고할 수 있도록 돕습니다.</p><p>이상 카페인 팀에서 사용하고 있는 테스팅 라이브러리와 테스트 자동화 방법을 알아봤습니다.</p>]]></content>
        <author>
            <name>가브리엘</name>
            <uri>https://github.com/gabrielyoon7</uri>
        </author>
        <category label="테스트" term="테스트"/>
        <category label="test" term="test"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[flyway를 이제서야 적용하는 이유]]></title>
        <id>https://car-ffeine.github.io/25</id>
        <link href="https://car-ffeine.github.io/25"/>
        <updated>2023-08-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="이-글을-쓰는-이유">이 글을 쓰는 이유<a href="#이-글을-쓰는-이유" class="hash-link" aria-label="이 글을 쓰는 이유에 대한 직접 링크" title="이 글을 쓰는 이유에 대한 직접 링크">​</a></h2><p>저희 팀은 flyway를 적용했습니다. 가장 큰 이유는 데이터베이스의 데이터를 drop 할 수 없기 때문입니다.</p><p>데이터베이스를 drop하는 것과 flyway가 무슨 상관이 있길래 적용할까요.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="예시-상황">예시 상황<a href="#예시-상황" class="hash-link" aria-label="예시 상황에 대한 직접 링크" title="예시 상황에 대한 직접 링크">​</a></h3><p>제가 아래와 같이 Member라는 entity를 만들었습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Member</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>지금의 entity는 두개의 필드 밖에 없습니다. 어느 날부터 Member에 email이라는 정보가 있어야한다는 요구사항이 생깁니다.
그래서 저희는 아래와 같이 email을 추가합니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Member</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> email</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>그리고 다시 jpa의 ddl-auto 속성 중 create를 사용해서 새로운 테이블을 만들었습니다. 기존의 테이블을 다 날리면서요.</p><p>하지만 저희의 데이터베이스의 데이터들을 그냥 drop해도 되는 것일까요?
개발 서버라도 힘들게 쌓은 데이터들을 테이블이 조금 변경되었다고 날려버리는 것은 바보같은 일이라고 생각했습니다.
그러면 ddl-auto의 다른 조건인 update를 사용하면 될 것 같습니다. 그랬더니 jpa가 아래와 같이 쿼리를 이쁘게 만들어 줬습니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> member</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> email </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>update를 사용하니 아주 편하게 칼럼이 추가되는 것을 볼 수 있습니다.</p><p>하지만 여기서 또 아래와 같은 요구사항이 추가되었습니다.</p><p>email의 제약조건으로 null이 되면 안되고, 길이는 20자가 되어야합니다.
그러면 어노테이션을 사용하여 변경해보겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Member</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nullable</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> length </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> email</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 하고 어플리케이션을 재시작 했습니다.
하지만 아무런 ddl이 발생하지 않습니다. 왜냐면 Jpa의 ddl-auto: update의 속성은 제약조건이 변경된 것은 반영해주지 않기 때문입니다.</p><p>그리고 만약 이 전의 회원들의 email이 null인 row도 있다면 어떻게 될까요? 제약조건을 반영할 수 없을 것입니다.</p><p>이런 식으로 운영 도중 table의 칼럼들이 추가되거나, 삭제되거나, 혹은 제약조건이 변경될 때 update 속성만으로는 반영할 수 없습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="flyway">flyway<a href="#flyway" class="hash-link" aria-label="flyway에 대한 직접 링크" title="flyway에 대한 직접 링크">​</a></h2><p>그래서 flyway를 사용했습니다.
물론 flyway 없이도 이런 문제를 해결할 수 있습니다. 방법은 간단합니다. 데이터베이스가 있는 서버에 직접 접속하여 ddl을 직접 하나 하나 다 작성하면 됩니다.</p><p>하지만 이런 방식에는 단점이 있습니다. 하나 하나 직접 입력하다보니 휴먼 에러가 발생할 수도 있기 때문입니다. 그리고 매번 데이터베이스 서버에 접속해야한다는 단점이 있습니다.
이렇게 매번 데이터베이스에 접속을 해야한다면 cd를 하는 이유가 있을까요?</p><p>하지만 flyway를 사용하면 편하게 변경된 schema를 관리할 수 있고 언제 바뀌었는지 어떻게 바뀌었는지 확인도 할 수 있습니다.</p><p>글로는 잘 와닿지 않을 수도 있으니 사용법을 확인하면서 어떤 장점이 있는지 확인해보도록 하겠습니다.</p><p>먼저 flyway 의존성을 추가하고 <code>resources/db/migration</code> 패키지를 만듭니다.
거기에 file을 만듭니다. 파일 이름이 중요한데요 <code>V1__init.sql</code> 이러한 방식으로 <code>V{version 숫자}__{어떠한 파일인지에 대한 이름}.sql</code> 언더스코어 2개는 필수로 작성해야합니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> member</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id    </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">auto_increment</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">primary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name  </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 <code>V1__init.sql</code>에 대한 파일을 작성했습니다. 이제는 email을 추가한다는 요구사항을 반영해보겠습니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> member</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> email </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 새로운 파일을 만들어서 해당 스크립트를 작성했습니다. 파일명이 중요한데요, 이전 파일의 숫자보다 +1 이 되는 숫자를 V 뒤에 붙입니다.</p><p>따라서 이번 파일은 <code>V2__add_column_email.sql</code> 이라고 만들었습니다.</p><p>그럼 이제 또 시간이 지나 회원이 많아졌습니다. 하지만 email이 없는 사용자도 많습니다. 이 상황에서 email을 not null로 변경해야한다는 요구사항이 생겼습니다.</p><p>그러면 아래와 같이 반영할 수 있습니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> member</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">MODIFY</span><span class="token plain"> email </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'default'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 <code>V3__add_constraints.sql</code> 파일을 만들었습니다. 그러면 null이 있던 row들은 email이 default가 되고 not null 제약조건이 활성화 된 것을 볼 수 있습니다.</p><p>그러면 주어진 요구사항은 모두 만족할 수 있습니다. 거기에다 v1, v2, v3 가 나뉘어져있어서 어느 커밋부터 해당 sql이 추가되었는지도 확인할 수 있습니다.</p><p>그리고 ddl-auto update를 사용하면 반영되지 않았던 제약조건의 추가도 확인할 수 있습니다. 그러면 ddl-auto의 속성을 validate로 변경하여, db schema와 entity의 필드가 다르면
어플리케이션이 실행되지 않도록 해서 좀 더 안전한 개발을 할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론">결론<a href="#결론" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><p>flyway는 roll back을 하는 것이 유료라서, production 서버에서 혹은 롤백을 해야하는 일이 있는 서버에서는 사용하는 것이 좋지 않지만,
이와 같이 데이터를 drop 할 수 없는 상황이라면, 사용하지 않을 이유가 없어보이는 좋은 도구입니다.</p><p>짧은 글 읽어주셔서 감사합니다.</p>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="hello" term="hello"/>
        <category label="world" term="world"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Out of memory trouble shooting]]></title>
        <id>https://car-ffeine.github.io/24</id>
        <link href="https://car-ffeine.github.io/24"/>
        <updated>2023-08-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 부릉부릉 허리케인 박스터입니다.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 부릉부릉 허리케인 박스터입니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="이-글을-쓰는-이유">이 글을 쓰는 이유<a href="#이-글을-쓰는-이유" class="hash-link" aria-label="이 글을 쓰는 이유에 대한 직접 링크" title="이 글을 쓰는 이유에 대한 직접 링크">​</a></h2><p>먼저 이 글을 쓰는 이유는 저희 카페인 팀의 충전소와 충전기들의 새로운 정보를 업데이트하거나, 저장하는 로직에서 아래와 같이 OOM(Out of memory)가 발생했기 때문입니다.
<img loading="lazy" alt="error-log" src="/assets/images/error-log-805eb9453a6ba067e66fc2928bd0e90e.png" width="2104" height="1759" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="왜-발생했을까">왜 발생했을까<a href="#왜-발생했을까" class="hash-link" aria-label="왜 발생했을까에 대한 직접 링크" title="왜 발생했을까에 대한 직접 링크">​</a></h3><p>먼저 간단히 저희가 처한 상황에 대해 설명드리겠습니다.</p><p>처음 어플리케이션을 실행하면 공공 API를 호출하여 충전소와 충전기에 대한 모든 정보들을 가져와 저장합니다. (충전소 약 6만 곳 + 충전기 약 23만 기)</p><p>하지만 이러한 정보들은 수정이 될 수 있고, 충전소와 충전기가 추가될 수 있습니다.</p><p>그러므로 정확한 정보가 사용자에게 가장 중요시되는 서비스에서 이러한 정보들이 늦게 반영이 된다거나, 반영이 되지 않는다면 저희 서비스를 사용할 사용자가 없을 것이라 판단했습니다.</p><p>그래서 하루에 한 번 충전소와 충전기들의 정보를 업데이트하고, 추가된 충전소와 충전기를 저장하는 로직을 만들었습니다.</p><p>대략적인 로직은 아래와 같습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updatePeriodicStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> stations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">requestStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stationUpdateService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> updatedStations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> stations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stationRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findAllFetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> savedStationsByStationId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">collect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Station</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getStationId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Function</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">identity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 저장된 정보와 비교하여 새로운 충전소와 충전기를 찾는 로직</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">saveAllStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toSaveStations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">updateAllStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toUpdateStations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">saveAllChargers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toSaveChargers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">updateAllChargers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toUpdateChargers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>간단하게 말씀드리면 <code>requestStations()</code> 메서드는 공공 API에서 모든 충전소와 충전기를 요청하고 받아오는 메서드입니다. 23만 + 6만개의 정보를 받아오는 것입니다.
이렇게 많은 정보를 받아오고 메모리에 올린다는 것은 누가봐도 비효율적입니다. 하지만 이러한 선택을 한 이유는 공공 API는 저희가 어떤 방식으로 보내줄 지 모른다는 것이였습니다.
그래서 어쩔 수 없이 23만건을 모두 요청해야한다는 부분은 바꿀 수 없는 한계입니다.</p><p>그 다음으로는 요청해서 받아온 데이터들과 데이터베이스에 저장되어 있던 데이터들을 <code>findAll()</code>을 통해 비교하고 새로운 충전소와 충전기는 저장하고, 업데이트된 충전소와 충전기는 수정합니다.</p><p>이런 로직은 총 (23 + 6) * 2 만건의 객체 약 58만개를 Heap 메모리에 적재합니다. 많다고는 생각했지만, 일단 제 로컬환경에서는 잘 작동했고, 기능 구현이 우선이기 때문에 추후에 개선을 하기로 하고 넘어갔습니다.</p><p>하지만 개발 서버 배포를 하고 다음날 서버가 접속이 되지 않는 것을 확인했고, 로그를 보니 위의 사진과 같이 OOM이 발생한 것을 확인할 수 있었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="해결-방안">해결 방안<a href="#해결-방안" class="hash-link" aria-label="해결 방안에 대한 직접 링크" title="해결 방안에 대한 직접 링크">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="heap-size-조절하기">Heap size 조절하기<a href="#heap-size-조절하기" class="hash-link" aria-label="Heap size 조절하기에 대한 직접 링크" title="Heap size 조절하기에 대한 직접 링크">​</a></h3><p>일단 임시 방편으로 Heap memory의 최대 크기를 늘리는 법이였습니다. JVM은 실행되는 환경에 따라 힙 메모리의 최대 사이즈를 정합니다. 힙 메모리는 설정하지 않으면 해당 환경의 메모리 1/4로 설정합니다.
그래서 저희 EC2 인스턴스의 메모리는 약 2기가로, 약 500MB가 할당되어 있었습니다. 그래서 저희는 메모리를 조금씩 늘려가며 조정하여 약 1기가로 힙 메모리의 최대 사이즈를 정했습니다.
힙 메모리의 설정을 하는 방법은 간단합니다.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java -Xms512m -Xmx1024m boxster.jar</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>실행할 때 이러한 방식으로 하면 최소 힙 메모리 사이즈는 512MB, 최대 1024MB로 설정할 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="페이징해서-가져오기">페이징해서 가져오기<a href="#페이징해서-가져오기" class="hash-link" aria-label="페이징해서 가져오기에 대한 직접 링크" title="페이징해서 가져오기에 대한 직접 링크">​</a></h3><p>힙 메모리의 사이즈를 조절해서 해결한다는 부분은 임시 방편이지 만약 저희 EC2 환경이 다운그레이드 되거나 한다면 또 OOM이 발생할 것이 뻔합니다. 그래서 어플리케이션 레벨에서 좀 더 해결할 방안이 필요합니다.</p><p>API의 요청에 대한 부분은 요청보내는 회사의 정책이 바뀌지 않는 이상 저희는 23만건을 모두 로딩해야한다는 점은 어쩔 수 없습니다. 그렇다면 저희가 제어할 수 있는 유일한 부분은 데이터베이스에서 데이터를 꺼내오는 부분 밖에 없습니다.</p><p>그렇다면 이것을 어떻게 조절할 수 있을까요.</p><p>여러 방법을 찾아보던 중 <code>No Offset</code>방식으로 데이터를 페이징한다는 글을 읽었습니다. 페이징을 하기위해서는 어디서부터 시작하고 어디까지 가져올 것인지 정해야합니다. 그 중 먼저 제일 자주 사용되는 Offset 방식에 대해 간단히 설명드리겠습니다.</p><p>해당 방식은</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> station</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> id </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">OFFSET</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이러한 쿼리를 만들어 요청합니다. station 테이블의 20001번째 레코드부터 10000개의 데이터를 요청하는 방식입니다. 이러한 쿼리도 나쁘지 않습니다.
장점으로는 언제든 해당 페이지로 이동할 수 있다는 점입니다.</p><p>하지만 이 쿼리에는 단점이 있습니다. 뒤로 갈수록 성능이 나빠진다는 점입니다. 20001번째 레코드부터 10000개를 요청한다면 데이터베이스는 어쩔 수 없이 20001번째 레코드를 찾기 위해
정렬을 하고, 정렬한 후에 20001번째까지 세어가며 읽고, 거기서부터 10000개의 레코드를 반환하기 때문입니다.
<img loading="lazy" alt="offset" src="/assets/images/offset-9b8e539b7328a1702af154f5c4855bf8.png" width="840" height="402" class="img_ev3q"></p><p>한 문장으로 정의하면, 순서를 알아야하기 때문에 내가 필요하지 않는 레코드도 읽어야 하기 때문입니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="no-offset">No Offset<a href="#no-offset" class="hash-link" aria-label="No Offset에 대한 직접 링크" title="No Offset에 대한 직접 링크">​</a></h4><p>그럼 No offset 방식에 대해 설명드리겠습니다.</p><p>사실 이름만 들으면 어려울 것 같지만 그냥 offset을 사용하지 않고 페이징하는 것입니다.</p><p>스크롤을 내리면서 자동으로 마지막의 데이터를 기준으로 다음 몇개의 레코드를 불러오는 방식이기 때문입니다.
해당 방식은</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> station</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> 마지막으로 보낸 id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> id </span><span class="token keyword" style="color:#00009f">desc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이러한 쿼리로 작동합니다. 아까와는 다른 부분은 where 절에 <code>마지막으로 보낸 id</code>라는 정보가 필요하다는 부분과, offset이 사라진 부분입니다.</p><p>같은 결과를 만들어내는 쿼리지만, 하나가 추가되고 하나가 사라졌다는 것은 추가된 부분이 사라진 부분을 대신한다는 뜻이겠죠.</p><p>이 이러한 방식의 단점은 offset을 이용한 방식과는 다르게 page를 지정해서 돌아가기는 힘듭니다.</p><p><img loading="lazy" alt="no offset" src="/assets/images/no-offset-76c580e828707d0c1a6760539784fff8.png" width="991" height="364" class="img_ev3q"></p><p>마지막으로 보낸 id를 받아 인덱스를 이용해 해당 id에서부터 레코드를 반환합니다. 굳이 필요없는 레코드를 읽을 필요 없기 때문에 성능이 좋아졌을 것이라 예상할 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="성능-차이">성능 차이<a href="#성능-차이" class="hash-link" aria-label="성능 차이에 대한 직접 링크" title="성능 차이에 대한 직접 링크">​</a></h3><p>바로 한번 두 개의 쿼리를 실행해보겠습니다.
<img loading="lazy" alt="test" src="/assets/images/test-a3e2a8131c7179bd49fbfee0297c93d6.png" width="1508" height="498" class="img_ev3q"></p><p>위의 쿼리는 no offset, 아래는 offset 방식입니다. 현재 데이터가 6만건 들어있는 테이블의 조회 기준으로 약 10배 가량 성능이 차이나는 것을 확인할 수 있습니다.</p><p>그럼 실행 계획도 간단히 알아보겠습니다.</p><p>먼저 offset 방식의 실행 계획입니다.
<img loading="lazy" alt="offset explain" src="/assets/images/offset-explain-bebfc224ea1ba5c1d396c773028188b8.png" width="1397" height="52" class="img_ev3q"></p><p> type 칼럼을 보시면 <code>index</code>라고 되어 있는 것을 확인할 수 있습니다. 여기서 index 접근 방법은
인덱스를 효율적으로 사용하는 것이 아닌 인덱스를 처음부터 끝까지 읽는 full scan을 뜻합니다. 그래서 그다지 효율적이지 못한 방법입니다.
그리고 rows 칼럼에는 <code>40010</code>이라고 되어있습니다. 해당 부분은 제가 offset을 40000, limit을 10으로 두었기 때문에 40010d의 row를
읽어야한다고 예상 값을 나타낸 것입니다.</p><p>다음은 no offset 방식의 실행 계획입니다.
<img loading="lazy" alt="no offset explain" src="/assets/images/no-offset-explain-ababd232c35d3f3f328d99cb065e69b4.png" width="1395" height="52" class="img_ev3q">
아까와는 다르게 type 칼럼은 <code>range</code>입니다. range 접근 방식은 인덱스를 하나의 값이 아니라 범위로 검색하는 경우를 의미합니다.
좀 전의 index 접근 방식과는 다르게 훨씬 효율적인 접근 방식입니다. 그리고 rows도 달라진 것을 확인할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="진짜-해결하기">진짜 해결하기<a href="#진짜-해결하기" class="hash-link" aria-label="진짜 해결하기에 대한 직접 링크" title="진짜 해결하기에 대한 직접 링크">​</a></h2><p>이제 열심히 페이징 처리를 했으니 어플리케이션에서 해결을 하도록 만들어야합니다.</p><p>저희 팀은 동적 쿼리 생성을 도와주는 Query DSL을 도입하지 않았고 아직까진 굳이 필요하지 않아서 no offset 방식을 jpa의 jpql을 통해 구현해보겠습니다.</p><p>먼저 첫 페이지는 id의 관계없이 원하는 갯수만큼만 가져오면 됩니다. 그리고 두번째 페이지부터는 id를 받아 그 다음부터 반환하면 됩니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">StationRepository</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Repository</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Long</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"SELECT s FROM Station s INNER JOIN FETCH s.chargers ORDER BY s.stationId"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAllByOrder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Pageable</span><span class="token plain"> pageable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"SELECT s FROM Station s INNER JOIN FETCH s.chargers WHERE s.stationId &gt; :stationId ORDER BY s.stationId"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAllByPaging</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"stationId"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> stationId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Pageable</span><span class="token plain"> pageable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>그럼 아까 update를 해주던 메서드에서 조금 수정해보겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updatePeriodicStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> stations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 처음에는 station의 id가 null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> lastStationId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> stations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LIMIT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 마지막 id를 메서드 실행할 때마다 변경해준다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lastStationId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stationUpdateService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lastStationId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LIMIT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> updatedStations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> lastStationId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> savedStations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lastStationId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> savedStationsByStationId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">collect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Station</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getStationId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Function</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">identity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 저장된 정보와 비교하여 새로운 충전소와 충전기를 찾는 로직</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">saveAllStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toSaveStations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">updateAllStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toUpdateStations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">saveAllChargers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toSaveChargers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">updateAllChargers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toUpdateChargers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 가져온 list에서 제일 마지막 station의 id를 반환</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getLastStationId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">savedStations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 페이징 처리</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getStations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> stationId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Id 가 null 이라면 첫 페이지이기 때문에 limit 사이즈만큼 select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stationId </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> stationRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findAllByOrder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Pageable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 아니라면 station Id 부터 limit 만큼</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> stationRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findAllByPaging</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stationId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Pageable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 되면 원래 23만개를 한꺼번에 가져오던 로직을 나눌 수 있기 때문에 Heap 메모리의 여유가 생길 것입니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="진짜-확인해보기">진짜 확인해보기<a href="#진짜-확인해보기" class="hash-link" aria-label="진짜 확인해보기에 대한 직접 링크" title="진짜 확인해보기에 대한 직접 링크">​</a></h3><p>물론 GC의 동작이 어떨지 모르겠지만 23만개 인스턴스를 생성하는 것보다 5000개 혹은 더 적게 생성하는 것이 Heap 메모리를 적게 사용할 것임을 유추할 수 있습니다.
하지만 직접 확인해보기 전까지는 확신할 수 없으니 간단히 <code>Runtime</code> 클래스에서 제공해주는 <code>totalMemory()</code>, <code>freeMemory()</code> 메서드를 통해 알아보겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> 페이징을_사용한_조회</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> stations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stationRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findAllByOrder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Pageable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> total </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRuntime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">totalMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> free </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRuntime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">freeMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"paging 사용 중인 메모리: "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">total </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> free</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"MB"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> 페이징을_사용하지_않고_조회</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> stations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stationRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findAllFetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> total </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRuntime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">totalMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> free </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRuntime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">freeMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"findAll() 사용 중인 메모리: "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">total </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> free</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"MB"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="findAll" src="/assets/images/findAll-ae5fb3f4360181f8543c74500c0d620f.png" width="462" height="34" class="img_ev3q">
<img loading="lazy" alt="paging" src="/assets/images/paging-d84ef95ea9ca28bd5da8099eb54853d5.png" width="424" height="42" class="img_ev3q">
확연히 차이가 나는 것을 확인할 수 있습니다.</p><p>물론 테스트코드에서는 23만건의 API 요청은 같은 조건이니 배제하고 확인했습니다.</p><p>이로써 하나의 문제가 또 해결된 것 같습니다.</p><p>아직 배우는 단계라 혹시 틀린 점이 있다면 지적 부탁드리겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="#reference" class="hash-link" aria-label="Reference에 대한 직접 링크" title="Reference에 대한 직접 링크">​</a></h2><ul><li>리얼 마이 에스큐엘 8.0</li><li><a href="https://jojoldu.tistory.com/528" target="_blank" rel="noopener noreferrer">https://jojoldu.tistory.com/528</a></li></ul>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="OOM" term="OOM"/>
        <category label="java" term="java"/>
        <category label="trouble-shooting" term="trouble-shooting"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Deadlock trouble shooting]]></title>
        <id>https://car-ffeine.github.io/23</id>
        <link href="https://car-ffeine.github.io/23"/>
        <updated>2023-07-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[이 글을 쓰는 이유]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="이-글을-쓰는-이유">이 글을 쓰는 이유<a href="#이-글을-쓰는-이유" class="hash-link" aria-label="이 글을 쓰는 이유에 대한 직접 링크" title="이 글을 쓰는 이유에 대한 직접 링크">​</a></h2><p>먼저 이 글을 쓰는 이유는 저희 카페인 팀의 혼잡도 저장 및 충전기의 상태를 업데이트하는 로직에서 dead Lock이 발생하여 mysql과 connection을 잃는 에러가 발생했기 때문입니다.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LATEST DETECTED DEADLock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-07-21 01:49:54 </span><span class="token number" style="color:#36acaa">281472560787424</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TRANSACTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRANSACTION </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain">, ACTIVE </span><span class="token number" style="color:#36acaa">373</span><span class="token plain"> sec inserting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql tables </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> use </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, Locked </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock WAIT </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> Lock struct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, heap size </span><span class="token number" style="color:#36acaa">1128</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> row Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, undo log entries </span><span class="token number" style="color:#36acaa">328</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL thread </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">860</span><span class="token plain">, OS thread handle </span><span class="token number" style="color:#36acaa">281472107409376</span><span class="token plain">, query </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2958720</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO charger_status </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station_id, charger_id, latest_update_time, charger_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> VALUES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'ST414511'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'01'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'2023-07-21 08:27:43'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'CHARGING_IN_PROGRESS'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ON DUPLICATE KEY UPDATE latest_update_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'2023-07-21 08:27:43'</span><span class="token plain">, charger_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CHARGING_IN_PROGRESS'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> HOLDS THE Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">742</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">424</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain"> Lock_mode X Locks rec but not gap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> WAITING FOR THIS Lock TO BE GRANTED:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">718</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">280</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain"> Lock_mode X Locks rec but not gap waiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TRANSACTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRANSACTION </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain">, ACTIVE </span><span class="token number" style="color:#36acaa">507</span><span class="token plain"> sec inserting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql tables </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> use </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, Locked </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock WAIT </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> Lock struct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, heap size </span><span class="token number" style="color:#36acaa">1323</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> row Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, undo log entries </span><span class="token number" style="color:#36acaa">432</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL thread </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">859</span><span class="token plain">, OS thread handle </span><span class="token number" style="color:#36acaa">281472629186528</span><span class="token plain">, query </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3017483</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO charger_status </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station_id, charger_id, latest_update_time, charger_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> VALUES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'ST412801'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'11'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'2023-07-21 10:48:20'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'CHARGING_IN_PROGRESS'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ON DUPLICATE KEY UPDATE latest_update_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'2023-07-21 10:48:20'</span><span class="token plain">, charger_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CHARGING_IN_PROGRESS'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> HOLDS THE Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">718</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">208</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain"> Lock_mode X Locks rec but not gap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> WAITING FOR THIS Lock TO BE GRANTED:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">742</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">424</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain"> Lock_mode X Locks rec but not gap waiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>실제 <strong>개발 서버</strong>에서 발생한 데드락의 로그입니다. 해당 로그는 charger_status에 저장 시 서로 XLock을 획득하지 못하여 생기는 에러입니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mysql-dead-lock이란">Mysql Dead Lock이란<a href="#mysql-dead-lock이란" class="hash-link" aria-label="Mysql Dead Lock이란에 대한 직접 링크" title="Mysql Dead Lock이란에 대한 직접 링크">​</a></h2><p>그럼 Dead Lock은 왜 생기고 언제 생길까요?
저는 이 Log를 직접 마주하기 전까지는 Dead Lock이 그냥 Lock의 시간이 오래 걸릴 때 생기는 줄 알았습니다. 하지만 그렇게 간단하게 발생하는 것은 아니였습니다.</p><ol><li><p>상호 배제(Mutual Exclusion): MySQL은 기본적으로 트랜잭션 내에서 잠금(Lock)을 사용하여 데이터의 상호 배제를 제어합니다. 따라서 두 개 이상의 트랜잭션이 같은 데이터를 동시에 변경하려고 할 때, 해당 데이터에 대한 잠금이 설정되어 상호 배제 조건이 만족됩니다.</p></li><li><p>점유와 대기(Hold and Wait): 트랜잭션이 이미 하나 이상의 데이터를 잠근 상태에서 다른 데이터의 잠금을 얻기 위해 대기하고 있는 경우 점유와 대기 조건이 만족됩니다. 즉, 트랜잭션이 자신이 점유한 데이터를 유지한 상태에서 다른 데이터에 대한 잠금을 기다리고 있어야 합니다.</p></li><li><p>비선점(Non-Preemption): MySQL에서는 기본적으로 트랜잭션이 다른 트랜잭션이 점유한 데이터의 잠금을 강제로 해제할 수 없습니다. 따라서 비선점 조건이 만족됩니다.</p></li><li><p>순환 대기(Circular Wait): 두 개 이상의 트랜잭션이 각각 서로가 기다리는 데이터의 잠금을 보유해야 순환 대기 조건이 만족됩니다. 예를 들면, 트랜잭션 A가 데이터 X의 잠금을 기다리고, 트랜잭션 B는 데이터 Y의 잠금을 기다리며, 트랜잭션 C는 데이터 Z의 잠금을 기다리는 상태가 발생한다면 순환 대기 조건이 성립합니다.</p></li></ol><p>사실 기본 컴퓨터 시스템의 dead Lock과 유사한 조건입니다. 이 부분을 모두 만족해야 데드락이 발생합니다.
하나씩 알아보겠습니다. 먼저 개발 서버에서 발생한 데드락으로 살펴보겠습니다.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TRANSACTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRANSACTION </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain">, ACTIVE </span><span class="token number" style="color:#36acaa">373</span><span class="token plain"> sec inserting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql tables </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> use </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, Locked </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock WAIT </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> Lock struct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, heap size </span><span class="token number" style="color:#36acaa">1128</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> row Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, undo log entries </span><span class="token number" style="color:#36acaa">328</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL thread </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">860</span><span class="token plain">, OS thread handle </span><span class="token number" style="color:#36acaa">281472107409376</span><span class="token plain">, query </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2958720</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO charger_status </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station_id, charger_id, latest_update_time, charger_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> VALUES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'ST414511'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'01'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'2023-07-21 08:27:43'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'CHARGING_IN_PROGRESS'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ON DUPLICATE KEY UPDATE latest_update_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'2023-07-21 08:27:43'</span><span class="token plain">, charger_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CHARGING_IN_PROGRESS'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> HOLDS THE Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">742</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">424</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000560</span><span class="token plain"> Lock_mode X Locks rec but not gap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TRANSACTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRANSACTION </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain">, ACTIVE </span><span class="token number" style="color:#36acaa">507</span><span class="token plain"> sec inserting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql tables </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> use </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, Locked </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock WAIT </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> Lock struct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, heap size </span><span class="token number" style="color:#36acaa">1323</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> row Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, undo log entries </span><span class="token number" style="color:#36acaa">432</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MySQL thread </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">859</span><span class="token plain">, OS thread handle </span><span class="token number" style="color:#36acaa">281472629186528</span><span class="token plain">, query </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3017483</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO charger_status </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station_id, charger_id, latest_update_time, charger_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> VALUES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'ST412801'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'11'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'2023-07-21 10:48:20'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'CHARGING_IN_PROGRESS'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ON DUPLICATE KEY UPDATE latest_update_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'2023-07-21 10:48:20'</span><span class="token plain">, charger_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CHARGING_IN_PROGRESS'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*** </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> HOLDS THE Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECORD LockS space </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> page no </span><span class="token number" style="color:#36acaa">718</span><span class="token plain"> n bits </span><span class="token number" style="color:#36acaa">208</span><span class="token plain"> index PRIMARY of table </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charge</span><span class="token variable" style="color:#36acaa">`</span><span class="token builtin class-name">.</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">charger_status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> trx </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">946331</span><span class="token plain"> Lock_mode X Locks rec but not gap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>1번 트랜잭션 1000560이 charge_status 테이블에 insert <del>~ on duplicate key update ~</del> 쿼리를 발생시키기 위해 <code>space id 64 page no 742 n bits 424 index PRIMARY of table</code>  에 X Lock을 가지고 있습니다
그리고 2번 트랜잭션 946331 도 똑같은 테이블에 비슷한 쿼리를 발생시키려고 합니다. 그리고 해당 트랜잭션도 X Lock을 가지고 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="저희-팀에-데드락이-발생한-이유">저희 팀에 데드락이 발생한 이유<a href="#저희-팀에-데드락이-발생한-이유" class="hash-link" aria-label="저희 팀에 데드락이 발생한 이유에 대한 직접 링크" title="저희 팀에 데드락이 발생한 이유에 대한 직접 링크">​</a></h3><p>먼저 저희 팀은 공공 API를 통해 전기차 충전소 정보를 cron으로 업데이트 해주고 있습니다.
그리고 충전기의 상태도 주기적으로 업데이트 해주고 있습니다.
충전소 정보를 갱신할 경우 새로 생긴 충전소가 있다면 추가해줘야하고, 새로 생긴 충전소가 있다면 새로운 충전기가 있을테고, 그에따른 충전기 상태도 추가해줘야합니다.
그리고 원래 있던 충전소의 정보가 바뀌는 것에 대해서도 업데이트 해줘야합니다. 이렇게 된다면 여러번의 분기 처리로 application 레벨에서 해결하는 것이 나을지 혹은 mysql의 문법 중 <code>INSERT ~~ ON DUPLICATE KEY UPDATE ~~</code>을 이용할까 고민을 했었는데요.</p><p>그 중 후자를 택한 이유를 말씀드리겠습니다. 충전기의 정보는 하루에 공공 API를 요청할 수 있는 key 제한이 있고 지도 기반으로 검색할 수 있는 조건이 없기 때문에 실시간으로 요청할 수 없는 구조입니다.
그래서 요청 key 제한을 넘지 않는 선에서 자주 요청을 해야합니다. 그렇게해야 사용자에게 정보에 대한 신뢰를 줄 수 있습니다. 따라서 자주 요청되는 작업에 Application 레벨에서 구현한다면, findAll() 메서드를 통해 23만건의 충전기 상태 정보를 메모리에 로딩합니다. 그리고 api의 요청을 통해 얻은 23만+n건의 충전기 상태 정보를 메모리에 올립니다.</p><p>그리고 해당 정보가 있는지 비교합니다. 해당 정보가 findAll()로 찾아온 list에 없으면 Insert, 해당 정보가 있다면 update를 통해 갱신합니다.</p><p>이렇게 한다면 총 batch Insert, Update를 통해 2번의 쿼리 + 46만 n건의 충전기 정보를 메모리에 올려 비교하는 연산이 생길 것 입니다.
하지만  <code>INSERT ~~ ON DUPLICATE KEY UPDATE ~~</code> 를 사용한다면 batch insert를 통해 1번의 쿼리로 해결 할 수 있습니다. 메모리에 데이터도 적재하지 않고 말이죠.</p><p>하지만 보셨던 것과 같이 데드락이 발생했습니다.  이유는 <code>INSERT ~~ ON DUPLICATE KEY UPDATE ~~</code> 의 특수한 Lock mechanism 때문입니다. 해당 쿼리는</p><ol><li>먼저 삽입하려는 행이 테이블에 존재하는지 확인합니다.</li><li>그리고 읽은 record에 대해 S Lock을 설정합니다.</li><li>그리고 해당 record가 duplicate key라는 조건이라면 X Lock을 설정합니다.</li></ol><p>이런 방식으로 작동하기 때문입니다.
이런 방식이 왜 문제가 될 수 있는지 알아보겠습니다.
먼저 자신이 읽은 record에 S Lock을 각각의 트랜잭션이 설정합니다.
그리고 업데이트를 하기위해 record에 X Lock을 설정하려고 합니다. 하지만 각각의 트랜잭션이 서로 S Lock을 설정했기 때문에 S Lock을 반납하고 X Lock을 설정하려고 해도 두 트랜잭션 모두 기다리는 데드락 상황이 발생하기 때문입니다. 이런 상황이 되면 아까 위에서 말씀드렸던 데드락의 조건 4가지가 다 만족하고 데드락이 발생합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="해결-방안">해결 방안<a href="#해결-방안" class="hash-link" aria-label="해결 방안에 대한 직접 링크" title="해결 방안에 대한 직접 링크">​</a></h3><p>해결 방안은 여러가지가 있을 수 있습니다.
그 중 제 수준에서 생각할 수 있는 방법은 2가지가 있습니다.</p><ol><li>트랜잭션을 작게 분리
트랜잭션을 오래 가지고 있으면 Lock을 가지고 있는 시간이 오래걸립니다.
그래서 트랜잭션을 작게 분리할 수 있습니다.  페이징을 통해 트랜잭션을 작게 분리하다보면 쿼리가 여러번 나가 성능상 문제가 생길 수 있을 것 같습니다.</li><li><code>INSERT ~~ ON DUPLICATE KEY UPDATE ~~</code> 사용하지 않기
해당 sql이 아닌 <code>INSERT IGNORE</code>을 사용하여 추가된 정보만 넣고, update는 다른 작업으로 분리하기</li></ol><p>이런 방법들을 사용하면 될 것 같았습니다. 그 중 저는 현재는 간단하게 2번째 방법이 제일 나을 것 같다는 생각에 쿼리를 수정했습니다.</p><p>그리고 문제를 해결했습니다. 해당 문제가 발생하게 되어 좀 더 재밌는 것들을 고민하고 공부할 수 있는 저희 팀에게 감사하고 모르는 키워드를 많이 알려준 누누에게 감사합니다.</p><p>아직 배우는 단계라 정확한 정보가 아닐 수 있습니다. 부족한 부분에 대해 많은 지적 부탁드립니다.</p>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="deadlock" term="deadlock"/>
        <category label="trouble-shooting" term="trouble-shooting"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[필터링 기능 구현과 인덱스 이용한 조회 속도 개선하기]]></title>
        <id>https://car-ffeine.github.io/22</id>
        <link href="https://car-ffeine.github.io/22"/>
        <updated>2023-07-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요~]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요~</p><p>우테코 카페인 팀의 제이입니다.</p><p>오늘은 필터링 기능 구현 및 인덱스를 이용한 조회 속도 개선하는 작업을 진행했습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="요구-사항과-기능-구현-목록">요구 사항과 기능 구현 목록<a href="#요구-사항과-기능-구현-목록" class="hash-link" aria-label="요구 사항과 기능 구현 목록에 대한 직접 링크" title="요구 사항과 기능 구현 목록에 대한 직접 링크">​</a></h2><p>카페인 팀은 전기차 충전소 조회 및 통계 데이터를 제공해주는 서비스입니다.</p><p>사용자 입장에서 전기차 충전소를 조회할 때 본인 차에 맞는 충전기 타입과, 속도, 마지막으로 충전기를 제공하는 회사명 요금과 관련도 되어 있어서 중요할 수 있습니다.</p><p>그래서 무수히 많은 충전소를 보는 것이 아닌 자신에게 필요한 것만 보는 것이 사용자 경험에 있어서는 더 중요한데요.</p><p>저희 팀은 이를 위해 필터링 기능을 도입하고자 했습니다.</p><p>또한 조회가 많은 서비스인만큼 조회 속도 개선을 위해 인덱스를 적용하기로 했습니다.</p><p>필터링 뿐만 아니라 해당 작업을 하면서 어떤 고민을 했고 어떤 것을 했는지 적어보고자 합니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="필터링-기능-구현하기">필터링 기능 구현하기<a href="#필터링-기능-구현하기" class="hash-link" aria-label="필터링 기능 구현하기에 대한 직접 링크" title="필터링 기능 구현하기에 대한 직접 링크">​</a></h2><p>저희 팀은 빠르게 기능을 구현하는 단계에 있습니다.</p><p>따라서 일단 3개의 필터만 도입했고, 필터는 다음과 같습니다. <!-- -->[충전소 운영 회사 이름, 충전 타입, 충전 속도]</p><p>사용자는 필터를 클릭하면 현재 위치를 기준으로 주변에 해당 필터가 적용된 충전소를 볼 수 있습니다.</p><p>3개의 필터 중에서 모두 적용될 수도 있고, 모두 적용되지 않을 수도 있습니다.</p><p>그래서 2^3 = 8가지의 경우를 생각해야 했었습니다.</p><p>그래서 처음에 필터를 적용하기 위해서 다음과 같은 방법들을 생각했습니다.</p><ol><li><p>JPQL + 필터의 조합 (2^3)만큼 if문 사용하기</p></li><li><p>기존 좌표로 조회하는 findAllByLatitudeBetweenAndLongitudeBetween() 메서드를 사용 후 Stream을 이용해 자바 코드로 필터링하기</p></li></ol><p>이렇게 두 가지 방법이 있었습니다.</p><p>1번의 경우 우테코 프로젝트에서 Querydsl을 사용해도 되는지 확실하지 않았고 정확한 필터 명세가 아직은 없고 3가지만 일단 도입하고자 해서 JPQL을 이용해서 상황마다 if문으로 해당 메서드를 실행시켜주는 방법이었습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 1. fetch join + 회사 이름만 조회</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"SELECT DISTINCT s FROM Station s "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"LEFT JOIN FETCH s.chargers c "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"LEFT JOIN FETCH c.chargerStatus "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"WHERE s.latitude.value BETWEEN :minLatitude AND :maxLatitude "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"AND s.longitude.value BETWEEN :minLongitude AND :maxLongitude "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"AND s.companyName IN :companyNames"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAllByFilteringBeingCompanyNames</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"minLatitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> minLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                      </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"maxLatitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                      </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"minLongitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> minLongitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                      </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"maxLongitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLongitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                      </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"companyNames"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> companyNames</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 2. fetch join + 충전 타입</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"SELECT DISTINCT s FROM Station s "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"LEFT JOIN FETCH s.chargers c "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"LEFT JOIN FETCH c.chargerStatus "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"WHERE s.latitude.value BETWEEN :minLatitude AND :maxLatitude "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"AND s.longitude.value BETWEEN :minLongitude AND :maxLongitude "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"AND c.type IN :types"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAllByFilteringBeingTypes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"minLatitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> minLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"maxLatitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"minLongitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> minLongitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"maxLongitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLongitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"types"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">ChargerType</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>진행 했다면 이런 느낌이었겠네요!</p><p>2번의 경우 모두 조회를하고 자바 코드를 이용해서 필터링 해주는 방법이었습니다.</p><p>현재 저희 서비스는 좌표를 중심으로 주변 충전소를 조회합니다.</p><p>어차피 사용자가 화면을 축소해서 큰 범위의 지도를 보는 것은 어차피 막힐테니 사용자는 작은 범위에 대해서 조회하게 됩니다.</p><p>따라서 하나의 쿼리를 이용해서 자바 코드로 필터링 해주는 방법입니다.</p><p>이렇게만 봤을 땐 1번 방식인 필터 별로 조회해주는 것은 조회 효율은 더 좋을 것 같습니다.</p><p>하지만 1번의 방법은 '현재 구조'에서는 많은 쿼리문과 메서드를 작성해야하고, if문 범벅으로 보기 좋지 않은 코드가 완성 됐을 것 같습니다.</p><p>결국 2번 방식인 <!-- -->[전체 조회 + 코드로 필터링]<!-- --> 방식을 선택했습니다.</p><strong>이 이유는 다음과 같습니다.</strong><ol><li>어차피 사용자는 작은 범위에서 조회를 한다.</li><li>인덱스를 걸었을 때 가장 효율적이다.</li></ol><p>1번의 이유는 위에서 말했고, 2번에 대해 간단하게 설명 드리겠습니다.</p><p>저희 서비스는 조회가 굉장히 많지만, 충전소의 주기적인 업데이트를 위해 데이터 업데이트가 굉장히 빈번하게 일어납니다.</p><p>이 과정에서 많지는 않지만 데이터 삽입도 발생하고, 데이터 업데이트도 많아집니다.</p><p>JPQL로 조건을 나눠서 조회해준다면 해당하는 모든 필터에 인덱스를 걸어야할까요?</p><p>그럴 순 없었을 것 같습니다.</p><p>가장 효율적인 Column에 인덱스를 걸었겠죠, 그렇다면 조회마다 속도도 달라졌을 것이고 가령 해당하는 모든 Column에 인덱스를 설정해놔도 업데이트와 삽입이 느려졌을 것입니다.</p><p>이는 7분마다 데이터를 업데이트 하는 저희 서비스에서는 적절하지 않습니다.</p><p>반면에 한 개의 쿼리로 주변을 모두 조회하고 이를 자바 코드로 바꾸는 방법은 더 쉬웠습니다.</p><p>어차피 많지 않은 양의 데이터를 조회하고 필터링 하기 때문에 속도 면에서도 큰 차이가 나지 않았고, 인덱스 설정에도 유리했습니다.</p><p>조회시 이용하는 latitude와 longitude만 설정해주면 어떤 경우든 빠르게 조회를 할 수 있었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="인덱스-적용으로-조회-속도-향상시키기">인덱스 적용으로 조회 속도 향상시키기<a href="#인덱스-적용으로-조회-속도-향상시키기" class="hash-link" aria-label="인덱스 적용으로 조회 속도 향상시키기에 대한 직접 링크" title="인덱스 적용으로 조회 속도 향상시키기에 대한 직접 링크">​</a></h2><p>먼저 일단 현재 코드에서 조회시 다음과 같은 쿼리가 발생합니다.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Hibernate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        station0_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> station_1_0_0_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        chargersta2_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latest_update_time </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> latest_u4_2_2_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        charge_station station0_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">left</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">outer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        charger chargers1_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> station0_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">chargers1_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">left</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">outer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        charger_status chargersta2_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> chargers1_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">chargersta2_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charger_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> chargers1_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">chargersta2_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">station_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            station0_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latitude </span><span class="token operator" style="color:#393A34">between</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            station0_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">longitude </span><span class="token operator" style="color:#393A34">between</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>where 절에서 위도 경도를 바탕으로 주변만 가져오게 됩니다. 기존에 N+1 문제가 발생해서 EntityGraph로 바꿨고 실행시 쿼리입니다.</p><p>따라서 아래 글을 읽고 BETWEEN 쿼리에서 부등호를 이용하는 쿼리로 변경하였습니다.
<a href="https://velog.io/@ggomjae/Mysql-Query-Between-%EA%B3%BC-%EC%84%B1%EB%8A%A5-%EC%B0%A8%EC%9D%B4-%EB%B9%84%EA%B5%90-%EB%8D%94%EB%AF%B8%EB%8D%B0%EC%9D%B4%ED%84%B0-50%EB%A7%8C" target="_blank" rel="noopener noreferrer">Mysql Query Between 과 &gt;=, &lt;= 성능 차이 비교 ( 더미데이터 50만 )
</a></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"SELECT DISTINCT s FROM Station s "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"LEFT JOIN FETCH s.chargers c "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"LEFT JOIN FETCH c.chargerStatus "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"WHERE s.latitude.value &gt;= :minLatitude AND s.latitude.value &lt;= :maxLatitude "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"AND s.longitude.value &gt;= :minLongitude AND s.longitude.value &lt;= :maxLongitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Station</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAllByLatitudeBetweenAndLongitudeBetweenWithFetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"minLatitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> minLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                       </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"maxLatitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLatitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                       </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"minLongitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> minLongitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                       </span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"maxLongitude"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">BigDecimal</span><span class="token plain"> maxLongitude</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>위와 같이 조회해주는 쿼리를 만들었고, 인덱스를 만들어주었습니다.</p><p>인덱스 설정 기준은 <a href="https://jojoldu.tistory.com/243" target="_blank" rel="noopener noreferrer">인덱스 정리 및 팁</a>
위에 링크와 같이 동욱님의 블로그를 참조해서 기준을 세웠습니다.</p><p>무조건 카디널리티가 높은 것을 설정할 순 없었기 때문에 (업데이트와 삽입 작업이 많기 때문에) 쿼리에서 사용되는 column과 update 작업을 고려하고 성능을 비교해가면서 가장 효율적인 것을 설정해주었습니다.</p><p>그리고 속도를 비교해주었습니다.</p><br><br><p>​</p><strong>먼저 속도 비교를 위해서 데이터 셋은 다음과 같이 진행하였습니다.</strong><ul><li>Charger (23만 건)</li><li>Station (6만 건)</li><li>ChargerStatus(23만 건)</li><li>선릉역 근처 조회</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ver1-인덱스-적용을-하지-않고-조회-및-필터링-했을-때-속도-084초">Ver1. 인덱스 적용을 하지 않고 조회 및 필터링 했을 때 속도 (0.84초)<a href="#ver1-인덱스-적용을-하지-않고-조회-및-필터링-했을-때-속도-084초" class="hash-link" aria-label="Ver1. 인덱스 적용을 하지 않고 조회 및 필터링 했을 때 속도 (0.84초)에 대한 직접 링크" title="Ver1. 인덱스 적용을 하지 않고 조회 및 필터링 했을 때 속도 (0.84초)에 대한 직접 링크">​</a></h3><p><img loading="lazy" src="https://postfiles.pstatic.net/MjAyMzA3MjdfMTYy/MDAxNjkwNDQwMDA0ODEw.vaeA83AD9ycHa26YN58rqzPV3XdX2zTvIZgKM6YKXWEg.Qqkkdr_lEJeGbYPpWji0E-IusfGpqMpZHKWZM4AyRrUg.PNG.sosow0212/image.png?type=w773" alt="이미지" class="img_ev3q">
평균적으로 0.84초가 나왔습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ver2-인덱스-적용-및-조회-및-필터링-했을-때-속도-063초">Ver2. 인덱스 적용 및 조회 및 필터링 했을 때 속도 (0.63초)<a href="#ver2-인덱스-적용-및-조회-및-필터링-했을-때-속도-063초" class="hash-link" aria-label="Ver2. 인덱스 적용 및 조회 및 필터링 했을 때 속도 (0.63초)에 대한 직접 링크" title="Ver2. 인덱스 적용 및 조회 및 필터링 했을 때 속도 (0.63초)에 대한 직접 링크">​</a></h3><p><img loading="lazy" src="https://postfiles.pstatic.net/MjAyMzA3MjdfNTUg/MDAxNjkwNDQwMTUyMDcx.F3sSiDgLp3O2Rn1waqh31vC6yv1Uk0zZkRzjyuDQEM4g.eziRKLCmUbzW88ueQRozZcYvhsH10C17w-IDRLh0cJ4g.PNG.sosow0212/SE-48b3f814-3306-4add-ab95-381186bab6ca.png?type=w773" alt="이미지" class="img_ev3q">
평균적으로 0.63초가 나왔습니다.
약 25 ~ 30%의 조회 속도가 개선되었습니다.</p><p>아직 이 부분은 개선이 더 필요해보입니다.</p><p>그래도 개선이 됐고, 삽입과 갱신에는 큰 지장이 없어서 일단 이정도로 마무리 하고, 추후에 개선을 해보도록 하겠습니다.</p><p><img loading="lazy" src="https://postfiles.pstatic.net/MjAyMzA3MjdfNzMg/MDAxNjkwNDQwODA1NzAy.b5gZPjl_E1x3wbjSMNcmfQDKB-hB9p8FEbIJqs5Kl4Qg.ZBq0-GmXJruPO7ejA_zq7RfaBaC17doHJUT19wje1Qkg.PNG.sosow0212/SE-f5396915-60ef-4293-a457-e30e8f5a2794.png?type=w773" alt="이미지" class="img_ev3q">
추가적으로 충전기 조회는 굉장히 빨라졌습니다!</p><p>배우는 단계이다보니 미숙하고 틀린 부분이 있을 수 있습니다.</p><p>긴 글 읽어주셔서 감사합니다 :)</p>]]></content>
        <author>
            <name>제이</name>
            <uri>https://github.com/sosow0212</uri>
        </author>
        <category label="filter" term="filter"/>
        <category label="index" term="index"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 팀이 styled-components를 선택한 이유]]></title>
        <id>https://car-ffeine.github.io/20</id>
        <link href="https://car-ffeine.github.io/20"/>
        <updated>2023-07-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[왜 styled-components인가?]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="왜-styled-components인가">왜 styled-components인가?<a href="#왜-styled-components인가" class="hash-link" aria-label="왜 styled-components인가?에 대한 직접 링크" title="왜 styled-components인가?에 대한 직접 링크">​</a></h2><br><p>여러 <code>CSS-in-JS</code> 중 styled-components를 선택한 이유는 다음과 같다.</p><ol><li><p>컴포넌트 안에 관련 CSS를 작성할 수 있어 컴포넌트별 디자인 코드 확인 및 수정이 용이하다.</p></li><li><p>혹자는 코드 가독성이 안 좋아진다고도 하지만, 개인적으로는 태그를 더 시맨틱 하게 작성할 수 있어서 좋다고 느꼈다.</p></li><li><p>팀원들 모두 styled-components가 익숙하다.</p></li><li><p>지금까지 사용하면서 불편한 점을 못 느꼈다.</p></li></ol><br><p>styled-components와 emotion은 기능도, 작성법도 상당히 유사하다.</p><p>그래서 이번에는 styled-components 대신 emotion을 써볼까도 생각했었다.</p><p>하지만 emotion에서만 사용 가능하던 <!-- -->*<!-- -->CSS Props라는 편리한 기능을</p><p>styled-components(v5.2.0 이상)에서 쓸 수 있게 되기도 했고,</p><p>'새로운 기술 공부를 해보면 좋을 것 같다'는 이유를 제외하고는</p><p>딱히 emotion을 사용할 필요성을 못 느껴 styled-components를 채택했다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// *CSS Props 예시</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> buttonStyle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> css</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string css language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string css language-css">  </span><span class="token template-string css language-css property" style="color:#36acaa">font-size</span><span class="token template-string css language-css punctuation" style="color:#393A34">:</span><span class="token template-string css language-css"> </span><span class="token template-string css language-css number" style="color:#36acaa">18</span><span class="token template-string css language-css unit">px</span><span class="token template-string css language-css punctuation" style="color:#393A34">;</span><span class="token template-string css language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string css language-css">  </span><span class="token template-string css language-css property" style="color:#36acaa">color</span><span class="token template-string css language-css punctuation" style="color:#393A34">:</span><span class="token template-string css language-css"> </span><span class="token template-string css language-css color">white</span><span class="token template-string css language-css punctuation" style="color:#393A34">;</span><span class="token template-string css language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string css language-css">  </span><span class="token template-string css language-css property" style="color:#36acaa">background</span><span class="token template-string css language-css punctuation" style="color:#393A34">:</span><span class="token template-string css language-css"> </span><span class="token template-string css language-css color">black</span><span class="token template-string css language-css punctuation" style="color:#393A34">;</span><span class="token template-string css language-css"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string css language-css"></span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ClickButton </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> styled</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">button</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> css</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CSSProp </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">  width: 100px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">  </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">{</span><span class="token template-string interpolation"> css </span><span class="token template-string interpolation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> css</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c"></span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ClickButton css</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">buttonStyle</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">Click me</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ClickButton</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>야미</name>
            <uri>https://github.com/feb-dain</uri>
        </author>
        <category label="styled-components" term="styled-components"/>
        <category label="css" term="css"/>
        <category label="css in js" term="css in js"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 팀의 상태관리 전략 (왜 Tanstack Query여야 하는가?)]]></title>
        <id>https://car-ffeine.github.io/21</id>
        <link href="https://car-ffeine.github.io/21"/>
        <updated>2023-07-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요? 카페인 팀 FE에서 상태관리 라이브러리를 어떻게 해야할 지 고민 끝에 서드파티 라이브러리가 필요하게 되어 글을 작성하게됐습니다.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요? 카페인 팀 FE에서 상태관리 라이브러리를 어떻게 해야할 지 고민 끝에 서드파티 라이브러리가 필요하게 되어 글을 작성하게됐습니다.</p><h1>서버 상태와 클라이언트 상태의 구분</h1><p>서버상태와 UI상태를 이해하는 것은 굉장히 중요했습니다. 데이터를 송수신하는 작업과 상태를 관리하는 작업은 유기적으로 동작해야했습니다. 기존에는 <code>상태와 데이터 송수신 과정을 분리해서 생각</code>했다면, 현대의 react 프로젝트들은 <code>서버와 동기화를 해야할 상태</code>와 <code>그렇지 않은 상태</code>로 분리해서 생각해야 합니다.</p><p><code>React에서 어떤 데이터를 상태로 다뤄야 하는가</code>에 대해서는 여러 의견이 나올 수 있다고 생각하지만 <code>상태가 특성을 가지고 있는가</code>에 대해서는 대부분 특성이 있다고 동의할 것입니다. 이 글에서는 React의 상태란 무엇인가?에 대해서 다루지 않고 React의 상태의 특성에 대해서만 언급을 하려고 합니다.</p><p>상태의 특성으로는 크게 두 가지가 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="클라이언트-상태">클라이언트 상태<a href="#클라이언트-상태" class="hash-link" aria-label="클라이언트 상태에 대한 직접 링크" title="클라이언트 상태에 대한 직접 링크">​</a></h3><p>클라이언트 상태는 컴포넌트들 간에 어떤 값을 공유해야하면서 <code>오로지 React DOM 내부에서만 CRUD가 일어나는 상태를 의미</code>합니다. 이 상태들은 React DOM 외부 세계와 크게 관련이 없으며 <code>동기적으로 반영</code>됩니다. 대표적으로는 UI를 조작하는 상태들이 될 것입니다. 클라이언트 상태들은 대부분 장기적으로 유지될 필요가 없기에 화면을 벗어나거나 세션이 끊기는 경우 사라져도 괜찮은 경우가 많습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="서버-상태">서버 상태<a href="#서버-상태" class="hash-link" aria-label="서버 상태에 대한 직접 링크" title="서버 상태에 대한 직접 링크">​</a></h3><p>서버 상태는 React의 바깥 세상(서버)에 존재하는 <code>데이터가 React의 상태 관리와 비동기적으로 동기화 된 것</code>을 의미합니다. 어떤 상태가 <code>외부에서 관리되는 데이터와 반드시 연동</code>되어야 한다면 이는 곧 서버 상태임을 의미합니다. React의 상태를 CRUD 하는 것 뿐만 아닌, 서버에서도 항상 같은 일이 일어나야 합니다. 서버 상태는 장기적으로 유지되어야 하며, 세션에서 벗어나더라도 서버로 부터 복구를 해야 합니다.</p><p>기존의 상태 관리 라이브러리들은 리액트의 전역에서 상태를 조작하는 것에 특화되어있고, 비동기적인 상태 관리도 지원하여 서버와의 통신이 가능합니다. 하지만 대부분의 라이브러리들은 <code>클라이언트 상태를 조작하는 것에 초점</code>이 맞춰져있습니다.</p><p>더군다나 클라이언트 상태와 서버 상태가 하는 일이 명확하게 다른 상황에서 이 둘을 한 곳에서 관리하는 것 보다는 완벽하게 분리하는 것이 더 나을 것입니다. 따라서 서버 상태를 관리하는 것에 중점을 둔 라이브러리들이 등장하였습니다. 대표적인 라이브러리로는 RTK Query, Tanstack Query, SWR 등이 있습니다.</p><h1>왜 Tanstack Query였나?</h1><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vs-rtk-query">vs RTK Query<a href="#vs-rtk-query" class="hash-link" aria-label="vs RTK Query에 대한 직접 링크" title="vs RTK Query에 대한 직접 링크">​</a></h3><p>RTK Query는 RTK를 반드시 사용해야 하는 것은 아니지만 RTK를 타겟으로 나온 서버 상태 관리 라이브러리입니다. <code>카페인 팀에서는 클라이언트 상태를 관리하기 위해 라이브러리를 사용하지 않습니다.</code> 더욱이 Redux의 복잡한 코드 구성과 방대한 보일러 플레이트는 매력적이지 않았습니다. tanstack query에서는 무한 데이터 페칭을 지원하기 위해 <strong>Infinite Queries</strong>가 있지만 RTK Query는 그렇지 않았습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vs-swr">vs SWR<a href="#vs-swr" class="hash-link" aria-label="vs SWR에 대한 직접 링크" title="vs SWR에 대한 직접 링크">​</a></h3><p>SWR도 하나의 좋은 선택지였지만, 전역 상태 관리 라이브러리들이 범용적으로 지원하는 셀렉터 기능을 지원하지 않았습니다. 또, 가비지 컬렉터의 부재도 아쉬웠습니다. 재요청을 하기 위한 stale time 설정이나 쿼리 취소 기능이 없는 점도 매력적이지 않았습니다.</p><h1>카페인 팀에서 하려는 일은요…</h1><p>저희 카페인 팀의 프로젝트는 <code>실시간 전기자동차 충전소 지도 및 사용 통계 조회 서비스</code> 로 지도 기반의 프로젝트입니다. 서버 상태를 적극적으로 다뤄야 하는 상황에서 Tanstack Query를 서버 상태 관리 라이브러리로 선정하게 됐습니다.</p><p>메인 기능 중 Tanstack Query가 핵심으로 사용될 것 같은 기능은 다음과 같습니다.</p><ul><li>지도에서 충전소 조회<ul><li>현재 접속한 클라이언트에 렌더링 된 지도 화면(디스플레이)의 크기에 따른 GPS좌표를 알아내어 서버로 부터 충전소 정보를 수신 받습니다. 즉, 화면이 이동하게 되면 사용자가 바라보고 있는 영역이 변하므로 새로운 요청을 보내게 됩니다.</li><li>서버에서 수신한 충전소 정보는 실시간 사용 현황도 반영되어있으므로 <code>주기적인 업데이트</code>도 필요합니다.</li><li>빈번한 데이터의 변화가 필요하며 그만큼 통신 실패 등 <code>에러가 발생할 가능성도 많아지게</code> 됩니다.</li><li>사용자의 빠른 지도 이동이 발생하는 경우를 대응할 수 있어야 합니다.</li></ul></li><li>전국 충전소 검색기<ul><li>원하는 충전소 검색을 하는 기능을 지원합니다. 전국 단위로 검색 결과를 수신하는 기능입니다.</li><li>네이버와 구글 검색창 처럼 사용자가 input 창에 검색어를 입력할 때 마다 검색 결과가 동적으로 표시되어야 합니다.</li><li>빈번한 데이터의 변화가 필요하고, <code>사용자의 빠른 타이핑으로 인해 잦은 검색이 발생하는 경우를 대응할 수 있어야</code> 합니다.</li><li>이를 위해 데이터를 캐싱할 필요도 있다고 생각합니다.</li></ul></li></ul><p>프로젝트에서 클라이언트와 서버와의 통신이 어쩌다 한번 일어난다면 굳이 라이브러리가 필요가 없겠지만, 서버의 데이터 전적으로 의존해야 하는 저희 프로젝트 특성상 Tanstack Query의 여러 기능이 생산성에 많은 도움이 될 것으로 기대합니다.</p>]]></content>
        <author>
            <name>가브리엘</name>
            <uri>https://github.com/gabrielyoon7</uri>
        </author>
        <category label="tanstack query" term="tanstack query"/>
        <category label="react state management" term="react state management"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[OAuth 2.0의 흐름과 설정 해보기]]></title>
        <id>https://car-ffeine.github.io/19</id>
        <link href="https://car-ffeine.github.io/19"/>
        <updated>2023-07-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[OAuth 2.0 ?]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="oauth-20-">OAuth 2.0 ?<a href="#oauth-20-" class="hash-link" aria-label="OAuth 2.0 ?에 대한 직접 링크" title="OAuth 2.0 ?에 대한 직접 링크">​</a></h2><blockquote><p>OAuth("Open Authorization")는 인터넷 사용자들이 비밀번호를 제공하지 않고 다른 웹사이트 상의 자신들의 정보에 대해 웹사이트나 애플리케이션의 접근 권한을 부여할 수 있는 공통적인 수단</p></blockquote><p>위키 백과에서는 위와 같이 설명하고 있습니다. 우리가 google과 같은 웹 사이트에 회원가입을 하고 저장해둔 이름, 이메일, 프로필 이미지 같은 정보를
굳이 한번 더 입력하지 않고도 다른 웹 사이트에서 사용할 수 있는 것 입니다. 그리고 다른 웹 사이트를 사용하더라도 google에서 로그인을 하는 과정을 거치기 때문에, 사용자는
비밀번호나, critical한 개인정보 같은 것을 한 곳에서 관리할 수 있다는 장점이 있습니다.</p><p>다시 한번 정리하자면 우리 웹 사이트의 사용자가 이용하는 다른 웹 사이트의 정보를 사용할 수 있게끔 다른 웹 사이트에서 권한을 위임 받는 것 입니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="oauth-flow">OAuth flow<a href="#oauth-flow" class="hash-link" aria-label="OAuth flow에 대한 직접 링크" title="OAuth flow에 대한 직접 링크">​</a></h3><p>OAuth Flow를 설명하기 전에 여기서 모르는 단어들이 많습니다.
해당 <a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-16#section-1.1" target="_blank" rel="noopener noreferrer">링크</a>에서 더 자세하게 정리 되어있지만 설명해보겠습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="resource-owner">Resource Owner<a href="#resource-owner" class="hash-link" aria-label="Resource Owner에 대한 직접 링크" title="Resource Owner에 대한 직접 링크">​</a></h4><p>Resource Owner는 말 그대로 리소스 소유자이고, 구글과 같은 플랫폼에 회원가입이 되어있는, 즉 구글에 자신의 정보들이 있는 사용자입니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="client">Client<a href="#client" class="hash-link" aria-label="Client에 대한 직접 링크" title="Client에 대한 직접 링크">​</a></h4><p>Client도 말 그대로 고객입니다. 하지만 어떤 관점에서 보느냐 고객이란 뜻은 달라집니다. 여기서는 Google과 같은 플랫폼에서 제공받은 리소스를 사용하는 고객입니다.
즉 우리의 서비스가 Client가 되는 것입니다. 왜냐면 우리는 구글에 정보를 요청하고 우리의 서비스에서 사용하기 때문입니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorization-server">Authorization Server<a href="#authorization-server" class="hash-link" aria-label="Authorization Server에 대한 직접 링크" title="Authorization Server에 대한 직접 링크">​</a></h4><p>여기도 말 그대로 인증 서버입니다. Resource Owner가 올바른 정보를 입력했는지 검증하고, 발급 받은 Code와 Token이 올바른 것인지 검증합니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="resource-server">Resource Server<a href="#resource-server" class="hash-link" aria-label="Resource Server에 대한 직접 링크" title="Resource Server에 대한 직접 링크">​</a></h4><p>Resource Owner의 정보들을 가지고 있는 서버입니다. 인증 서버에서 인증을 마치고 난 뒤 우리는 Resource를 받습니다.</p><p>하지만 여기서 Authorization Server 와 Resource Server가 나뉘어진 이유는 딱히 없습니다. <strong>해당 플랫폼의 서버 구성에 따라 다를 수 있습니다.</strong></p><p>중요한 것은 <strong>Authorization Server</strong>와 <strong>Resource Server</strong>가 같은 묶음이라는 것 입니다.</p><p>간단하게 flow를 도식화 했습니다.</p><ol><li>먼저 Resource Owner는 로그인을 하고 싶다면 Client가 제공하는 해당 Resource platform의 URI를 클릭합니다. 그리고 인증서버에서 로그인 페이지를 제공 받습니다.</li><li>그리고 Resource Owner는 ID/PW를 입력하고 Authorization Code를 발급 받습니다. 동시에 Client에서 등록해놓은 Redirect URI로 code와 함께 이동합니다.</li><li>Client는 Resource Owner에게 받은 Code를 가지고 Authorization Server에 토큰을 요청합니다. 그리고 받은 토큰을 저장합니다.</li><li>그리고 Client는 로그인을 성공하고 이후 다른 platform에서 정보를 필요하게 된다면 저장한 Access Token을 통해 Resource Server에서 정보를 가져옵니다.</li></ol><p>근데 여기서 이상한 점이 있습니다. 이상하다기보단 왜 이렇게 복잡한가 라는 의문을 가질 수 있습니다.</p><p>굳이 Authorization code를 받아 다시 한번 더 Access Token을 받아야 한다는 부분입니다. 바로 <strong>Client에게 Access Token을 준다면 통신이 한번 줄어들 수 있지 않을까??</strong></p><p>보안문제 때문입니다.
만약 바로 Access Token을 준다면 그 Access Token이 탈취 당하면 해당 Resource Owner의 모든 정보에 접근할 수 있게 됩니다.
Code는 Secret Key와 같이 전달해야 Access Token을 발급 받을 수 있기 때문에 탈취되어도 더 안전합니다.
하지만 다른 플랫폼에서 Code나 Token이나 해당 정보를 전달할 방법은 URI에 전달하는 방법뿐 입니다.
그렇기 때문에 Redircet URI에 Access Token을 담는다면 탈취 가능성이 커지기 때문에 보안문제가 발생합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="백엔드와-프론트엔드의-flow">백엔드와 프론트엔드의 flow<a href="#백엔드와-프론트엔드의-flow" class="hash-link" aria-label="백엔드와 프론트엔드의 flow에 대한 직접 링크" title="백엔드와 프론트엔드의 flow에 대한 직접 링크">​</a></h3><p>아까 Client 부분을 좀 더 Frontend, Backend로 구분지어 세분화 해봤습니다. 복잡해보이지만, 전혀 어렵지 않습니다. 아까 설명했던 흐름과 다른 부분은 없습니다.</p><p>또 여기서는 굳이 제가 Authorization Server에서 Code를 받아올 때 Redirect URI를 백엔드 서버로 하지않고 프론트엔드 서버로 하려는 이유는 Resource Owner가 다른 platform과 인증하는 부분은 백엔드의 역할이 아니라고 생각했습니다.
그리고 백엔드는 Resource Owner가 가져온 code를 프론트엔드에서 전달 받아 Resource Server에 정보를 요청하는 것이라고 생각했습니다.
<strong><em>(물론 제 개인적인 의견이라 정답은 아닙니다.)</em></strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="oauth-구현해보기">OAuth 구현해보기<a href="#oauth-구현해보기" class="hash-link" aria-label="OAuth 구현해보기에 대한 직접 링크" title="OAuth 구현해보기에 대한 직접 링크">​</a></h2><p>간단히 Spring Security 없이 OAuth 인증을 구현해보겠습니다.</p><p>제일 먼저 구글 혹은 다른 플랫폼에서 설정한 id, secret key 등등의 정보를 yml에 작성했습니다.</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">application-oauth.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">oauth2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">provider</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">google</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">secret</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> google</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">redirect-url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">8080/login/oauth2/code/google</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">token-url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//www.googleapis.com/oauth2/v4/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">info-url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//www.googleapis.com/oauth2/v2/userinfo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>그리고 OAuth는 어느 플랫폼이 될 지 모르고, 확장성 있게 구성하는 것이 좋을 것 같아 인터페이스로 만들었습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">OAuthMember.java</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">OAuthMember</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">email</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nickname</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">imageUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이러한 클래스들을 관리하기 쉽게 Enum을 추가합니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Provider.java</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">Provider</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">GOOGLE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"google"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">GoogleMember</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> providerName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Function</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">OAuthMember</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> function</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Provider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> providerName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Function</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">OAuthMember</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> function</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">providerName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> providerName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">function </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> function</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">Provider</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Arrays</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">providerName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findFirst</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">orElseThrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RuntimeExceptin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">OAuthMember</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getOAuthProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> function</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>해당 Enum은 두개의 필드를 가지고 있습니다. 하나는 해당 플랫폼의 이름, 그리고 <code>Map&lt;String, Object&gt;</code>를 아까 만들었던 인터페이스로 반환하는 Function 여기서
<code>Map&lt;String, Object&gt;</code>로 지정해준 이유는, 플랫폼마다 반환되는 JSON 타입이 다르기 때문에 그런 부분에 대해 중복을 제거하기 위해 이러한 형태로 만들었습니다.</p><p>그리고 아까 yml에 작성했던 정보들을 가져와야합니다. <code>@Value</code> 어노테이션으로도 가져올 수 있습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token annotation punctuation" style="color:#393A34">@Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"oauth.provider.google.id"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token annotation punctuation" style="color:#393A34">@Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"oauth.provider.google.secret"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> secret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>하지만 이렇게 계속 binding을 해줘야한다는 점이 아주 귀찮고 보기도 안좋습니다.</p><div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">build.gradle</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">annotationProcessor "org.springframework.boot:spring-boot-configuration-processor"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>하지만 위의 의존성을 추가해준다면 아주 편하게 property를 가져올 수 있습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">OAuthProviderProperties.java</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@ConfigurationProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prefix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"oauth2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">OAuthProviderProperties</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// prefix oauth2 기준으로 알아서 google이 이름인 Provider Enum을 찾아서 Key로 바인딩</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Provider</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">OAuthProviderProperty</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> provider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EnumMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">OAuthProviderProperty</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getProviderProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Provider</span><span class="token plain"> provider</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Getter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Setter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">OAuthProviderProperty</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 그리고 provider 하위 정보들은 아래의 필드에 바인딩</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> secret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> redirectUrl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> tokenUrl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> infoUrl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 되면 구조적인 준비는 끝났습니다.</p><p>이제는 해당 플랫폼에 정보를 요청하는 작업만 하면 됩니다.
그럼 아까 말씀드렸던 순서로 요청을 해보겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">RestTemplateOAuthRequester.java</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RestTemplateOAuthRequester</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">OAuthRequester</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">OAuthMember</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">login</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">OAuthLoginRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// frontend에서 받아온 로그인 platform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Provider</span><span class="token plain"> provider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">provider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 해당 Platform에 맞는 정보 찾음</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">OAuthProviderProperty</span><span class="token plain"> property </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oAuthProviderProperties</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getProviderProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// frontend에서 받아온 code와 등록해놓은 property로 Access Token 요청</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">OAuthTokenResponse</span><span class="token plain"> token </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">requestAccessToken</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">property</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> requet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 받아온 Token으로 해당 Resource Owner의 정보 요청</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> userAttributes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getUserAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">property</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getOAuthProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userAttributes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">OAuthTokenResponse</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">requestAccessToken</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">OAuthProviderProperty</span><span class="token plain"> property</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">HttpHeaders</span><span class="token plain"> headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HttpHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBasicAuth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">property</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> property</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSecret</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setContentType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MediaType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">APPLICATION_FORM_URLENCODED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">HttpEntity</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">MultiValueMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HttpEntity</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">URI</span><span class="token plain"> tokenUri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getTokenUri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">property</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> restTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">postForEntity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tokenUri</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">OAuthTokenResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">URI</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getTokenUri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">OAuthProviderProperty</span><span class="token plain"> property</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">UriComponentsBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fromUriString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">property</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTokenUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queryParam</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">CODE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">URLDecoder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">StandardCharsets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">UTF_8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queryParam</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">GRANT_TYPE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AUTHORIZATION_CODE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queryParam</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">REDIRECT_URI</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> property</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRedirectUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toUri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getUserAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">OAuthProviderProperty</span><span class="token plain"> property</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">OAuthTokenResponse</span><span class="token plain"> tokenResponse</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">HttpHeaders</span><span class="token plain"> headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HttpHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBearerAuth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tokenResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">accessToken</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setContentType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MediaType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">APPLICATION_JSON</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">URI</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">URI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">property</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInfoUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">RequestEntity</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> requestEntity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RequestEntity</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">HttpMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">GET</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ResponseEntity</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> responseEntity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> restTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">exchange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestEntity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ParameterizedTypeReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> responseEntity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게만 한다면 그 어려워 보이던 OAuth 인증도 간단하게 해결할 수 있습니다.
<strong><em>(물론 제 코드가 정답이 아닙니다)</em></strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="#reference" class="hash-link" aria-label="Reference에 대한 직접 링크" title="Reference에 대한 직접 링크">​</a></h3><p><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-16" target="_blank" rel="noopener noreferrer">https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-16</a></p><p><a href="https://developers.google.com/identity/protocols/oauth2?hl=ko" target="_blank" rel="noopener noreferrer">https://developers.google.com/identity/protocols/oauth2?hl=ko</a></p>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="oauth" term="oauth"/>
        <category label="login" term="login"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[private 서브넷에 인스턴스를 외부와 연결할 때, public ip? private ip?]]></title>
        <id>https://car-ffeine.github.io/18</id>
        <link href="https://car-ffeine.github.io/18"/>
        <updated>2023-07-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[어떤 문제가 있었나요?]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="어떤-문제가-있었나요">어떤 문제가 있었나요?<a href="#어떤-문제가-있었나요" class="hash-link" aria-label="어떤 문제가 있었나요?에 대한 직접 링크" title="어떤 문제가 있었나요?에 대한 직접 링크">​</a></h2><p>우아한테크코스에서 private 서브넷에 db 인스턴스를 두고, 보안을 위해 외부에서 접속을 차단하려고 했습니다.</p><p>이 과정에서 총 2가지의 문제점이 있었습니다.</p><ol><li>private 서브넷에 인스턴스가 인터넷에서 mysql을 설치할 수 없었습니다.</li><li>public 서브넷에 있는 인스턴스에서 private 서브넷에 있는 인스턴스에 접속이 안되었습니다.</li></ol><p>이 부분을 어떻게 해결했는지 알아보도록 하겠습니다.</p><p>아래의 모든 설명은 AWS 를 기준으로 합니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="private-서브넷에-인스턴스가-인터넷에서-mysql을-설치할-수-없었다">private 서브넷에 인스턴스가 인터넷에서 mysql을 설치할 수 없었다.<a href="#private-서브넷에-인스턴스가-인터넷에서-mysql을-설치할-수-없었다" class="hash-link" aria-label="private 서브넷에 인스턴스가 인터넷에서 mysql을 설치할 수 없었다.에 대한 직접 링크" title="private 서브넷에 인스턴스가 인터넷에서 mysql을 설치할 수 없었다.에 대한 직접 링크">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="해결-방법">해결 방법<a href="#해결-방법" class="hash-link" aria-label="해결 방법에 대한 직접 링크" title="해결 방법에 대한 직접 링크">​</a></h3><p>public ip 자동할당을 해주지 않아서, 인터넷에 연결이 안 되었습니다.</p><p>이를 해결하기 위해 public ip 자동할당을 해주었습니다.</p><p>왜 public ip를 할당했더니 문제가 해결되었을까요?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="private-서브넷이란">private 서브넷이란?<a href="#private-서브넷이란" class="hash-link" aria-label="private 서브넷이란?에 대한 직접 링크" title="private 서브넷이란?에 대한 직접 링크">​</a></h2><p>정말 간단하게 설명했을 때</p><p>private 서브넷은 인터넷에 연결되지 않은 서브넷입니다.</p><p>조금 자세하게 들어가 보도록 하겠습니다</p><p>private 서브넷은 인터넷 게이트웨이가 연결되지 않은 서브넷입니다.</p><p>aws 공식문서에서 사진을 통해 보면 아래와 같이 되어있습니다</p><p><img loading="lazy" src="https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/images/internet-gateway-basics.png" alt="private subnet" class="img_ev3q"></p><p>public 서브넷에만 인터넷 게이트웨이가 연결되어 있고, private 서브넷에는 인터넷 게이트웨이가 연결되어있지 않습니다.</p><p>private 서브넷에 인터넷 게이트웨이가 연결되어 있지 않다고 했을 때, 기본적으로 인터넷에 접속이 안됩니다.</p><p>mysql을 설치할 때도, 인터넷에 접속을 해야하는데, 인터넷에 접속이 안되니 설치가 안되는 것입니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="어-인터넷-자체가-접근이-안되면-어떻게-설치하나요">어? 인터넷 자체가 접근이 안되면 어떻게 설치하나요?<a href="#어-인터넷-자체가-접근이-안되면-어떻게-설치하나요" class="hash-link" aria-label="어? 인터넷 자체가 접근이 안되면 어떻게 설치하나요?에 대한 직접 링크" title="어? 인터넷 자체가 접근이 안되면 어떻게 설치하나요?에 대한 직접 링크">​</a></h3><p>정말 원시적으로 해결하기 위해서는 public 서브넷에 인스턴스를 하나 더 만들어서, mysql 을 압축해서 scp를 통해 private 서브넷에 있는 인스턴스에 전송하고, 압축을 풀어서 설치하는 방법이 있습니다.</p><p>하지만 이 방법은 너무 원시적이고, 비효율적입니다.</p><p>그래서 인터넷으로 요청을 보낼 수 있도록 만드는 과정이 필요합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="인터넷으로-요청을-보낼-수-있도록-만드는-과정">인터넷으로 요청을 보낼 수 있도록 만드는 과정<a href="#인터넷으로-요청을-보낼-수-있도록-만드는-과정" class="hash-link" aria-label="인터넷으로 요청을 보낼 수 있도록 만드는 과정에 대한 직접 링크" title="인터넷으로 요청을 보낼 수 있도록 만드는 과정에 대한 직접 링크">​</a></h3><p>인터넷으로 요청을 보낼 수 있도록 만드는 과정은 크게 2가지가 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="private-서브넷을-public-서브넷으로-바꾸기">private 서브넷을 public 서브넷으로 바꾸기<a href="#private-서브넷을-public-서브넷으로-바꾸기" class="hash-link" aria-label="private 서브넷을 public 서브넷으로 바꾸기에 대한 직접 링크" title="private 서브넷을 public 서브넷으로 바꾸기에 대한 직접 링크">​</a></h3><p>보안을 위해서 private 서브넷에 두려고 했던 것을 public 서브넷으로 바꾼다는 부분은 매우 위험합니다.</p><p>그래서 이 방법은 보통 사용하지 않습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nat-인스턴스gateway-만들기">NAT 인스턴스(Gateway) 만들기<a href="#nat-인스턴스gateway-만들기" class="hash-link" aria-label="NAT 인스턴스(Gateway) 만들기에 대한 직접 링크" title="NAT 인스턴스(Gateway) 만들기에 대한 직접 링크">​</a></h3><p>NAT 인스턴스는 private 서브넷에 있는 인스턴스가 인터넷에 접속할 수 있도록 만들어주는 인스턴스입니다.</p><p>인터넷에 접속을 하기 위해서는 public ip 가 필요합니다.</p><p>따라서 NAT 인스턴스, NAT 게이트웨이는 public 서브넷에 존재해야 합니다.</p><p>어? NAT 인스턴스를 통해서 바로 통신이 가능하면 왜 private 서브넷이 필요한가요? 그냥 다 public 서브넷에 두면 되지 않나요?</p><p>NAT 인스턴스, NAT Gateway는 내부에서 출발한 트래픽만 통과할 수 있도록 설정이 되어있습니다.</p><p>예를 들면 private 서브넷에 인스턴스에 접속해서 직접 mysql download 요청을 했을 때만 허용이 됩니다.</p><p>외부에서 바로 private 인스턴스로 접근할 수는 없습니다.</p><p>NAT 인스턴스만 설정을 하면 바로 연결이 되나요?</p><p>public ip도 자동 할당을 해줘야 합니다</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="public-ip-가-필요한-이유">public ip 가 필요한 이유<a href="#public-ip-가-필요한-이유" class="hash-link" aria-label="public ip 가 필요한 이유에 대한 직접 링크" title="public ip 가 필요한 이유에 대한 직접 링크">​</a></h3><p>NAT 인스턴스를 통해서 private 서브넷에 있는 인스턴스가 인터넷에 접속할 수 있도록 만들었는데, 왜 public ip 가 필요할까요?</p><p>외부 인터넷과 통신을 할 때 public ip 가 필요합니다.</p><p>NAT 인스턴스 혹은 NAT 게이트웨이가 인터넷과 통신할 때, NAT 인스턴스의 public ip + private ip를 통해서 통신을 하지 않습니다.</p><p>내부 인스턴스의 public ip 를 통해서 통신을 하게 되어있습니다.</p><p>따라서 NAT 인스턴스와 내부 인스턴스 모두 public ip 가 필요합니다.</p><p>이 과정을 통해서 1번 문제를 해결할 수 있었습니다.</p><p>이제 2번째 문제를 해결해 보도록 하겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="public-서브넷에-있는-인스턴스에서-private-서브넷에-있는-인스턴스에-접속이-안-되는-문제">public 서브넷에 있는 인스턴스에서 private 서브넷에 있는 인스턴스에 접속이 안 되는 문제<a href="#public-서브넷에-있는-인스턴스에서-private-서브넷에-있는-인스턴스에-접속이-안-되는-문제" class="hash-link" aria-label="public 서브넷에 있는 인스턴스에서 private 서브넷에 있는 인스턴스에 접속이 안 되는 문제에 대한 직접 링크" title="public 서브넷에 있는 인스턴스에서 private 서브넷에 있는 인스턴스에 접속이 안 되는 문제에 대한 직접 링크">​</a></h2><p>public 서브넷에 있는 서버가 private 서브넷에 있는 서버에 접속을 하려고 했는데, 접속이 안 되는 문제가 있었습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="해결-방법-1">해결 방법<a href="#해결-방법-1" class="hash-link" aria-label="해결 방법에 대한 직접 링크" title="해결 방법에 대한 직접 링크">​</a></h3><p>해결 방법에는 2가지 과정이 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="public-서브넷에-있는-인스턴스의-보안-그룹에-private-서브넷에-있는-인스턴스의-보안-그룹을-추가해-주기">public 서브넷에 있는 인스턴스의 보안 그룹에 private 서브넷에 있는 인스턴스의 보안 그룹을 추가해 주기<a href="#public-서브넷에-있는-인스턴스의-보안-그룹에-private-서브넷에-있는-인스턴스의-보안-그룹을-추가해-주기" class="hash-link" aria-label="public 서브넷에 있는 인스턴스의 보안 그룹에 private 서브넷에 있는 인스턴스의 보안 그룹을 추가해 주기에 대한 직접 링크" title="public 서브넷에 있는 인스턴스의 보안 그룹에 private 서브넷에 있는 인스턴스의 보안 그룹을 추가해 주기에 대한 직접 링크">​</a></h3><p>기본적으로 public 서브넷에 있는 인스턴스의 보안 그룹에는 private 서브넷에 있는 인스턴스의 보안 그룹이 추가되어있지 않습니다.</p><p>따라서 public 서브넷에 있는 인스턴스의 보안 그룹에 private 서브넷에 있는 인스턴스의 보안 그룹을 추가해주어야 합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="private-ip를-통해서-접속하기">private ip를 통해서 접속하기<a href="#private-ip를-통해서-접속하기" class="hash-link" aria-label="private ip를 통해서 접속하기에 대한 직접 링크" title="private ip를 통해서 접속하기에 대한 직접 링크">​</a></h3><p>public 서브넷에 있는 인스턴스가 private 서브넷에 있는 인스턴스에 접속할 때, public ip 를 통해서 접속을 하면 안 됩니다.</p><p>public ip를 통해서 접속하는 과정을 자세하게 알아보겠습니다.</p><ol><li>public 서브넷에 있는 인스턴스가 public ip 를 통해서 private 서브넷에 있는 인스턴스에 접속을 시도합니다.</li><li>라우팅 테이블에서 public ip 일 경우에 어떻게 처리할지에 대한 정보를 찾습니다.</li><li>라우터를 통해서 외부 인터넷으로 나가게 됩니다.</li><li>트래픽이 NAT 인스턴스에 도착합니다.</li><li>NAT 인스턴스는 내부에서 출발한 트래픽이 아니기 때문에, 트래픽을 거부합니다.</li></ol><p>이 과정이 일어나기에, public ip 를 통해서 접속을 하면 안 됩니다.</p><p>private ip를 통해서 접근하면 어떻게 되는지 알아보겠습니다</p><ol><li>public 서브넷에 있는 인스턴스가 private ip 를 통해서 private 서브넷에 있는 인스턴스에 접속을 시도합니다.</li><li>라우팅 테이블에서 private ip 일 경우에 어떻게 처리할지에 대한 정보를 찾습니다.</li><li>라우터를 거쳐서 private 서브넷의 라우터로 이동합니다.</li><li>private 서브넷의 라우터는 private 서브넷에 있는 인스턴스에게 트래픽을 전달합니다.</li><li>private 서브넷에 있는 인스턴스는 트래픽을 받아서 처리합니다.</li></ol><p>이 과정을 통해서 2번 문제를 해결할 수 있었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="요약">요약<a href="#요약" class="hash-link" aria-label="요약에 대한 직접 링크" title="요약에 대한 직접 링크">​</a></h2><ol><li>private 서브넷에 있는 인스턴스가 인터넷에 접속을 하려면 NAT 인스턴스 혹은 NAT 게이트웨이가 필요합니다.</li><li>private 서브넷에 있는 인스턴스도 public ip 가 필요합니다.</li><li>public 서브넷에 있는 인스턴스가 private 서브넷에 있는 인스턴스에 접속을 하려면 private 서브넷에 있는 인스턴스의 보안 그룹을 추가해주어야 합니다.</li><li>public 서브넷에 있는 인스턴스가 private 서브넷에 있는 인스턴스에 접속을 할 때, private ip 를 통해서 접속을 해야 합니다.</li></ol>]]></content>
        <author>
            <name>누누</name>
            <uri>https://github.com/be-student</uri>
        </author>
        <category label="aws" term="aws"/>
        <category label="vpc" term="vpc"/>
        <category label="subnet" term="subnet"/>
        <category label="ip" term="ip"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 팀의 CI/CD]]></title>
        <id>https://car-ffeine.github.io/17</id>
        <link href="https://car-ffeine.github.io/17"/>
        <updated>2023-07-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요. 카페인 팀의 제이입니다.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요. 카페인 팀의 제이입니다.
저희 팀에서 CI/CD는 어떻게 진행되는지 작성하겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ci-지속적-통합">CI (지속적 통합)<a href="#ci-지속적-통합" class="hash-link" aria-label="CI (지속적 통합)에 대한 직접 링크" title="CI (지속적 통합)에 대한 직접 링크">​</a></h2><p><img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/blob/main/ci-cd/ci.png?raw=true" alt="ci" class="img_ev3q"></p><p>카페인 팀에서는 지속적 통합 즉 CI를 진행하기 위해서 위에 사진과 같이 Github Actions를 사용합니다.</p><p>main, develop 브랜치에 Push, Pull Request 요청이 들어간다면 이벤트가 발생하고, Github Actions를 통해 저희가 작성해둔 스크립트가 실행 됩니다.</p><p>이 스크립트에 여러가지를 등록할 순 있지만, 저희는 자동으로 테스트를 진행하도록 하였습니다.
자동으로 테스트를 돌리면서 테스트가 통과를 해야지만 Merge를 진행할 수 있습니다.</p><p>이를 통해 개발자의 실수를 줄일 수 있고 안정적으로 지속적 통합을 이룰 수 있게 됩니다.</p><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cd-지속적-배포">CD (지속적 배포)<a href="#cd-지속적-배포" class="hash-link" aria-label="CD (지속적 배포)에 대한 직접 링크" title="CD (지속적 배포)에 대한 직접 링크">​</a></h2><p><img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/blob/main/ci-cd/cd.png?raw=true" alt="cd" class="img_ev3q"></p><p>저희의 지속적 배포 아키텍처입니다.</p><strong>순서를 요약하자면 다음과 같습니다.</strong><ol><li>Release 브랜치에 Push를 한다.</li><li>Github Actions를 통해 Docker Hub에 레포지토리의 소스코드를 Docker Image로 빌드해서 Push 한다.</li><li>인프라 서버에서 Self Hosted Runner가 작동한다.</li><li>인프라 서버에서 배포 서버로 들어간다.</li><li>배포 서버 안에서 Docker Hub에 미리 업로드한 Docker Image를 Pull 해온다.</li><li>배포 서버 안에서 Docker Image를 컨테이너에 띄운다.</li></ol><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="배포-자동화-툴-선택하기">배포 자동화 툴 선택하기<a href="#배포-자동화-툴-선택하기" class="hash-link" aria-label="배포 자동화 툴 선택하기에 대한 직접 링크" title="배포 자동화 툴 선택하기에 대한 직접 링크">​</a></h3><p>먼저 배포 자동화 과정을 구축하기 위해서 여러가지 툴이 있습니다.</p><p>Travis, Jenkins, Github Actions 등등 여러가지가 있는데요.
저희 팀은 <code>Github Actions</code>를 선택했습니다.</p><p>이를 선택한 여러가지 이유가 있었지만
저희 팀 누누를 제외하고 CI/CD 경험이 부족해서 비교적 쉽고 설치 및 큰 세팅이 없는 점이 저희한테는 매력적으로 다가왔습니다.</p><p>또한 Docker를 사용하는데, 이유는 다음과 같습니다.</p><ol><li>JDK 혹은 Node 버전을 관리할 수 있다.</li><li>Docker Image를 빌드한 후 배포하기 때문에 서버 환경 차이로 발생하는 문제를 최소화할 수 있다.</li><li>배포 서버에서 Docker만 설치하고 Image를 받고 실행시키면 돼서 빠르고 쉽게 배포 환경을 구축할 수 있다.</li></ol><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="과정">과정<a href="#과정" class="hash-link" aria-label="과정에 대한 직접 링크" title="과정에 대한 직접 링크">​</a></h3><p>본격적으로 저희의 배포 자동화를 구축하는 과정을 설명하겠습니다.</p><br><strong>1. Github Actions에 Runners 등록</strong><p><img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/blob/main/ci-cd/selfHosted.png?raw=true" alt="runner" class="img_ev3q">
먼저 Self Hosted Runner를 이용하기 때문에 저희는 위에 사진과 같이 Runners를 등록을 해줬습니다.</p><p>이를 등록을 할 때 제공해주는 설정 코드가 나오는데요.
이 코드들을 infra 서버에 모두 입력을 해주면서 설정을 해주시면 됩니다.</p><br><strong>2. Github workflow 만들기</strong>다음으로는 저희가 수행하고자 하는 Task를 등록해주기 위해서 yml 파일을 만들어줍니다.<p>yml 파일의 경로는 <code>./github/workflows/</code> 안에 만들어주면 됩니다.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># release/backend push 할 때</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> release/backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Docker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">docker-build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaults</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Docker Hub 로그인</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Log in to Docker Hub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker/login</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">action@f4ef78c080cd8ba55a85445d5b36e214a81df20a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.DOCKERHUB_USERNAME </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.DOCKERHUB_PASSWORD </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set up JDK 17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">java@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">java-version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'17'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">distribution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'adopt'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Gradle Caching</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/cache@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            ~/.gradle/caches</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            ~/.gradle/wrapper</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> runner.os </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gradle</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> hashFiles('</span><span class="token important">**/*.gradle*'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> '</span><span class="token important">**/gradle-wrapper.properties')</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">restore-keys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            ${{ runner.os }}-gradle-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Grant execute permission for gradlew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> chmod +x gradlew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build with Gradle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./gradlew bootjar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Extract metadata (tags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> labels) for Docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> meta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker/metadata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">action@9ec57ed1fcdbf14dcef7dfbe97b2010124a938b7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">images</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Docker Hub 사용자명/이미지 이름</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Build 및 Docker image를 Docker Hub에 push</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build and push Docker image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker/build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">action@3b5e8027fcad23fda98b2e3ac259d8d67585f671</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">context</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./backend/Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">platforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> linux/arm64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">tags</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> woowacarffeine/backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> steps.meta.outputs.labels </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hosted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> needs.docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">build.result == 'success' </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">needs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">build </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># EC2 배포 서버로 접속</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Join EC2 dev server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> appleboy/ssh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">action@master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">JASYPT_KEY</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.JASYPT_KEY </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SERVER_HOST </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SERVER_USERNAME </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SERVER_KEY </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SERVER_PORT </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">envs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> JASYPT_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 1. 도커 이미지 받기</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 2. 기존에 켜진 백엔드 서버(도커 이미지) stop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 3. 최신 백엔드 서버 run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 4. 사용하지 않는 이미지와 컨테이너 삭제</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">script</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            sudo docker pull woowacarffeine/backend:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            sudo docker stop backend || true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            sudo docker run -d --rm -p 8080:8080 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            -e "ENCRYPT_KEY=${{secrets.JASYPT_KEY}}" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            --name backend \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            Docker Hub 사용자명/이미지 이름:latest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sudo docker image prune </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>저희 팀은 위와 같이 backend-deploy.yml 파일을 만들어주었습니다.</p><p>위에 yml에서 저희는 키를 숨겼는데요.</p><p><img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/blob/main/ci-cd/selfHostedKeys.png?raw=true" alt="img" class="img_ev3q">
위에 사진과 같이 설정을 해주시면 됩니다.</p><p>그리고 이를 yml에서 사용하기 위해선 <code>secrets.Key이름</code>으로 사용해주시면 됩니다.</p><br><p>이제 마지막으로 <code>Dockerfile</code>을 만들어줍니다.</p><p>저희는 <code>/backend/</code> 경로에 만들어주었습니다.</p><div class="language-Dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM amazoncorretto:17-alpine-jdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ARG JAR_FILE=./backend/build/libs/carffeine-0.0.1-SNAPSHOT.jar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY ${JAR_FILE} app.jar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT ["java", "-Dspring.profiles.active=dev", "-jar","/app.jar"]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>저희는 위처럼 절대 경로를 기준으로 JAR_FILE 위치를 지정하고, profiles는 dev로 설정해서 만들어주었습니다.</p><br><strong>3. 배포하기</strong><p>트리거를 작동시켜서 저희가 yml 파일에서 지정해준 것들이 잘 작동하는지 확인합니다.</p><p><img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/blob/main/ci-cd/jobsSuccess.png?raw=true" alt="jobSuccess" class="img_ev3q">
위에 사진처럼 모든 Job이 성공적으로 통과하는 것을 보실 수 있습니다.</p><p><img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/blob/main/ci-cd/success.png?raw=true" alt="dockerPs" class="img_ev3q">
이렇게 인프라 서버에서 배포 서버로 들어가서 성공적으로 서버를 도커로 띄운 것을 보실 수 있습니다.</p><p>EC2 배포 서버에서 <code>docker ps</code>를 입력했을 때에도 잘 실행이 되네요!</p><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cd-배포-과정-요약">CD 배포 과정 요약<a href="#cd-배포-과정-요약" class="hash-link" aria-label="CD 배포 과정 요약에 대한 직접 링크" title="CD 배포 과정 요약에 대한 직접 링크">​</a></h3><p>지속적 배포 과정을 요약 하자면 다음과 같습니다.</p><ol><li>Self Hosted Runner를 EC2 인프라 서버에 등록해준다.</li><li>yml 파일과 Dockerfile을 만들어준다.</li><li>트리거를 작동시켜서 Github Actions의 태스크가 모두 잘 되는지 확인한다.</li><li>잘 됐다면 EC2 배포 서버에 Docker image가 성공적으로 띄워진다.</li></ol>]]></content>
        <author>
            <name>제이</name>
            <uri>https://github.com/sosow0212</uri>
        </author>
        <category label="CI" term="CI"/>
        <category label="CD" term="CD"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[JPA에서 ID가 있는 Entity에 대해 save 시에 select 쿼리가 나가는 이유]]></title>
        <id>https://car-ffeine.github.io/16</id>
        <link href="https://car-ffeine.github.io/16"/>
        <updated>2023-07-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 박스터 입니다.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 박스터 입니다.</p><p>먼저 이번에 글을 쓰게된 계기를 말씀드리겠습니다. 저희 팀은 공공 데이터 API에서 받아온 충전소와, 충전기들의 ID를 그대로 사용하고 있습니다.
물론 다른 API, 제가 제어할 수 없는 곳에 의존하는 것은 좋지 않다고 생각합니다.</p><p>하지만 데이터를 받아오는 과정에서 마주한 성능적인 문제 때문에 그대로 사용하고 있습니다. 전국의 충전소는 6만개, 충전소 안에 존재하는 충전기는 23만기입니다.
하지만 공공 데이터는 충전소와, 충전기의 정보를 따로 제공하는 것이 아닌 중복된 충전소를 포함한 데이터를 충전기 개수만큼인 23만개의 row로 제공합니다.</p><p>따라서 저희가 ID를 따로 부여하게 된다면, 충전소를 저장하는 과정에서 받아오는 ID로 충전기를 연결해줘야하는데 그렇게 된다면 셀 수 없이 많은 쿼리가 발생합니다.</p><p>잠깐 생각해본다면</p><ol><li>충전소를 각각 저장하고 ID를 부여받는 쿼리 <code>6만번</code> (ID를 알아와야하기 때문에 batch를 사용할 수 없습니다.)</li><li>충전소에서 받아온 ID를 충전기에 매핑하고 저장하는 쿼리 <code>최소 1번</code> (만약 batch로 23만건을 한번에 저장한다는 가정)</li></ol><p>하지만 ID를 그대로 사용하게 된다면,</p><ol><li>충전소를 저장하는 쿼리 <code>최소 1번</code> (만약 batch로 6만건을 한번에 저장한다는 가정)</li><li>충전기를 저장하는 쿼리 <code>최소 1번</code> (만약 batch로 23만건을 한번에 저장한다는 가정)</li></ol><p>23만건이 넘는 정보를 확인했을 때, ID는 중복되지 않았고, 중복하지 않을 것이라 생각했습니다. 그 뿐만 아니라 처음 한번만 저장하는 것이 아닌 주기적으로 업데이트된 정보를
반영해주고 <code>update</code> or <code>save</code> 해주어야하기 때문에, ID를 그대로 가지고 있는 것이 훨씬 효율적이라 생각했습니다.</p><p>사족이 길었습니다. 각설하고 이런 방식으로 ID를 직접 넣어주는 경우 발생하는 문제에 대해 말씀드리겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="id를-직접-넣어준-entity를-저장할-때">ID를 직접 넣어준 Entity를 저장할 때<a href="#id를-직접-넣어준-entity를-저장할-때" class="hash-link" aria-label="ID를 직접 넣어준 Entity를 저장할 때에 대한 직접 링크" title="ID를 직접 넣어준 Entity를 저장할 때에 대한 직접 링크">​</a></h2><p>먼저 간단한 예제 Entity로 설명드리겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Entity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ChargeStation</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> stationId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> stationName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>보통의 Entity와 다른 부분은 Id를 직접 할당하기 때문에  <code>@GeneratedValue(strategy = GenerationType.IDENTITY)</code> 이러한 ID 생성 전략에 대한 정보가 없습니다.</p><p>그리고 <code>save()</code> 코드를 호출하면 어떤 쿼리가 나가는지 확인해보겠습니다. 아래와 같이 아주 간단한 선릉역 충전소를 저장하는 테스트를 실행해보겠습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@DataJpaTest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ChargeStationRepositoryTest</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Autowired</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">ChargeStationRepository</span><span class="token plain"> chargeStationRepository</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> 충전소를_저장한다</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ChargeStation</span><span class="token plain"> station </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ChargeStationFixture</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">선릉역_충전소_충전기_2개_사용가능_1개</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        chargeStationRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ChargeStation</span><span class="token plain"> expect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chargeStationRepository</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findByStationId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStationId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">assertThat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isEqualTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">station</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>먼저 코드만 보면 먼저 <code>chargeStationRepository.save()</code> 호출과 함께 insert 쿼리 1번, 그리고 <code>chargeStationRepository.findByStationId()</code>에서 select 쿼리 1번
총 2번 발생할 것이라고 유추할 수 있습니다.</p><p><img loading="lazy" src="https://github.com/car-ffeine/design-system/assets/106640954/f48b7f0f-3f39-41ce-8fcd-94b995e95fae" alt="query-three-times" class="img_ev3q"></p><p>하지만 예상과 다르게 위의 사진과 같이 쿼리가 총 3번 발생했습니다. 첫번째는 호출하지 않은 station id로 station을 조회하는 쿼리가 발생했습니다.</p><p>이유를 찾기 위해 <code>save()</code> 메서드를 디버깅 해봤습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="save-시-select-쿼리가-발생하는-이유">save 시 SELECT 쿼리가 발생하는 이유<a href="#save-시-select-쿼리가-발생하는-이유" class="hash-link" aria-label="save 시 SELECT 쿼리가 발생하는 이유에 대한 직접 링크" title="save 시 SELECT 쿼리가 발생하는 이유에 대한 직접 링크">​</a></h3><p><img loading="lazy" src="https://github.com/car-ffeine/design-system/assets/106640954/b1db00b7-d7fb-4647-912c-6f8e2fe44974" alt="save-method" class="img_ev3q">
로직은 간단해보입니다. <code>isNew()</code> 를 통해 새로운 Entity인지 확인한 후, 새로운 Entity라면 <code>persist()</code>, 아니라면 <code>merge()</code>를 호출합니다.</p><p>여기서 <code>EntityManager#persist()</code> 메서드를 간단히 말씀드리면, 새로운 Entity를 영속화하는 메서드로 트랜잭션이 커밋될 때 데이터베이스에 저장합니다.</p><p>그리고 <code>EntityManager#merge()</code> 메서드는 준영속 상태의 Entity를 영속 상태로 변경하는데 사용합니다.
하지만 이때 영속성 컨텍스트에 존재하지 않는 객체라면 데이터베이스에서 조회 후 영속화하는 작업을 수행합니다.</p><p><code>merge()</code>를 호출하기 때문에 SELECT 쿼리가 발생하고, 영속화하는 작업을 수행하는 것 입니다.</p><p>하지만 제가 저장한 객체는 확실히 새로운 Entity가 맞습니다. 하지만 <code>entityInformation.isNew()</code> 메서드는 false를 반환합니다.</p><p>그래서 어떤 것을 기준으로 새로운 Entity인 것을 구분하는지 알아보겠습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="새로운-entity를-구분하는-기준">새로운 Entity를 구분하는 기준<a href="#새로운-entity를-구분하는-기준" class="hash-link" aria-label="새로운 Entity를 구분하는 기준에 대한 직접 링크" title="새로운 Entity를 구분하는 기준에 대한 직접 링크">​</a></h3><p>일단, 디버깅을 통해 isNew 메서드를 확인해보겠습니다.
<img loading="lazy" src="https://github.com/car-ffeine/design-system/assets/106640954/e4a56694-c623-46d8-badd-3345d557e29f" alt="is-new" class="img_ev3q"></p><p>간단합니다. 먼저 Entity에 ID를 가져옵니다. 그리고 id가 <code>primitive</code> 타입인지 확인 후, 아닐경우 id가 null 이면 새로운 Entity, 아닐경우 false를 반환합니다.</p><p>이때, <code>primitve</code> 타입이라면, id가 숫자인지 확인 후 id가 0이면 새로운 Entity, 아닐경우 false를 반환합니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="id를-직접-넣어주는-객체는-jpa-사용을-포기해야할까">ID를 직접 넣어주는 객체는 JPA 사용을 포기해야할까?<a href="#id를-직접-넣어주는-객체는-jpa-사용을-포기해야할까" class="hash-link" aria-label="ID를 직접 넣어주는 객체는 JPA 사용을 포기해야할까?에 대한 직접 링크" title="ID를 직접 넣어주는 객체는 JPA 사용을 포기해야할까?에 대한 직접 링크">​</a></h2><p>결론부터 말씀드리면 아닙니다. 다른 방법으로 새로운 Entity 임을 증명할 수 있다면 <code>merge()</code>가 아닌 <code>persist()</code>를 호출하도록 만들 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="그럼-어떻게">그럼 어떻게?<a href="#그럼-어떻게" class="hash-link" aria-label="그럼 어떻게?에 대한 직접 링크" title="그럼 어떻게?에 대한 직접 링크">​</a></h3><p>먼저 save() 메서드의 필드 중 <code>JpaEntityInformation</code>이라는 필드를 확인할 수 있습니다.</p><p><img loading="lazy" src="https://github.com/car-ffeine/design-system/assets/106640954/d9956fe6-07c7-41a9-9d6b-7c01b5f31c5d" alt="entity-info" class="img_ev3q"></p><p>이 인터페이스는 Entity의 추가 정보를 알기 위해 필드에 있습니다.</p><p>해당 인터페이스의 구현체는 <code>JpaEntityInformationSupport</code>, <code>JpaMetamodelEntityInformation</code>, <code>JpaPersistableEntityInformation</code> 이렇게 3개의 클래스가 있습니다.</p><p>그럼 다른 방법으로도 <code>isNew()</code>가 구현되어 있을거라 추측을 할 수 있습니다. 디버깅을 통해 알아보겠습니다.</p><p>아까 위의 사진으로 보고 실제로 실행됐던 <code>isNew()</code> 메서드의 주인은 <code>JpaMetamodelEntityInformation</code> 클래스였습니다. 그래서 해당 클래스는 제외하고 다른 클래스를 보겠습니다.</p><p>먼저 <code>JpaPersistableEntityInformation</code> 클래스입니다.
<img loading="lazy" src="https://github.com/car-ffeine/design-system/assets/106640954/dc2293c3-2854-4619-9ef6-d08e55b4581b" alt="is-new-persistable" class="img_ev3q">
아주 간단하게 entity의 <code>isNew()</code>를 호출한다고 적혀있습니다. 하지만 <code>Persistable</code> 인터페이스를 구현한 Entity의 <code>isNew()</code> 를 호출하는 것 입니다.</p><p>그럼 남은 하나의 클래스를 확인하겠습니다.</p><p><img loading="lazy" src="https://github.com/car-ffeine/design-system/assets/106640954/f1d654c0-e741-4db7-8e7f-4e758c36133a" alt="info-support" class="img_ev3q"></p><p>위 사진처럼 이 클래스가 Entity 마다 <code>Persistable</code> 구현 유무에 따라 동적으로 구현체를 변경해주고 있었습니다.</p><p>그럼 답이 나온 것 같습니다. ID를 직접 할당하는 Entity에 <code>Persistable</code>을 구현해주면 됩니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="persistable-구현하기">Persistable 구현하기<a href="#persistable-구현하기" class="hash-link" aria-label="Persistable 구현하기에 대한 직접 링크" title="Persistable 구현하기에 대한 직접 링크">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Entity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ChargeStation</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">Pesistable</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> stationId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> stationName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@CreatedDate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">LocalDateTime</span><span class="token plain"> createdTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getStationId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isNew</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> createdTime </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>간단히 만들어봤습니다. <code>@CreatedDate</code>는 Entity가 처음 영속화될 때 동작하기 때문에 이 Entity의 CreateTime 필드가 null 이면 새로운 Entity라고 확신할 수 있습니다.
그럼 이렇게 인터페이스를 구현하고 아까 실행했던 테스트를 다시 실행해보겠습니다.</p><p><img loading="lazy" src="https://github.com/car-ffeine/design-system/assets/106640954/ea5db719-9919-42f4-b431-00e14d6fea5e" alt="solved" class="img_ev3q"></p><p>깔끔하게 구현된 것을 확인할 수 있었습니다. 원하던대로 쿼리가 2번 발생합니다.
이런  <code>Persistable</code>을 <code>@MappedSuperClass</code>를 통해 더 깔끔하게 구현할 수 있습니다. 하지만 따로 설명드리지는 않겠습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="결론">결론<a href="#결론" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h4><p>JPA는 많은 편의 기능을 제공해주는 것 같아보입니다. 쫄지맙시다.</p>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="jpa" term="jpa"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[주기적인 데이터 요청으로 받은 데이터를 효율적으로 업데이트 및 삽입하기 (with. 박스터)]]></title>
        <id>https://car-ffeine.github.io/15</id>
        <link href="https://car-ffeine.github.io/15"/>
        <updated>2023-07-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요~]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요~
우테코 카페인 팀의 제이입니다.</p><p>오늘은 카페인 팀의 프로젝트를 진행하면서 '박스터'와 함께 어떤 문제를 겪고 해결했는지 적어보도록 하겠습니다.</p><ul><li>배우는 단계이다 보니 틀린 부분이 있을 수 있는데, 피드백 부탁드립니다 :)</li></ul><p>먼저 글을 쓰기 전에 문제 상황에 대해 간단하게 말씀드리겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="문제-상황">문제 상황<a href="#문제-상황" class="hash-link" aria-label="문제 상황에 대한 직접 링크" title="문제 상황에 대한 직접 링크">​</a></h2><p>카페인 팀에서는 전기차 충전소 공공 API를 활용하여 충전소의 혼잡도 제공 및 여러 서비스를 제공합니다.</p><p>이런 서비스를 사용자들에게 제공하기 위해서 다음과 같은 작업들이 필요합니다.</p><ol><li>첫 실행시 공공 API 데이터를 모두 불러서 데이터베이스에 삽입합니다.</li><li>혼잡도를 제공하기 위해서 주기적인 시간 (아직 정하진 않았지만 ex.12시간) 단위로 충전소와 충전기의 상태를 업데이트 하기 위해서 다시 데이터를 요청을 합니다.</li><li>새롭게 추가된 충전소와 충전기는 모두 Insert해주고, 기존에 있던 충전소 혹은 충전기가 업데이트 됐다면 변경된 데이터로 업데이트 해줍니다.</li></ol><p>저랑 박스터는 2~3번 과정을 진행하는 역할을 맡았습니다.</p><p>테이블의 관계는 다음과 같습니다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">charge_station &lt;---1------N---&gt; charger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       charger &lt;---1------1---&gt; charger_status</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>저희는 이 문제를 어떻게 해결 했는지 보겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="문제-해결-과정">문제 해결 과정<a href="#문제-해결-과정" class="hash-link" aria-label="문제 해결 과정에 대한 직접 링크" title="문제 해결 과정에 대한 직접 링크">​</a></h2><p>전제조건</p><ul><li>첫 실행 모든 테이블은 초기화 상태이다.</li><li>데이터는 9999건을 기준으로 한다.</li><li>메서드 첫 시행에서는 모든 데이터가 새롭게 insert 되고</li><li>그 다음 메서드 시행에서는 일부 데이터는 추가되고, 일부는 업데이트 된다.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ver1-findall-조회-후-각각-save-해주기-약14초">Ver1. findAll() 조회 후 각각 save() 해주기 (약14초)<a href="#ver1-findall-조회-후-각각-save-해주기-약14초" class="hash-link" aria-label="Ver1. findAll() 조회 후 각각 save() 해주기 (약14초)에 대한 직접 링크" title="Ver1. findAll() 조회 후 각각 save() 해주기 (약14초)에 대한 직접 링크">​</a></h2><p>저희가 처음에 생각한 방법입니다.
알아서 바뀐 것들은 업데이트 해주고, 새로운 건 저장해주기 때문에 간단한 방법으로 생각했습니다.</p><p>실제로 해본 결과, 삽입의 경우는 SELECT 쿼리문 실행 후 INSERT 쿼리문을 발생 시켰고,
업데이트 시에도 SELECT 후 UPDATE 혹은 INSERT를 발생 시켰습니다. (변경 사항 없으면 SELECT만)</p><p>이는 식별자에 따른 JPA 작동 방식 때문인데요.
이 방법의 결과는 약 14초가 나왔습니다.</p><p>저희는 이렇게 불필요한 SELECT 작업을 막아보고자 다른 방법을 구상해봤습니다.</p><p>기본적으로 Jdbc를 이용해서 Batch Insert와 Batch Update를 사용하기로 했고, 이 작업을 위해서 변경 혹은 삽입될 데이터들을 직접 찾는 과정이 중요했습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ver2-변경-감지를-직접-해주고-자료구조로-배치-데이터-모으기--on2-약-11초">Ver2. 변경 감지를 직접 해주고, 자료구조로 배치 데이터 모으기 : O(n^2) (약 11초)<a href="#ver2-변경-감지를-직접-해주고-자료구조로-배치-데이터-모으기--on2-약-11초" class="hash-link" aria-label="Ver2. 변경 감지를 직접 해주고, 자료구조로 배치 데이터 모으기 : O(n^2) (약 11초)에 대한 직접 링크" title="Ver2. 변경 감지를 직접 해주고, 자료구조로 배치 데이터 모으기 : O(n^2) (약 11초)에 대한 직접 링크">​</a></h2><p>두 번째로 저희가 생각한 방법입니다.
먼저 데이터 추가 및 변경 감지 부분입니다.</p><p>기존 업데이트 시에 SELECT와 UPDATE(or INSERT) 두번의 쿼리가 나가는 것이 맘에 들지 않아서
변경 감지를 직접 해주려고 메서드를 만들었습니다.</p><p>저희가 생각한 변경 감지는 생각보다 간단한데요.
도메인에 메서드를 만들어서 필드를 if문으로 하나씩 비교해줬습니다.</p><p>충전소의 데이터 특징상 데이터가 자주 바뀌는 데이터는 비교적 초반에 비교하도록 구현하고, 자주 바뀌지 않는 데이터는 후에 비교하도록 만들었습니다.</p><p>그리고 데이터 저장 및 업데이트 부분입니다.
먼저 findAll()로 충전소와 충전기 등 관련된 모든 데이터를 Map에 넣었습니다.
Map&lt;stationId, Station&gt;의 구조로 기존에 테이블에 저장된 모든 데이터를 자료구조에 넣었습니다.</p><p>그리고 공공 API를 불러와서, 똑같이 Map&lt;updatedStationId, Station&gt;의 구조로 만들었습니다.
(Station 안에는 <code>List&lt;Charger&gt;</code>가 존재)</p><p>저희는 충전소와 충전소에 해당하는 모든 충전기들을 비교하면서 변경 감지를 해줘야하기 때문에
각각의 Map.values()인 <code>List&lt;Station&gt; : 기존 충전소</code>와 <code>List&lt;Station&gt; : 업데이트된 충전소</code>를 비교해줬습니다.</p><p>비교를 하면서 새로 삽입된 충전소와 업데이트 된 충전소를 각각 처리해주었습니다.</p><p>충전소의 변경 감지를 위해서 충전기들은 충전소 안에 List로 속해있기 때문에 O(n^2)의 시간 복잡도를 가지고 전체 데이터들은 약 23만 건이므로, 전체 데이터를 대상으로 한다면 약 530억번의 연산이 이뤄졌겠네요.</p><p>Ver1에 비해서는 크지는 않지만 평균적으로 약 2초 정도 줄었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ver3-변경-감지를-직접-해주고-자료구조로-배치-데이터-모으기--o1-약-10초">Ver3. 변경 감지를 직접 해주고, 자료구조로 배치 데이터 모으기 : O(1) (약 10초)<a href="#ver3-변경-감지를-직접-해주고-자료구조로-배치-데이터-모으기--o1-약-10초" class="hash-link" aria-label="Ver3. 변경 감지를 직접 해주고, 자료구조로 배치 데이터 모으기 : O(1) (약 10초)에 대한 직접 링크" title="Ver3. 변경 감지를 직접 해주고, 자료구조로 배치 데이터 모으기 : O(1) (약 10초)에 대한 직접 링크">​</a></h2><p>Ver2와 거의 유사한 방법입니다.</p><p>차이점은 Map 자료 구조 사용방법을 변경했습니다.
기존 2중 for문에서, 1중 for문을 돌면서 키 값을 통해서 신규 데이터와 업데이트 될 데이터들을 분류하고, 이들을 각각 List에 넣어주었습니다.
이를 통해서 Ver2에 비해서 1초정도 줄었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ver4-이전-방식--fetch-join-사용하기-약-6초">Ver4. 이전 방식 + Fetch Join 사용하기 (약 6초)<a href="#ver4-이전-방식--fetch-join-사용하기-약-6초" class="hash-link" aria-label="Ver4. 이전 방식 + Fetch Join 사용하기 (약 6초)에 대한 직접 링크" title="Ver4. 이전 방식 + Fetch Join 사용하기 (약 6초)에 대한 직접 링크">​</a></h2><p>마지막 방법은 조회 과정의 시간 단축입니다.</p><p>처음에 Stations를 findAll()하는 쿼리를 확인해보니 N+1 문제가 발생하고 있었습니다.
그 이유는 Station에서 Chargers를 지연로딩으로 설정 했는데, 이를 그대로 get 메서드를 통해 조회해서 해당 문제가 발생했습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">ChargeStation</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 기존</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"SELECT DISTINCT c FROM ChargeStation c JOIN FETCH c.chargers"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Fetch Join 적용</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">ChargeStation</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>따라서 위에 코드와 같이 Fetch Join을 이용해서 처음에 데이터를 가져왔습니다.
이렇게 효율적인 조회로 변경하면서 시간을 많이 줄일 수 있었습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="지금까지의-방법을-정리를-하자면">지금까지의 방법을 정리를 하자면<a href="#지금까지의-방법을-정리를-하자면" class="hash-link" aria-label="지금까지의 방법을 정리를 하자면에 대한 직접 링크" title="지금까지의 방법을 정리를 하자면에 대한 직접 링크">​</a></h3><p>Ver1 과 같은 방식에서는 업데이트 과정에서 JPA의 식별자에 따른 처리 방식으로 인해 <!-- -->[SELECT + UPDATE]<!-- --> or <!-- -->[SELECT + INSERT]<!-- --> 와 같이 쿼리가 두 번씩 나갔습니다.</p><p>그래서 Ver3까지 개선을 하기 위해서 저장과 업데이트를 한 번에 JDBC를 이용해서 Batch로 처리해주는 방식을 선택했고,</p><p>변경 감지 + 배치 데이터를 모으기 위해서 자료구조를 이용해서 시간을 조금씩 단축 했습니다.</p><p>마지막으로 Ver4에서는 findAll()에서 발생하는 N+1의 문제를 해결하면서 시간을 단축했습니다.</p><p>이런 과정을 통해서 동일 작업을 14초에서 6초 정도로 줄일 수 있었습니다!</p>]]></content>
        <author>
            <name>제이</name>
            <uri>https://github.com/sosow0212</uri>
        </author>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="우아한테크코스" term="우아한테크코스"/>
        <category label="서버" term="서버"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인팀 서버 아키텍처를 설명해드리겠습니다]]></title>
        <id>https://car-ffeine.github.io/14</id>
        <link href="https://car-ffeine.github.io/14"/>
        <updated>2023-07-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 우아한테크코스 카페인팀 누누입니다]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 우아한테크코스 카페인팀 누누입니다</p><p>이번에 카페인 팀에서 배포 아키텍처를 결정하게 되었던 과정에 대해서 정리를 해보고 싶어서 글을 쓰게 되었습니다.</p><p>아키텍처와 서버가 배포되는 과정을 보여드리면서 시작하도록 하겠습니다</p><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/dKVRTG/btsnFE7Nb82/GRONsIJPqd8WFVzjzqsgqk/img.png" alt="배포 아키텍처" class="img_ev3q"></p><p>서버가 배포되는 과정은 다음과 같습니다.</p><p><img loading="lazy" src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fdto7By%2FbtsnD31hYHy%2F7rWKwxulxXzfhRigE60Sd0%2Fimg.png" alt="server image" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="우아한테크코스-인스턴스에-대한-소개">우아한테크코스 인스턴스에 대한 소개<a href="#우아한테크코스-인스턴스에-대한-소개" class="hash-link" aria-label="우아한테크코스 인스턴스에 대한 소개에 대한 직접 링크" title="우아한테크코스 인스턴스에 대한 소개에 대한 직접 링크">​</a></h2><p>우테코에서 선택할 수 있는 인스턴스는 총 2가지 종류입니다.</p><ol><li>퍼블릭 서브넷에 있는 인스턴스<ul><li>캠퍼스에서만 SSH 접근이 가능한 인스턴스입니다.</li><li>미리 열려있는 포트들만 허용이 되어 있습니다.</li><li>같은 서브넷에 있는 인스턴스끼리는 모든 포트가 허용되어 있습니다</li></ul></li><li>프라이빗 서브넷에 있는 인스턴스<ul><li>퍼블릭 서브넷에 있는 인스턴스를 통해서만 접근이 가능합니다.</li><li>같은 서브넷에 있는 인스턴스끼리는 모든 포트가 허용되어 있습니다.</li></ul></li></ol><p>1번 인스턴스를 2개 사용 가능하고, 2번 인스턴스를 1개 사용 가능합니다.</p><p>권장되는 환경에서 1개는 db 서버로 사용하고, 나머지 2개는 자유롭게 사용이 가능했습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="그전에-알면-좋아요">그전에 알면 좋아요<a href="#그전에-알면-좋아요" class="hash-link" aria-label="그전에 알면 좋아요에 대한 직접 링크" title="그전에 알면 좋아요에 대한 직접 링크">​</a></h2><p>여기서는 Self Hosted Runner를 사용했는데요.</p><p>Self Hosted Runner에 대한 내용은 <a href="https://be-student.tistory.com/75#%EC%99%9C%20Self%20Hosted%20Runner%EC%95%BC%3F-1" target="_blank" rel="noopener noreferrer">여기</a> 에 잘 나와있습니다.</p><p>외부 IP로부터 SSH 접근이 불가능하기에, Self Hosted Runner 나, Jenkins 같은 방법을 사용할 수 있었는데, 러닝 커브를 고려해서 Self Hosted Runner를 선택하게 되었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="배포-아키텍처에-대한-고민">배포 아키텍처에 대한 고민<a href="#배포-아키텍처에-대한-고민" class="hash-link" aria-label="배포 아키텍처에 대한 고민에 대한 직접 링크" title="배포 아키텍처에 대한 고민에 대한 직접 링크">​</a></h2><p>저희 팀이 이번 아키텍처를 만들기 위해서 고민했던 점들은 다음과 같습니다.</p><ol><li>어떻게 하면 장애의 영향을 최소화할 수 있을까?</li><li>운영 서버를 나중에 추가하게 되었을 때, 어떻게 중복으로 관리되는 부분을 최소화할 수 있을까?</li><li>2차 데모데이까지의 과제인 개발 서버를 어떻게 구성할 수 있을까?</li></ol><p>여기서 1번을 가장 먼저 생각한 아키텍처를 구성하게 되었는데, 다음과 같습니다.</p><p>선택의 기준이 되었던 것은 총 3가지였습니다.</p><ol><li>DB는 프라이빗 서브넷에 위치시키고, 우리 인스턴스를 거쳐서만 접근이 가능하게 한다.<ul><li>이 부분은 보안을 위해서 어쩔 수 없이 선택하게 된 부분입니다.이 부분을 고려하다 보니, 최소한으로 구성할 수 있는 구조가 db 용 private 인스턴스 1개, 그리고 우리가 사용할 public 인스턴스 1개가 됩니다</li></ul></li><li>운영 서버를 나중에 추가하게 되었을 때, 어떻게 중복으로 관리되는 부분을 최소화할 수 있을까?<ul><li>개발용 인스턴스에 CD 툴이나, 모니터링 툴을 설치하게 되면, 운영 서버에도 동일하게 작업을 해야 합니다.</li><li>이 부분을 최소화하기 위해서, 개발용 인스턴스와, CD 툴, 모니터링 툴을 설치한 인스턴스를 분리하게 되었습니다.</li></ul></li><li>어떻게 하면 장애의 영향을 최소화할 수 있을까?<ul><li>개발용 인스턴스와, CD 툴, 모니터링 툴을 설치한 인스턴스를 분리하게 않는다면 개발용 인스턴스에서 장애가 발생했을 때, CD 툴과 모니터링 툴에도 영향을 미치게 됩니다. 이 부분을 생각했을 때도, 개발용 인스턴스와, CD 툴, 모니터링 툴을 설치한 인스턴스를 분리해야 한다고 결정하게 되었습니다</li><li>한 부분의 장애가 다른 툴까지 사용할 수 없게 만들게 되어서, 롤백이나, 상황 파악을 하기 힘들게 만들게 됩니다.</li></ul></li></ol><p>이런 과정들을 생각했을 때, 인스턴스 1개를 개발 서버용으로, 인스턴스 1개를 CD 툴과 모니터링 툴을 설치한 인스턴스로 사용하게 되었습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="실제-내부-구성은-어떻게-될까요">실제 내부 구성은 어떻게 될까요?<a href="#실제-내부-구성은-어떻게-될까요" class="hash-link" aria-label="실제 내부 구성은 어떻게 될까요?에 대한 직접 링크" title="실제 내부 구성은 어떻게 될까요?에 대한 직접 링크">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="개발-서버">개발 서버<a href="#개발-서버" class="hash-link" aria-label="개발 서버에 대한 직접 링크" title="개발 서버에 대한 직접 링크">​</a></h3><p>이 인스턴스에는 총 2가지 기능이 들어가 있습니다.</p><ol><li>프론트 서버<ul><li>react로 되어있는 프론트엔드 코드를 사용자에게 전달해 주는 역할을 합니다.</li></ul></li><li>백엔드 서버<ul><li>spring으로 되어있는 api 서버입니다.</li></ul></li></ol><p>물론, 이렇게 하면 두 곳 중 한 곳에 장애가 발생했을 때, 프론트 서버와 백엔드 서버가 모두 영향을 받게 됩니다.</p><p>같이 관리하게 된 첫 번째 이유로 비용이 들기 때문에 비용의 문제를 고려하게 되었습니다. 개발 서버에서 프론트 서버와 백엔드 서버를 관리하게 되었습니다.</p><p>두 번째 이유로는, 아직 프로젝트 초창기 이기 때문에, 백엔드에서 장애가 났을 때, 프론트에서 일정 이상의 에러 처리가 불가능했습니다.</p><p>프로젝트가 많이 진행되었다면, 프론트엔드만으로 혹은 장애가 나지 않은 서버를 활용해 에러 처리를 할 수 있지만, 아직은 그런 기능을 구현하지 못했습니다.</p><p>이와는 별개로 실행 시 편의를 위해서 도커를 사용해 개발 서버를 관리하고 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cd-툴과-모니터링-툴">CD 툴과 모니터링 툴<a href="#cd-툴과-모니터링-툴" class="hash-link" aria-label="CD 툴과 모니터링 툴에 대한 직접 링크" title="CD 툴과 모니터링 툴에 대한 직접 링크">​</a></h3><p>이 인스턴스에는 총 3가지 기능이 들어가 있습니다.</p><ol><li>CD 툴<ul><li>위에서 설명드린 것처럼, self hosted runner 가 동작하게 되어있습니다</li></ul></li><li>보안을 위한 리버스 프록시<ul><li>저희 프로젝트에서 구글 지도를 사용하게 되는데, 이때 API 키를 사용하게 됩니다. 이렇게 하면, API 키를 노출시키지 않고, 사용할 수 있습니다.</li><li>이 API 키를 노출시키지 않기 위해서, 리버스 프록시를 하나 두고, 여기서 API 키를 추가해 요청을 보내는 방식으로 구성하게 되었습니다.</li></ul></li><li>모니터링 툴<ul><li>저희 프로젝트에서 아직 도입하지 않았지만, 현재 이슈로는 올라가 있는 상태입니다.</li><li>Actuator, 프로메테우스, 그라파나 이 3가지를 활용해서 모니터링 툴을 구성하게 될 예정입니다</li></ul></li></ol><p>위 기능들이 한 인스턴스에 모여있기에, 위의 기능들은 추후에 운영 서버가 추가되었을 때, 중복으로 관리하지 않아도 됩니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="배포-과정-더-자세히-알아보기">배포 과정 더 자세히 알아보기<a href="#배포-과정-더-자세히-알아보기" class="hash-link" aria-label="배포 과정 더 자세히 알아보기에 대한 직접 링크" title="배포 과정 더 자세히 알아보기에 대한 직접 링크">​</a></h2><p>아래에 사진에서 보이는 과정을 통해서 배포를 진행하고 있는데요</p><p><img loading="lazy" src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fdto7By%2FbtsnD31hYHy%2F7rWKwxulxXzfhRigE60Sd0%2Fimg.png" alt="server image" class="img_ev3q"></p><ol><li>사용자가 push를 하면, github actions에서 도커 빌드를 진행하고, 도커 허브에 이미지를 올립니다.</li><li>도커 허브에 이미지가 올라간 이후에, self hosted runner 가 작동을 시작합니다.</li><li>개발용 인스턴스에 접근해서, 이미지를 받고, 컨테이너를 실행합니다.</li></ol><p>이런 과정을 통해서, 개발용 인스턴스에 배포를 진행하고 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="느낀-점">느낀 점<a href="#느낀-점" class="hash-link" aria-label="느낀 점에 대한 직접 링크" title="느낀 점에 대한 직접 링크">​</a></h2><p>좋은 아키텍처를 설계하기 위해서는 고려해야 할 점들이 정말 많다는 것을 다시 한번 느꼈습니다.</p><p>운영 서버가 추가된다던가, 인스턴스가 늘어나고, 줄어드는 상황에 유연하게 대처할 수 있도록 설계를 해야 한다는 것을 다시 한번 느꼈습니다.</p><p>중복으로 관리될 포인트를 줄여야 한다는 것도 다시 한번 느낄 수 있었고요</p><p>긴 글을 읽어주셔서 감사합니다</p>]]></content>
        <author>
            <name>누누</name>
            <uri>https://github.com/be-student</uri>
        </author>
        <category label="ec2" term="ec2"/>
        <category label="aws" term="aws"/>
        <category label="우아한테크코스" term="우아한테크코스"/>
        <category label="배포" term="배포"/>
        <category label="서버" term="서버"/>
        <category label="아키텍처" term="아키텍처"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[충전소 리스트 클릭시 마커에 간단정보 모달을 띄우는 기능 추가에서 겪었던 트러블 슈팅]]></title>
        <id>https://car-ffeine.github.io/13</id>
        <link href="https://car-ffeine.github.io/13"/>
        <updated>2023-07-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Untitled]]></summary>
        <content type="html"><![CDATA[<p><img loading="lazy" src="https://file.notion.so/f/s/16a32751-2088-4261-8bf6-3d556c0bf2e8/Untitled.png?id=020fb0e2-81d8-4dca-bb76-cf4536ca7b29&amp;table=block&amp;spaceId=e725e94b-8029-47f5-aecb-8eb1ef7c939f&amp;expirationTimestamp=1689364800000&amp;signature=3KH3gvfzTgKmmFsrNBluQ3evQ6jwe2C-tj8LqB6gQyw&amp;downloadName=Untitled.png" alt="Untitled" class="img_ev3q"></p><p>위 이미지는 현재까지 구현한 지도의 모습이다. 구현된 기능은 다음과 같다.</p><ul><li>충전소 정보를 서버에 요청해 받아온 충전소 정보를 바탕으로 화면에 마커를 표시하는 기능</li><li>화면이 이동하거나 줌인, 줌 아웃을 할 시 화면의 마커 정보가 최신화 되는 기능</li><li>마커 정보를 최신화 할 때 화면에서 사라진 마커를 dom에서 제거하는 기능</li><li>마커 정보를 최신화 할 때 이전 화면에서도 있었던 마커를 재생성 하지 않는 기능</li><li>마커를 클릭했을 시 해당 마커에 대한 간단 정보를 모달로 띄워주는 기능</li><li>화면에 표시된 마커들에 대한 충전소 정보를 리스트로 보여주는 기능</li></ul><p>이번에 새로 추가하고자 한 기능은 다음과 같다.</p><ul><li>충전소 리스트에서 충전소를 선택하면 화면의 중심이 선택한 충전소 마커로 이동하고, 충전소의 간단 정보를 모달로 띄워주는 기능</li></ul><p>위 기능을 구현하기 위해선 google maps api의 InfoWindow객체를 이용해야 한다. 사용 방식은 다음과 같다.</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> infowindow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">google</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">maps</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">InfoWindow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> contentString</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">ariaLabel</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Uluru'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> marker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">google</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">maps</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Marker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">position</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> uluru</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Uluru (Ayers Rock)'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">infowindow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">anchor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> marker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>간단하게 요약하자면 다음과 같다.</p><ul><li><code>InfoWindow</code> 생성자 함수를 통해 <code>infoWindow</code> 인스턴스를 생성한다.<ul><li>생성시 dom 요소 혹은 string을 전달해 <code>infoWindow</code>가 생성될 dom위치를 지정해준다.</li></ul></li><li><code>marker</code> 인스턴스를 <code>infoWindow</code> 인스턴스의 <code>open</code> 메서드에 인자로 전달한다.</li><li><code>infoWindow</code> 생성 시 전달했던 dom요소의 위치가 <code>marker</code>의 위치로 고정되면서 화면에 그려진다.</li></ul><hr><p><img loading="lazy" src="https://file.notion.so/f/s/3079d7b9-8226-46b1-9482-054d1ea78016/Untitled.png?id=bce7685b-8a95-429c-bb75-98a4402cfc17&amp;table=block&amp;spaceId=e725e94b-8029-47f5-aecb-8eb1ef7c939f&amp;expirationTimestamp=1689364800000&amp;signature=jKnY-AhoxwqTiWrMi66uUtIamSOZDj8GGBTzgKeu_qY&amp;downloadName=Untitled.png" alt="Untitled" class="img_ev3q"></p><p>충전소 정보를 보여주는 위 <code>StationList</code> 컴포넌트는 충전소 정보에 접근할 때 react-query를 통해 서버 상태를 직접 내려 받아 컴포넌트 내부 리스트를 렌더링 한다.</p><p>또한, <code>StationMarkersContainer</code>에서도 충전소 정보를 react-query의 서버 상태에서 참조해 마커를 렌더링 하고 있다.</p><p>따라서 <code>StationList</code> 컴포넌트와 <code>StationMarkersContainer</code>는 각각 따로 서버 상태에 접근해 렌더링을 수행하고 있으므로 둘 사이에는 어떠한 연결 고리가 없다.</p><p>여기서 문제가 발생하게 되었다.</p><hr><p>현재까지의 코드에서는 <code>infoWindow</code>인스턴스를 <code>StationMarkersContainer</code>컴포넌트에서 생성한다. 이를 하위 컴포넌트인 <code>StationMarker</code>에 내려주고, 이 컴포넌트 내부에서 <code>marker</code>인스턴스를 생성한다.</p><p>이번에 구현하기로 한 기능은 <code>StationList</code>의 항목 중 하나를 선택했을 시 선택된 충전소에 해당하는 마커에 간단 정보 모달이 뜨며 화면을 해당 마커가 중심으로 오도록 이동 시키는 것이었다.</p><p>하지만 지금의 코드 구조상 <code>StationList</code>와 <code>StationMarkersContainer</code>사이에는 어떠한 연결 고리도 없으므로 <code>infoWindow</code>와 <code>marker</code>에 <code>StationList</code>는 접근할 수 없는 상태가 된다.</p><p>이를 해결하기 위해서 다음과 같은 방법을 사용하기로 했다.</p><ul><li><code>infoWindow</code>인스턴스를 root 단에서 생성해 전역적으로 관리한다.</li><li>생성될 <code>marker</code> 인스턴스들을 배열 형태의 전역 상태로 관리한다.</li></ul><p>위 내용을 말로만 본다면 별로 어려울 것 없어 보이지만 실제 구현을 진행해보니 내부적으로 큰 문제가 두 가지 존재했다.</p><ol><li>따로 모듈을 분리해 <code>infoWindow</code>를 생성할 수 없다.</li><li><code>marker</code>인스턴스를 생성하는 주체가 <code>StationMarkersContainer</code>가 되어서는 안된다.</li></ol><p>각각의 문제점을 살펴보자.</p><hr><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-따로-모듈을-분리해-infowindow를-생성할-수-없다">1. 따로 모듈을 분리해 <code>infoWindow</code>를 생성할 수 없다.<a href="#1-따로-모듈을-분리해-infowindow를-생성할-수-없다" class="hash-link" aria-label="1-따로-모듈을-분리해-infowindow를-생성할-수-없다에 대한 직접 링크" title="1-따로-모듈을-분리해-infowindow를-생성할-수-없다에 대한 직접 링크">​</a></h3><p><code>infoWinodw</code>를 전역 상태로 만들어 사용하기 위해 처음으로 했던 생각은 <code>infoWindowStore.ts</code>로 모듈을 분리하여 <code>infoWindow</code>를 생성해 store의 초기값으로 지정하는 것이었다.</p><p>위 생각을 가지고 그대로 구현해보았더니 <code>google</code>을 참조할 수 없다는 에러가 발생했다. <code>InfoWindow</code>생성자 함수는 <code>google.maps.InfoWindow</code>를 통해 접근할 수 있기 때문에 해당 에러는 <code>infoWindow</code>인스턴스를 생성할 수 없다는 것을 의미했다.</p><p>왜 <code>google</code>을 참조할 수 없는지 이유를 분석해보니 이유는 다음과 같았다.</p><p>우리 팀이 구글 지도 로드를 위해 선택한 라이브러리는 <code>@googlemaps/react-wrapper</code>이다. 이 라이브러리의 동작을 살펴보면 다음과 같다.</p><ul><li><code>Wrapper</code>컴포넌트가 <code>@googlemaps/js-loader</code>라이브러리의 <code>Loader</code>생성자 함수를 호출한다.</li><li>생성된 <code>loader</code>인스턴스의 <code>load</code>메서드를 실행시켜 지도의 로딩 작업을 시작한다.<ul><li><code>load</code> 메서드는 최종적으로 <code>Promise&lt;typeof google&gt;</code>을 반환하는데, 지도 로드에 성공하면 <code>resolve(window.google)</code> 을 실행시켜 <code>google</code>을 전역적으로 사용 가능하도록 만들어준다.</li></ul></li><li>지도의 로딩이 완료되면 <code>Wrapper</code>의 <code>render</code> props를 통해 받은 콜백 함수를 실행시킨다.<ul><li><code>render</code>콜백 함수는 로딩 상태를 나타내는 Status를 파라미터로 넘겨 받아 호출된다.</li></ul></li></ul><p>최종적으로 <code>render</code>를 실행 시켰을 때 반환 되는 컴포넌트에서는 <code>google</code> 로딩 되어 전역적으로 접근이 가능함을 보장할 수 있으므로 이때부터 <code>google</code>에 접근이 가능해진다. → 따라서 <code>Wrapper</code>를 통해 반환되는 컴포넌트의 하위 컴포넌트에서 <code>google.maps.Map</code>생성자 함수를 사용해 지도를 생성할 수 있게 된다.</p><p><code>infoWindow</code>를 생성하기 위해 만든 새로운 모듈은 첫 <code>import</code>시기에 평가될 것이기 때문에 <code>Wrapper</code>의 하위 컴포넌트에서 <code>import</code>를 수행한다면 로드가 완료된 이후 시점일 것이므로 <code>window.google</code>이 등록되어 <code>google</code>에 접근이 가능할 것으로 예상했다.</p><p>하지만 웹팩을 통한 번들링 과정에서 모듈이 뒤섞여 파일의 평가 시기를 보장할 수 없어져 새로 만든 모듈에서는 <code>google</code>에 대한 접근이 불가능해지게 되었다. 웹팩을 좀 더 공부해본다면 이 문제를 해결할 수 있을 것 같았지만, 너무 지엽적인 부분에서 많은 시간을 들이기 보단 기존에 개발하던 방식을 통해 문제를 해결해보기로 결정했다.</p><p>최종적으로 문제를 해결한 방식은 다음과 같다.</p><ul><li><code>InfoWindow</code>생성자 함수를 호출할 <code>CarFfeineInfoWindowInitializer</code>컴포넌트를 만든다.</li><li><code>Wrapper</code>로 감싸진 컴포넌트 하위에 <code>CarFfeineInfoWindowInitializer</code> 컴포넌트를 추가한다.</li><li><code>google</code>에 접근이 가능한 상태를 보장받은 <code>CarFfeineInfoWindowInitializer</code>내부에서 <code>infoWindow</code>인스턴스를 생성한다.</li><li><code>store</code>에 <code>infoWindow</code>인스턴스를 <code>set</code>해주어 전역적으로 <code>infoWindow</code>를 사용 가능하도록 한다.</li></ul><hr><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-marker인스턴스를-생성하는-주체가-stationmarkerscontainer가-되어서는-안된다">2. <code>marker</code>인스턴스를 생성하는 주체가 <code>StationMarkersContainer</code>가 되어서는 안된다.<a href="#2-marker인스턴스를-생성하는-주체가-stationmarkerscontainer가-되어서는-안된다" class="hash-link" aria-label="2-marker인스턴스를-생성하는-주체가-stationmarkerscontainer가-되어서는-안된다에 대한 직접 링크" title="2-marker인스턴스를-생성하는-주체가-stationmarkerscontainer가-되어서는-안된다에 대한 직접 링크">​</a></h3><p>이번 팀 프로젝트에서 지도를 구현하기 위해 google maps api를 사용하게 되었다. 뜬금없이 이 이야기를 한 이유는 다음과 같다.</p><ul><li>google maps api는 바닐라 자바스크립트를 기반으로 동작한다.</li><li>이번 팀 프로젝트는 리액트를 기반으로 개발을 진행할 것이다.</li><li>지도를 그리기 위해서 바닐라 자바스크립트와 리액트의 적절한 조화가 필요하다.</li><li>다소 혼란스러울 수 있는 지도의 조작 방식을 리액트와 조화롭게 사용하기 위해서 컴포넌트 설계시 컴포넌트의 책임을 확실하게 구분해야겠다는 생각을 하게 되었다.</li></ul><p>이 컴포넌트의 책임에 대한 문제로 인해 <code>marker</code> 인스턴스를 생성하는 주체에 대해 많은 고민을 하게 되었다.</p><p>일단 원래 코드 구조에서 마커를 그리기 위해 컴포넌트를 다음과 같이 추상화 했다.</p><ul><li><code>StationMarkersContainer</code> 컴포넌트<ul><li>리액트 쿼리를 통해 받아온 서버 상태(충전소 정보 배열)로 <code>StationMarker</code>를 호출한다.</li></ul></li><li><code>StationMarker</code> 컴포넌트<ul><li>상위에서 내려받은 충전소 정보 props를 통해 <code>marker</code> 인스턴스를 생성한다. (google maps api에서는 인스턴스 생성이 곧 렌더링을 의미한다)</li><li>생성한 <code>marker</code> 인스턴스에 <code>infoWindow</code> 인스턴스의 <code>open</code> 메서드를 트리거 하는 클릭 이벤트 리스너를 추가해준다.</li><li><code>useEffect</code>의 클린업 함수를 이용해 충전소 정보가 최신화 되었을 때 마커가 더이상 화면에 보이지 않는다면 <code>marker</code> 인스턴스의 <code>setMap(null)</code> 메서드를 호출해 google maps api에서 마커를 지우도록 한다. (마커 렌더링 최적화)</li></ul></li></ul><p>간략히 설명하자면 <code>StationMarkersContainer</code> 컴포넌트는 충전소 정보를 서버에서 받아 <code>StationMarker</code>를 호출하는 역할만을 수행하고, 마커에 대한 모든 세부 로직은 <code>StationMarker</code>가 수행하도록 컴포넌트를 추상화 해보았다.</p><p>이름에서도 드러나듯 <code>StationMarker</code> 컴포넌트가 <code>marker</code> 인스턴스를 생성하는 주체가 되어야 바닐라 자바스크립트와 리액트의 혼종인 이 프로젝트의 코드를 추후 유지보수 할 때 문제가 없으리라 판단했다.</p><p>하지만 이렇게 추상화 된 컴포넌트들은 <code>marker</code> 인스턴스를 배열 형식의 전역 상태에 담아 관리하고자 할 때 문제가 되었다.</p><hr><p>일단 먼저 서버에서 내려 받은 충전소 정보를 <code>station</code>이라고 하자, 우리는 이 <code>station</code>을 통해 <code>marker</code> 인스턴스를 생성하고자 한다.</p><p>이때 생각 할 수 있는 가장 간단한 방법은 <code>station</code>에서 <code>map</code> 메서드를 통해 <code>marker</code> 인스턴스를 생성하여 이 <code>marker</code> 인스턴스를 하위 컴포넌트인 <code>StationMarker</code>에 넘겨주는 방식일 것이다.</p><p>하지만 이 방식은 인스턴스를 생성하는 것이 곧 화면에 렌더링을 발생시키는 것을 의미하는 google maps api의 특성상 우리가 처음 설계한 컴포넌트의 책임을 반하는 구조를 만들어내게 된다.</p><p>자세히 설명해보자면 마커의 렌더링은 <code>StationMarkersContainer</code>가 수행하고 있는데 화면에 보이지 않는 마커를 지우는 역할은 <code>StationMarker</code>컴포넌트가 수행하고 있고, 이벤트 핸들러의 추가 역시 마커가 생성된 이후에 하위 컴포넌트에서 이를 수행하는 괴상한 코드가 만들어지게 된다.</p><p>추후 코드의 유지보수성을 위해선 피해야 할 방식임이 명확했다.</p><p>해결 방식을 고민해보다가 다음과 같은 해결 방안을 생각하게 되었다.</p><p><code>StationMarker</code> 컴포넌트의 역할</p><ul><li><code>marker</code> 인스턴스를 생성한다.</li><li><code>marker</code> 인스턴스의 이벤트 핸들러를 추가한다.</li><li>생성된 <code>marker</code> 인스턴스를 배열 형식의 전역 상태에 추가한다.</li><li>충전소 정보가 최신화 되었을 때 마커가 화면에 보이지 않는 상태가 되었다면 <code>marker</code> 인스턴스를 전역 상태에서 삭제한다.</li></ul><p>위와 같이 <code>StationMarker</code> 의 역할을 잡게 되면 기존의 컴포넌트 설계 구조를 해치지 않으면서 전역 상태에 <code>marker</code>인스턴스를 잘 추가할 수 있게 된다. 하지만 이렇게 되면 <code>StationMarker</code> 컴포넌트는 다음의 큰 문제들을 가지게 된다.</p><ol><li><code>marker</code>들을 가지는 전역 상태를 구독하고 있는 컴포넌트가 새로 생성되는 마커의 개수만큼 리렌더링 된다.</li><li>현재 사용하고 있는 전역 상태 관리 도구의 특성상 이전 상태를 참조해와야 <code>marker</code>를 추가할 수 있게 되는데, 이 때 이전 상태가 최신의 상태임을 보장하지 못할 수 있다.</li></ol><p>이 두 문제를 해결할 방식을 고민해보았을 때 다음과 같은 결론에 도달하게 되었다.</p><ul><li>현재 사용하고 있는 전역 상태 관리 도구는 React 18에 새로 추가된 <code>useSyncExternalState</code> 훅을 기반으로 <code>recoil</code>과 비슷하게 사용할 수 있도록 계층을 분리하여 만든 도구이다.</li><li>기존에 사용하던 전역 상태 관리 도구의 메서드 <code>useExternalState</code>, <code>useExternalValue</code>, <code>useSetExternalState</code> 이외에 <code>store</code> 인스턴스에 직접 접근하여 최신의 상태를 참조하는 <code>getStoreSnapShot</code> 메서드를 추가한다.</li><li><code>store</code>에 직접 접근해 받아온 최신의 상태는 바닐라 자바스크립트 객체 이므로 리액트의 리렌더링을 발생 시키지 않는다.</li><li>리렌더링으로 인한 문제점들을 <code>getStoreSnapShot</code> 메서드를 추가함으로써 해결할 수 있다.</li></ul><hr><p>새로운 기능 추가를 위해 마주했던 앞선 두 가지의 문제와 해결 방식을 살펴 보았다. 그래서 최종적으로 이전까지 계속해서 고민해왔던 문제를 해결한 과정을 간추려보자면 다음과 같다.</p><ul><li>충전소 정보를 서버에서 받아와 렌더링 하는 <code>StationList</code> 컴포넌트에서 <code>marker</code> 인스턴스 배열을 저장하고 있는 <code>store</code>인스턴스에 직접 접근해 최신의 <code>marker</code>인스턴스들을 가져온다.</li><li>충전소 목록에서 사용자가 충전소를 클릭했을 때 전역으로 관리되는 <code>infoWindow</code> 인스턴스의 <code>open</code>메서드에 <code>marker</code> 인스턴스들 중 선택된 <code>marker</code>를 전달해 간단 정보 모달을 띄워준다.</li></ul>]]></content>
        <author>
            <name>센트</name>
            <uri>https://github.com/kyw0716</uri>
        </author>
        <category label="react" term="react"/>
        <category label="google maps api" term="google maps api"/>
        <category label="useSyncExternalStore" term="useSyncExternalStore"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[카페인 팀에서 사용하는 지도 라이브러리를 소개합니다.]]></title>
        <id>https://car-ffeine.github.io/11</id>
        <link href="https://car-ffeine.github.io/11"/>
        <updated>2023-07-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[지도 api 벤더 선택 이유]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="지도-api-벤더-선택-이유">지도 api 벤더 선택 이유<a href="#지도-api-벤더-선택-이유" class="hash-link" aria-label="지도 api 벤더 선택 이유에 대한 직접 링크" title="지도 api 벤더 선택 이유에 대한 직접 링크">​</a></h2><p>국내 서비스 중인 지도 서비스로는 google, naver, kakao가 있습니다.</p><p>이 중에서도 google maps api는 css로 <code>지도의 테마를 직접 스타일링할 수 있는 기능이 있어서 선택</code>하게 됐습니다.</p><p>google maps api를 사용하기 위해서 별도의 라이브러리 사용이 필수는 아니지만</p><p>저희 팀에서 대중적인 라이브러리들과 기본 환경 설정법을 모두 테스트 했을 때, 반드시 사용하고 싶은 라이브러리가 존재하여 비교를 기록으로 남기게 됐습니다.</p><h1>google maps api 관련 라이브러리</h1><p>(선택한 라이브러리들은 ✅으로 표시했습니다.)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="google-maps-api">google maps API<a href="#google-maps-api" class="hash-link" aria-label="google maps API에 대한 직접 링크" title="google maps API에 대한 직접 링크">​</a></h3><p><a href="https://github.com/tomchentw/react-google-maps" target="_blank" rel="noopener noreferrer">https://github.com/tomchentw/react-google-maps</a></p><p>이 라이브러리는 구글에서 공식으로 제공하는 지도 api로, HTML DOM에 구글 지도를 부착하고, 사용(조작)할 수 있도록 도와줍니다. 이 라이브러리는 <code>vanilla Javascript 기반으로 동작</code>합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typesgooglemaps-"><strong>@types/google.maps</strong> ✅<a href="#typesgooglemaps-" class="hash-link" aria-label="typesgooglemaps-에 대한 직접 링크" title="typesgooglemaps-에 대한 직접 링크">​</a></h3><p><a href="https://www.npmjs.com/package/@types/google.maps" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/@types/google.maps</a></p><p>TypeScript에서 구글 지도를 사용할 때 <code>타입을 제공</code>해주는 역할을 합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="googlemapsjs-api-loader"><strong>@googlemaps/js-api-loader</strong><a href="#googlemapsjs-api-loader" class="hash-link" aria-label="googlemapsjs-api-loader에 대한 직접 링크" title="googlemapsjs-api-loader에 대한 직접 링크">​</a></h3><p><a href="https://www.npmjs.com/package/@googlemaps/js-api-loader" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/@googlemaps/js-api-loader</a></p><p>이 라이브러리는 구글에서 공식으로 제공하는 지도 호출 api로, api key만 넘겨주더라도 구글 지도를 스크립트 형태로 불러와주는 역할을 하는 라이브러리입니다. 별도로 html 조작 없이 불러온 <code>라이브러리에서 구글 지도를 꺼내서 동적으로 사용</code>할 수 있습니다. vanilla Javascript 기반으로 동작하여 어디에서나 사용이 가능합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="대중적인-라이브러리-비교">대중적인 라이브러리 비교<a href="#대중적인-라이브러리-비교" class="hash-link" aria-label="대중적인 라이브러리 비교에 대한 직접 링크" title="대중적인 라이브러리 비교에 대한 직접 링크">​</a></h3><table><thead><tr><th></th><th>react-google-maps</th><th>@react-google-maps/api</th><th>@googlemaps/react-wrapper</th></tr></thead><tbody><tr><td>링크</td><td><a href="https://www.npmjs.com/package/react-google-maps" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/react-google-maps</a></td><td><a href="https://www.npmjs.com/package/@react-google-maps/api" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/@react-google-maps/api</a></td><td><a href="https://www.npmjs.com/package/@googlemaps/react-wrapper" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/@googlemaps/react-wrapper</a></td></tr><tr><td>설명</td><td>이 라이브러리는 개인이 만든 라이브러리로, google maps API를 react DOM 위에 올려서 사용하게 돕습니다. <br> 구글 지도와 마커를 react component 처럼 사용하여 react스럽게 렌더링 하는 것을 지원합니다. <br> react 진영에서 가장 대중적으로 사용되는 구글 지도 라이브러리였지만 2018년 이후로 업데이트가 끊겼습니다.</td><td>이 라이브러리도 개인이 만든 라이브러리로 앞서 소개한 react-google-maps를 개량하여 만든 라이브러리입니다.<br> 이 라이브러리 역시 react에 지도나 마커 컴포넌트를 호출해서 사용이 가능합니다. <br> 현재 react 진영에서 가장 대중적으로 사용되는 구글 지도 라이브러리 입니다.</td><td>이 라이브러리는 구글에서 공식으로 제공하는 react용 라이브러리입니다. <br> 이 라이브러리는 앞서 소개한 js-api-loader를 활용하여 만든 Wrapper 컴포넌트를 제공하는데, 구글 지도를 호출하는 과정에서 수신중, 실패, 성공에 따라 지도를 보여줄 지, 로딩중 컴포넌트를 보여줄 지, 에러 컴포넌트를 보여줄 지 결정하는 기능이 있습니다. <br> 이외에는 기존의 js-api-loader의 기능과 완벽하게 동일합니다. (라이브러리를 열어서 직접 확인해봤습니다.)</td></tr><tr><td>선택여부</td><td></td><td></td><td>✅</td></tr></tbody></table><h1>라이브러리 선택 이유</h1><p>저희 프로젝트는 <code>실시간 전기자동차 충전소 지도 및 사용 통계 조회 서비스</code> 다보니 지도 위에 띄워줘야 할 마커를 최적화 하는 과정이 굉장히 중요합니다.</p><ol><li>전국 6만여 개의 마커를 전부 보여줄 수 없다.</li><li>현재 디스플레이 영역의 마커만을 호출해야한다.</li><li>그 마커들의 렌더링 과정을 저수준에서 다룰 수 있어야 한다.</li></ol><p>이런 원칙을 가지고 있기에 대중적인 라이브러리들(react-google-maps, @react-google-maps/api)은 저희의 선택지에 없었습니다.</p><p>따라서 구글 지도는 오로지 vanilla로 제공되는 상태에서 직접 제어하기로 결정하였고, 마커를 관리하는 주체 또한 구글 지도에서 직접 컨트롤을 하려고 합니다.</p><p>따라서 구글 지도를 호출하는 작업은 @googlemaps/react-wrapper에 맡기고, 불러온 구글 지도는 vanilla로 통제하기로 했습니다.</p><p>지도의 조작, 지도에 마커를 찍는 과정을 모두 <code>공식 문서에 나와있는 방법대로 통제</code>하려고 합니다.</p><p>기존의 라이브러리들은 마커나 지도를 컴포넌트화 한 상태이기에 최적화 과정에서 저희가 제어할 수 없는 부분들이 있다고 생각합니다. 따라서 트러블슈팅 과정에서 마커의 호출 시점, 메모리에서 해제하는 시점, 렌더링하는 시점 등의 작업들을 훨씬 더 세밀하게 하려면 google maps api을 있는 그대로 사용할 수 있어야 합니다. 따라서 지도에 관련된 기능은 react DOM 위에서가 아닌 vanilla 환경에서 작업을 할 것입니다.</p><h1>구글 지도 제어 전략</h1><ol><li>구글 지도와 마커는 항상 바닐라 환경(react DOM 바깥)에서 동작하게 한다.</li><li>바닐라 환경에서만 동작하게 하여 리액트 컴포넌트에서의 재 렌더링을 일절 방지한다.</li><li>마커나 지도의 동작 이벤트에 의해 UI를 조작해야하는 경우에는 react DOM 조작을 하도록 한다.</li><li>바닐라 환경인 google maps api와 react DOM 사이의 제어 과정에는 useSyncExternalStore 훅을 이용하여 리액트 UI를 강제로 동기화 시킬 수 있도록 한다.</li></ol><p>구글 지도는 바닐라 환경에서, 각종 UI 통제는 리액트에서 통합하여 사용하는 환경을 구상하고 있습니다.</p><p>시중에 나와있는 대부분의 라이브러리들을 활용하여 비교하고 테스트한 결과 @googlemaps/react-wrapper를 선택하는 것이 최적화와 생산성, 앱 안정성을 모두 확보할 수 있는 선택이라고 생각했습니다.</p><p>현재 카페인 팀에서 사용중인 지도 제어에 관한 방법은 이후에 작성 될 글에서 상세하게 설명하겠습니다.</p>]]></content>
        <author>
            <name>가브리엘</name>
            <uri>https://github.com/gabrielyoon7</uri>
        </author>
        <category label="react" term="react"/>
        <category label="google maps" term="google maps"/>
        <category label="google maps api" term="google maps api"/>
        <category label="react-wrapper" term="react-wrapper"/>
        <category label="@googlemaps/react-wrapper" term="@googlemaps/react-wrapper"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[jasypt를 활용하여 프로퍼티를 암호화하자]]></title>
        <id>https://car-ffeine.github.io/12</id>
        <link href="https://car-ffeine.github.io/12"/>
        <updated>2023-07-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[서론]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="서론">서론<a href="#서론" class="hash-link" aria-label="서론에 대한 직접 링크" title="서론에 대한 직접 링크">​</a></h2><p>안녕하세요 카페인팀 <code>키아라</code>입니다.</p><p>이번 프로젝트를 시작하면서 프로퍼티를 암호화하는 방법으로 jasypt를 알게되어</p><p>사용하는 방법을 익혀 저희 프로젝트에 적용해볼 계획입니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="프로퍼티-암호화는-왜-필요할까">프로퍼티 암호화는 왜 필요할까?<a href="#프로퍼티-암호화는-왜-필요할까" class="hash-link" aria-label="프로퍼티 암호화는 왜 필요할까?에 대한 직접 링크" title="프로퍼티 암호화는 왜 필요할까?에 대한 직접 링크">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  datasource</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 데이터베이스 url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 계정</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 비밀번호</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>프로젝트를 진행하면서 yml 파일에 DB 연결 URL이나 계정, 비밀번호 같이 노출되어선 안 되는 민감한 정보들이 많습니다.</p><p>git의 public repository와 CI/CD를 연동해 어플리케이션을 배포한다면 중요한 정보가 탈취될 가능성이 있죠.</p><p>Jasypt 라이브러리를 사용하면 평문으로 된 데이터베이스 접속 정보를 암호화 하여 방어막을 한 겹 쌓을 수 있게 됩니다.</p><p>간략하게 라이브러리를 소개하고 사용 방법을 알아볼까요?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="jasypt는-뭐지">jasypt는 뭐지?<a href="#jasypt는-뭐지" class="hash-link" aria-label="jasypt는 뭐지?에 대한 직접 링크" title="jasypt는 뭐지?에 대한 직접 링크">​</a></h2><p>Jasypt이란 쉽게 암호화 기능을 사용할 수 있도록 제공하는 Java 라이브러리입니다.</p><p>민감한 평문 정보를 암호화하고, 아래처럼 설정 값을 지정하면 어플리케이션이 실행될 때 자동으로 이를 복호화하여 사용합니다.</p><p>사용자가 편하게 암호화 기능을 사용할 수 있도록 제공하는 Java 라이브러리로</p><p>공식 홈페이지는 <a href="http://www.jasypt.org/" target="_blank" rel="noopener noreferrer">http://www.jasypt.org/</a> 에 가면 더 자세한 정보를 확인할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="사용-방법">사용 방법<a href="#사용-방법" class="hash-link" aria-label="사용 방법에 대한 직접 링크" title="사용 방법에 대한 직접 링크">​</a></h2><p>정말 간단하게 라이브러리 추가, key값 넘겨주기, 암호화 세 가지 단계로 프로퍼티를 암호화하여 관리할 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-라이브러리-추가--의존성-추가">1. 라이브러리 추가 (= 의존성 추가)<a href="#1-라이브러리-추가--의존성-추가" class="hash-link" aria-label="1. 라이브러리 추가 (= 의존성 추가)에 대한 직접 링크" title="1. 라이브러리 추가 (= 의존성 추가)에 대한 직접 링크">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">implementation </span><span class="token string" style="color:#e3116c">"com.github.ulisesbocchio:jasypt-spring-boot-starter:3.0.3"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-jasypt-설정-및-bean-등록">2. Jasypt 설정 및 Bean 등록<a href="#2-jasypt-설정-및-bean-등록" class="hash-link" aria-label="2. Jasypt 설정 및 Bean 등록에 대한 직접 링크" title="2. Jasypt 설정 및 Bean 등록에 대한 직접 링크">​</a></h3><p>key를 사용해서 Bean을 등록하는 기본 설정입니다. 여기서 Bean의 이름을 jasyptEncryptor라고 설정했다면 프로퍼티 등록해야 합니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">JasyptConfig</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ENCRYPT_KEY</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"hello"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"jasyptEncryptor"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">StringEncryptor</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">stringEncryptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">PooledPBEStringEncryptor</span><span class="token plain"> encryptor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PooledPBEStringEncryptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">SimpleStringPBEConfig</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SimpleStringPBEConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setPassword</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ENCRYPT_KEY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setAlgorithm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"PBEWithMD5AndDES"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setKeyObtentionIterations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setPoolSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setSaltGeneratorClassName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"org.jasypt.salt.RandomSaltGenerator"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setStringOutputType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"base64"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        encryptor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> encryptor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jasypt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encryptor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bean</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> jasyptEncryptor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-암호화">3. 암호화<a href="#3-암호화" class="hash-link" aria-label="3. 암호화에 대한 직접 링크" title="3. 암호화에 대한 직접 링크">​</a></h3><p>라이브러리를 사용할 준비는 거의 다 끝났습니다. 이제 암호화하여 프로퍼티에 작성합니다.</p><p>이때 암호화 하는 방법은, 아래 사이트에 접속해 평문과 키를 입력한 후 나온 암호문을 프로퍼티 파일에 'ENC(암호문)' 로 작성합니다.</p><p><a href="https://www.devglan.com/online-tools/jasypt-online-encryption-decryption" target="_blank" rel="noopener noreferrer">암복호화 사이트</a></p><p><img loading="lazy" src="https://github.com/kiarakim/algorithm/assets/101039161/b0293dfc-e0d8-45a0-91af-becf790a1002" alt="평문" class="img_ev3q"></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  datasource</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 데이터베이스 url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 계정</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ENC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">piAhHYGHR3dWDkdco6C3n8TpJdyq8FnO</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>나머지도 마저 암호화해줍시다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  datasource</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ENC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j94r94hQbd1SfFHGCUeweg</span><span class="token operator" style="color:#393A34">+</span><span class="token class-name">GGDosfnxP8dL0FQxfXtE</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ENC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vp3Gw8kLpwDZhmMMqf88</span><span class="token operator" style="color:#393A34">/</span><span class="token class-name">Q</span><span class="token operator" style="color:#393A34">==</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ENC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">piAhHYGHR3dWDkdco6C3n8TpJdyq8FnO</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="실행">실행<a href="#실행" class="hash-link" aria-label="실행에 대한 직접 링크" title="실행에 대한 직접 링크">​</a></h2><p>올바른 암호문을 입력했다면 정상적으로 실행이 됩니다.</p><p>그러나 이때 임의로 암호문을 수정한다면 다음과 같이 빌드를 실패합니다.</p><p><img loading="lazy" src="https://github.com/kiarakim/algorithm/assets/101039161/d003df00-bf4f-4ed2-a1ee-293cd7da6fc1" alt="실행 실패" class="img_ev3q"></p><p>그런데 뭔가 이상하지 않나요?</p><p>프로퍼티는 분명 암호화 했는데 키가 코드에 그대로 노출되어 있습니다.</p><p>Git의 public Repository에 배포하면 다른 사람들도 볼 수 있습니다.</p><p>그럼 이 키를 어디에 숨길 수 있을까요?</p><p>저는 처음에 일반 file에 키를 넣어놓고 파일을 읽어오는 식으로 키를 관리하려고 했습니다. 당연히 해당 파일은 .gitignore로 커밋 대상에서 제외해야겠죠.</p><p>그런데 이것보다 더 쉽고 빠른 방법이 있습니다.</p><p>바로 환경변수를 설정하는 것이죠.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-환경변수-설정">+ 환경변수 설정<a href="#-환경변수-설정" class="hash-link" aria-label="+ 환경변수 설정에 대한 직접 링크" title="+ 환경변수 설정에 대한 직접 링크">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ENCRYPT_KEY</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"hello"</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>기존의 키를 관리하는 방식이었습니다.</p><p>우선 이 키를 프로퍼티에서 관리하도록 설정해볼까요?</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// JasyptConfig.class</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"${jasypt.encryptor.password}"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ENCRYPT_KEY</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// application.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jasypt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encryptor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> hello</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이제 환경변수를 설정해봅시다.</p><p>Run &gt; Edit Configurations... 경로로 들어가면</p><p>Run/Debug Configurations 창이 나오는데</p><p>Environment variables: 부분에 ENCRYPT_KEY=hello</p><p>라고 적어주세요.</p><p>그 후 다시 yml 파일로 돌아와 기존 hello로 되어있는 부분을 ${ENCRYPT_KEY}로 변경하고 실행한다면 정상적으로 작동됩니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jasypt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encryptor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">ENCRYPT_KEY</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>긴 글 읽어주셔서 감사합니다.</p>]]></content>
        <author>
            <name>키아라</name>
            <uri>https://github.com/kiarakim</uri>
        </author>
        <category label="jasypt" term="jasypt"/>
        <category label="Spring" term="Spring"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Pull Request 시 자동으로 test 실행하기]]></title>
        <id>https://car-ffeine.github.io/9</id>
        <link href="https://car-ffeine.github.io/9"/>
        <updated>2023-07-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 박스터입니다.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 박스터입니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pull-request시-자동으로-test를-실행하면-좋은-점">Pull Request시 자동으로 test를 실행하면 좋은 점<a href="#pull-request시-자동으로-test를-실행하면-좋은-점" class="hash-link" aria-label="Pull Request시 자동으로 test를 실행하면 좋은 점에 대한 직접 링크" title="Pull Request시 자동으로 test를 실행하면 좋은 점에 대한 직접 링크">​</a></h2><p>pull request 생성 시 자동으로 테스트를 돌려준다면 다른 팀원의 pr을 굳이 제 로컬에 clone하여 테스트를 돌려보지 않아도 됩니다.
많은 시간을 단축할 수 있습니다.</p><p>그리고 test가 실패한다면 강제로 Merge가 되지 않도록 한다면 실수로 테스트가 되지 않는 커밋을 올리는 것을 방지할 수 있겠죠.</p><p>이 두가지만으로도 생산성이 많이 올라갈 것을 기대할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="어떻게-할-수-있나요">어떻게 할 수 있나요<a href="#어떻게-할-수-있나요" class="hash-link" aria-label="어떻게 할 수 있나요에 대한 직접 링크" title="어떻게 할 수 있나요에 대한 직접 링크">​</a></h2><p>Github Action을 이용하여 설정한 조건에 맞는 상황에서 명령어를 실행하여 test를 할 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="github-action-파일-생성">Github Action 파일 생성<a href="#github-action-파일-생성" class="hash-link" aria-label="Github Action 파일 생성에 대한 직접 링크" title="Github Action 파일 생성에 대한 직접 링크">​</a></h3><ol><li>먼저 최상위 폴더에 <code>.github/workflows</code> 폴더를 생성합니다.</li><li>해당 폴더 내에 <code>example.yml</code>을 생성합니다.</li><li>아래와 같이 yml 파일을 작성합니다.</li></ol><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pr test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">permissions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">contents</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> merge</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaults</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set up JDK 17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">java@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">java-version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'17'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">distribution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'adopt'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Grant execute permission for gradlew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> chmod +x gradlew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Test with Gradle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./gradlew build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="job-이름-설정">Job 이름 설정<a href="#job-이름-설정" class="hash-link" aria-label="Job 이름 설정에 대한 직접 링크" title="Job 이름 설정에 대한 직접 링크">​</a></h3><p>복잡하지 않습니다. 먼저 <strong>name</strong> 속성은 github action에서 보여질 Job의 이름을 정하는 부분입니다.</p><p>지금은 <code>pr test</code>로 해두었습니다. 그럼 아래 사진과 같이 반영됩니다.</p><p><img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/assets/106640954/28494d8e-66b5-4eec-a98a-414968b03306" alt="workflows name" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="workflow-트리거-설정">workflow 트리거 설정<a href="#workflow-트리거-설정" class="hash-link" aria-label="workflow 트리거 설정에 대한 직접 링크" title="workflow 트리거 설정에 대한 직접 링크">​</a></h3><p>다음으론 <code>on</code> 속성입니다. 이 속성은 workflow를 실행할 이벤트를 지정하는데 사용됩니다. 특정 이벤트 유형과 조건을 기반으로 workflow를 트리거하도록 구성할 수 있습니다.</p><p>예를 들어 아래와 같이 정의했습니다.</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> develop</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>그렇다면 이 workflow가 작동되는 시점은 <code>main</code> 브랜치에 <strong>push</strong>가 되거나 <code>develop</code> 브랜치에 <strong>pull request</strong>를 보낼 때 작동합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="권한-부여">권한 부여<a href="#권한-부여" class="hash-link" aria-label="권한 부여에 대한 직접 링크" title="권한 부여에 대한 직접 링크">​</a></h3><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">permissions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">contents</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> read</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이런 권한을 주게 된다면 이 job은 읽기 권한밖에 없기 때문에 실수로 다른 것을 추가하지 못하게 막을 수 있습니다</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="동작할-명령어-입력">동작할 명령어 입력<a href="#동작할-명령어-입력" class="hash-link" aria-label="동작할 명령어 입력에 대한 직접 링크" title="동작할 명령어 입력에 대한 직접 링크">​</a></h3><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> merge</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaults</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set up JDK 17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">java@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">java-version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'17'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">distribution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'adopt'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Grant execute permission for gradlew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> chmod +x gradlew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Test with Gradle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./gradlew build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="name">name<a href="#name" class="hash-link" aria-label="name에 대한 직접 링크" title="name에 대한 직접 링크">​</a></h4><p>제일 간단히 볼 수 있는 <strong>name</strong> 설정은 아래 사진처럼 어떤식으로 보여줄지 정할 수 있습니다.</p><p><img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/assets/106640954/43ebf3c1-4632-447f-89c3-0e74ed01dc3c" alt="job image" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="runs-on">runs-on<a href="#runs-on" class="hash-link" aria-label="runs-on에 대한 직접 링크" title="runs-on에 대한 직접 링크">​</a></h4><p><strong>runs-on</strong> 속성입니다. 해당 운영체제를 사용한다고 정의하는 부분입니다. 지금은 저희가 사용할 ec2와 같은 환경인 <code>ubuntu</code>에서 작동하도록 설정했지만,
<code>windows-latest</code>, <code>macos-latest</code>로 변경할 수도 있습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="environment">environment<a href="#environment" class="hash-link" aria-label="environment에 대한 직접 링크" title="environment에 대한 직접 링크">​</a></h4><p><strong>environment</strong> 속성입니다. 해당 속성은 꼭 필요한 부분이 아니지만 branch의 rule 설정에 사용할 수 있습니다. 그리고 환경을 한꺼번에 관리할 수 있습니다.</p><p>이 부분은 아래에 branch rule을 정하는 부분을 보시면 아마 이해가 될 것 입니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="defaults">defaults<a href="#defaults" class="hash-link" aria-label="defaults에 대한 직접 링크" title="defaults에 대한 직접 링크">​</a></h4><p>해당 속성은 어떤 폴더에서 명령어를 실행할 지 지정합니다. 지금의 저희 프로젝트에서는 한 repository에 backend, frontend 폴더를 나누었기 때문에 backend 폴더로 이동하여 명령어를 실행해야 합니다.</p><p>그래서 <strong>working-directory</strong>를 <code>./backend</code>라고 지정했습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="steps">steps<a href="#steps" class="hash-link" aria-label="steps에 대한 직접 링크" title="steps에 대한 직접 링크">​</a></h4><p>제일 중요한 <strong>steps</strong>입니다. 해당 속성은 어떤 명령어를 어떤 순서로 실행시킬지 정의합니다. 지금의 workflow에선</p><ol><li>Java 17 설치</li><li>gradlew 파일에 실행 권한 부여</li><li>gradle build 실행</li></ol><p>순으로 동작합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="다른-조건과-이벤트도-추가하고-싶어요">다른 조건과 이벤트도 추가하고 싶어요<a href="#다른-조건과-이벤트도-추가하고-싶어요" class="hash-link" aria-label="다른 조건과 이벤트도 추가하고 싶어요에 대한 직접 링크" title="다른 조건과 이벤트도 추가하고 싶어요에 대한 직접 링크">​</a></h3><p>저희 프로젝트는 하나의 repository에서 frontend, backend 코드를 같이 관리하는 상황입니다. 하지만 frontend 코드를 수정했다고 java 테스트를 돌리는 것은 오히려 생산성이 줄어들겠죠.</p><p>그리고 frontend도 테스트를 돌리고 싶지만 gradle을 사용하지 않습니다.</p><p>그럴 때 간단한 속성을 추가하면 <strong>파일의 변경에 따라 해당 job을 실행할 조건</strong>을 정의할 수 있습니다.</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> backend/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> .github/</span><span class="token important">**</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>위와 달리 지금 <strong>pull request</strong>에는 속성이 하나가 더 있는데요. <strong>paths</strong>를 적용하면 <code>backend</code> 폴더 하위의 무언가 변경이 있는 <strong>pull request</strong>에만 작동을 하게 됩니다.</p><p>그럼 backend의 workflow 파일에 <strong>paths</strong> 속성을 하나 추가하고, 비슷한 frontend workflow를 만들어주면 되겠죠.</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> frontend test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> frontend/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">permissions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">contents</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaults</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">working-directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NPM Install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> npm i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Jest run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> npm run test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이런 식으로 yml 파일을 하나 추가하면 <strong>frontend의 수정이 일어날 때는 jest</strong>를 실행하고, <strong>backend 폴더의 수정이 일어나면 gradlew</strong>를 실행하게 할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="test가-실패하는-pr은-merge-막기">Test가 실패하는 PR은 Merge 막기<a href="#test가-실패하는-pr은-merge-막기" class="hash-link" aria-label="Test가 실패하는 PR은 Merge 막기에 대한 직접 링크" title="Test가 실패하는 PR은 Merge 막기에 대한 직접 링크">​</a></h2><p>Test가 실패하는 Pull Request가 Merge 되는 일은 절대로 없어야 합니다. 그런 실수를 방지하려면 팀원 전부가 리뷰할 때 테스트를 돌려봐야하는 귀찮음이 생길 수 있습니다.</p><p>그리고 사람은 실수해도 기계는 거짓말을 하지 않습니다. 자동으로 막도록 동작하게 만들어놓으면 그럴 일을 미연에 방지할 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="environments-확인하기">Environments 확인하기<a href="#environments-확인하기" class="hash-link" aria-label="Environments 확인하기에 대한 직접 링크" title="Environments 확인하기에 대한 직접 링크">​</a></h3><p>먼저 해당 Repository의 Settings -&gt; Environments 탭으로 들어갑니다.
<img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/assets/106640954/4e3e867a-1037-46bc-865a-6d7d52527518" alt="environments" class="img_ev3q">
아까 <strong>environment</strong> 속성을 보면 <code>test</code>라고 설정해놓은 것을 볼 수 있습니다. 해당 환경이 여기에 적용됩니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="branch-rule-정의하기">Branch rule 정의하기<a href="#branch-rule-정의하기" class="hash-link" aria-label="Branch rule 정의하기에 대한 직접 링크" title="Branch rule 정의하기에 대한 직접 링크">​</a></h3><p>이번에는 해당 Repository의 Settings -&gt; Branches 탭으로 들어갑니다. 그리고 원하는 branch에 들어가 <code>edit</code> 버튼을 누릅니다.</p><p>그리고 사진과 같이 <strong>Require deployments to succeed before merging</strong> 속성을 클릭합니다. 그리고 아래와 같이 어떤 환경을 적용할 것인지 선택할 수 있습니다.</p><p>이 속성은 해당 배포가 성공해야 merge 할 수 있도록 브랜치를 보호하는 기능입니다.</p><p>그리고 저희는 frontend와 backend Job의 환경을 둘 다 test라는 이름으로 정의했기 때문에 하나의 environment만 선택해도 둘 다 적용되는 효과를 볼 수 있습니다.
<img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/assets/106640954/02be4679-56a2-4e47-ae01-b7025f8778a4" alt="branch rule" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="적용-후">적용 후<a href="#적용-후" class="hash-link" aria-label="적용 후에 대한 직접 링크" title="적용 후에 대한 직접 링크">​</a></h4><p>아래와 같이 merge가 안된다는 글과 빨간색으로 경고 표시를 해주고 있습니다.
<img loading="lazy" src="https://github.com/car-ffeine/car-ffeine.github.io/assets/106640954/7dfba566-c8c8-4a24-a0e3-42081f3af31c" alt="blocked" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론">결론<a href="#결론" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><p>간단한 github action을 통해서 생산성을 많이 올릴 수 있는 좋은 기능인 것 같습니다. 다른 팀들도 이 기능을 도입하여 사용하는 것을 추천드립니다.</p>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="github" term="github"/>
        <category label="action" term="action"/>
        <category label="pr" term="pr"/>
        <category label="test" term="test"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[webpack으로 msw 설정하기]]></title>
        <id>https://car-ffeine.github.io/10</id>
        <link href="https://car-ffeine.github.io/10"/>
        <updated>2023-07-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[웹팩에서 msw 설정]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="웹팩에서-msw-설정">웹팩에서 msw 설정<a href="#웹팩에서-msw-설정" class="hash-link" aria-label="웹팩에서 msw 설정에 대한 직접 링크" title="웹팩에서 msw 설정에 대한 직접 링크">​</a></h2><p>이번 팀 프로젝트는 CRA와 같은 보일러 플레이트 코드를 사용하지 못하게 제한이 있다. 또한 요즘 많이 사용된다는 Vite의 사용도 제한이 있고, 웹팩으로 프로젝트를 시작하도록 강제하고 있다.</p><p>팀원 모두 한 번도 웹팩을 통해 프로젝트를 시작해본 경험이 없어 프론트엔드 팀원 각자 개인 레포에서 웹팩 공부를 진행한 후 어느정도 진척이 있을 때 팀 레포에 프로젝트를 시작하기로 했다.</p><p>다행히 웹팩으로 시작하는 프로젝트에 대한 많은 참고 자료들이 있어 첫 리액트 프로젝트 화면을 띄우는데 까지는 그리 오랜 시간이 걸리지 않았다. 그렇게 모든 팀원이 첫 웹팩 프로젝트를 성공시킨 후 모여 팀 프로젝트 초기 설정을 시작해보았다.</p><p>eslint, prettier, 웹팩 등등 여러 설정들을 하고 필요한 패키지를 설치하는데 문제가 발생했다. 큰 데이터를 다루는 백엔드의 개발 속도를 고려해 프론트엔드 개발을 진행하기 위해서 미션중에 배웠던 MSW 라이브러리를 사용하기로 결정했는데, 이 라이브러리가 우리 팀의 개발 환경에서 동작하지 않았다.</p><p>왜 동작하지 않는지 원인을 찾아보니 MSW service worker 파일을 찾을 수 없다는 오류 메세지가 나오는 것을 확인할 수 있었다. 원인을 더 자세히 알아보니 public 폴더에 있는 파일들은 웹팩이 번들링을 진행할 때 포함이 되지 않는다는 것을 알 수 있었고, 이를 어떻게 해결할 지 팀원들과 방법을 찾아보았다.</p><p>약 한시간쯤 지났을 무렵 copy-webpack-plugin 패키지를 통해 public 경로에 있는 파일들도 빌드 폴더에 포함시킬 수 있다는 것을 알게 되었다. 하지만 이 copy-webpack-plugin에 대한 사용법이 미숙해 public 폴더에 있는 mockServiceWorker.js 파일만 빌드 폴더로 옮겼어야 했는데 index.html과 같은 다른 파일들 까지 한꺼번에 빌드 폴더로 옮겨지게 되었다.</p><p>이런 저런 방법들을 시도해보다 webpack.config.js 파일의 plugins에 아래와 같은 설정을 추가 해주어 MSW를 프로젝트에 적용할 수 있게 되었다.</p><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CopyWebpackPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">patterns</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'public/mockServiceWorker.js'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">to</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'.'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// msw service worker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>설정을 간단히 보면 public 경로에 있는 mockServiceWorker.js 파일을 빌드 후 폴더의 루트 디렉토리에 추가해준다는 설정이다.</p><p>문제 상황과 해결 방법을 간단하게 다시 정리해보면 다음과 같다.</p><ol><li>MSW를 적용해보려고 함.</li><li>웹팩에서 개발 서버를 열었을 때 MSW 실행을 위해 필요한 mockServiceWorker.js 파일을 찾을 수 없다는 오류가 발생함.</li><li>문제의 원인은 웹팩에서 번들링을 진행할 때 public 폴더 하위 경로에 있는 파일들을 무시하기 때문이었음.</li><li>문제를 해결하기 위해 public 경로에 있는 mockServiceWorker.js 파일을 번들링 후 폴더의 루트 디렉토리에 저장하도록 하는 설정을 추가해줌.</li></ol>]]></content>
        <author>
            <name>센트</name>
            <uri>https://github.com/kyw0716</uri>
        </author>
        <category label="msw" term="msw"/>
        <category label="webpack" term="webpack"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[스프링에서 발생한 에러 로그를 슬랙으로 모니터링하는 방법]]></title>
        <id>https://car-ffeine.github.io/8</id>
        <link href="https://car-ffeine.github.io/8"/>
        <updated>2023-07-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 카페인팀 nunu입니다.]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 카페인팀 nunu입니다.</p><p>오늘은 스프링에서 발생한 에러 로그를 슬랙으로 모니터링하는 방법에 대해서 알아보려고 합니다.</p><p>목차는 다음과 같습니다.</p><ol><li>스프링에서 로그를 남기는 방법</li><li>Slf4 j의 동작원리</li><li>Logback의 동작원리</li><li>Logback을 사용해서 슬랙으로 에러 로그를 모니터링하는 방법</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="스프링에서-로그는-어떻게-찍을까">스프링에서 로그는 어떻게 찍을까?<a href="#스프링에서-로그는-어떻게-찍을까" class="hash-link" aria-label="스프링에서 로그는 어떻게 찍을까?에 대한 직접 링크" title="스프링에서 로그는 어떻게 찍을까?에 대한 직접 링크">​</a></h2><p>스프링에서 로그를 찍는 방법은 여러 가지가 있지만, 가장 간단한 방법은 <code>System.out.println()</code>을 사용하는 것입니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@RestController</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">TestController</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@GetMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/test"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"test"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"test"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>당연하지만, 성능이 안 좋아서 실제 서비스에서는 사용하지 않습니다.</p><p>스프링에서는 Slf4 j를 통해서 로그를 남길 수 있습니다.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Slf4j</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// private final Logger log = LoggerFactory.getLogger(this.getClass()); 와 같다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@RestController</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">TestController</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@GetMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/test"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"test"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"test"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이 코드를 통해서 로그를 남길 수 있는데, 자동으로 콘솔에 출력이 됩니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="스프링에서-로깅은-어떻게-작동하는-거지">스프링에서 로깅은 어떻게 작동하는 거지?<a href="#스프링에서-로깅은-어떻게-작동하는-거지" class="hash-link" aria-label="스프링에서 로깅은 어떻게 작동하는 거지?에 대한 직접 링크" title="스프링에서 로깅은 어떻게 작동하는 거지?에 대한 직접 링크">​</a></h2><p>스프링 4까지는 <code>Commons Logging</code>을 사용했었습니다.</p><p><code>Commons Logging</code>은 <code>JCL</code>이라고도 불리며, <code>JDK Logging</code>, <code>Log4 j,</code> <code>Logback</code> 등 다양한 로깅 프레임워크를 지원합니다.</p><p>JCL 은 런타임에 어떤 로깅 프레임워크를 사용할지 결정할 수 있습니다.</p><p>런타임에 어떤 로깅 프레임워크를 사용할지 결정하는 방식으로 클래스 로더에게 질의를 하는 방식으로 작동하게 되는데</p><p>클래스 로더에게 질의를 했을 경우에 몇 가지 문제점이 생깁니다</p><ol><li>클래스 로더에 명확한 표준이 없고, 부모 자식 모델이 있어서, 클래스 로더에 따라서 다른 결과가 나올 수 있습니다. <a href="http://articles.qos.ch/classloader.html" target="_blank" rel="noopener noreferrer">참고</a></li><li>클래스로더는 gc의 동작에 방해를 일으켜서 메모리 누수를 발생시킬 수 있습니다. <a href="https://cwiki.apache.org/confluence/display/COMMONS/Logging+UndeployMemoryLeak" target="_blank" rel="noopener noreferrer">참고</a></li></ol><p><code>@Slf4j</code> 어노테이션을 붙이면, 컴파일 시점에 <code>private final Logger log = LoggerFactory.getLogger(this.getClass());</code> 와 같은 코드로 변환됩니다.</p><p>스프링 5에서는 Slf4j 가 사용하는 것처럼, 컴파일 타임에 어떤 로깅 프레임워크를 사용할지 결정하는 기능을 작성했고, <code>Commons Logging</code>을 사용하지 않게 되었습니다.</p><p><a href="https://docs.spring.io/spring-framework/docs/5.0.0.RC3/spring-framework-reference/overview.html#overview-logging" target="_blank" rel="noopener noreferrer">spring 5에서 변경되었다는 링크</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="slf4-j에-대해서-알아보자">Slf4 j에 대해서 알아보자<a href="#slf4-j에-대해서-알아보자" class="hash-link" aria-label="Slf4 j에 대해서 알아보자에 대한 직접 링크" title="Slf4 j에 대해서 알아보자에 대한 직접 링크">​</a></h2><p>Slf4 j는 로깅을 위한 인터페이스를 제공하는 프레임워크입니다.(Simple Logging Facade for Java)</p><p>컴파일 타임에, 어떤 로그 라이브러리를 사용할지 결정하는 기능을 제공합니다.</p><p>로그 라이브러리를 바꾸려고 했을 때, 기존 코드는 하나도 건드리지 않고, 로그 라이브러리만 바꿔주면 되도록 해줍니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="조금-더-자세한-동작-원리를-알아보자">조금 더 자세한 동작 원리를 알아보자<a href="#조금-더-자세한-동작-원리를-알아보자" class="hash-link" aria-label="조금 더 자세한 동작 원리를 알아보자에 대한 직접 링크" title="조금 더 자세한 동작 원리를 알아보자에 대한 직접 링크">​</a></h3><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/lCcTc/btsmBw3OEJz/1njLV283KdUWc9qyppEdak/img.png" alt="only slf4j" class="img_ev3q"></p><p>Slf4 j 만을 사용했을 경우 위 사진 같은 형태로 요청이 처리가 됩니다.</p><p>Slf4 j 라는 인터페이스를 통해서 로그를 남기고, 어떤 로그 라이브러리를 사용할지는 <code>Slf4j binding</code>이라는 것을 통해서 결정합니다.</p><p><code>Slf4j binding</code> 은 <code>Slf4j</code>의 인터페이스를 구현하고 있지 않은 라이브러리의 구현체를 연결해 주는 역할을 합니다.</p><p>그 구현체로 <code>Slf4j-log4 j12-{version}. jar</code> 같은 것이 있다.</p><p>이와는 다르게 Logback 은 Slf4 j 를 구현하고 있기에, <code>Slf4j binding</code> 을 사용하지 않아도 됩니다.</p><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/IYC3k/btsmy0einLF/F0aiMnteJeGB00fkGdBjRK/img.png" alt="logback example" class="img_ev3q"></p><p>위 사진처럼 <code>Slf4j binding</code> 을 사용하지 않고, <code>Logback</code> 바로 사용하는 것도 가능합니다.</p><p>그렇다면 Slf4 j를 바로 사용하지 않은 코드에서 <code>Slf4j</code> 를 사용하려면 어떻게 해야 할까요?</p><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/msTPw/btsmziy04VE/sXSOKYvi9yXSoiRmg6mIGk/img.png" alt="slf4j working principle" class="img_ev3q"></p><p>위 사진처럼 <code>Slf4j bridge</code> 를 통해서 외부 라이브러리를 사용하는 것처럼 갈아 끼울 수 있습니다.</p><p><code>Log4j2</code> 를 사용하는 코드를 전혀 바꾸지 않아도, <code>Bridge</code> 가 <code>Slf4j</code> 를 통해 <code>Logback</code>으로 자연스럽게 로그를 남길 수 있도록 해줍니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="logback에-대해서-알아보자">Logback에 대해서 알아보자<a href="#logback에-대해서-알아보자" class="hash-link" aria-label="Logback에 대해서 알아보자에 대한 직접 링크" title="Logback에 대해서 알아보자에 대한 직접 링크">​</a></h2><p>Logback 은 스프링에서 기본으로 사용될 만큼 인기 있는 로그 라이브러리입니다.</p><p><img loading="lazy" src="https://logback.qos.ch/manual/images/chapters/architecture/underTheHoodSequence2_small.gif" alt="logback 동작 과정" class="img_ev3q"></p><p>공식문서에서 아주 핵심적인 동작원리를 설명해주고 있는 사진이라서 가져왔습니다.</p><p>너무 어려워 보여서, 조금 자세하게 각각의 구성요소에 대해서 알아보도록 하겠습니다</p><p>이에 대해 알아보도록 하겠습니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="로그백의-구성요소">로그백의 구성요소<a href="#로그백의-구성요소" class="hash-link" aria-label="로그백의 구성요소에 대한 직접 링크" title="로그백의 구성요소에 대한 직접 링크">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="appender">Appender<a href="#appender" class="hash-link" aria-label="Appender에 대한 직접 링크" title="Appender에 대한 직접 링크">​</a></h3><p>Appender는 로그를 어디에 출력할지를 결정하는 역할을 합니다.</p><p>외부로부터 어떤 데이터를 받아서, 어떤 방식으로 처리할지에 대해서 전체적으로 설정할 수 있습니다.</p><p>기본적으로 수많은 Appender 가 제공되고 있습니다.</p><ul><li>ConsoleAppender</li><li>FileAppender</li><li>RollingFileAppender</li><li>AsyncAppender</li><li>DBAppender</li><li>SMTPAppender</li><li>SocketAppender</li><li>SyslogAppender</li></ul><p>저희는 Slack에 알림을 주는 것이 목적이기 때문에, SlackAppender를 사용하면 될 것 같습니다.</p><p>하지만 SlackAppender는 제공되고 있지 않기에 직접 구현을 해야 하는데요</p><p>이를 구현했을 때, Slack API 가 끝날 때까지, 계속 기다리고 있을 필요가 없기에, AsyncAppender를 사용하는 것이 좋을 것 같습니다.</p><p>사용 방법은 다음과 같습니다. xml 기반으로 가능한데요</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">FILE</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ch.qos.logback.core.FileAppender</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">myapp.log</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">encoder</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">pattern</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">%logger{35} -%kvp -%msg%n</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">pattern</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">encoder</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ASYNC</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ch.qos.logback.classic.AsyncAppender</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender-ref</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">FILE</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">root</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">level</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">DEBUG</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender-ref</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ASYNC</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">root</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>만약 여기에 있는 기능들로 부족하다면, 직접 Appender 를 구현해서 사용할 수도 있습니다.</p><p>직접 구현하려면 AppenderBase를 상속받아서 구현하면 됩니다.</p><p>이 클래스는 필요한 부분이 대부분 구현되어 있고, appender 만 구현하면 바로 사용할 수 있습니다. 당연하지만 필요하다면 override 도 가능하죠</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="layout">Layout<a href="#layout" class="hash-link" aria-label="Layout에 대한 직접 링크" title="Layout에 대한 직접 링크">​</a></h3><p>Layout 은 로그를 어떤 형식으로 출력할지를 결정하는 역할을 합니다.</p><p>Appender는 로그를 어디에 출력할지를 결정하는 역할을 하고, Layout 은 로그를 어떤 형식으로 출력할지를 결정하는 역할을 하도록 하는 것이 이상적이지만</p><p>Logback 은 Appender에서 Layout 을 직접 지정할 수 있도록 해주고 있습니다.</p><p>따라서, 직접 Layout 을 만들지 않고, Appender 에서 기존에 이미 있는 패턴만 사용하려고 합니다</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="encoder">Encoder<a href="#encoder" class="hash-link" aria-label="Encoder에 대한 직접 링크" title="Encoder에 대한 직접 링크">​</a></h3><p>Encoder는 Layout 과 비슷한 역할을 합니다.</p><p>Layout 은 로그를 어떤 형식으로 출력할지를 결정하는 역할을 하고, Encoder 는 실제 byte 형태로 변환하는 역할을 합니다.</p><p>Slack의 webhook을 사용할 것이지만, AppenderBase를 사용하기에, 이번에는 사용할 수 없습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="filter">Filter<a href="#filter" class="hash-link" aria-label="Filter에 대한 직접 링크" title="Filter에 대한 직접 링크">​</a></h3><p>Filter는 로그를 어떤 조건에 따라서 출력할지를 결정하는 역할을 합니다.</p><p>Filter 는 Appender를 등록하며 같이 등록할 수 있는데요</p><p>이번 프로젝트에서는 Level 이 ERROR 이상인 것만 출력하도록 하고 싶기에, LevelFilter를 사용하면 좋을 것 같습니다.</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">CONSOLE</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ch.qos.logback.core.ConsoleAppender</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">filter</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ch.qos.logback.classic.filter.LevelFilter</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">level</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">INFO</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">level</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">onMatch</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">ACCEPT</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">onMatch</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">onMismatch</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">DENY</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">onMismatch</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">filter</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">encoder</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">pattern</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        %-4relative [%thread] %-5level %logger{30} -%kvp -%msg%n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">pattern</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">encoder</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">root</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">level</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">DEBUG</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender-ref</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">CONSOLE</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">root</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>와 비슷하게 사용할 수 있어 보입니다.</p><p>그러면 실제로 프로젝트에서 error 발생 시 slack으로 알림을 주는 것을 구현해 보도록 하겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="슬랙에-추가하는-방법">슬랙에 추가하는 방법<a href="#슬랙에-추가하는-방법" class="hash-link" aria-label="슬랙에 추가하는 방법에 대한 직접 링크" title="슬랙에 추가하는 방법에 대한 직접 링크">​</a></h2><p><a href="https://velog.io/@king/slack-incoming-webhook" target="_blank" rel="noopener noreferrer">이 블로그</a>를 보고서 작성했습니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="실제-구현">실제 구현<a href="#실제-구현" class="hash-link" aria-label="실제 구현에 대한 직접 링크" title="실제 구현에 대한 직접 링크">​</a></h2><p>구현된 결과물은 아래와 같습니다</p><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/d3z7QG/btsmQCCV69f/NwiyNhQGZOBnKBP2hT8kf0/img.png" alt="slack appender" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="slackappender-구현하기">SlackAppender 구현하기<a href="#slackappender-구현하기" class="hash-link" aria-label="SlackAppender 구현하기에 대한 직접 링크" title="SlackAppender 구현하기에 대한 직접 링크">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SlackAppender</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">AppenderBase</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">ILoggingEvent</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ILoggingEvent</span><span class="token plain"> eventObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> restTemplate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RestTemplate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"https://hooks.slack.com/services/"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createSlackErrorBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        restTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">postForEntity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createSlackErrorBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ILoggingEvent</span><span class="token plain"> eventObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"attachments"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">Map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token string" style="color:#e3116c">"fallback"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"요청을 실패했어요 :cry:"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token string" style="color:#e3116c">"color"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"#2eb886"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token string" style="color:#e3116c">"pretext"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"에러가 발생했어요 확인해주세요 :cry:"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token string" style="color:#e3116c">"author_name"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"car-ffeine"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token string" style="color:#e3116c">"text"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token string" style="color:#e3116c">"fields"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token class-name">Map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                </span><span class="token string" style="color:#e3116c">"title"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"우선순위"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                </span><span class="token string" style="color:#e3116c">"value"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"High"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                </span><span class="token string" style="color:#e3116c">"short"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token class-name">Map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                </span><span class="token string" style="color:#e3116c">"title"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"서버 환경"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                </span><span class="token string" style="color:#e3116c">"value"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"local"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                </span><span class="token string" style="color:#e3116c">"short"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token string" style="color:#e3116c">"ts"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eventObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTimeStamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ILoggingEvent</span><span class="token plain"> eventObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> baseMessage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"에러가 발생했습니다.\n"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> pattern </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> baseMessage </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"```%s %s %s [%s] - %s```"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">SimpleDateFormat</span><span class="token plain"> simpleDateFormat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pattern</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                simpleDateFormat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTimeStamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                eventObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                eventObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getThreadName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                eventObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLoggerName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                eventObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getFormattedMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이 과정에서 url을 직접 입력하시면 됩니다.</p><p>그리고, 이렇게 만든 SlackAppender를 logback-spring.xml 에 등록하면 됩니다.</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token prolog" style="color:#999988;font-style:italic">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">scan</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">true</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">scanPeriod</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">60 seconds</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">include</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">resource</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">org/springframework/boot/logging/logback/defaults.xml</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">LOG_FILE</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">${LOG_FILE:-${LOG_PATH:-${LOG_TEMP:-${java.io.tmpdir:-/tmp}}}/spring.log}</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">include</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">resource</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">org/springframework/boot/logging/logback/console-appender.xml</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">include</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">resource</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">org/springframework/boot/logging/logback/file-appender.xml</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">root</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">level</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">INFO</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender-ref</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">FILE</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender-ref</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">CONSOLE</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">root</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">SLACK_APPENDER</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">racingcar.SlackAppender</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ASYNC_SLACK_APPENDER</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ch.qos.logback.classic.AsyncAppender</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender-ref</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">SLACK_APPENDER</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">appender</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">logger</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">racingcar</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">level</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ERROR</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">additivity</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">true</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">appender-ref</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">ASYNC_SLACK_APPENDER</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">logger</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 하면, racingcar 패키지에서 에러가 발생할 때만 slack으로 알림을 받을 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="결론">결론<a href="#결론" class="hash-link" aria-label="결론에 대한 직접 링크" title="결론에 대한 직접 링크">​</a></h2><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/d3z7QG/btsmQCCV69f/NwiyNhQGZOBnKBP2hT8kf0/img.png" alt="slack appender" class="img_ev3q"></p><p>이번 글에서는 log 레벨에 따라 slack 으로 알림을 받는 방법을 알아보았습니다.</p><p>긴 글을 읽어주셔서 감사합니다</p>]]></content>
        <author>
            <name>누누</name>
            <uri>https://github.com/be-student</uri>
        </author>
        <category label="spring" term="spring"/>
        <category label="slack" term="slack"/>
        <category label="error" term="error"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[깃 커밋 메시지에 이슈 번호를 자동으로 입력할 순 없을까?]]></title>
        <id>https://car-ffeine.github.io/7</id>
        <link href="https://car-ffeine.github.io/7"/>
        <updated>2023-07-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[프로젝트 브랜치명 컨벤션이 feat/이슈번호여서, 브랜치명에서 이슈번호만 가져온 다음 커밋할 때마다 커밋 메시지 아래단(footer)에 이슈 번호를 자동으로 입력해주고 싶었다. 자동으로 입력된다면 깜빡하고 이슈 번호를 안 적는 일도 없고, 시간도 단축할 수 있기 때문이다.]]></summary>
        <content type="html"><![CDATA[<p>프로젝트 브랜치명 컨벤션이 feat/이슈번호여서, 브랜치명에서 이슈번호만 가져온 다음 커밋할 때마다 커밋 메시지 아래단(footer)에 이슈 번호를 자동으로 입력해주고 싶었다. 자동으로 입력된다면 깜빡하고 이슈 번호를 안 적는 일도 없고, 시간도 단축할 수 있기 때문이다.</p><p>아래 순서대로 진행한다면 이슈 번호 POSTFIX 자동화를 할 수 있다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-프로젝트-폴더에-githooks-폴더-생성">1) 프로젝트 폴더에 .githooks 폴더 생성<a href="#1-프로젝트-폴더에-githooks-폴더-생성" class="hash-link" aria-label="1) 프로젝트 폴더에 .githooks 폴더 생성에 대한 직접 링크" title="1) 프로젝트 폴더에 .githooks 폴더 생성에 대한 직접 링크">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-githooks-폴더에-commit-msg-파일-생성">2) .githooks 폴더에 commit-msg 파일 생성<a href="#2-githooks-폴더에-commit-msg-파일-생성" class="hash-link" aria-label="2) .githooks 폴더에 commit-msg 파일 생성에 대한 직접 링크" title="2) .githooks 폴더에 commit-msg 파일 생성에 대한 직접 링크">​</a></h3><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">COMMIT_MESSAGE_FILE_PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">MESSAGE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">cat</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$COMMIT_MESSAGE_FILE_PATH</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 커밋 메시지가 없을 때, 커밋 방지</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">head</span><span class="token variable" style="color:#36acaa"> -1 </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$COMMIT_MESSAGE_FILE_PATH</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 브랜치명에서 이슈 번호만 추출 ('/' 뒤에 있는 문자만 추출)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">POSTFIX</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">git</span><span class="token variable" style="color:#36acaa"> branch </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">'\*'</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">sed</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">'s/* //'</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">sed</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">'s/^.*\///'</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">sed</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">'s/^\([^-]*-[^-]*\).*/\1/'</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">COMMIT_SOURCE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CURRENT_BRANCH</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">git</span><span class="token variable" style="color:#36acaa"> branch --show-current</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># [[ "$CURRENT_BRANCH" != "$POSTFIX" ]] 👉🏻 현재 브랜치명과 POSTFIX가 똑같으면 POSTFIX 입력 방지</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># [ "$COMMIT_SOURCE" != "merge" ] 👉🏻 merge할 때, POSTFIX 입력 방지</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># [[ "$MESSAGE" != *"[#$POSTFIX]"* ]] 👉🏻 이미 POSTFIX가 존재할 때, POSTFIX 중복 입력 방지</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$CURRENT_BRANCH</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$POSTFIX</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$COMMIT_SOURCE</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"merge"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$MESSAGE</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> *</span><span class="token string" style="color:#e3116c">"[#</span><span class="token string variable" style="color:#36acaa">$POSTFIX</span><span class="token string" style="color:#e3116c">]"</span><span class="token plain">* </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">printf</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%s</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">[#%s]"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$MESSAGE</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$POSTFIX</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$COMMIT_MESSAGE_FILE_PATH</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>🧐 이슈 번호 추출에 사용된 명령어 설명</p><ul><li>grep '<!-- -->*<!-- -->' 👉 <code>*</code> 표시된 브랜치(현재 위치의 브랜치)를 가져온다.</li><li>sed 's/_ //' 👉 <code>*</code> 제거</li><li>sed 's/<!-- -->(<sup id="fnref-/-33a37a"><a href="#fn-/-33a37a" class="footnote-ref">/</a></sup><em>)<!-- -->.</em>/\1/' 👉 <code>/</code> 이후의 문자만 추출</li><li>sed 's/^<!-- -->(<sup id="fnref---33a37a"><a href="#fn---33a37a" class="footnote-ref">-</a></sup><em>-<sup id="fnref---33a37a"><a href="#fn---33a37a" class="footnote-ref">-</a></sup></em>)<!-- -->.<!-- -->_<!-- -->/\1/' 👉 하나의 이슈에 여러 브랜치를 만들면서 feat/10-1 이런 형태로 브랜치를 만들 경우, 첫 번째 '-' 앞 뒤만 추출 (ex. 10-1)</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-프로젝트-폴더에-makefile-파일-생성">3) 프로젝트 폴더에 Makefile 파일 생성<a href="#3-프로젝트-폴더에-makefile-파일-생성" class="hash-link" aria-label="3) 프로젝트 폴더에 Makefile 파일 생성에 대한 직접 링크" title="3) 프로젝트 폴더에 Makefile 파일 생성에 대한 직접 링크">​</a></h3><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">init:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> config core.hooksPath .githooks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x .githooks/commit-msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> update-index --chmod</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">+x .githooks/commit-msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># chmod +x .githooks/commit-msg 👉🏻 macOS, 리눅스에서 스크립트 권한 부여</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># git update-index --chmod=+x .githooks/commit-msg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 👉 macOS, 리눅스에서 브랜치가 바뀔 때마다 스크립트 실행시켜줘야 하는 문제 해결</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-아래-코드-실행">4) 아래 코드 실행<a href="#4-아래-코드-실행" class="hash-link" aria-label="4) 아래 코드 실행에 대한 직접 링크" title="4) 아래 코드 실행에 대한 직접 링크">​</a></h3><p>새로 git clone을 할 때마다 아래 코드를 실행시켜줘야 한다. 한 번만 실행시키면 계속 적용된다. (window 기준)</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> config core.hooksPath .githooks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>❗macOS는 git clone 할 때마다 아래 코드를 실행시켜줘야 한다.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><p>참고 블로그
<a href="https://blog.deering.co/commit-convention/" target="_blank" rel="noopener noreferrer">https://blog.deering.co/commit-convention/</a></p>]]></content>
        <author>
            <name>야미</name>
            <uri>https://github.com/feb-dain</uri>
        </author>
        <category label="git" term="git"/>
        <category label="commit" term="commit"/>
        <category label="message" term="message"/>
        <category label="issue" term="issue"/>
        <category label="auto" term="auto"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[[DB] 대량의 데이터를 DB에 넣는 과정을 최적화해보자]]></title>
        <id>https://car-ffeine.github.io/6</id>
        <link href="https://car-ffeine.github.io/6"/>
        <updated>2023-07-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 카페인팀 누누입니다]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 카페인팀 <code>누누</code>입니다</p><p>이번에는 대량의 데이터를 DB에 넣는 과정을 최적화하는 과정에서 알게 된 내용을 공유하려고 합니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="이번-최적화의-목표">이번 최적화의 목표<a href="#이번-최적화의-목표" class="hash-link" aria-label="이번 최적화의 목표에 대한 직접 링크" title="이번 최적화의 목표에 대한 직접 링크">​</a></h2><p>전기차 충전소에 대한 공공 데이터를 가져오고, 그 데이터를 DB 에 넣는 과정을 최적화해보자</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="대량의-데이터를-삽입하는-과정">대량의 데이터를 삽입하는 과정<a href="#대량의-데이터를-삽입하는-과정" class="hash-link" aria-label="대량의 데이터를 삽입하는 과정에 대한 직접 링크" title="대량의 데이터를 삽입하는 과정에 대한 직접 링크">​</a></h2><p>저희 팀의 요구사항을 간단하게 정리하면 다음과 같습니다</p><ol><li>대량의 데이터를 공공 데이터에서 전기차 충전소와 전기차 충전기에 대한 데이터를 가져온다<ul><li>충전소는 6만 개, 충전기는 23만 개의 데이터가 존재한다.</li><li>한 번에 가져올 수 있는 양은 9999개 까지다.</li></ul></li><li>이 데이터를 DB에 넣는다<ul><li>충전소와 충전기는 1:N 관계이다</li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="최적화-전은-어떤-상황이었는데">최적화 전은 어떤 상황이었는데?<a href="#최적화-전은-어떤-상황이었는데" class="hash-link" aria-label="최적화 전은 어떤 상황이었는데?에 대한 직접 링크" title="최적화 전은 어떤 상황이었는데?에 대한 직접 링크">​</a></h2><p><img loading="lazy" src="https://veiled-starfish-4c7.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Ffb934c88-4589-4096-90bc-36b4bc88f6a2%2FUntitled.png?id=f7f7c2af-7b95-42e8-8d95-ddd952e53005&amp;table=block&amp;spaceId=9db11c89-12d2-4910-8822-5ffecbdb8ccd&amp;width=2000&amp;userId=&amp;cache=v2" alt="before_optimize" class="img_ev3q"></p><p>위 사진을 잘 보시면 아실 수 있으시겠지만, 2000개를 저장하는데, 231.762 초가 사용되었습니다.</p><p>물론 출력을 위한 시간도 포함되었기에, 230초 정도라고 생각하셔도 좋습니다</p><p>1만 개라면? 231.762초 <!-- -->*<!-- --> 5 = 1,158.81초</p><p>23만 개라면? 1158.81 <!-- -->*<!-- --> 23 = 26,652.63초</p><p>시간으로 바꿔보면 7.4 시간이 걸린다는 것을 볼 수 있습니다</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="이-과정에서-볼-수-있는-문제점">이 과정에서 볼 수 있는 문제점<a href="#이-과정에서-볼-수-있는-문제점" class="hash-link" aria-label="이 과정에서 볼 수 있는 문제점에 대한 직접 링크" title="이 과정에서 볼 수 있는 문제점에 대한 직접 링크">​</a></h3><ol><li>데이터를 저장할 때마다, 새로운 Transaction 이 생성된다.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="어떻게-개선할-수-있을까">어떻게 개선할 수 있을까?<a href="#어떻게-개선할-수-있을까" class="hash-link" aria-label="어떻게 개선할 수 있을까?에 대한 직접 링크" title="어떻게 개선할 수 있을까?에 대한 직접 링크">​</a></h3><p>데이터를 저장할 때마다, 새로운 Transaction 이 생성되는 것을 방지하기 위해, 전체를 하나의 트랜잭션으로 묶는다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="전체를-한-트랜잭션으로-묶은-버전">전체를 한 트랜잭션으로 묶은 버전<a href="#전체를-한-트랜잭션으로-묶은-버전" class="hash-link" aria-label="전체를 한 트랜잭션으로 묶은 버전에 대한 직접 링크" title="전체를 한 트랜잭션으로 묶은 버전에 대한 직접 링크">​</a></h2><p><img loading="lazy" src="https://veiled-starfish-4c7.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9ff34622-4a26-4acd-980c-ae175c83143d%2FUntitled.png?id=979aa2c5-e972-4c52-a44a-1669c497c84e&amp;table=block&amp;spaceId=9db11c89-12d2-4910-8822-5ffecbdb8ccd&amp;width=2000&amp;userId=&amp;cache=v2" alt="all_in_transaction" class="img_ev3q"></p><p>이 과정에서 2000개를 저장하는데 65초 가 사용되었습니다.</p><p>1만 개라면? 65초 <!-- -->*<!-- --> 5 = 325초</p><p>23만 개라면? 325초 <!-- -->*<!-- --> 23 = 7,475초</p><p>시간으로 바꿔보면 2시간이 걸린다는 것을 볼 수 있습니다</p><p>전체적으로 3배 정도 빨라졌습니다</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="이-과정에서-볼-수-있는-문제점-1">이 과정에서 볼 수 있는 문제점<a href="#이-과정에서-볼-수-있는-문제점-1" class="hash-link" aria-label="이 과정에서 볼 수 있는 문제점에 대한 직접 링크" title="이 과정에서 볼 수 있는 문제점에 대한 직접 링크">​</a></h3><ol><li>23만 개의 저장이 모두 한 트랜잭션이 되어서, 하나가 실패하면 23만개를 새로 저장해야 하는 상황에 처한다</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="어떻게-개선할-수-있을까-1">어떻게 개선할 수 있을까?<a href="#어떻게-개선할-수-있을까-1" class="hash-link" aria-label="어떻게 개선할 수 있을까?에 대한 직접 링크" title="어떻게 개선할 수 있을까?에 대한 직접 링크">​</a></h3><p>23만개의 저장이 모두 한 트랜잭션이 되는 것을 방지하기 위해, 1만 개씩 영속화시킨다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1만-개가-한-트랜잭션으로-묶인-버전">1만 개가 한 트랜잭션으로 묶인 버전<a href="#1만-개가-한-트랜잭션으로-묶인-버전" class="hash-link" aria-label="1만 개가 한 트랜잭션으로 묶인 버전에 대한 직접 링크" title="1만 개가 한 트랜잭션으로 묶인 버전에 대한 직접 링크">​</a></h2><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/c2mgfd/btsmrWCfnKy/9Y6Dv8vYzcftsket61tub1/img.png" alt="separateTransaction" class="img_ev3q"></p><p>성능상으로 개선한 부분은 그렇게 크지 않지만, 실패했을 때, 1만 개만 다시 저장하면 되기에, 훨씬 빠르게 복구가 가능합니다.</p><p>여기서 PageNo라는 클래스는, i를 바로 참조했을 경우, effectively final을 보장할 수 없어서 만들었습니다.</p><p>성능은 전체를 한 트랜잭션으로 묶은 버전과 큰 차이가 나지 않습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="이-과정에서-볼-수-있는-문제점-2">이 과정에서 볼 수 있는 문제점<a href="#이-과정에서-볼-수-있는-문제점-2" class="hash-link" aria-label="이 과정에서 볼 수 있는 문제점에 대한 직접 링크" title="이 과정에서 볼 수 있는 문제점에 대한 직접 링크">​</a></h3><ol><li>id 생성 전략이 <code>GenerationType.IDENTITY</code> 이기에, 데이터를 저장할 때마다, DB에서 id를 생성해야 한다.</li></ol><p>JPA에 있는 쓰기 지연을 전혀 활용할 수 없고, DB에서 id를 생성하기 위해, DB와 매번 통신을 해야 한다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="어떻게-개선할-수-있을까-2">어떻게 개선할 수 있을까?<a href="#어떻게-개선할-수-있을까-2" class="hash-link" aria-label="어떻게 개선할 수 있을까?에 대한 직접 링크" title="어떻게 개선할 수 있을까?에 대한 직접 링크">​</a></h3><p>id를 미리 생성해서, DB 에서 id 를 생성하는 과정을 생략한다</p><p>ID 생성 전략을 <code>GenerationType.Table의</code> 형태로 바꿔서, DB에서 id를 생성하는 과정을 줄여서, 성능을 개선한다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1만-개가-한-트랜잭션으로-묶이고-id를-미리-생성한-버전">1만 개가 한 트랜잭션으로 묶이고, id를 미리 생성한 버전<a href="#1만-개가-한-트랜잭션으로-묶이고-id를-미리-생성한-버전" class="hash-link" aria-label="1만 개가 한 트랜잭션으로 묶이고, id를 미리 생성한 버전에 대한 직접 링크" title="1만 개가 한 트랜잭션으로 묶이고, id를 미리 생성한 버전에 대한 직접 링크">​</a></h2><p>이때 batch size를 1000 단위로 설정해서 1000개씩 id 가 늘어나도록 설정했다</p><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/bFjNWb/btsmuoLmzVh/GddHebu2V43fpk2t3IUmz0/img.png" alt="charger_generator" class="img_ev3q"><img loading="lazy" src="https://blog.kakaocdn.net/dn/pae8w/btsmrANjAGi/gjUhD6sMvBLpmsPl9c1tAk/img.png" alt="station_generator" class="img_ev3q"></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring.jdbc.template.fetch-size=10000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/mtBFp/btsmtEt48jp/3mFOfrIBWbjJhHHuyP4zPk/img.png" alt="10000batch_size" class="img_ev3q"></p><p>1자리 숫자는 앞에서부터 n(만개)를 의미하고, 2번째 숫자는 1만 개를 저장하는 데 걸린 시간(ms)을 의미합니다.</p><p>처음 1만 개는 142초가 걸리고, 2만 개는 285초가 걸렸습니다.</p><p>23만 개라면? 142 <!-- -->*<!-- --> 26 = 3,266초</p><p>처음과 비교하자면 7.4시간이 걸리는 것에서 54분 정도 걸리는 것으로 개선되었습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="이-과정에서-볼-수-있는-문제점-3">이 과정에서 볼 수 있는 문제점<a href="#이-과정에서-볼-수-있는-문제점-3" class="hash-link" aria-label="이 과정에서 볼 수 있는 문제점에 대한 직접 링크" title="이 과정에서 볼 수 있는 문제점에 대한 직접 링크">​</a></h3><p>하나의 스레드에서만 동작하기에, 성능이 개선되었지만, 여전히 느립니다.</p><p>하나의 스레드에서만 동작하기에, 하나의 커넥션을 사용하게 됩니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="어떻게-개선할-수-있을까-3">어떻게 개선할 수 있을까?<a href="#어떻게-개선할-수-있을까-3" class="hash-link" aria-label="어떻게 개선할 수 있을까?에 대한 직접 링크" title="어떻게 개선할 수 있을까?에 대한 직접 링크">​</a></h3><p>여러 스레드에서 동작하게 하고, 여러 커넥션을 사용하게 합니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="여러-스레드에서-동작하고-여러-커넥션을-사용하는-버전">여러 스레드에서 동작하고, 여러 커넥션을 사용하는 버전<a href="#여러-스레드에서-동작하고-여러-커넥션을-사용하는-버전" class="hash-link" aria-label="여러 스레드에서 동작하고, 여러 커넥션을 사용하는 버전에 대한 직접 링크" title="여러 스레드에서 동작하고, 여러 커넥션을 사용하는 버전에 대한 직접 링크">​</a></h2><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/bPV2aa/btsmrSfU2D4/phDwk77XiKvwiXa5geX0PK/img.png" alt="multi_thread" class="img_ev3q"></p><p>이 버전에서 89991 개를 저장하는데 총 157초가 걸렸습니다.</p><p>23만 개라면? 157 <!-- -->*<!-- --> 3 = 471초</p><p>시간으로 바꿔보면 5분도 채 걸리지 않는 시간이죠</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="이-과정에서-볼-수-있는-문제점-4">이 과정에서 볼 수 있는 문제점<a href="#이-과정에서-볼-수-있는-문제점-4" class="hash-link" aria-label="이 과정에서 볼 수 있는 문제점에 대한 직접 링크" title="이 과정에서 볼 수 있는 문제점에 대한 직접 링크">​</a></h3><p>hikari connection pool 사이즈를 10으로 설정했는데, 10개의 커넥션을 사용하면서 저장을 하다 보니, 10개의 커넥션을 모두 사용하고 나서, 11번째부터는 커넥션을 가져오기 위해, 기다려야 하는 상황이 발생합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="어떻게-개선할-수-있을까-4">어떻게 개선할 수 있을까?<a href="#어떻게-개선할-수-있을까-4" class="hash-link" aria-label="어떻게 개선할 수 있을까?에 대한 직접 링크" title="어떻게 개선할 수 있을까?에 대한 직접 링크">​</a></h3><p>hikari connection pool 사이즈를 25로 설정해서, 25개의 커넥션을 사용하도록 합니다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.maximum-pool-size=25</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="여러-스레드에서-동작하고-여러-커넥션을-사용하는-버전-2">여러 스레드에서 동작하고, 여러 커넥션을 사용하는 버전 2<a href="#여러-스레드에서-동작하고-여러-커넥션을-사용하는-버전-2" class="hash-link" aria-label="여러 스레드에서 동작하고, 여러 커넥션을 사용하는 버전 2에 대한 직접 링크" title="여러 스레드에서 동작하고, 여러 커넥션을 사용하는 버전 2에 대한 직접 링크">​</a></h2><p><img loading="lazy" src="https://blog.kakaocdn.net/dn/vJEoD/btsmsfau8Mv/j0CT8fVrAp3LKGRMmyMVeK/img.png" alt="multi_thread2" class="img_ev3q"></p><p>총 13만 개의 데이터를 저장하는데, 147초가 걸리고, db 인스턴스의 cpu 사용률이 100%에 가까워져서 ec2 가 다운되었습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="이-과정에서-볼-수-있는-문제점-5">이 과정에서 볼 수 있는 문제점<a href="#이-과정에서-볼-수-있는-문제점-5" class="hash-link" aria-label="이 과정에서 볼 수 있는 문제점에 대한 직접 링크" title="이 과정에서 볼 수 있는 문제점에 대한 직접 링크">​</a></h3><p>db의 cpu 사용량을 고려하지 않고, 23만 개가 조금 넘는 데이터를 25개의 커넥션을 활용해 저장하려고 했습니다</p><h1>결론</h1><ol><li>데이터를 저장할 때마다, transaction을 사용하지 말자</li><li>데이터를 저장할 때마다, id를 생성하지 말자</li><li>여러 스레드에서 동작하고, 여러 커넥션을 사용하자</li><li>db의 cpu 사용량을 고려하자</li></ol><p>긴 글 읽어주셔서 감사합니다</p>]]></content>
        <author>
            <name>누누</name>
            <uri>https://github.com/be-student</uri>
        </author>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <category label="DB" term="DB"/>
        <category label="JPA" term="JPA"/>
        <category label="Hibernate" term="Hibernate"/>
        <category label="Spring" term="Spring"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[pr 본문에 이슈 번호를 달아주는 기능을 만들었습니다]]></title>
        <id>https://car-ffeine.github.io/5</id>
        <link href="https://car-ffeine.github.io/5"/>
        <updated>2023-07-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요 우테코 카페인팀 누누입니다]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요 우테코 카페인팀 누누입니다</p><p>빠르게 결과부터 보고 가시죠.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="어떤-결과가-나왔나요">어떤 결과가 나왔나요?<a href="#어떤-결과가-나왔나요" class="hash-link" aria-label="어떤 결과가 나왔나요?에 대한 직접 링크" title="어떤 결과가 나왔나요?에 대한 직접 링크">​</a></h2><p>pr의 본문 끝에, 연관된 이슈 번호를 달아주는 기능을 만들었습니다.</p><p>밑에 사진을 보시면 쉽게 이해하실 수 있을 것 같습니다.</p><p><img loading="lazy" src="https://user-images.githubusercontent.com/80899085/250614527-e2672cf2-786a-434c-a8b6-8b374de4d689.png" alt="img" class="img_ev3q"><img loading="lazy" src="https://user-images.githubusercontent.com/80899085/250614882-d99aa570-51e2-4565-ab4c-ccdbd4d36e57.png" alt="img" class="img_ev3q"></p><p>github에서 issue 번호가 pr에 담겨있다면 2가지 장점이 생기는데요.</p><ol><li>issue를 클릭했을 때, 자동으로 그 issue로 넘어갈 수 있습니다. (호버만으로 이슈에 대한 간단한 정보를 볼 수 있습니다)</li><li>pr 이 merge 되었을 때, 자동으로 issue 가 close 됩니다.</li></ol><p>이 과정을 손으로 진행하는 것보다, 자동으로 진행하게 되면 실수도 줄어들고, 개발 과정이 편해질 것 같아서 이 기능을 제작하게 되었는데요</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="중요한-점">중요한 점<a href="#중요한-점" class="hash-link" aria-label="중요한 점에 대한 직접 링크" title="중요한 점에 대한 직접 링크">​</a></h2><p><strong>이 과정을 진행하려면 밑에서 소개해드릴 브랜치 네이밍 규칙이 필요합니다.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="브랜치-이름-규칙">브랜치 이름 규칙<a href="#브랜치-이름-규칙" class="hash-link" aria-label="브랜치 이름 규칙에 대한 직접 링크" title="브랜치 이름 규칙에 대한 직접 링크">​</a></h2><ul><li>브랜치 이름은 <code>타입/이슈번호</code> 으로 구성합니다. ex) <code>feat/1</code></li><li>타입은 <code>feat</code>, <code>fix</code>, <code>docs</code>, <code>refactor</code>, <code>test</code> 등 여러 가지가 있을 수 있습니다.</li></ul><p>이렇게 했을 때, 이슈 번호를 브랜치 명에서부터 가져올 수 있기에, 자동화를 할 수 있습니다.</p><p>이런 규칙이 아닌, feat/action 같은 형태가 된다면 issue 번호를 찾기 어렵겠죠?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="사용-방법">사용 방법<a href="#사용-방법" class="hash-link" aria-label="사용 방법에 대한 직접 링크" title="사용 방법에 대한 직접 링크">​</a></h2><p>작성된 코드부터 보시고, 설명을 드리겠습니다.</p><p>아래에 작성된 코드를. github/workflows/assign<!-- -->_<!-- -->issue<!-- -->_<!-- -->number<!-- -->_<!-- -->to<!-- -->_<!-- -->pr<!-- -->_<!-- -->body.yml로 저장하시면 끝입니다.</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> assign_issue_number_to_pr_body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">types</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> opened </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches-ignore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> develop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">append_issue_number_to_pr_body</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> append feature number to pr body pr branch = feat/(issueNumber)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/github</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">script@v4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">github-token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">script</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            const pr = await github.pulls.get({</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                owner: context.repo.owner,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                repo: context.repo.repo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                pull_number: context.issue.number</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            const body = pr.data.body;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            const issueNumber= pr.data.head.ref.split('/')[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            const newBody = body + "\n\n" + "close #" + issueNumber;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            await github.pulls.update({</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                  owner: context.repo.owner,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                  repo: context.repo.repo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                  pull_number: context.issue.number,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                  body: newBody</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              });</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="진행-과정">진행 과정<a href="#진행-과정" class="hash-link" aria-label="진행 과정에 대한 직접 링크" title="진행 과정에 대한 직접 링크">​</a></h2><ol><li>pr 이 생성되면, pr에 대한 정보를 가져옵니다.</li><li>pr의 본문을 가져옵니다.</li><li>pr의 브랜치 이름에서 이슈 번호를 가져옵니다.</li><li>pr의 본문에 이슈 번호를 추가합니다.</li><li>pr의 본문을 업데이트합니다.</li></ol><p>이 과정을 통해서, 직접 pr의 본문을 수정하지 않아도, 자동으로 이슈 번호가 추가되기에, 실수를 줄일 수 있으니, 한 번 시도해 보세요</p>]]></content>
        <author>
            <name>누누</name>
            <uri>https://github.com/be-student</uri>
        </author>
        <category label="github" term="github"/>
        <category label="action" term="action"/>
        <category label="pr" term="pr"/>
        <category label="issue" term="issue"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[큰 틀에서 바라보는 서버 아키텍처 계획]]></title>
        <id>https://car-ffeine.github.io/4</id>
        <link href="https://car-ffeine.github.io/4"/>
        <updated>2023-07-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[서론]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="서론">서론<a href="#서론" class="hash-link" aria-label="서론에 대한 직접 링크" title="서론에 대한 직접 링크">​</a></h2><p>안녕하세요👋👋 <code>카페인</code> 팀의 제이입니다.</p><p>회의를 하면서 이번 주 제가 맡은 파트는 서버 인프라입니다.</p><p>아직은 EC2 스펙과 데이터들이 정확히 나오진 않았지만,
우테코에서 적은 EC2 스펙을 제공한다는 기준으로 계획도를 적어볼 생각입니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="상황-인식">상황 인식<a href="#상황-인식" class="hash-link" aria-label="상황 인식에 대한 직접 링크" title="상황 인식에 대한 직접 링크">​</a></h2><strong>예상하는 상황은 다음과 같습니다.</strong><ul><li>API의 데이터를 다루는 상황에서 최소 약 150만 건에서 최악 약 3700만 건의 데이터를 다룹니다.</li><li>이전 기수를 봤을 때 EC2의 개수는 많이 나눠주는 것으로 파악 됐습니다. (이 부분은 달라질 수 있습니다.)</li><li>상황에 따라서 공공 API를 업데이트 해주는 서버와, 제공 서버를 나눌 수 있습니다.</li><li>Conflict가 나지 않기 위해서 안정적인 검증을 거친 후 Merge를 해야합니다.</li><li>프로젝트의 버전이 갱신된다면 EC2 서버에서 자동으로 스크립트를 작동시켜 Pull 및 서버 재배포를 해야합니다.</li><li>서버의 버전이 바뀌는 경우 기존 서버를 끄고 새로운 서버를 키면 사용자가 이용할 수 없는 텀이 생기기 때문에 무중단 배포를 해야합니다.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="문제점">문제점<a href="#문제점" class="hash-link" aria-label="문제점에 대한 직접 링크" title="문제점에 대한 직접 링크">​</a></h2><p>위에 상황에서 파악되는 문제점들은 먼저 적은 성능의 EC2 서버로 인해 데이터를 받아오는 과정 혹은 업데이트 과정에서 서버가 터질 수도 있습니다.
성능이 좋다면 하나로 모든 것을 할 수 있지만, 그렇지 않기 때문에 현재 여러 개의 EC2를 기준으로 아키텍처를 구성할 예정입니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="문제-해결을-위한-현재-생각">문제 해결을 위한 현재 생각<a href="#문제-해결을-위한-현재-생각" class="hash-link" aria-label="문제 해결을 위한 현재 생각에 대한 직접 링크" title="문제 해결을 위한 현재 생각에 대한 직접 링크">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="서버의-기능-분산">서버의 기능 분산<a href="#서버의-기능-분산" class="hash-link" aria-label="서버의 기능 분산에 대한 직접 링크" title="서버의 기능 분산에 대한 직접 링크">​</a></h3><p>위에서 언급한 것처럼 서버의 성능이 받쳐주지 못할 가능성이 있습니다. 성능을 생각해서 이를 나누기 위해서는 먼저 다음과 같이 서버를 분산할 필요가 있다고 생각합니다.
(물론 서버가 못 버틸 경우이고, 어떻게 나뉘는 지는 회의 후 결정하겠지만!)</p><ul><li><code>공공 API 데이터 적재 및 주기적인 업데이트</code></li><li><code>실시간 혼잡도를 위한 실시간 데이터 업데이트</code></li><li><code>요청 처리</code></li></ul><p>적은 성능으로 업데이트와 요청 처리를 동시에 한다면, 서버가 그 부하를 견디지 못할 수도 있겠죠?
따라서 서버의 역할을 분담하고, 각 역할에 충실하도록 구현한다면 보다 효율적인 처리를 할 수 있을 것이라고 예상됩니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="안정적인-merge">안정적인 Merge<a href="#안정적인-merge" class="hash-link" aria-label="안정적인 Merge에 대한 직접 링크" title="안정적인 Merge에 대한 직접 링크">​</a></h3><p>잘못된 PR을 Merge 시켜버리면 어떨까요? Conflict도 날 수 있고.. 생각만해도 끔찍합니다.</p><p>코드리뷰를 통해서 이를 어느정도 해소한다고 해도, 사람이다보니 실수할 수 있습니다.
이를 해결하기 위해서 <code>Github Actions</code>를 이용하여 미리 지정해둔 Task를 시키고, 이게 통과한다면 Merge할 수 있도록 할 예정입니다.</p><p>이렇게 한다면 협업할 때에도 안전한 Merge가 가능하다고 생각합니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cicd">CI/CD<a href="#cicd" class="hash-link" aria-label="CI/CD에 대한 직접 링크" title="CI/CD에 대한 직접 링크">​</a></h3><p>지금까지 우테코 미션에서는 배포를 다음과 같은 과정으로 진행했습니다.</p><ol><li>배포</li><li>리팩토링 및 커밋</li><li>EC2 서버에서 스크립트 실행하여 재배포</li></ol><p>이렇게 배포를 해도 상관없지만, 매번 리팩토링과 기능 추가를 할 때마다 EC2 서버로 들어가서 빌드 스크립트를 사용해서 서버를 재시작 해야할까요?
이렇게 된다면 불필요한 시간이 소모되고, 불편한 점이 많을 것이라고 생각됩니다.</p><p>따라서 CI/CD 개념을 적용해서 이 과정을 자동으로 진행하고자 합니다.</p><p>이 부분은 더 알아봐야겠지만, Github Actions를 이용해서 이를 적용하면, 외부에서 SSH 접근이 불가능하기 때문에 Jenkins를 이용할 예정입니다.
깃허브의 변동 사항을 Webhook을 이용해서 Jenkins로 넘기고, 이를 통해 CI를 적용하면 될 것 같다고 판단했습니다.
물론 이는 계획이고 공부하지 않은 다른 내용이 있을 수 있기 때문에 언제든 바뀔 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="무중단-배포-아키텍처-적용">무중단 배포 아키텍처 적용<a href="#무중단-배포-아키텍처-적용" class="hash-link" aria-label="무중단 배포 아키텍처 적용에 대한 직접 링크" title="무중단 배포 아키텍처 적용에 대한 직접 링크">​</a></h3><p>이 또한 아직은 먼 이야기지만, 고려해 볼 상황이라서 적어봤습니다.</p><p>사용자가 이용하고 있는 서비스가 갑자기 중단된다면 어떨까요?
저는 화가 많이 날 것 같습니다.</p><p>피치 못할 사정으로 서버가 터져도, 사용자가 서비스를 계속 이용할 방법이 없을까요?</p><p>이런 고민을 해결하기 위해서 나온 개념이 무중단 배포입니다.</p><p><code>카나리아 배포</code>, <code>Blue/Green 배포</code>, <code>롤링</code>등 무중단 배포를 위한 여러가지 전략은 이미 존재합니다.
이 부분은 아직은 서버의 명세가 정확하지 않아서 어떤 방식으로 어떻게 처리할 것인지에 대해서는 아직 정할 수는 없습니다.</p><p>이는 명세가 확실하게 정해진 후 팀원과 장단점을 상의하며 결정할 일이기 때문에 현재까지는 "이 정도를 고려하고 있다." 정도만 알면 될 것 같습니다.</p>]]></content>
        <author>
            <name>제이</name>
            <uri>https://github.com/sosow0212</uri>
        </author>
        <category label="java17" term="java17"/>
        <category label="infra" term="infra"/>
        <category label="ec2" term="ec2"/>
        <category label="ci" term="ci"/>
        <category label="cd" term="cd"/>
        <category label="aws" term="aws"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Java 17 을 도입한 이유]]></title>
        <id>https://car-ffeine.github.io/3</id>
        <link href="https://car-ffeine.github.io/3"/>
        <updated>2023-07-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[우아한테크코스에서 자바 11을 사용하는 것이 너무 익숙해진 상황이어서, java 11 대신 java 17을 쓰려면 쓰는 대신, 왜 java 17을 쓰면 좋은지에 대해서 설득을 하는 시간이 있어야 하는데요]]></summary>
        <content type="html"><![CDATA[<p>우아한테크코스에서 자바 11을 사용하는 것이 너무 익숙해진 상황이어서, java 11 대신 java 17을 쓰려면 쓰는 대신, 왜 java 17을 쓰면 좋은지에 대해서 설득을 하는 시간이 있어야 하는데요</p><p>처음에는 단순히 record 클래스가 좋아요, collect(Collectors.toList()); 대신 toList() 만으로 해결할 수 있어서 좋아요</p><p>까지밖에 설명할 수 없었습니다.</p><p>이것만으로 동의를 해줘서 일단 java 17 을 사용하기로 했지만, 이번 기회에 조금 더 자세하게 알아보려고 합니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="java-17-과-java-11의-중요한-차이들">Java 17 과 Java 11의 중요한 차이들<a href="#java-17-과-java-11의-중요한-차이들" class="hash-link" aria-label="Java 17 과 Java 11의 중요한 차이들에 대한 직접 링크" title="Java 17 과 Java 11의 중요한 차이들에 대한 직접 링크">​</a></h2><p>기능적인 부분과, 숨겨진 부분을 나누어볼 수 있을 것 같습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="기능적인-차이점">기능적인 차이점<a href="#기능적인-차이점" class="hash-link" aria-label="기능적인 차이점에 대한 직접 링크" title="기능적인 차이점에 대한 직접 링크">​</a></h2><p>언제나 직접 차이를 보면 더 직관적이기 때문에, 직접 코드를 보면서 설명을 해보려고 합니다</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="record-클래스">record 클래스<a href="#record-클래스" class="hash-link" aria-label="record 클래스에 대한 직접 링크" title="record 클래스에 대한 직접 링크">​</a></h3><p>간단한 dto 클래스를 만들었을 때 코드가 정말 간단해지는 것을 확인할 수 있습니다</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="java-11">Java 11<a href="#java-11" class="hash-link" aria-label="Java 11에 대한 직접 링크" title="Java 11에 대한 직접 링크">​</a></h4><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Dto {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Dto(int data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.data = data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getData() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>lombok 을 사용했을 때</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Getter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Dto {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="java17">Java17<a href="#java17" class="hash-link" aria-label="Java17에 대한 직접 링크" title="Java17에 대한 직접 링크">​</a></h4><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public record Record(int data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이렇게 보면 훨씬 간단해진 것을 볼 수 있습니다</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="예상되는-문제점">예상되는 문제점<a href="#예상되는-문제점" class="hash-link" aria-label="예상되는 문제점에 대한 직접 링크" title="예상되는 문제점에 대한 직접 링크">​</a></h4><p>objectMapper를 사용하면 어떻게 되나요? noArgsConstructor 가 필요하지 않나요?</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RecordTest</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> objectMapper_로_변환</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">JsonProcessingException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// given</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ObjectMapper</span><span class="token plain"> objectMapper </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ObjectMapper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Record</span><span class="token plain"> record </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Record</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// when</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> json </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> objectMapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">writeValueAsString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">assertEquals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"{\"data\":1}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> string_에서_객체로_변환</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">JsonProcessingException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// given</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> json </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"{\"data\":1}"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ObjectMapper</span><span class="token plain"> objectMapper </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ObjectMapper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// when</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Record</span><span class="token plain"> record </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> objectMapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">assertEquals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이 테스트에서 볼 수 있는 것처럼 성공적으로 deserialize, serialize 가 가능합니다</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tolist-method">toList() method<a href="#tolist-method" class="hash-link" aria-label="toList() method에 대한 직접 링크" title="toList() method에 대한 직접 링크">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="java-11-1">Java 11<a href="#java-11-1" class="hash-link" aria-label="Java 11에 대한 직접 링크" title="Java 11에 대한 직접 링크">​</a></h4><p>이 부분도 정말 편의성이 높다고 생각하는 부분 중 하나인데요</p><p>Collectors.toList() 대신 toList() 만으로도 사용이 가능합니다</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ToListWith11</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">collect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="java-17">Java 17<a href="#java-17" class="hash-link" aria-label="Java 17에 대한 직접 링크" title="Java 17에 대한 직접 링크">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ToListWith17</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="switch-expression">switch expression<a href="#switch-expression" class="hash-link" aria-label="switch expression에 대한 직접 링크" title="switch expression에 대한 직접 링크">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="java-11-2">Java 11<a href="#java-11-2" class="hash-link" aria-label="Java 11에 대한 직접 링크" title="Java 11에 대한 직접 링크">​</a></h4><p>우테코에서는 switch, case 를 싫어하기에 볼 수는 없겠지만</p><p>switch 문에도 정말 편하게 바뀌었는데요</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SwitchWith11</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Sunday"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Monday"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Tuesday"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Wednesday"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Thursday"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Friday"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Saturday"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Sunday"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="java-17-1">Java 17<a href="#java-17-1" class="hash-link" aria-label="Java 17에 대한 직접 링크" title="Java 17에 대한 직접 링크">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SwitchWith17</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Sunday"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Monday"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Tuesday"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Wednesday"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Thursday"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Friday"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Saturday"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Sunday"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>코드 량이 엄청 줄어든 것을 확인하실 수 있습니다</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="instanceof-pattern-matching">instanceof pattern matching<a href="#instanceof-pattern-matching" class="hash-link" aria-label="instanceof pattern matching에 대한 직접 링크" title="instanceof pattern matching에 대한 직접 링크">​</a></h3><p>물론 instanceof 를 사용할 경우가 많은가? 하면 많지는 않겠지만</p><p>아래와 같이 변경되었습니다</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="java-11-3">Java 11<a href="#java-11-3" class="hash-link" aria-label="Java 11에 대한 직접 링크" title="Java 11에 대한 직접 링크">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">InstanceOfWith11</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Object</span><span class="token plain"> obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Hello"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">String</span><span class="token plain"> str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toUpperCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="java-17-2">Java 17<a href="#java-17-2" class="hash-link" aria-label="Java 17에 대한 직접 링크" title="Java 17에 대한 직접 링크">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">InstanceOfWith17</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Object</span><span class="token plain"> obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Hello"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toUpperCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="number-format">number format<a href="#number-format" class="hash-link" aria-label="number format에 대한 직접 링크" title="number format에 대한 직접 링크">​</a></h3><p>이 기능은 12에 나왔는데요</p><p>언어별로 숫자를 표현하는 방식이 다르지만, 쉽게 표현할 수 있도록 도와주는 기능입니다</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="java-17-3">Java 17<a href="#java-17-3" class="hash-link" aria-label="Java 17에 대한 직접 링크" title="Java 17에 대한 직접 링크">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">NumberFormatterWith11</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> number </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1_000_000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">NumberFormat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCompactNumberInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Locale</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">KOREA</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">NumberFormat</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">LONG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"100만"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>나머지 부분은 사실 그렇게 큰 역할을 할 것 같지는 않아서 생략하겠습니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="숨겨진-부분들">숨겨진 부분들<a href="#숨겨진-부분들" class="hash-link" aria-label="숨겨진 부분들에 대한 직접 링크" title="숨겨진 부분들에 대한 직접 링크">​</a></h2><p><img loading="lazy" src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FXhFJg%2Fbtsl9uZOa5R%2FrzrlotCERUqAWM2pknDwq0%2Fimg.png" alt="gc throughput" class="img_ev3q"></p><p>위의 사진은 gc 의 버전별 처리량입니다.</p><p>G1 GC 를 기준으로 본다면 Java8 과의 차이는 15% 정도 향상되었고, java 11과는 10% 정도 향상되었습니다.</p><p><img loading="lazy" src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FZusmb%2Fbtsl5jYN68u%2FWCKRCFnYjQK4AjkcHRNAt0%2Fimg.png" alt="gc latency" class="img_ev3q"></p><p>위의 사진은 gc의 버전별 지연시간입니다.</p><p>G1 GC 를 기준으로 본다면 Java8 과의 차이는 30% 정도 향상되었고, java 11과는 25% 정도 향상되었습니다.</p><p>이와 같이, 단순하게 새로운 기능만 추가되는 것이 아니라 꾸준히 성능도 향상되고 있습니다.</p><p>이런 부분을 고려했을 때, Java 17을 사용하는 것이 좋을 것 같습니다.</p><p>참고</p><ul><li><a href="https://kstefanj.github.io/2021/11/24/gc-progress-8-17.html" target="_blank" rel="noopener noreferrer">https://kstefanj.github.io/2021/11/24/gc-progress-8-17.html</a></li></ul>]]></content>
        <author>
            <name>누누</name>
            <uri>https://github.com/be-student</uri>
        </author>
        <category label="java17" term="java17"/>
        <category label="java11" term="java11"/>
        <category label="record" term="record"/>
        <category label="toList" term="toList"/>
        <category label="gc" term="gc"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[git branch 전략 작성해보기]]></title>
        <id>https://car-ffeine.github.io/2</id>
        <link href="https://car-ffeine.github.io/2"/>
        <updated>2023-07-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[현재 상황은 어떤데?]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="현재-상황은-어떤데">현재 상황은 어떤데?<a href="#현재-상황은-어떤데" class="hash-link" aria-label="현재 상황은 어떤데?에 대한 직접 링크" title="현재 상황은 어떤데?에 대한 직접 링크">​</a></h2><p>현재 우아한테크코스에서는 프론트 코드와 백엔드 코드가 같은 레포지토리를 사용하고 있습니다.</p><p>프론트와 백엔드가 같이 작업하기에, 의도치 않은 충돌이 자주 생길 수 있는 구조이기에, 이를 git branch 전략으로 충돌을 줄이고자 합니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="git-branch-전략이란">Git Branch 전략이란?<a href="#git-branch-전략이란" class="hash-link" aria-label="Git Branch 전략이란?에 대한 직접 링크" title="Git Branch 전략이란?에 대한 직접 링크">​</a></h2><p>git을 사용해서 소프트웨어 개발을 관리하는 방법입니다.</p><p>여러 개발자가 동시에 작업하고 코드를 통합할 때 생기는 충돌을 효율적으로 조정하기 위한 방법입니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="왜-git-branch-전략이-중요한데">왜 git branch 전략이 중요한데?<a href="#왜-git-branch-전략이-중요한데" class="hash-link" aria-label="왜 git branch 전략이 중요한데?에 대한 직접 링크" title="왜 git branch 전략이 중요한데?에 대한 직접 링크">​</a></h2><p>아래에 있는 4가지를 제외하고도 훨씬 많은 장점이 있을 수 있습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-동시-작업이-편하다">1<!-- -->.<!-- --> 동시 작업이 편하다<a href="#1-동시-작업이-편하다" class="hash-link" aria-label="1-동시-작업이-편하다에 대한 직접 링크" title="1-동시-작업이-편하다에 대한 직접 링크">​</a></h4><p>여러 사람이 독립적으로 작업하고, 커밋을 할 때, 자신의 브랜치에서 변경 사항을 커밋하게 됩니다.</p><p>브랜치가 병합될 때만 충돌을 해결하면 되니, 아무 규칙이 없는 것보다 충돌 시점이 명확해지기에 생산성을 높일 수 있습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-목적이-명확한-브랜치">2<!-- -->.<!-- --> 목적이 명확한 브랜치<a href="#2-목적이-명확한-브랜치" class="hash-link" aria-label="2-목적이-명확한-브랜치에 대한 직접 링크" title="2-목적이-명확한-브랜치에 대한 직접 링크">​</a></h4><p>애플리케이션의 상태에 몇 가지가 있는데, 안정된 프로덕션, 테스트 환경, 기능 추가 환경... 등이 있습니다</p><p>여러 기능별 브랜치(안정된 버전의 코드만이 관리되는 브랜치, 테스트 환경을 위한 브랜치, 기능 추가를 위한 브랜치)를</p><p>네이밍을 통해 구분하면 각각의 브랜치에 대해서 추가적인 설명을 할 필요 없이 명확하게 관리할 수 있습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-배포-파이프라인-관리가-편함">3<!-- -->.<!-- --> 배포 파이프라인 관리가 편함<a href="#3-배포-파이프라인-관리가-편함" class="hash-link" aria-label="3-배포-파이프라인-관리가-편함에 대한 직접 링크" title="3-배포-파이프라인-관리가-편함에 대한 직접 링크">​</a></h4><p>브랜치가 네이밍으로 명확하게 구분이 되어있다면, 조건을 설정하기 쉽습니다.</p><p>특정 타입의 브랜치에 push 되었을 때, pull request를 만들었을 때 같은 조건에 따른 스크립트를 만들어둔다면 CI/CD를 구축하기 쉽습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-버전-관리가-편리하다">4<!-- -->.<!-- --> 버전 관리가 편리하다<a href="#4-버전-관리가-편리하다" class="hash-link" aria-label="4-버전-관리가-편리하다에 대한 직접 링크" title="4-버전-관리가-편리하다에 대한 직접 링크">​</a></h4><p>서버에 문제가 생겼을 때, 어떤 브랜치로 돌아가서 롤백을 해야 하는지에 대한 것들이 명확합니다.</p><p>안정된 브랜치가 어떤 것인지 명확하기에, 롤백 과정에 대한 의사결정을 줄일 수 있습니다.</p><p>그러면 어떤 종류가 있는지 더 자세하게 알아보도록 하겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="git-branch-전략의-종류는">Git Branch 전략의 종류는?<a href="#git-branch-전략의-종류는" class="hash-link" aria-label="Git Branch 전략의 종류는?에 대한 직접 링크" title="Git Branch 전략의 종류는?에 대한 직접 링크">​</a></h2><p>총 3가지의 전략이 있습니다.</p><p>1<!-- -->.<!-- --> Github Flow</p><p>2<!-- -->.<!-- --> Gitlab Flow</p><p>3<!-- -->.<!-- --> Git Flow</p><p>git을 사용하기에, Git Flow라는 네이밍이 가장 직관적이고 유명한데요.&nbsp;</p><p>3가지 전략 중에서 가장 복잡하기에, 쉬운 순서대로 진행해 보도록 하겠습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-github-flow">1<!-- -->.<!-- --> Github Flow<a href="#1-github-flow" class="hash-link" aria-label="1-github-flow에 대한 직접 링크" title="1-github-flow에 대한 직접 링크">​</a></h2><p>그림으로 flow 간단하게 보고 가도록 하겠습니다.</p><p><img loading="lazy" src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FblgfI6%2FbtslEWRFdaJ%2F3KmwR2yqlfgKk0msnufYNk%2Fimg.png" alt="img" class="img_ev3q"></p><p><img loading="lazy" src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbtUzxm%2FbtslJ1xWHzy%2FMP0s11FoCTKpqwQnUJUm30%2Fimg.png" alt="img2" class="img_ev3q"></p><p>브랜치는 총 2가지 종류가 존재합니다</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-master-브랜치">1<!-- -->.<!-- --> master 브랜치<a href="#1-master-브랜치" class="hash-link" aria-label="1-master-브랜치에 대한 직접 링크" title="1-master-브랜치에 대한 직접 링크">​</a></h4><p>여기에 머지가 되면 배포가 되도록 CD를 연결해 놓은 경우가 많습니다.</p><p>안정된 버전의 코드가 관리되는 브랜치입니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-feature-브랜치">2<!-- -->.<!-- --> feature 브랜치<a href="#2-feature-브랜치" class="hash-link" aria-label="2-feature-브랜치에 대한 직접 링크" title="2-feature-브랜치에 대한 직접 링크">​</a></h4><p>기능 추가, 버그 수정 등 모든 작업은 feature 브랜치에서 일어납니다.</p><p>master 브랜치에서 새로운 브랜치를 만들어서, 마스터로 머지되는 단순한 사이클을 가지고 있습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="장점">장점<a href="#장점" class="hash-link" aria-label="장점에 대한 직접 링크" title="장점에 대한 직접 링크">​</a></h4><p>위에서 볼 수 있는 것처럼 2종류의 브랜치만 있기에, 정말 간단합니다.</p><p>학습 과정까지의 러닝 커브가 거의 없다시피 하기에, 간단한 프로젝트에 적용하기 정말 좋습니다.</p><p>릴리즈 되지 않은 코드가 최소화됩니다. 최신 버전의 코드와 최대한 빠르게 동기화를 계속해서 시킬 수 있습니다</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="단점">단점<a href="#단점" class="hash-link" aria-label="단점에 대한 직접 링크" title="단점에 대한 직접 링크">​</a></h4><p>모든 코드는 다 master 브랜치에 머지가 되어야 한다는 점이 개발 서버와, 운영서버를 나누기 애매할 수 있습니다.</p><p>개발 서버에 배포를 하고 싶은 상황이라면, master에 머지가 되어야 합니다.</p><p>머지가 된 이후에 cd 파이프라인을 통해서 개발 서버와 운영 서버 모두에 배포가 됩니다.</p><p>여러 환경을 나누고 관리를 하고 싶으시다면 다음에 소개해드릴 전략을 사용해 보셔도 좋을 것 같습니다</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-gitlab-flow">2<!-- -->.<!-- --> Gitlab Flow<a href="#2-gitlab-flow" class="hash-link" aria-label="2-gitlab-flow에 대한 직접 링크" title="2-gitlab-flow에 대한 직접 링크">​</a></h2><p>그림으로 flow 간단하게 보고 가도록 하겠습니다.</p><p><img loading="lazy" src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fdlarwn%2FbtslKkYqqTR%2FXi8NnZIEXahoVFusk0xV31%2Fimg.png" alt="img2" class="img_ev3q"></p><p>밑에 환경은 총 2개의 서버가 존재할 때를 가정하고 있습니다.</p><p>1<!-- -->.<!-- --> pre-production 서버</p><p>2<!-- -->.<!-- --> production 서버</p><p>편의를 위해 main에 머지되는 과정은 간단하게 표현했습니다.</p><p><img loading="lazy" src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdbkNc9%2FbtslJ0MBrWb%2F0CT7DVQoCDFOpbqyAko9mk%2Fimg.png" alt="img3" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="브랜치-종류">브랜치 종류<a href="#브랜치-종류" class="hash-link" aria-label="브랜치 종류에 대한 직접 링크" title="브랜치 종류에 대한 직접 링크">​</a></h4><p>총 3가지 브랜치가 필요하고, 추가에 따라서 더 추가할 수 있습니다.</p><p>1<!-- -->.<!-- --> main(or develop) 브랜치</p><p>기능에 대한 개발이 완료되었지만, 여기에 머지되어도 바로 배포되지는 않습니다.</p><p>2<!-- -->.<!-- --> feature브랜치</p><p>기능을 개발하는 브랜치입니다. Github Flow 와도 유사합니다.</p><p>3<!-- -->.<!-- --> production 브랜치</p><p>실제 배포가 일어나는 브랜치입니다.&nbsp;</p><p>여기에 머지가 되는 순간 배포가 일어납니다.</p><p>위 사진에 있는 것처럼, 필요에 따라서 pre-production이나, staging 같은 환경에 따른 브랜치를 추가할 수 있습니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="특징">특징<a href="#특징" class="hash-link" aria-label="특징에 대한 직접 링크" title="특징에 대한 직접 링크">​</a></h4><p>1<!-- -->.<!-- --> 무조건 단방향으로 머지가 일어납니다.</p><p>긴급하게 라이브 서버에 수정을 해야 할 때, production 부터 시작하는 것이 아닌, main 부터 차근차근 올라가야 합니다</p><p>2<!-- -->.<!-- --> 환경에 따라 브랜치 종류가 늘어날 수 있습니다.</p><p>위 사진에서는 pre-production 이 그 예시가 되겠네요.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="장점-1">장점<a href="#장점-1" class="hash-link" aria-label="장점에 대한 직접 링크" title="장점에 대한 직접 링크">​</a></h4><p>1<!-- -->.<!-- --> Github Flow에서 환경별 브랜치를 통해서 개발 서버나 pre-production 서버에 버전을 깔끔하게 관리할 수 있습니다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-git-flow">3<!-- -->.<!-- --> Git Flow<a href="#3-git-flow" class="hash-link" aria-label="3-git-flow에 대한 직접 링크" title="3-git-flow에 대한 직접 링크">​</a></h2><p>브랜치 전략 중 가장 처음으로 유명해진 브랜치 전략입니다.</p><p>배포가 특정 주기를 가지고 있는 애플리케이션일 때, 가장 적합합니다.</p><p>가장 복잡한 전략을 가지고 있어서, 모두가 브랜치 전략에 대해서 이해하고 있다면 역할에 따른 깔끔한 분리가 가능합니다</p><p>그림으로 보고 가도록 하겠습니다</p><p><img loading="lazy" src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fd9WzKn%2FbtslKdkAHNP%2F2fCAqKSVxtPVWqYnBS8juk%2Fimg.png" alt="img4" class="img_ev3q"></p><p>가장 유명한 브랜치 전략이지만, 가장 어려운 전략이기도 합니다.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="특징-1">특징<a href="#특징-1" class="hash-link" aria-label="특징에 대한 직접 링크" title="특징에 대한 직접 링크">​</a></h4><p>1<!-- -->.<!-- --> 브랜치에 대해서 양방향으로 머지가 일어납니다</p><p>release 브랜치에서 버그 수정이 일어나면, develop 브랜치에도 머지해줘야 합니다.</p><p>hotfix 브랜치를 main 브랜치뿐만 아니라, develop 브랜치에도 머지해줘야 합니다</p><p>브랜치의 종류가 5가지나 됩니다</p><p>1<!-- -->.<!-- --> main</p><p>production 이 배포되었을 때, 이 브랜치에 머지되는 것이 기준이 됩니다.</p><p>2<!-- -->.<!-- --> develop&nbsp;</p><p>위에서 설명드렸던 브랜치들과 큰 차이가 없이 배포 전 브랜치입니다.</p><p>3<!-- -->.<!-- --> feature</p><p>기능을 개발할 때 사용하는 브랜치입니다. 이것도 위와 큰 차이가 없습니다</p><p>4<!-- -->.<!-- --> release</p><p>Gitlab Flow에서 pre-production에 해당한다고 봐도 무방합니다.</p><p>여기서 버그 수정이 일어났을 경우에,&nbsp; develop에 머지하는 것을 까먹으면 안 됩니다.</p><p>5<!-- -->.<!-- --> hotfix</p><p>main 브랜치에서 생성된 브랜치로, 긴급한 변경사항을 처리합니다.</p><p>이때, develop에 머지하는 것을 깜빡하면 안 됩니다.</p><p>더 자세하게 알아보실 분은 아래 링크들을 확인해 보세요</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="우리-프로젝트에는-어떤-것이-적절할까">우리 프로젝트에는 어떤 것이 적절할까?<a href="#우리-프로젝트에는-어떤-것이-적절할까" class="hash-link" aria-label="우리 프로젝트에는 어떤 것이 적절할까?에 대한 직접 링크" title="우리 프로젝트에는 어떤 것이 적절할까?에 대한 직접 링크">​</a></h2><p>나중에 개발 서버 혹은 스테이징 서버를 두고 싶기에, 이 부분에 대한 처리가 부족한 Github Flow는 적절하지 않습니다.</p><p>Git Flow는 깔끔하게 처리할 수 있지만, 러닝 커브가 Gitlab Flow 보다 약간 더 있어서, 빠르게 개발하는 취지에 맞지 않아 보였습니다.</p><p>이런 과정을 통해서 Gitlab Flow를 사용하려고 합니다&nbsp;</p><p>참고</p><p><a href="https://techblog.woowahan.com/2553/" target="_blank" rel="noopener noreferrer">https://techblog.woowahan.com/2553/</a></p><p><a href="https://docs.gitlab.com/ee/topics/gitlab_flow.html" target="_blank" rel="noopener noreferrer">https://docs.gitlab.com/ee/topics/gitlab<!-- -->_<!-- -->flow.html</a></p>]]></content>
        <author>
            <name>누누</name>
            <uri>https://github.com/be-student</uri>
        </author>
        <category label="git" term="git"/>
        <category label="branch" term="branch"/>
        <category label="git branch" term="git branch"/>
        <category label="github flow" term="github flow"/>
        <category label="gitlab flow" term="gitlab flow"/>
        <category label="git flow" term="git flow"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello World]]></title>
        <id>https://car-ffeine.github.io/1</id>
        <link href="https://car-ffeine.github.io/1"/>
        <updated>2023-06-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[안녕하세요]]></summary>
        <content type="html"><![CDATA[<p>안녕하세요</p>]]></content>
        <author>
            <name>박스터</name>
            <uri>https://github.com/drunkenhw</uri>
        </author>
        <author>
            <name>누누</name>
            <uri>https://github.com/be-student</uri>
        </author>
        <author>
            <name>제이</name>
            <uri>https://github.com/sosow0212</uri>
        </author>
        <author>
            <name>키아라</name>
            <uri>https://github.com/kiarakim</uri>
        </author>
        <author>
            <name>야미</name>
            <uri>https://github.com/feb-dain</uri>
        </author>
        <author>
            <name>센트</name>
            <uri>https://github.com/kyw0716</uri>
        </author>
        <author>
            <name>가브리엘</name>
            <uri>https://github.com/gabrielyoon7</uri>
        </author>
        <category label="hello" term="hello"/>
        <category label="world" term="world"/>
    </entry>
</feed>